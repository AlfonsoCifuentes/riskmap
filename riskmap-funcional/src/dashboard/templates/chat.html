{% extends "base.html" %}

{% block title %}AI Chat - Geopolitical Intelligence{% endblock %}

{% block content %}
<style>
    .chat-container {
        background: var(--card-gradient);
        border: 1px solid var(--border-color);
        border-radius: 20px;
        height: 600px;
        display: flex;
        flex-direction: column;
        backdrop-filter: blur(20px);
    }

    .chat-header {
        background: var(--primary-gradient);
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 20px 20px 0 0;
        display: flex;
        justify-content: between;
        align-items: center;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .message {
        max-width: 80%;
        padding: 1rem;
        border-radius: 15px;
        word-wrap: break-word;
    }

    .message.user {
        align-self: flex-end;
        background: var(--primary-gradient);
        color: white;
        border-bottom-right-radius: 5px;
    }

    .message.ai {
        align-self: flex-start;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
        border-bottom-left-radius: 5px;
    }

    .message.system {
        align-self: center;
        background: rgba(102, 126, 234, 0.1);
        color: var(--text-secondary);
        font-style: italic;
        max-width: 60%;
        text-align: center;
        border-radius: 20px;
    }

    .chat-input-area {
        padding: 1rem 1.5rem;
        border-top: 1px solid var(--border-color);
        border-radius: 0 0 20px 20px;
        background: rgba(255, 255, 255, 0.05);
    }

    .chat-input {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
        border-radius: 10px;
        padding: 0.75rem 1rem;
        width: 100%;
        resize: none;
    }

    .chat-input:focus {
        background: rgba(255, 255, 255, 0.15);
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        color: var(--text-primary);
        outline: none;
    }

    .send-button {
        background: var(--primary-gradient);
        border: none;
        color: white;
        border-radius: 50%;
        width: 45px;
        height: 45px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition);
        margin-left: 0.5rem;
    }

    .send-button:hover {
        transform: scale(1.1);
        box-shadow: var(--shadow-lg);
    }

    .send-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .typing-indicator {
        display: none;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        max-width: 80px;
        align-self: flex-start;
    }

    .typing-dots {
        display: flex;
        gap: 4px;
    }

    .typing-dots span {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--primary-color);
        animation: typing 1.4s infinite ease-in-out;
    }

    .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
    .typing-dots span:nth-child(2) { animation-delay: -0.16s; }

    @keyframes typing {
        0%, 80%, 100% {
            transform: scale(0);
            opacity: 0.5;
        }
        40% {
            transform: scale(1);
            opacity: 1;
        }
    }

    .quick-questions {
        background: rgba(22, 27, 34, 0.9);
        border: 1px solid var(--border-color);
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .quick-question {
        background: rgba(102, 126, 234, 0.1);
        border: 1px solid rgba(102, 126, 234, 0.3);
        color: var(--text-primary);
        padding: 0.5rem 1rem;
        border-radius: 20px;
        margin: 0.25rem;
        cursor: pointer;
        transition: var(--transition);
        display: inline-block;
        font-size: 0.9rem;
    }

    .quick-question:hover {
        background: rgba(102, 126, 234, 0.2);
        transform: translateY(-2px);
    }

    .ai-capabilities {
        background: rgba(22, 27, 34, 0.9);
        border: 1px solid var(--border-color);
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .capability-item {
        display: flex;
        align-items: center;
        margin-bottom: 0.5rem;
        color: var(--text-secondary);
    }

    .capability-item i {
        color: var(--primary-color);
        margin-right: 0.5rem;
        width: 20px;
    }

    .chat-status {
        font-size: 0.8rem;
        color: var(--text-muted);
    }

    .online-indicator {
        width: 8px;
        height: 8px;
        background: var(--success-color);
        border-radius: 50%;
        margin-left: 0.5rem;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
</style>

<div class="container-fluid">
    <div class="row">
        <!-- Chat Interface -->
        <div class="col-lg-8">
            <div class="chat-container">
                <!-- Chat Header -->
                <div class="chat-header">
                    <div>
                        <h4 class="mb-0">
                            <i class="fas fa-robot me-2"></i>
                            Asistente Geopol√≠tico IA
                        </h4>
                        <div class="chat-status">
                            Modelo open-source ‚Ä¢ An√°lisis en tiempo real
                            <span class="online-indicator"></span>
                        </div>
                    </div>
                    <div>
                        <button class="btn btn-outline-light btn-sm" onclick="clearChat()">
                            <i class="fas fa-trash me-1"></i>Limpiar
                        </button>
                    </div>
                </div>

                <!-- Chat Messages -->
                <div class="chat-messages" id="chat-messages">
                    <div class="message system">
                        <i class="fas fa-info-circle me-2"></i>
                        ¬°Hola! Soy tu asistente de inteligencia geopol√≠tica. Preg√∫ntame sobre conflictos, tendencias regionales, an√°lisis de riesgo o cualquier tema geopol√≠tico.
                    </div>
                </div>

                <!-- Typing Indicator -->
                <div class="typing-indicator" id="typing-indicator">
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>

                <!-- Chat Input -->
                <div class="chat-input-area">
                    <div class="d-flex">
                        <textarea 
                            class="chat-input" 
                            id="chat-input" 
                            placeholder="Preg√∫ntame sobre geopol√≠tica, conflictos, regiones, tendencias..."
                            rows="2"
                            maxlength="500"></textarea>
                        <button class="send-button" id="send-button" onclick="sendMessage()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <small class="text-muted mt-1 d-block">
                        Presiona Enter para enviar ‚Ä¢ M√°ximo 500 caracteres
                    </small>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Quick Questions -->
            <div class="quick-questions">
                <h5><i class="fas fa-lightning-bolt me-2"></i>Preguntas R√°pidas</h5>
                <p class="text-muted small mb-3">Haz clic para preguntar:</p>
                
                <div class="quick-question" onclick="askQuickQuestion('¬øCu√°les son los principales focos de tensi√≥n geopol√≠tica actualmente?')">
                    üåç Focos de tensi√≥n actuales
                </div>
                
                <div class="quick-question" onclick="askQuickQuestion('¬øQu√© regiones tienen mayor riesgo geopol√≠tico?')">
                    ‚ö†Ô∏è Regiones de alto riesgo
                </div>
                
                <div class="quick-question" onclick="askQuickQuestion('¬øCu√°les son las tendencias geopol√≠ticas m√°s importantes?')">
                    üìà Tendencias importantes
                </div>
                
                <div class="quick-question" onclick="askQuickQuestion('¬øC√≥mo eval√∫an el riesgo de conflictos?')">
                    üéØ Evaluaci√≥n de riesgo
                </div>
                
                <div class="quick-question" onclick="askQuickQuestion('¬øQu√© factores influyen en la estabilidad regional?')">
                    üèõÔ∏è Factores de estabilidad
                </div>
                
                <div class="quick-question" onclick="askQuickQuestion('¬øCu√°l es el impacto econ√≥mico de los conflictos geopol√≠ticos?')">
                    üí∞ Impacto econ√≥mico
                </div>
                
                <div class="quick-question" onclick="askQuickQuestion('¬øC√≥mo funciona el an√°lisis de sentimiento en noticias?')">
                    üß† An√°lisis de sentimiento
                </div>
                
                <div class="quick-question" onclick="askQuickQuestion('¬øQu√© tecnolog√≠as usan para el an√°lisis geopol√≠tico?')">
                    üî¨ Tecnolog√≠as IA
                </div>
            </div>

            <!-- AI Capabilities -->
            <div class="ai-capabilities">
                <h5><i class="fas fa-brain me-2"></i>Capacidades del Asistente</h5>
                
                <div class="capability-item">
                    <i class="fas fa-globe"></i>
                    <span>An√°lisis de eventos geopol√≠ticos globales</span>
                </div>
                
                <div class="capability-item">
                    <i class="fas fa-chart-line"></i>
                    <span>Interpretaci√≥n de tendencias y patrones</span>
                </div>
                
                <div class="capability-item">
                    <i class="fas fa-map-marked-alt"></i>
                    <span>Informaci√≥n sobre regiones espec√≠ficas</span>
                </div>
                
                <div class="capability-item">
                    <i class="fas fa-shield-alt"></i>
                    <span>Evaluaci√≥n de niveles de riesgo</span>
                </div>
                
                <div class="capability-item">
                    <i class="fas fa-balance-scale"></i>
                    <span>An√°lisis de impacto y consecuencias</span>
                </div>
                
                <div class="capability-item">
                    <i class="fas fa-lightbulb"></i>
                    <span>Recomendaciones estrat√©gicas</span>
                </div>
                
                <div class="capability-item">
                    <i class="fas fa-language"></i>
                    <span>Respuestas en espa√±ol y otros idiomas</span>
                </div>
                
                <div class="capability-item">
                    <i class="fas fa-clock"></i>
                    <span>Informaci√≥n actualizada en tiempo real</span>
                </div>

                <div class="mt-3 text-center">
                    <small class="text-muted">
                        <i class="fas fa-open-source-initiative me-1"></i>
                        Modelo 100% open-source y gratuito
                    </small>
                </div>
            </div>

            <!-- Chat Stats -->
            <div class="ai-capabilities">
                <h6><i class="fas fa-chart-bar me-2"></i>Estad√≠sticas de la Sesi√≥n</h6>
                <div class="row text-center">
                    <div class="col-6">
                        <div class="stat-number" id="message-count">0</div>
                        <div class="stat-label">Mensajes</div>
                    </div>
                    <div class="col-6">
                        <div class="stat-number" id="session-time">00:00</div>
                        <div class="stat-label">Tiempo</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatMessages = document.getElementById('chat-messages');
    const chatInput = document.getElementById('chat-input');
    const sendButton = document.getElementById('send-button');
    const typingIndicator = document.getElementById('typing-indicator');
    const messageCountEl = document.getElementById('message-count');
    const sessionTimeEl = document.getElementById('session-time');
    
    let messageCount = 0;
    let sessionStartTime = new Date();
    
    // Update session timer
    setInterval(updateSessionTime, 1000);
    
    function updateSessionTime() {
        const elapsed = Math.floor((new Date() - sessionStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
        const seconds = (elapsed % 60).toString().padStart(2, '0');
        sessionTimeEl.textContent = `${minutes}:${seconds}`;
    }
    
    // Handle Enter key
    chatInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    
    // Auto-resize textarea
    chatInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 100) + 'px';
    });
    
    window.sendMessage = function() {
        const message = chatInput.value.trim();
        if (!message) return;
        
        // Add user message
        addMessage(message, 'user');
        chatInput.value = '';
        chatInput.style.height = 'auto';
        
        // Show typing indicator
        showTyping();
        
        // Send to AI
        fetch('/api/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ message: message })
        })
        .then(response => response.json())
        .then(data => {
            hideTyping();
            if (data.response) {
                addMessage(data.response, 'ai');
            } else {
                addMessage('Lo siento, no pude procesar tu mensaje. Por favor, intenta de nuevo.', 'ai');
            }
        })
        .catch(error => {
            hideTyping();
            console.error('Error:', error);
            addMessage('Error de conexi√≥n. Por favor, verifica tu conexi√≥n a internet.', 'ai');
        });
    };
    
    function addMessage(text, sender) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}`;
        
        if (sender === 'ai') {
            // Add AI icon and format response
            messageDiv.innerHTML = `
                <div class="d-flex align-items-start">
                    <i class="fas fa-robot me-2 mt-1" style="color: var(--primary-color);"></i>
                    <div>${formatAIResponse(text)}</div>
                </div>
            `;
        } else {
            messageDiv.innerHTML = `
                <div class="d-flex align-items-start justify-content-end">
                    <div>${escapeHtml(text)}</div>
                    <i class="fas fa-user ms-2 mt-1"></i>
                </div>
            `;
        }
        
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
        // Update message count
        messageCount++;
        messageCountEl.textContent = messageCount;
    }
    
    function formatAIResponse(text) {
        // Basic formatting for AI responses
        return escapeHtml(text)
            .replace(/\n\n/g, '</p><p>')
            .replace(/\n/g, '<br>')
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>');
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function showTyping() {
        typingIndicator.style.display = 'block';
        chatMessages.scrollTop = chatMessages.scrollHeight;
        sendButton.disabled = true;
    }
    
    function hideTyping() {
        typingIndicator.style.display = 'none';
        sendButton.disabled = false;
    }
    
    window.askQuickQuestion = function(question) {
        chatInput.value = question;
        sendMessage();
    };
    
    window.clearChat = function() {
        if (confirm('¬øEst√°s seguro de que quieres limpiar el chat?')) {
            chatMessages.innerHTML = `
                <div class="message system">
                    <i class="fas fa-info-circle me-2"></i>
                    Chat limpiado. ¬°Preg√∫ntame sobre geopol√≠tica!
                </div>
            `;
            messageCount = 0;
            messageCountEl.textContent = '0';
            sessionStartTime = new Date();
        }
    };
    
    // Initial focus on input
    chatInput.focus();
});
</script>

{% endblock %}
