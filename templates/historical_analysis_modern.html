<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historical Analysis - Risk Intelligence Dashboard</title>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/plotly.js@2.29.1/dist/plotly.min.js"></script>
    <script src="https://unpkg.com/d3@7.8.5/dist/d3.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 25%, #16213e 50%, #0f3460 75%, #533483 100%);
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Glassmorphic Container */
        .dashboard-container {
            padding: 2rem;
            min-height: 100vh;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 25px 45px rgba(0, 0, 0, 0.3);
        }

        /* Header Section */
        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 3rem;
            padding: 1.5rem 0;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-title h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(45deg, #00d4ff, #00b8d4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        /* Tab Navigation */
        .tab-navigation {
            display: flex;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 15px;
            padding: 0.5rem;
            margin-bottom: 2rem;
            overflow-x: auto;
        }

        .tab-button {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            padding: 1rem 1.5rem;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            font-weight: 500;
            white-space: nowrap;
        }

        .tab-button:hover {
            color: #00d4ff;
            background: rgba(0, 212, 255, 0.1);
        }

        .tab-button.active {
            color: #00d4ff;
            background: rgba(0, 212, 255, 0.15);
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.2);
        }

        /* Filter Panel */
        .filter-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .filter-group {
            position: relative;
        }

        .filter-label {
            display: block;
            color: #00d4ff;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .filter-select, .filter-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 0.75rem;
            color: #ffffff;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .filter-select:focus, .filter-input:focus {
            outline: none;
            border-color: #00d4ff;
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.3);
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 15px 35px rgba(0, 212, 255, 0.1);
        }

        .stat-icon {
            font-size: 2.5rem;
            color: #00d4ff;
            margin-bottom: 1rem;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
            font-weight: 500;
        }

        /* Content Areas */
        .content-area {
            display: none;
        }

        .content-area.active {
            display: block;
        }

        .content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 15px;
            padding: 1.5rem;
            min-height: 400px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .map-container {
            height: 500px;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 2rem;
        }

        /* Alert System */
        .alerts-panel {
            max-height: 400px;
            overflow-y: auto;
        }

        .alert-item {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid;
            transition: all 0.3s ease;
        }

        .alert-item:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateX(5px);
        }

        .alert-high {
            border-left-color: #ff4757;
        }

        .alert-medium {
            border-left-color: #ffa726;
        }

        .alert-low {
            border-left-color: #66bb6a;
        }

        .alert-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .alert-severity {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .severity-high {
            background: rgba(255, 71, 87, 0.2);
            color: #ff4757;
        }

        .severity-medium {
            background: rgba(255, 167, 38, 0.2);
            color: #ffa726;
        }

        .severity-low {
            background: rgba(102, 187, 106, 0.2);
            color: #66bb6a;
        }

        /* Data Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 1rem;
        }

        .data-table th,
        .data-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .data-table th {
            background: rgba(0, 212, 255, 0.1);
            color: #00d4ff;
            font-weight: 600;
        }

        .data-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        /* Loading States */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            color: rgba(255, 255, 255, 0.7);
        }

        .spinner {
            animation: spin 1s linear infinite;
            margin-right: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Action Buttons */
        .btn {
            background: linear-gradient(45deg, #00d4ff, #0097a7);
            border: none;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 212, 255, 0.3);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
        }

        .btn-danger {
            background: linear-gradient(45deg, #ff4757, #c44569);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .dashboard-container {
                padding: 1rem;
            }

            .header-section {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .content-grid {
                grid-template-columns: 1fr;
            }

            .filter-panel {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .header-title h1 {
                font-size: 2rem;
            }
        }

        /* Correlation Heatmap */
        .heatmap-container {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 15px;
            padding: 1.5rem;
            min-height: 400px;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 212, 255, 0.5);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 212, 255, 0.7);
        }

        /* Animation classes */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header Section -->
        <div class="glass-panel">
            <div class="header-section">
                <div class="header-title">
                    <i class="fas fa-chart-line" style="color: #00d4ff; font-size: 2rem;"></i>
                    <h1>Historical Analysis</h1>
                </div>
                <div class="header-controls">
                    <button class="btn" onclick="triggerETLUpdate()">
                        <i class="fas fa-sync-alt"></i>
                        Update Data
                    </button>
                    <button class="btn btn-secondary" onclick="exportData()">
                        <i class="fas fa-download"></i>
                        Export
                    </button>
                </div>
            </div>

            <!-- Filter Panel -->
            <div class="filter-panel">
                <div class="filter-group">
                    <label class="filter-label">Date Range</label>
                    <input type="date" id="dateFrom" class="filter-input">
                </div>
                <div class="filter-group">
                    <label class="filter-label">To</label>
                    <input type="date" id="dateTo" class="filter-input">
                </div>
                <div class="filter-group">
                    <label class="filter-label">Countries</label>
                    <select id="countryFilter" class="filter-select" multiple>
                        <option value="">All Countries</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Categories</label>
                    <select id="categoryFilter" class="filter-select" multiple>
                        <option value="">All Categories</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Actions</label>
                    <button class="btn" onclick="applyFilters()" style="width: 100%;">
                        <i class="fas fa-filter"></i>
                        Apply Filters
                    </button>
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="glass-panel">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="stat-number" id="totalEvents">-</div>
                    <div class="stat-label">Total Events</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-number" id="recentEvents">-</div>
                    <div class="stat-label">Recent (7 days)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-globe"></i>
                    </div>
                    <div class="stat-number" id="countriesAffected">-</div>
                    <div class="stat-label">Countries Affected</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    <div class="stat-number" id="avgEventsPerDay">-</div>
                    <div class="stat-label">Avg Events/Day</div>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="glass-panel">
            <div class="tab-navigation">
                <button class="tab-button active" onclick="switchTab('events')">
                    <i class="fas fa-calendar-alt"></i>
                    Events
                </button>
                <button class="tab-button" onclick="switchTab('resources')">
                    <i class="fas fa-oil-can"></i>
                    Resources
                </button>
                <button class="tab-button" onclick="switchTab('risks')">
                    <i class="fas fa-shield-alt"></i>
                    Structural Risks
                </button>
                <button class="tab-button" onclick="switchTab('displacement')">
                    <i class="fas fa-people-arrows"></i>
                    Displacements
                </button>
                <button class="tab-button" onclick="switchTab('alerts')">
                    <i class="fas fa-bell"></i>
                    Alerts
                </button>
                <button class="tab-button" onclick="switchTab('correlations')">
                    <i class="fas fa-project-diagram"></i>
                    Correlations
                </button>
            </div>

            <!-- Events Tab -->
            <div id="eventsTab" class="content-area active">
                <div class="content-grid">
                    <div class="chart-container">
                        <h3 style="color: #00d4ff; margin-bottom: 1rem;">Event Timeline</h3>
                        <div id="eventsTimeChart"></div>
                    </div>
                    <div class="chart-container">
                        <h3 style="color: #00d4ff; margin-bottom: 1rem;">Category Breakdown</h3>
                        <div id="categoryChart"></div>
                    </div>
                </div>
                <div class="map-container" id="eventsMap"></div>
                <div class="glass-panel">
                    <h3 style="color: #00d4ff; margin-bottom: 1rem;">Recent Events</h3>
                    <div id="eventsTable"></div>
                </div>
            </div>

            <!-- Resources Tab -->
            <div id="resourcesTab" class="content-area">
                <div class="content-grid">
                    <div class="chart-container">
                        <h3 style="color: #00d4ff; margin-bottom: 1rem;">Energy Supply Trends</h3>
                        <div id="energyChart"></div>
                    </div>
                    <div class="chart-container">
                        <h3 style="color: #00d4ff; margin-bottom: 1rem;">Resource Distribution</h3>
                        <div id="resourceDistChart"></div>
                    </div>
                </div>
                <div class="map-container" id="resourcesMap"></div>
            </div>

            <!-- Risks Tab -->
            <div id="risksTab" class="content-area">
                <div class="content-grid">
                    <div class="chart-container">
                        <h3 style="color: #00d4ff; margin-bottom: 1rem;">Political Stability</h3>
                        <div id="stabilityChart"></div>
                    </div>
                    <div class="chart-container">
                        <h3 style="color: #00d4ff; margin-bottom: 1rem;">Governance Indicators</h3>
                        <div id="governanceChart"></div>
                    </div>
                </div>
                <div class="map-container" id="risksMap"></div>
            </div>

            <!-- Displacement Tab -->
            <div id="displacementTab" class="content-area">
                <div class="content-grid">
                    <div class="chart-container">
                        <h3 style="color: #00d4ff; margin-bottom: 1rem;">Displacement Trends</h3>
                        <div id="displacementChart"></div>
                    </div>
                    <div class="chart-container">
                        <h3 style="color: #00d4ff; margin-bottom: 1rem;">Population Movements</h3>
                        <div id="movementChart"></div>
                    </div>
                </div>
                <div class="map-container" id="displacementMap"></div>
            </div>

            <!-- Alerts Tab -->
            <div id="alertsTab" class="content-area">
                <div class="alerts-panel" id="alertsPanel">
                    <div class="loading">
                        <i class="fas fa-spinner spinner"></i>
                        Loading alerts...
                    </div>
                </div>
            </div>

            <!-- Correlations Tab -->
            <div id="correlationsTab" class="content-area">
                <div class="content-grid">
                    <div class="heatmap-container">
                        <h3 style="color: #00d4ff; margin-bottom: 1rem;">Correlation Heatmap</h3>
                        <div id="correlationHeatmap"></div>
                    </div>
                    <div class="chart-container">
                        <h3 style="color: #00d4ff; margin-bottom: 1rem;">Strong Correlations</h3>
                        <div id="correlationList"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentData = null;
        let maps = {};
        let charts = {};

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeDashboard();
            loadFilters();
            loadDashboardData();
        });

        // Initialize dashboard components
        function initializeDashboard() {
            // Set default date range (last 90 days)
            const today = new Date();
            const ninetyDaysAgo = new Date(today.getTime() - (90 * 24 * 60 * 60 * 1000));
            
            document.getElementById('dateTo').value = today.toISOString().split('T')[0];
            document.getElementById('dateFrom').value = ninetyDaysAgo.toISOString().split('T')[0];

            // Initialize maps for each tab
            initializeMaps();
        }

        // Initialize maps
        function initializeMaps() {
            const mapContainers = ['eventsMap', 'resourcesMap', 'risksMap', 'displacementMap'];
            
            mapContainers.forEach(mapId => {
                const map = L.map(mapId).setView([20, 0], 2);
                
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                    subdomains: 'abcd',
                    maxZoom: 19
                }).addTo(map);
                
                maps[mapId] = map;
            });
        }

        // Load filter options
        async function loadFilters() {
            try {
                const response = await fetch('/api/historical/filters');
                const result = await response.json();
                
                if (result.success) {
                    populateFilterSelects(result.data);
                }
            } catch (error) {
                console.error('Failed to load filters:', error);
            }
        }

        // Populate filter select elements
        function populateFilterSelects(filterData) {
            // Countries
            const countrySelect = document.getElementById('countryFilter');
            filterData.countries.forEach(country => {
                const option = document.createElement('option');
                option.value = country.iso3;
                option.textContent = country.country;
                countrySelect.appendChild(option);
            });

            // Categories
            const categorySelect = document.getElementById('categoryFilter');
            filterData.categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.category;
                option.textContent = category.category.charAt(0).toUpperCase() + category.category.slice(1);
                categorySelect.appendChild(option);
            });
        }

        // Load dashboard data
        async function loadDashboardData() {
            try {
                showLoading();
                
                const dateFrom = document.getElementById('dateFrom').value;
                const dateTo = document.getElementById('dateTo').value;
                const countries = Array.from(document.getElementById('countryFilter').selectedOptions).map(o => o.value);
                const categories = Array.from(document.getElementById('categoryFilter').selectedOptions).map(o => o.value);

                const params = new URLSearchParams();
                if (dateFrom) params.append('date_from', dateFrom);
                if (dateTo) params.append('date_to', dateTo);
                countries.forEach(c => params.append('countries', c));
                categories.forEach(c => params.append('categories', c));

                const response = await fetch(`/api/historical/dashboard?${params}`);
                const result = await response.json();
                
                if (result.success) {
                    currentData = result.data;
                    updateDashboard(result.data);
                } else {
                    showError('Failed to load dashboard data: ' + result.message);
                }
            } catch (error) {
                showError('Network error: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // Update dashboard with new data
        function updateDashboard(data) {
            updateStatistics(data.summary_stats);
            updateEventsTab(data);
            updateResourcesTab(data);
            updateRisksTab(data);
            updateDisplacementTab(data);
            updateAlertsTab(data.alerts);
            updateCorrelationsTab();
        }

        // Update statistics cards
        function updateStatistics(stats) {
            document.getElementById('totalEvents').textContent = stats.total_events.toLocaleString();
            document.getElementById('recentEvents').textContent = stats.recent_events.toLocaleString();
            document.getElementById('countriesAffected').textContent = stats.countries_affected.toLocaleString();
            document.getElementById('avgEventsPerDay').textContent = stats.avg_events_per_day;
        }

        // Update events tab
        function updateEventsTab(data) {
            // Events timeline chart
            const timelineData = [];
            Object.keys(data.time_series).forEach(category => {
                const series = data.time_series[category];
                timelineData.push({
                    x: series.dates,
                    y: series.counts,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: category.charAt(0).toUpperCase() + category.slice(1),
                    line: { width: 3 }
                });
            });

            Plotly.newPlot('eventsTimeChart', timelineData, {
                title: '',
                paper_bgcolor: 'transparent',
                plot_bgcolor: 'transparent',
                font: { color: '#ffffff' },
                xaxis: { 
                    gridcolor: 'rgba(255,255,255,0.1)',
                    zerolinecolor: 'rgba(255,255,255,0.1)'
                },
                yaxis: { 
                    gridcolor: 'rgba(255,255,255,0.1)',
                    zerolinecolor: 'rgba(255,255,255,0.1)'
                }
            });

            // Category breakdown pie chart
            const categoryData = [{
                values: data.category_breakdown.map(c => c.count),
                labels: data.category_breakdown.map(c => c.category),
                type: 'pie',
                textinfo: 'label+percent',
                textposition: 'outside',
                marker: {
                    colors: ['#00d4ff', '#0097a7', '#00695c', '#004d40', '#26a69a']
                }
            }];

            Plotly.newPlot('categoryChart', categoryData, {
                paper_bgcolor: 'transparent',
                plot_bgcolor: 'transparent',
                font: { color: '#ffffff' }
            });

            // Update events map
            updateEventsMap(data.geographic_data);

            // Update events table
            updateEventsTable(data.recent_events);
        }

        // Update events map
        function updateEventsMap(geoData) {
            const map = maps['eventsMap'];
            
            // Clear existing markers
            map.eachLayer(layer => {
                if (layer instanceof L.Marker) {
                    map.removeLayer(layer);
                }
            });

            // Add new markers
            geoData.forEach(location => {
                if (location.avg_lat && location.avg_lon) {
                    const marker = L.marker([location.avg_lat, location.avg_lon])
                        .bindPopup(`
                            <strong>${location.country}</strong><br>
                            Category: ${location.category}<br>
                            Events: ${location.event_count}<br>
                            Last Activity: ${location.last_activity}
                        `);
                    marker.addTo(map);
                }
            });
        }

        // Update events table
        function updateEventsTable(events) {
            const container = document.getElementById('eventsTable');
            
            if (events.length === 0) {
                container.innerHTML = '<p style="color: rgba(255,255,255,0.7);">No events found for the selected criteria.</p>';
                return;
            }

            let tableHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Country</th>
                            <th>Category</th>
                            <th>Indicator</th>
                            <th>Value</th>
                            <th>Source</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            events.slice(0, 20).forEach(event => {
                tableHTML += `
                    <tr>
                        <td>${event.date}</td>
                        <td>${event.country || 'Unknown'}</td>
                        <td>${event.category}</td>
                        <td>${event.indicator}</td>
                        <td>${typeof event.value === 'number' ? event.value.toLocaleString() : event.value}</td>
                        <td>${event.source}</td>
                    </tr>
                `;
            });

            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
        }

        // Update resources tab
        function updateResourcesTab(data) {
            // Filter resource data
            const resourceData = data.recent_events.filter(e => e.category === 'energy');
            
            if (resourceData.length > 0) {
                // Energy trends chart
                const energyByDate = {};
                resourceData.forEach(event => {
                    if (!energyByDate[event.date]) {
                        energyByDate[event.date] = 0;
                    }
                    energyByDate[event.date] += event.value || 0;
                });

                const energyChartData = [{
                    x: Object.keys(energyByDate),
                    y: Object.values(energyByDate),
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Energy Supply',
                    line: { color: '#00d4ff', width: 3 }
                }];

                Plotly.newPlot('energyChart', energyChartData, {
                    paper_bgcolor: 'transparent',
                    plot_bgcolor: 'transparent',
                    font: { color: '#ffffff' },
                    xaxis: { gridcolor: 'rgba(255,255,255,0.1)' },
                    yaxis: { gridcolor: 'rgba(255,255,255,0.1)' }
                });
            }
        }

        // Update risks tab
        function updateRisksTab(data) {
            // Filter risk data
            const riskData = data.recent_events.filter(e => 
                e.category === 'governance' || e.indicator.includes('stability')
            );
            
            if (riskData.length > 0) {
                // Stability chart
                const stabilityByCountry = {};
                riskData.forEach(event => {
                    if (event.indicator.includes('stability')) {
                        stabilityByCountry[event.country] = event.value;
                    }
                });

                const stabilityChartData = [{
                    x: Object.keys(stabilityByCountry),
                    y: Object.values(stabilityByCountry),
                    type: 'bar',
                    marker: { color: '#00d4ff' }
                }];

                Plotly.newPlot('stabilityChart', stabilityChartData, {
                    paper_bgcolor: 'transparent',
                    plot_bgcolor: 'transparent',
                    font: { color: '#ffffff' },
                    xaxis: { gridcolor: 'rgba(255,255,255,0.1)' },
                    yaxis: { gridcolor: 'rgba(255,255,255,0.1)' }
                });
            }
        }

        // Update displacement tab
        function updateDisplacementTab(data) {
            // Filter displacement data
            const displacementData = data.recent_events.filter(e => e.category === 'displacement');
            
            if (displacementData.length > 0) {
                // Displacement trends
                const displacementByDate = {};
                displacementData.forEach(event => {
                    if (!displacementByDate[event.date]) {
                        displacementByDate[event.date] = 0;
                    }
                    displacementByDate[event.date] += event.value || 0;
                });

                const displacementChartData = [{
                    x: Object.keys(displacementByDate),
                    y: Object.values(displacementByDate),
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Displaced Population',
                    line: { color: '#ffa726', width: 3 }
                }];

                Plotly.newPlot('displacementChart', displacementChartData, {
                    paper_bgcolor: 'transparent',
                    plot_bgcolor: 'transparent',
                    font: { color: '#ffffff' },
                    xaxis: { gridcolor: 'rgba(255,255,255,0.1)' },
                    yaxis: { gridcolor: 'rgba(255,255,255,0.1)' }
                });
            }
        }

        // Update alerts tab
        function updateAlertsTab(alerts) {
            const container = document.getElementById('alertsPanel');
            
            if (!alerts || alerts.length === 0) {
                container.innerHTML = '<p style="color: rgba(255,255,255,0.7); text-align: center; padding: 2rem;">No active alerts</p>';
                return;
            }

            let alertsHTML = '';
            alerts.forEach(alert => {
                alertsHTML += `
                    <div class="alert-item alert-${alert.severity}">
                        <div class="alert-header">
                            <div>
                                <strong>${alert.country}</strong>
                                <span class="alert-severity severity-${alert.severity}">${alert.severity}</span>
                            </div>
                            <small>${new Date(alert.timestamp).toLocaleDateString()}</small>
                        </div>
                        <p>${alert.message}</p>
                    </div>
                `;
            });

            container.innerHTML = alertsHTML;
        }

        // Update correlations tab
        async function updateCorrelationsTab() {
            try {
                const indicators = ['political_stability', 'violence_events', 'energy_supply', 'displacement'];
                
                const response = await fetch('/api/historical/correlation', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ indicators, time_window: 90 })
                });

                const result = await response.json();
                
                if (result.success && result.data.correlations) {
                    displayCorrelationHeatmap(result.data.correlations, indicators);
                    displayStrongCorrelations(result.data.strong_correlations);
                }
            } catch (error) {
                console.error('Failed to load correlation data:', error);
            }
        }

        // Display correlation heatmap
        function displayCorrelationHeatmap(correlations, indicators) {
            const z = [];
            const x = indicators;
            const y = indicators;

            indicators.forEach(ind1 => {
                const row = [];
                indicators.forEach(ind2 => {
                    row.push(correlations[ind1] ? correlations[ind1][ind2] || 0 : 0);
                });
                z.push(row);
            });

            const data = [{
                z: z,
                x: x,
                y: y,
                type: 'heatmap',
                colorscale: [
                    [0, '#000051'],
                    [0.5, '#00d4ff'],
                    [1, '#ffffff']
                ]
            }];

            Plotly.newPlot('correlationHeatmap', data, {
                paper_bgcolor: 'transparent',
                plot_bgcolor: 'transparent',
                font: { color: '#ffffff' }
            });
        }

        // Display strong correlations
        function displayStrongCorrelations(strongCorrelations) {
            const container = document.getElementById('correlationList');
            
            if (!strongCorrelations || strongCorrelations.length === 0) {
                container.innerHTML = '<p style="color: rgba(255,255,255,0.7);">No strong correlations found</p>';
                return;
            }

            let html = '<div style="padding: 1rem;">';
            strongCorrelations.forEach(corr => {
                const strength = corr.strength === 'strong' ? 'high' : 'medium';
                html += `
                    <div class="alert-item alert-${strength}" style="margin-bottom: 1rem;">
                        <strong>${corr.indicator1}</strong> ↔ <strong>${corr.indicator2}</strong>
                        <br>
                        <span style="color: #00d4ff;">Correlation: ${corr.correlation}</span>
                        <span class="alert-severity severity-${strength}">${corr.strength}</span>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }

        // Tab switching
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Update content areas
            document.querySelectorAll('.content-area').forEach(area => area.classList.remove('active'));
            document.getElementById(tabName + 'Tab').classList.add('active');

            // Refresh map if switching to a map tab
            if (maps[tabName + 'Map']) {
                setTimeout(() => {
                    maps[tabName + 'Map'].invalidateSize();
                }, 100);
            }
        }

        // Apply filters
        function applyFilters() {
            loadDashboardData();
        }

        // Trigger ETL update
        async function triggerETLUpdate() {
            try {
                showLoading();
                
                const response = await fetch('/api/historical/etl/trigger', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ force_refresh: true })
                });

                const result = await response.json();
                
                if (result.success) {
                    showSuccess('Data updated successfully!');
                    loadDashboardData();
                } else {
                    showError('Failed to update data: ' + result.message);
                }
            } catch (error) {
                showError('Network error: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // Export data
        function exportData() {
            if (!currentData) {
                showError('No data to export');
                return;
            }

            const dataStr = JSON.stringify(currentData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `historical_analysis_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        // Utility functions
        function showLoading() {
            document.body.style.cursor = 'wait';
        }

        function hideLoading() {
            document.body.style.cursor = 'default';
        }

        function showError(message) {
            alert('Error: ' + message);
        }

        function showSuccess(message) {
            alert('Success: ' + message);
        }
    </script>
</body>
</html>
