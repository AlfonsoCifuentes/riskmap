{% extends "base_navigation.html" %}

{% block title %}An√°lisis de Noticias - Stratosight{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/article_cards.css') }}">
<style>
    :root {
        --bg-primary: linear-gradient(180deg, #0a0f2c 0%, #1a2040 40%, #2a3558 80%, #3a4a70 100%);
        --bg-secondary: #141824;
        --text-primary: #e8eaed;
        --text-secondary: #b0b8c4;
        --accent-cyan: #00d4ff;
        --accent-glow: 0 0 15px rgba(0, 212, 255, 0.4), 0 0 25px rgba(0, 212, 255, 0.2);
        --border-color: rgba(255, 255, 255, 0.1);
    }

    html, body {
        margin: 0;
        padding: 0;
        min-height: 100vh;
        background: #1a237e;
        color: var(--text-primary);
        font-family: 'Inter', sans-serif;
        position: relative;
    }

    /* News Analysis Dashboard Styles - Responsive y Mobile-First */
    .news-dashboard {
        padding: 0;
        max-width: none;
        margin: 0;
        position: relative;
        z-index: 1;
        display: flex;
        flex-direction: column;
        min-height: calc(100vh - 80px);
        background: rgba(10, 15, 44, 0.08);
        backdrop-filter: blur(2px);
        gap: 0;
        width: 100vw;
    }
    
    .dashboard-content {
        max-width: 96%;
        margin: 0 auto !important;
        margin-top: 0 !important;
        padding: 0 20px;
        width: 100%;
        box-sizing: border-box;
    }
    
    /* Header and Stats Container */
    .header-stats-container {
        width: 100vw;
        position: relative;
        left: 50%;
        right: 50%;
        margin-left: -50vw;
        margin-right: -50vw;
        margin-bottom: 0;
        top: -80px;
        z-index: 0;
        background: transparent;
        border-radius: 0;
    }
    
    .page-header {
        text-align: center;
        margin: 0;
        color: #fff;
        padding: 180px 0 100px 0;
        width: 100%;
        position: relative;
        background: linear-gradient(135deg, rgba(26, 32, 64, 0.75) 0%, rgba(16, 24, 48, 0.8) 50%, rgba(20, 28, 56, 0.75) 100%);
        backdrop-filter: blur(10px);
        box-shadow: 0 2px 20px rgba(0, 0, 0, 0.3);
    }
    
    .page-title {
        font-family: 'Orbitron', monospace;
        font-size: clamp(1.5rem, 6vw, 4rem);
        font-weight: 700;
        margin-bottom: 10px;
        background: linear-gradient(135deg, #00d4ff 0%, #00a3cc 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        width: 75%;
        margin-left: auto;
        margin-right: auto;
        line-height: 1.2;
        word-wrap: break-word;
        hyphens: auto;
    }
    
    .page-subtitle {
        font-size: 1rem;
        color: rgba(255, 255, 255, 0.7);
        margin-bottom: 20px;
    }

    /* Stats Cards - Responsive Grid */
    .news-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 0;
        margin: 0;
        width: 100%;
        position: relative;
    }
    
    .news-stat-card {
        background: transparent;
        border: none;
        border-radius: 0;
        padding: 20px;
        text-align: center;
        transition: all 0.3s ease;
        backdrop-filter: blur(3px);
        box-shadow: none;
        border-right: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .news-stat-card:last-child {
        border-right: none;
    }
    
    .news-stat-card:nth-child(1) {
        background: linear-gradient(135deg, rgba(0, 119, 255, 0.4) 0%, rgba(30, 144, 255, 0.35) 100%);
    }
    
    .news-stat-card:nth-child(2) {
        background: linear-gradient(135deg, rgba(220, 38, 38, 0.45) 0%, rgba(239, 68, 68, 0.4) 100%);
    }
    
    .news-stat-card:nth-child(3) {
        background: linear-gradient(135deg, rgba(70, 234, 215, 0.4) 0%, rgba(45, 212, 191, 0.35) 100%);
    }
    
    .news-stat-card:nth-child(4) {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.4) 0%, rgba(37, 99, 235, 0.35) 100%);
    }
    
    .news-stat-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    }
    
    .news-stat-card:nth-child(1):hover {
        background: linear-gradient(135deg, rgba(0, 119, 255, 0.6) 0%, rgba(30, 144, 255, 0.5) 100%);
    }
    
    .news-stat-card:nth-child(2):hover {
        background: linear-gradient(135deg, rgba(220, 38, 38, 0.65) 0%, rgba(239, 68, 68, 0.55) 100%);
    }
    
    .news-stat-card:nth-child(3):hover {
        background: linear-gradient(135deg, rgba(70, 234, 215, 0.6) 0%, rgba(45, 212, 191, 0.5) 100%);
    }
    
    .news-stat-card:nth-child(4):hover {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.6) 0%, rgba(37, 99, 235, 0.5) 100%);
    }
    
    .stat-icon {
        width: 50px;
        height: 50px;
        margin: 0 auto 15px;
        background: linear-gradient(135deg, #00d4ff 0%, #00a3cc 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.3rem;
        color: #fff;
    }
    
    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: #fff;
        margin-bottom: 5px;
        font-family: 'Orbitron', monospace;
    }
    
    .stat-label {
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    /* Section styling - Mobile-First */
    .news-section {
        background: rgba(26, 32, 64, 0.7);
        border: 1px solid rgba(70, 234, 215, 0.3);
        border-radius: 12px;
        padding: 20px;
        backdrop-filter: blur(15px);
        margin-bottom: 25px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }
    
    .section-header {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--border-color);
        gap: 15px;
    }
    
    .section-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #fff;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .section-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: center;
    }
    
    .btn-control {
        flex: 1 1 auto;
        max-width: 140px;
        min-width: 80px;
        text-align: center;
        padding: 8px 12px;
        font-size: 0.8rem;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
        border: 1px solid rgba(255, 255, 255, 0.2);
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .btn-control:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateY(-2px);
    }

    .btn-control.active {
        background: rgba(70, 234, 215, 0.3);
        border-color: rgba(70, 234, 215, 0.5);
        color: #fff;
    }

    /* High Risk Articles Grid - Responsive */
    .high-risk-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .high-risk-card {
        background: linear-gradient(145deg, rgba(239, 68, 68, 0.15), rgba(220, 38, 38, 0.08));
        border: 1px solid rgba(239, 68, 68, 0.4);
        border-radius: 12px;
        padding: 15px;
        transition: all 0.3s ease;
        backdrop-filter: blur(15px);
    }
    
    .high-risk-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(239, 68, 68, 0.3);
        border-color: rgba(239, 68, 68, 0.5);
    }
    
    .high-risk-title {
        font-size: 1rem;
        font-weight: 600;
        color: #fff;
        margin-bottom: 8px;
        line-height: 1.3;
    }
    
    .high-risk-description {
        color: rgba(255, 255, 255, 0.8);
        font-size: 0.85rem;
        line-height: 1.5;
        margin-bottom: 12px;
    }
    
    .high-risk-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.75rem;
        flex-wrap: wrap;
        gap: 8px;
    }
    
    .high-risk-location {
        color: rgba(255, 255, 255, 0.6);
        display: flex;
        align-items: center;
        gap: 4px;
    }
    
    .high-risk-badge {
        background: rgba(239, 68, 68, 0.2);
        color: #ef4444;
        padding: 3px 6px;
        border-radius: 4px;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.65rem;
    }

    /* Latest Articles - Full width cards - Mobile-First */
    .latest-articles-grid {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    
    .latest-article-card {
        background: rgba(26, 32, 64, 0.7);
        border: 1px solid rgba(70, 234, 215, 0.25);
        border-radius: 12px;
        padding: 15px;
        transition: all 0.3s ease;
        backdrop-filter: blur(15px);
        display: flex;
        flex-direction: column;
        gap: 12px;
        box-shadow: 0 2px 15px rgba(0, 0, 0, 0.2);
    }
    
    .latest-article-card:hover {
        background: rgba(26, 32, 64, 0.85);
        border-color: rgba(70, 234, 215, 0.4);
        transform: translateY(-2px);
    }
    
    .latest-article-content {
        flex: 1;
    }
    
    .latest-article-title {
        font-size: 1rem;
        font-weight: 600;
        color: #fff;
        margin-bottom: 6px;
        line-height: 1.3;
    }
    
    .latest-article-description {
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.85rem;
        line-height: 1.5;
        margin-bottom: 8px;
    }
    
    .latest-article-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.6);
    }
    
    .latest-article-meta-item {
        display: flex;
        align-items: center;
        gap: 4px;
    }
    
    .latest-article-sidebar {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 8px;
    }
    
    .latest-risk-badge {
        padding: 3px 6px;
        border-radius: 4px;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.65rem;
    }
    
    .latest-risk-badge.high {
        background: rgba(239, 68, 68, 0.2);
        color: #ef4444;
    }
    
    .latest-risk-badge.medium {
        background: rgba(245, 158, 11, 0.2);
        color: #f59e0b;
    }
    
    .latest-risk-badge.low {
        background: rgba(34, 197, 94, 0.2);
        color: #22c55e;
    }

    /* News Mosaic Section - Dynamic Collage Layout */
    .news-mosaic-section {
        width: 100vw;
        position: relative;
        left: 50%;
        right: 50%;
        margin-left: -50vw;
        margin-right: -50vw;
        margin-top: 0;
        padding: 0;
        background: transparent;
        z-index: 1;
        margin-top: 0 !important;
    }

    .mosaic-controls-container {
        width: 100%;
        padding: 20px;
        background: rgba(10, 15, 44, 0.5);
        backdrop-filter: blur(5px);
        z-index: 5;
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
        left: 50%;
        right: 50%;
        margin-left: -50vw;
        margin-right: -50vw;
        width: 100vw;
        box-sizing: border-box;
    }
    
    .mosaic-controls {
        display: flex;
        gap: 15px;
        justify-content: center;
    }
    
    .news-mosaic-container {
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        grid-auto-rows: calc(16.666vw / 1.2);
        gap: 0;
        grid-auto-flow: dense;
        width: 100vw;
        min-height: 100vh;
        background: rgba(0, 0, 0, 0.1);
        padding: 0;
    }

    /* Load More Button Container */
    .load-more-container {
        width: 100vw;
        position: relative;
        left: 50%;
        right: 50%;
        margin-left: -50vw;
        margin-right: -50vw;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 30px 0;
        background: rgba(10, 15, 44, 0.3);
        backdrop-filter: blur(5px);
    }

    .load-more-btn {
        width: 66.666%;
        max-width: 800px;
        padding: 15px 30px;
        background: linear-gradient(135deg, rgba(70, 234, 215, 0.2) 0%, rgba(70, 234, 215, 0.4) 100%);
        border: 2px solid rgba(70, 234, 215, 0.5);
        color: #46ead7;
        font-size: 1.1rem;
        font-weight: 600;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 1px;
        backdrop-filter: blur(15px);
        box-shadow: 0 4px 20px rgba(70, 234, 215, 0.2);
    }

    .load-more-btn:hover {
        background: linear-gradient(135deg, rgba(70, 234, 215, 0.4) 0%, rgba(70, 234, 215, 0.6) 100%);
        border-color: rgba(70, 234, 215, 0.8);
        transform: translateY(-2px);
        box-shadow: 0 8px 30px rgba(70, 234, 215, 0.3);
        color: #fff;
    }

    .load-more-btn:active {
        transform: translateY(0);
    }
    
    /* Mosaic Article Tiles - Irregular Sizes */
    .mosaic-article {
        position: relative;
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        border: 1px solid #0a0f2c;
        box-sizing: border-box;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(2px);
    }
    
    .mosaic-article::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
            135deg,
            rgba(0, 0, 0, 0.2) 0%,
            rgba(0, 0, 0, 0.1) 40%,
            rgba(0, 0, 0, 0.5) 100%
        );
        border-radius: 0;
        z-index: 1;
    }
    
    .mosaic-article:hover {
        transform: scale(1.02);
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.5);
        z-index: 5;
        border: 1px solid var(--accent-cyan);
    }
    
    .mosaic-article:hover::before {
        background: linear-gradient(
            135deg,
            rgba(0, 0, 0, 0.1) 0%,
            rgba(0, 0, 0, 0.05) 40%,
            rgba(0, 0, 0, 0.4) 100%
        );
    }
    
    /* Irregular size variants based on importance score - 6-column grid */
    .mosaic-article.size-1 { grid-column: span 3; grid-row: span 2; } /* Hero article - half width */
    .mosaic-article.size-2 { grid-column: span 2; grid-row: span 2; } /* Large vertical */
    .mosaic-article.size-3 { grid-column: span 1; grid-row: span 2; } /* Tall thin */
    .mosaic-article.size-4 { grid-column: span 2; grid-row: span 1; } /* Wide horizontal */
    .mosaic-article.size-5 { grid-column: span 1; grid-row: span 1; } /* Small square */
    .mosaic-article.size-6 { grid-column: span 1; grid-row: span 1; } /* Small square */
    .mosaic-article.size-7 { grid-column: span 1; grid-row: span 1; } /* Small square */
    .mosaic-article.size-8 { grid-column: span 2; grid-row: span 1; } /* Wide horizontal */
    .mosaic-article.size-9 { grid-column: span 1; grid-row: span 2; } /* Tall thin */
    .mosaic-article.size-10 { grid-column: span 1; grid-row: span 1; } /* Small square */
    .mosaic-article.size-11 { grid-column: span 1; grid-row: span 1; } /* Small square */
    .mosaic-article.size-12 { grid-column: span 1; grid-row: span 1; } /* Small square */
    .mosaic-article.size-13 { grid-column: span 3; grid-row: span 1; } /* Extra wide */
    .mosaic-article.size-14 { grid-column: span 1; grid-row: span 2; } /* Tall thin */
    .mosaic-article.size-15 { grid-column: span 2; grid-row: span 1; } /* Wide horizontal */
    .mosaic-article.size-16 { grid-column: span 1; grid-row: span 1; } /* Small square */
    .mosaic-article.size-17 { grid-column: span 1; grid-row: span 1; } /* Small square */
    .mosaic-article.size-18 { grid-column: span 1; grid-row: span 1; } /* Small square */

    /* Fallback sizes for additional articles */
    .mosaic-article.size-default-lg-wide { grid-column: span 3; grid-row: span 1; }
    .mosaic-article.size-default-lg-tall { grid-column: span 1; grid-row: span 2; }
    .mosaic-article.size-default-md-wide { grid-column: span 2; grid-row: span 1; }
    .mosaic-article.size-default-md-sq { grid-column: span 1; grid-row: span 1; }
    
    /* Article content overlay with fixed padding */
    .mosaic-content {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 15px;
        z-index: 2;
        color: white;
        background: linear-gradient(
            transparent 0%,
            rgba(0, 0, 0, 0.3) 20%,
            rgba(0, 0, 0, 0.7) 70%,
            rgba(0, 0, 0, 0.9) 100%
        );
        border-radius: 0;
        min-height: 80px;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
    }
    
    .mosaic-title {
        font-size: 1.1rem;
        font-weight: 600;
        line-height: 1.3;
        margin: 0 0 8px 0;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
        display: -webkit-box;
        -webkit-line-clamp: 3;
        line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .mosaic-article.size-1 .mosaic-title {
        font-size: 1.6rem;
        -webkit-line-clamp: 4;
        line-clamp: 4;
    }
    .mosaic-article.size-2 .mosaic-title {
        font-size: 1.2rem;
        -webkit-line-clamp: 3;
        line-clamp: 3;
    }
    
    .mosaic-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: auto;
    }
    
    .mosaic-location {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.9);
        background: rgba(0, 0, 0, 0.4);
        padding: 6px 10px;
        border-radius: 15px;
        backdrop-filter: blur(8px);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .mosaic-risk-badge {
        font-size: 0.65rem;
        font-weight: 700;
        padding: 6px 10px;
        border-radius: 15px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        text-shadow: none;
        backdrop-filter: blur(8px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .mosaic-risk-badge.hero {
        background: linear-gradient(135deg, #dc2626, #ef4444);
        color: white;
        font-size: 0.8rem;
        padding: 8px 12px;
        box-shadow: 0 4px 15px rgba(220, 38, 38, 0.4);
    }
    
    .mosaic-risk-badge.high {
        background: rgba(220, 38, 38, 0.9);
        color: white;
        box-shadow: 0 2px 10px rgba(220, 38, 38, 0.3);
    }
    
    .mosaic-risk-badge.medium {
        background: rgba(245, 158, 11, 0.9);
        color: white;
        box-shadow: 0 2px 10px rgba(245, 158, 11, 0.3);
    }
    
    .mosaic-risk-badge.low {
        background: rgba(34, 197, 94, 0.9);
        color: white;
        box-shadow: 0 2px 10px rgba(34, 197, 94, 0.3);
    }

    /* Filler articles styling */
    .mosaic-article.filler-article {
        opacity: 0.85;
    }
    
    .mosaic-article.filler-article::before {
        background: linear-gradient(
            135deg,
            rgba(0, 0, 0, 0.3) 0%,
            rgba(0, 0, 0, 0.2) 40%,
            rgba(0, 0, 0, 0.6) 100%
        );
    }
    
    .mosaic-article.filler-article:hover {
        opacity: 1;
        transform: scale(1.01); /* Slightly less dramatic hover for filler */
    }

    /* Loading state */
    .mosaic-loading {
        grid-column: 1 / -1;
        grid-row: 1 / -1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: rgba(255, 255, 255, 0.7);
        font-size: 1.2rem;
    }
    
    .mosaic-loading i {
        font-size: 2rem;
        margin-bottom: 15px;
        color: #46ead7;
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
        .news-mosaic-container {
            grid-template-columns: repeat(4, 1fr);
            grid-auto-rows: calc(25vw / 1.2);
        }
        
        .mosaic-article.size-1 { grid-column: span 2; grid-row: span 2; }
        .mosaic-article.size-2 { grid-column: span 2; grid-row: span 1; }
        .mosaic-article.size-13 { grid-column: span 2; grid-row: span 1; }
        .mosaic-article.size-default-lg-wide { grid-column: span 2; grid-row: span 1; }
    }

    @media (max-width: 768px) {
        .news-mosaic-container {
            grid-template-columns: repeat(3, 1fr);
            grid-auto-rows: calc(33.333vw / 1.2);
        }
        
        .mosaic-article.size-1 { grid-column: span 3; grid-row: span 1; }
        .mosaic-article.size-2 { grid-column: span 2; grid-row: span 1; }
        .mosaic-article.size-7 { grid-column: span 2; grid-row: span 1; }
        .mosaic-article.size-8 { grid-column: span 2; grid-row: span 1; }
        .mosaic-article.size-12 { grid-column: span 2; grid-row: span 1; }
        .mosaic-article.size-13 { grid-column: span 3; grid-row: span 1; }
        .mosaic-article.size-15 { grid-column: span 2; grid-row: span 1; }
        .mosaic-article.size-default-lg-wide { grid-column: span 2; grid-row: span 1; }
        .mosaic-article.size-default-md-wide { grid-column: span 2; grid-row: span 1; }
        
        .load-more-btn {
            width: 85%;
            font-size: 1rem;
        }
    }

    @media (max-width: 480px) {
        .news-mosaic-container {
            grid-template-columns: repeat(2, 1fr);
            grid-auto-rows: 50vw;
        }
        
        .mosaic-article { grid-column: span 1; grid-row: span 1; }
        .mosaic-article.size-1 { grid-column: span 2; grid-row: span 1; }
        .mosaic-article.size-7 { grid-column: span 2; grid-row: span 1; }
        .mosaic-article.size-8 { grid-column: span 2; grid-row: span 1; }
        .mosaic-article.size-12 { grid-column: span 2; grid-row: span 1; }
        .mosaic-article.size-13 { grid-column: span 2; grid-row: span 1; }
        .mosaic-article.size-15 { grid-column: span 2; grid-row: span 1; }
        
        .load-more-btn {
            width: 90%;
            font-size: 0.9rem;
            padding: 12px 20px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="news-dashboard">
    <!-- Header and Stats Section -->
    <div class="header-stats-container">
        <div class="page-header">
            <h1 class="page-title">An√°lisis Estrat√©gico de Noticias</h1>
            <p class="page-subtitle">Monitoreo en tiempo real de riesgos y amenazas globales</p>
            
            <!-- Statistics Cards -->
            <div class="news-stats" id="newsStats">
                <div class="news-stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-newspaper"></i>
                    </div>
                    <div class="stat-value" id="totalArticles">-</div>
                    <div class="stat-label">Total Art√≠culos</div>
                </div>
                <div class="news-stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="stat-value" id="highRiskArticles">-</div>
                    <div class="stat-label">Alto Riesgo</div>
                </div>
                <div class="news-stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-globe"></i>
                    </div>
                    <div class="stat-value" id="countriesCount">-</div>
                    <div class="stat-label">Pa√≠ses</div>
                </div>
                <div class="news-stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-value" id="lastUpdate">-</div>
                    <div class="stat-label">√öltima Actualizaci√≥n</div>
                </div>
            </div>
        </div>
    </div>

    <div class="dashboard-content">
        <!-- News Mosaic Section -->
        <div class="news-mosaic-section">
            <div class="mosaic-controls-container">
                <div class="mosaic-controls">
                    <button class="btn-control active" data-filter="all">
                        <i class="fas fa-th"></i> Todos
                    </button>
                    <button class="btn-control" data-filter="high">
                        <i class="fas fa-exclamation-triangle"></i> Alto Riesgo
                    </button>
                    <button class="btn-control" data-filter="medium">
                        <i class="fas fa-exclamation-circle"></i> Medio Riesgo
                    </button>
                    <button class="btn-control" data-filter="recent">
                        <i class="fas fa-clock"></i> Recientes
                    </button>
                </div>
            </div>
            
            <div class="news-mosaic-container" id="newsMosaic">
                <div class="mosaic-loading">
                    <i class="fas fa-spinner fa-spin"></i>
                    <div>Cargando noticias...</div>
                </div>
            </div>
            
            <!-- Load More Button -->
            <div class="load-more-container">
                <button class="load-more-btn" id="loadMoreBtn">
                    <i class="fas fa-plus"></i> Cargar M√°s Noticias
                </button>
            </div>
        </div>

        <!-- Map Section - Enhanced -->
        <div class="map-section-enhanced">
            <div class="section-header">
                <h3 class="section-title">
                    <i class="fas fa-map-marked-alt"></i>
                    Mapas de An√°lisis Geopol√≠tico
                </h3>
                <div class="section-controls">
                    <button class="btn-control active" data-map-type="general">
                        <i class="fas fa-globe"></i> General
                    </button>
                    <button class="btn-control" data-map-type="conflict_risk">
                        <i class="fas fa-exclamation-triangle"></i> Riesgo Conflicto
                    </button>
                    <button class="btn-control" data-map-type="historical_conflicts">
                        <i class="fas fa-history"></i> Conflictos Hist√≥ricos
                    </button>
                    <button class="btn-control" data-map-type="oil">
                        <i class="fas fa-oil-can"></i> Petr√≥leo
                    </button>
                    <button class="btn-control" data-map-type="energy">
                        <i class="fas fa-bolt"></i> Energ√≠a
                    </button>
                    <button class="btn-control" data-map-type="supplies">
                        <i class="fas fa-shipping-fast"></i> Suministros
                    </button>
                    <button class="btn-control" data-map-type="internet_cables">
                        <i class="fas fa-network-wired"></i> Internet
                    </button>
                    <button class="btn-control" data-map-type="military_bases">
                        <i class="fas fa-shield-alt"></i> Militar
                    </button>
                    <button class="btn-control" data-map-type="trade_routes">
                        <i class="fas fa-route"></i> Comercio
                    </button>
                </div>
            </div>
            <div class="section-body">
                <div id="map" class="h-96 rounded-lg bg-gray-800/50 border border-gray-700/50"></div>
            </div>
            <div class="map-container" id="main-map">
                <i class="fas fa-map" style="font-size: 3rem; opacity: 0.3;"></i>
                <p style="margin-top: 1rem; opacity: 0.6;">Mapa de calor cargando...</p>
            </div>
        </div>

        <!-- Enhanced AI Analysis Section -->
        <div id="aiArticleContent" class="news-section">
            <div class="section-header">
                <h3 class="section-title">
                    <i class="fas fa-newspaper"></i>
                    La actualidad geopol√≠tica vista por la IA
                </h3>
                <div class="section-controls">
                    <button class="btn-control" id="refreshAIAnalysis">
                        <i class="fas fa-sync-alt"></i> Actualizar An√°lisis
                    </button>
                    <button class="btn-control" id="generateAIReport">
                        <i class="fas fa-file-download"></i> Exportar Art√≠culo
                    </button>
                </div>
            </div>
            <div class="section-body">
                <div id="aiAnalysisContent" class="ai-article-container">
                    <div class="ai-loading-state">
                        <i class="fas fa-edit" style="font-size: 2rem; margin-bottom: 15px; opacity: 0.6; color: #46ead7;"></i>
                        <h4 style="margin-bottom: 10px; color: #fff;">Generando an√°lisis geopol√≠tico...</h4>
                        <p style="color: rgba(255,255,255,0.7); font-size: 0.9rem;">Nuestro periodista de IA est√° preparando un resumen exhaustivo de la actualidad mundial</p>
                        <div class="loading-spinner" style="margin-top: 20px;">
                            <i class="fas fa-spinner fa-spin" style="color: #46ead7; font-size: 1.5rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analytics Charts Section -->
        <div class="news-section">
            <div class="section-header">
                <h3 class="section-title"><i class="fas fa-chart-pie"></i> An√°lisis de Categor√≠as</h3>
            </div>
            <div class="section-body grid grid-cols-1 md:grid-cols-3 gap-6">
                <div id="categoryChart" style="height:300px;"></div>
                <div id="timelineChart" style="height:300px;"></div>
                <div id="sentimentChart" style="height:300px;"></div>
            </div>
        </div>

    </div> <!-- close dashboard-content -->
</div>
{% endblock %}

{% block extra_js %}
<script>
// Global variables
let articlesData = [];
let mosaicOffset = 0;
const mosaicPageSize = 10;
let currentPage = 1;
let isLoading = false;
let currentFilter = 'all';

// Initialize dashboard when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Add error handling for external libraries
    window.addEventListener('error', function(e) {
        if (e.message && (e.message.includes('getElementsByClassName') || 
                         e.message.includes('particles') || 
                         e.message.includes('particlesJS') ||
                         e.message.includes('city_lights'))) {
            console.warn('External library DOM/particle access error (handled):', e.message);
            e.preventDefault();
            return false;
        }
    });
    
    initializeNews();
    initializeSocketConnection();
    setupEventListeners();
    setupMapControls();
    loadNewsMosaic(0);
    loadDashboardStats();
});

// Socket.IO connection for real-time updates
function initializeSocketConnection() {
    try {
        if (typeof io !== 'undefined') {
            window.dashboardSocket = io();
            
            window.dashboardSocket.on('connect', function() {
                console.log('Connected to real-time updates');
                showNotification('Conectado a actualizaciones en tiempo real', 'success');
            });
            
            window.dashboardSocket.on('new_article', function(article) {
                console.log('New article received:', article);
                showNotification(`Nueva noticia: ${article.title.substring(0, 50)}...`, 'info');
                loadNewsMosaic(0);
            });
            
            window.dashboardSocket.on('disconnect', function() {
                console.log('Disconnected from real-time updates');
                showNotification('Desconectado de actualizaciones en tiempo real', 'error');
            });
        } else {
            console.warn('Socket.IO not available');
        }
    } catch (error) {
        console.error('Socket connection initialization failed:', error);
    }
}

// Load dashboard statistics
function loadDashboardStats() {
    fetch('/api/stats')
        .then(response => response.json())
        .then(data => {
            document.getElementById('totalArticles').textContent = data.total_articles || 0;
            document.getElementById('highRiskArticles').textContent = data.high_risk_articles || 0;
            document.getElementById('countriesCount').textContent = data.countries_count || 0;
            document.getElementById('lastUpdate').textContent = data.last_update || 'N/A';
        })
        .catch(error => {
            console.error('Error loading stats:', error);
        });
}

// News Mosaic Functions - Hybrid: Real data with Mock fallback
async function loadNewsMosaic(offset = 0) {
    const container = document.querySelector('.news-mosaic-container');
    if (!container) return;
    
    if (offset === 0) container.innerHTML = '';
    container.insertAdjacentHTML('beforeend', '<p>Cargando noticias...</p>');
    
    // Mock articles for fallback - Extended to 18 for better grid filling
    const mockArticles = [
        {
            id: 1, title: 'Tensiones geopol√≠ticas aumentan en Europa Oriental', 
            content: 'An√°lisis de la situaci√≥n actual en la regi√≥n...', 
            risk_level: 'high', location: 'Europa Oriental',
            created_at: new Date().toISOString(),
            url: 'https://example.com/news1',
            risk_score: 0.8
        },
        {
            id: 2, title: 'Nuevo acuerdo comercial entre potencias mundiales',
            content: 'Las negociaciones han llegado a un punto crucial...',
            risk_level: 'medium', location: 'Global',
            created_at: new Date(Date.now() - 3600000).toISOString(),
            url: 'https://example.com/news2',
            risk_score: 0.5
        },
        {
            id: 3, title: 'Desarrollo en tecnolog√≠a de defensa', 
            content: 'Avances significativos en sistemas defensivos...',
            risk_level: 'low', location: 'Asia Pac√≠fico',
            created_at: new Date(Date.now() - 7200000).toISOString(),
            url: 'https://example.com/news3',
            risk_score: 0.2
        },
        {
            id: 4, title: 'Crisis econ√≥mica mundial se agrava',
            content: 'Los mercados financieros muestran signos de inestabilidad...',
            risk_level: 'high', location: 'Mundial',
            created_at: new Date(Date.now() - 10800000).toISOString(),
            url: 'https://example.com/news4',
            risk_score: 0.75
        },
        {
            id: 5, title: 'Avances en energ√≠a renovable',
            content: 'Nuevas tecnolog√≠as prometen revolucionar el sector...',
            risk_level: 'low', location: 'Europa',
            created_at: new Date(Date.now() - 14400000).toISOString(),
            url: 'https://example.com/news5',
            risk_score: 0.1
        },
        {
            id: 6, title: 'Conflicto regional se intensifica',
            content: 'Las tensiones en la regi√≥n han escalado significativamente...',
            risk_level: 'high', location: 'Medio Oriente',
            created_at: new Date(Date.now() - 18000000).toISOString(),
            url: 'https://example.com/news6',
            risk_score: 0.9
        },
        {
            id: 7, title: 'Cumbre diplom√°tica busca soluciones',
            content: 'L√≠deres mundiales se re√∫nen para abordar crisis global...',
            risk_level: 'medium', location: 'Suiza',
            created_at: new Date(Date.now() - 21600000).toISOString(),
            url: 'https://example.com/news7',
            risk_score: 0.6
        },
        {
            id: 8, title: 'Innovaci√≥n en ciberseguridad',
            content: 'Nuevos protocolos de seguridad digital...',
            risk_level: 'low', location: 'Estados Unidos',
            created_at: new Date(Date.now() - 25200000).toISOString(),
            url: 'https://example.com/news8',
            risk_score: 0.3
        },
        {
            id: 9, title: 'Amenaza nuclear aumenta',
            content: 'Expertos expresan preocupaci√≥n por la escalada...',
            risk_level: 'high', location: 'Asia',
            created_at: new Date(Date.now() - 28800000).toISOString(),
            url: 'https://example.com/news9',
            risk_score: 0.85
        },
        {
            id: 10, title: 'Cooperaci√≥n internacional fortalecida',
            content: 'Nuevos acuerdos multilaterales prometen estabilidad...',
            risk_level: 'low', location: 'Internacional',
            created_at: new Date(Date.now() - 32400000).toISOString(),
            url: 'https://example.com/news10',
            risk_score: 0.15
        },
        {
            id: 11, title: 'Crisis migratoria se agudiza',
            content: 'Aumenta el flujo de refugiados en la frontera...',
            risk_level: 'medium', location: 'Europa',
            created_at: new Date(Date.now() - 36000000).toISOString(),
            url: 'https://example.com/news11',
            risk_score: 0.65
        },
        {
            id: 12, title: 'Nuevos hallazgos cient√≠ficos',
            content: 'Investigadores descubren avances prometedores...',
            risk_level: 'low', location: 'Jap√≥n',
            created_at: new Date(Date.now() - 39600000).toISOString(),
            url: 'https://example.com/news12',
            risk_score: 0.05
        },
        {
            id: 13, title: 'Tensiones comerciales escalan globalmente',
            content: 'Nuevas sanciones afectan el comercio internacional...',
            risk_level: 'high', location: 'Global',
            created_at: new Date(Date.now() - 43200000).toISOString(),
            url: 'https://example.com/news13',
            risk_score: 0.7
        },
        {
            id: 14, title: 'Avances en inteligencia artificial',
            content: 'Nueva generaci√≥n de IA promete revolucionar industrias...',
            risk_level: 'medium', location: 'Silicon Valley',
            created_at: new Date(Date.now() - 46800000).toISOString(),
            url: 'https://example.com/news14',
            risk_score: 0.4
        },
        {
            id: 15, title: 'Crisis clim√°tica acelera cambios pol√≠ticos',
            content: 'Gobiernos implementan medidas urgentes contra el cambio clim√°tico...',
            risk_level: 'high', location: 'Mundial',
            created_at: new Date(Date.now() - 50400000).toISOString(),
            url: 'https://example.com/news15',
            risk_score: 0.8
        },
        {
            id: 16, title: 'Nuevas alianzas militares se forman',
            content: 'Pa√≠ses estrat√©gicos establecen acuerdos de defensa...',
            risk_level: 'medium', location: 'Asia-Pac√≠fico',
            created_at: new Date(Date.now() - 54000000).toISOString(),
            url: 'https://example.com/news16',
            risk_score: 0.55
        },
        {
            id: 17, title: 'Revoluci√≥n en transporte sostenible',
            content: 'Nuevas tecnolog√≠as de transporte limpio ganan tracci√≥n...',
            risk_level: 'low', location: 'Europa',
            created_at: new Date(Date.now() - 57600000).toISOString(),
            url: 'https://example.com/news17',
            risk_score: 0.2
        },
        {
            id: 18, title: 'Ciberataques amenazan infraestructura cr√≠tica',
            content: 'Expertos alertan sobre vulnerabilidades en sistemas vitales...',
            risk_level: 'high', location: 'Internacional',
            created_at: new Date(Date.now() - 61200000).toISOString(),
            url: 'https://example.com/news18',
            risk_score: 0.85
        }
    ];
    
    const initialLoadCount = offset === 0 ? 18 : mosaicPageSize;
    
    try {
        const response = await fetch(`/api/articles?limit=${initialLoadCount}&offset=${offset}`);
        if (response.ok) {
            const data = await response.json();
            if (data && data.length > 0) {
                renderMosaic(data, offset > 0);
                updateStatistics();
                mosaicOffset = offset + data.length;
                return;
            }
        }
        throw new Error('No hay art√≠culos reales disponibles');
    } catch (error) {
        console.warn('Carga de datos reales fall√≥:', error.message);
        console.log('Usando datos de demostraci√≥n');
        const articlesToShow = offset === 0 ? mockArticles : mockArticles.slice(0, mosaicPageSize);
        renderMosaic(articlesToShow);
        updateStatistics();
    }
}

function renderMosaic(articles, append = false) {
    const container = document.querySelector('.news-mosaic-container');
    if (!container) return;
    
    if (!articles || articles.length === 0) {
        container.insertAdjacentHTML('beforeend', '<p>No hay art√≠culos disponibles</p>');
        return;
    }
    
    // Update global articles data for statistics
    if (!append) {
        articlesData = [...articles];
    } else {
        articlesData = [...articlesData, ...articles];
    }
    
    // Calculate importance for each article and assign irregular sizes
    const articlesWithSizes = articles.map((article, index) => {
        const importance = calculateArticleImportance(article);
        
        // Smart size assignment based on position and importance
        let sizeClass;
        if (index < 18) {
            sizeClass = `size-${index + 1}`;
        } else {
            // Cycle through fallback patterns for additional articles
            const fallbackPatterns = ['default-md-sq', 'default-lg-wide', 'default-lg-tall', 'default-md-wide'];
            const patternIndex = (index - 18) % fallbackPatterns.length;
            sizeClass = `size-${fallbackPatterns[patternIndex]}`;
        }
        
        return {
            ...article,
            importance,
            sizeClass,
            isFiller: false
        };
    });
    
    // Sort by importance for more engaging layout
    articlesWithSizes.sort((a, b) => {
        const scoreDiff = b.importance - a.importance;
        const randomFactor = (Math.random() - 0.5) * 8;
        return scoreDiff + randomFactor;
    });
    
    // Calculate how many grid spaces we're using and add filler to complete rows
    let totalSpacesUsed = 0;
    articlesWithSizes.forEach(article => {
        const spaces = getGridSpacesForSize(article.sizeClass);
        totalSpacesUsed += spaces;
    });
    
    // Calculate how many spaces we need to fill to complete the grid (multiples of 6)
    const remainderSpaces = totalSpacesUsed % 6;
    let spacesToAdd = 0;
    
    if (remainderSpaces > 0) {
        spacesToAdd = 6 - remainderSpaces;
        console.log(`üîß Grid usa ${totalSpacesUsed} espacios, resto: ${remainderSpaces}, agregando ${spacesToAdd} espacios`);
        
        // Add small filler articles (1x1) to fill the remaining spaces
        for (let i = 0; i < spacesToAdd; i++) {
            const fillerArticle = {
                id: `filler-${Date.now()}-${i}`,
                title: generateFillerTitle(),
                content: 'Art√≠culo de relleno para mantener la cohesi√≥n del dise√±o.',
                risk_level: ['low', 'medium'][Math.floor(Math.random() * 2)],
                location: ['Global', 'Internacional', 'Mundo'][Math.floor(Math.random() * 3)],
                created_at: new Date().toISOString(),
                risk_score: 0.1 + Math.random() * 0.4,
                importance: 10, // Low importance for filler
                sizeClass: 'size-default-md-sq', // Always 1x1 for filler
                isFiller: true
            };
            articlesWithSizes.push(fillerArticle);
        }
    }
    
    const mosaicHTML = articlesWithSizes.map((article, index) => {
        const title = (article.title || 'Sin t√≠tulo').substring(0, 120);
        const location = article.location || article.country || 'Global';
        const riskLevel = getRiskLevel(article.risk_score);
        const riskClass = riskLevel.toLowerCase();
        
        // Enhanced image selection with more variety
        const imageVariations = [
            'https://images.unsplash.com/photo-1504711434969-e33886168f5c?w=800&h=600&fit=crop',
            'https://images.unsplash.com/photo-1495020689067-958852a7765e?w=800&h=600&fit=crop',
            'https://images.unsplash.com/photo-1526304640581-d334cdbbf45e?w=800&h=600&fit=crop',
            'https://images.unsplash.com/photo-1585409677983-0f6c41ca9c58?w=800&h=600&fit=crop',
            'https://images.unsplash.com/photo-1598387993441-a364f854c3e1?w=800&h=600&fit=crop',
            'https://images.unsplash.com/photo-1543286386-713bdd548da4?w=800&h=600&fit=crop',
            'https://images.unsplash.com/photo-1557804506-669a67965ba0?w=800&h=600&fit=crop',
            'https://images.unsplash.com/photo-1611273426858-450d8e3c9fce?w=800&h=600&fit=crop'
        ];
        const defaultImage = imageVariations[index % imageVariations.length];
        const backgroundImage = article.image_url || article.image || article.urlToImage || defaultImage;
        
        // Add subtle styling for filler articles
        const fillerClass = article.isFiller ? ' filler-article' : '';
        
        return `
            <div class="mosaic-article ${article.sizeClass}${fillerClass}" 
                 style="background-image: url('${backgroundImage}')"
                 data-article-id="${article.id || index}"
                 data-importance="${article.importance}"
                 data-is-filler="${article.isFiller || false}"
                 onclick="openArticleModal(${JSON.stringify(article).replace(/"/g, '&quot;')})">
                <div class="mosaic-content">
                    <h3 class="mosaic-title">${title}</h3>
                    <div class="mosaic-meta">
                        <span class="mosaic-location">
                            <i class="fas fa-map-marker-alt"></i>
                            ${location}
                        </span>
                        <span class="mosaic-risk-badge ${!article.isFiller && index === 0 ? 'hero' : riskClass}">
                            ${!article.isFiller && index === 0 ? 'DESTACADO' : riskLevel}
                        </span>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    if (append) container.insertAdjacentHTML('beforeend', mosaicHTML);
    else container.innerHTML = mosaicHTML;
    
    const finalSpaceCount = totalSpacesUsed + spacesToAdd;
    console.log('‚úÖ Mosaico renderizado con', articlesWithSizes.length, 'art√≠culos');
    console.log('üìä Espacios totales:', finalSpaceCount, '- M√∫ltiplo de 6:', finalSpaceCount % 6 === 0 ? 'S√ç' : 'NO');
    console.log('üéØ Grid perfectamente alineado sin art√≠culos sueltos');
}

// Calculate article importance based on multiple factors
function calculateArticleImportance(article) {
    let score = 40; // Base score
    
    // Risk level weight (40% of importance)
    const riskWeights = { 'high': 40, 'medium': 24, 'low': 12 };
    score += riskWeights[article.risk_level] || 20;
    
    // Recency weight (30% of importance)
    try {
        const pubDate = new Date(article.published_date || article.date_published || Date.now());
        const now = new Date();
        const hoursOld = (now - pubDate) / (1000 * 60 * 60);
        const recencyScore = Math.max(0, 30 - (hoursOld / 24) * 5);
        score += recencyScore;
    } catch {
        score += 15; // Default recency
    }
    
    // Content keywords weight (20% of importance)
    const highImpactKeywords = [
        'guerra', 'conflicto', 'crisis', 'emergencia', 'ataque', 'bomba',
        'muerte', 'muertos', 'v√≠ctimas', 'evacuaci√≥n', 'desastre',
        'terremoto', 'tsunami', 'hurac√°n', 'incendio', 'explosi√≥n',
        'militar', 'ej√©rcito', 'terrorismo', 'tensi√≥n', 'disputa'
    ];
    
    const title = (article.title + ' ' + (article.description || '')).toLowerCase();
    const keywordMatches = highImpactKeywords.filter(keyword => title.includes(keyword)).length;
    score += Math.min(keywordMatches * 3, 20);
    
    // Location importance (10% of importance)
    const highRiskLocations = [
        'ucrania', 'gaza', 'israel', 'siria', 'afganist√°n', 'yemen',
        'somalia', 'sud√°n', 'myanmar', 'venezuela', 'corea', 'china', 'rusia', 'ir√°n'
    ];
    const location = (article.location + ' ' + (article.country || '')).toLowerCase();
    const isHighRiskLocation = highRiskLocations.some(loc => location.includes(loc));
    score += isHighRiskLocation ? 10 : 5;
    
    return Math.min(Math.max(score, 0), 100);
}

// Calculate total grid spaces needed for articles
function calculateGridSpaces(articles) {
    const sizeMap = {
        'size-1': 6,  // 3x2 = 6 spaces
        'size-2': 4,  // 2x2 = 4 spaces
        'size-3': 2,  // 1x2 = 2 spaces
        'size-4': 2,  // 2x1 = 2 spaces
        'size-5': 1,  // 1x1 = 1 space
        'size-6': 1,  // 1x1 = 1 space
        'size-7': 1,  // 1x1 = 1 space
        'size-8': 2,  // 2x1 = 2 spaces
        'size-9': 2,  // 1x2 = 2 spaces
        'size-10': 1, // 1x1 = 1 space
        'size-11': 1, // 1x1 = 1 space
        'size-12': 1, // 1x1 = 1 space
        'size-13': 3, // 3x1 = 3 spaces
        'size-14': 2, // 1x2 = 2 spaces
        'size-15': 2, // 2x1 = 2 spaces
        'size-16': 1, // 1x1 = 1 space
        'size-17': 1, // 1x1 = 1 space
        'size-18': 1, // 1x1 = 1 space
        'size-default-lg-wide': 3, // 3x1 = 3 spaces
        'size-default-lg-tall': 2,  // 1x2 = 2 spaces
        'size-default-md-wide': 2,  // 2x1 = 2 spaces
        'size-default-md-sq': 1     // 1x1 = 1 space
    };
    
    let totalSpaces = 0;
    articles.forEach((article, index) => {
        let sizeClass;
        if (index < 18) {
            sizeClass = `size-${index + 1}`;
        } else {
            const fallbackPatterns = ['default-md-sq', 'default-lg-wide', 'default-lg-tall', 'default-md-wide'];
            const patternIndex = (index - 18) % fallbackPatterns.length;
            sizeClass = `size-${fallbackPatterns[patternIndex]}`;
        }
        totalSpaces += sizeMap[sizeClass] || 1;
    });
    
    return totalSpaces;
}

// Get grid spaces for a specific size class
function getGridSpacesForSize(sizeClass) {
    const sizeMap = {
        'size-1': 6,  // 3x2 = 6 spaces
        'size-2': 4,  // 2x2 = 4 spaces
        'size-3': 2,  // 1x2 = 2 spaces
        'size-4': 2,  // 2x1 = 2 spaces
        'size-5': 1,  // 1x1 = 1 space
        'size-6': 1,  // 1x1 = 1 space
        'size-7': 1,  // 1x1 = 1 space
        'size-8': 2,  // 2x1 = 2 spaces
        'size-9': 2,  // 1x2 = 2 spaces
        'size-10': 1, // 1x1 = 1 space
        'size-11': 1, // 1x1 = 1 space
        'size-12': 1, // 1x1 = 1 space
        'size-13': 3, // 3x1 = 3 spaces
        'size-14': 2, // 1x2 = 2 spaces
        'size-15': 2, // 2x1 = 2 spaces
        'size-16': 1, // 1x1 = 1 space
        'size-17': 1, // 1x1 = 1 space
        'size-18': 1, // 1x1 = 1 space
        'size-default-lg-wide': 3, // 3x1 = 3 spaces
        'size-default-lg-tall': 2,  // 1x2 = 2 spaces
        'size-default-md-wide': 2,  // 2x1 = 2 spaces
        'size-default-md-sq': 1     // 1x1 = 1 space
    };
    
    return sizeMap[sizeClass] || 1;
}

// Generate filler article titles
function generateFillerTitle() {
    const fillerTitles = [
        'Desarrollo sostenible avanza en nuevas regiones',
        'Innovaci√≥n tecnol√≥gica impulsa crecimiento econ√≥mico',
        'Cooperaci√≥n internacional fortalece lazos diplom√°ticos',
        'Avances en salud p√∫blica mejoran calidad de vida',
        'Educaci√≥n digital transforma el aprendizaje global',
        'Energ√≠as renovables ganan terreno mundialmente',
        'Investigaci√≥n cient√≠fica revela nuevos hallazgos',
        'Programas de desarrollo rural muestran progreso',
        'Iniciativas culturales promueven diversidad global',
        'Modernizaci√≥n de infraestructuras beneficia comunidades',
        'Pol√≠ticas ambientales generan cambios positivos',
        'Colaboraci√≥n empresarial impulsa innovaci√≥n'
    ];
    
    return fillerTitles[Math.floor(Math.random() * fillerTitles.length)];
}

// Helper function to determine risk level
function getRiskLevel(riskScore) {
    if (riskScore >= 0.7) return 'ALTO';
    if (riskScore >= 0.4) return 'MEDIO';
    return 'BAJO';
}

// Enhanced article modal functionality
function openArticleModal(article) {
    console.log('Opening article:', article);
    
    // Create modal backdrop
    const modalBackdrop = document.createElement('div');
    modalBackdrop.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.8); z-index: 1000; display: flex; 
        align-items: center; justify-content: center; backdrop-filter: blur(5px);
    `;
    
    // Create modal content
    const modalContent = document.createElement('div');
    modalContent.style.cssText = `
        background: linear-gradient(135deg, #1a2040 0%, #2a3558 100%);
        border-radius: 12px; max-width: 800px; max-height: 90vh; 
        overflow-y: auto; margin: 20px; color: white; position: relative;
        box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    `;
    
    modalContent.innerHTML = `
        <div style="padding: 30px;">
            <button onclick="this.closest('.modal-backdrop').remove()" 
                    style="position: absolute; top: 15px; right: 15px; background: none; 
                           border: none; color: white; font-size: 24px; cursor: pointer;">√ó</button>
            <h2 style="margin-bottom: 20px; color: #00d4ff;">${article.title}</h2>
            <div style="margin-bottom: 20px;">
                <span style="background: rgba(70, 234, 215, 0.2); color: #46ead7; 
                           padding: 5px 10px; border-radius: 5px; margin-right: 10px;">
                    ${article.location || 'Ubicaci√≥n desconocida'}
                </span>
                <span style="background: ${getRiskLevel(article.risk_score) === 'ALTO' ? 'rgba(220, 38, 38, 0.3)' : 
                                         getRiskLevel(article.risk_score) === 'MEDIO' ? 'rgba(245, 158, 11, 0.3)' : 
                                         'rgba(34, 197, 94, 0.3)'}; 
                           color: ${getRiskLevel(article.risk_score) === 'ALTO' ? '#ef4444' : 
                                   getRiskLevel(article.risk_score) === 'MEDIO' ? '#f59e0b' : '#22c55e'};
                           padding: 5px 10px; border-radius: 5px;">
                    Riesgo: ${getRiskLevel(article.risk_score)}
                </span>
            </div>
            ${article.image_url ? `<img src="${article.image_url}" style="width: 100%; border-radius: 8px; margin-bottom: 20px;">` : ''}
            <p style="line-height: 1.6; color: rgba(255,255,255,0.9);">
                ${article.content || article.description || 'No hay contenido disponible para este art√≠culo.'}
            </p>
            ${article.url ? `<a href="${article.url}" target="_blank" 
                              style="display: inline-block; margin-top: 20px; padding: 10px 20px; 
                                     background: linear-gradient(135deg, #00d4ff 0%, #00a3cc 100%); 
                                     color: white; text-decoration: none; border-radius: 8px;">
                              Leer art√≠culo completo
                              </a>` : ''}
        </div>
    `;
    
    modalBackdrop.className = 'modal-backdrop';
    modalBackdrop.appendChild(modalContent);
    document.body.appendChild(modalBackdrop);
    
    // Close on backdrop click
    modalBackdrop.addEventListener('click', (e) => {
        if (e.target === modalBackdrop) {
            modalBackdrop.remove();
        }
    });
}

// Initialize news system
function initializeNews() {
    console.log('üì∞ Inicializando sistema de noticias...');
    setupMosaicControls();
}

// Setup mosaic controls
function setupMosaicControls() {
    const controls = document.querySelectorAll('.btn-control[data-filter]');
    const loadMoreBtn = document.getElementById('loadMoreBtn');
    
    controls.forEach(control => {
        control.addEventListener('click', function() {
            controls.forEach(c => c.classList.remove('active'));
            this.classList.add('active');
            
            currentFilter = this.dataset.filter;
            currentPage = 1;
            loadNewsMosaic(0);
        });
    });
    
    if (loadMoreBtn) {
        loadMoreBtn.addEventListener('click', function() {
            loadNewsMosaic(mosaicOffset);
        });
    }
}

// Setup event listeners
function setupEventListeners() {
    // AI Analysis refresh
    const refreshAIBtn = document.getElementById('refreshAIAnalysis');
    if (refreshAIBtn) {
        refreshAIBtn.addEventListener('click', () => {
            showNotification('Actualizando an√°lisis de IA...', 'info');
            // TODO: Implement AI analysis refresh
        });
    }
    
    // AI Report generation
    const generateReportBtn = document.getElementById('generateAIReport');
    if (generateReportBtn) {
        generateReportBtn.addEventListener('click', () => {
            showNotification('Generando reporte...', 'info');
            // TODO: Implement report generation
        });
    }
}

// Setup map controls
function setupMapControls() {
    const mapControls = document.querySelectorAll('[data-map-type]');
    mapControls.forEach(control => {
        control.addEventListener('click', function() {
            mapControls.forEach(c => c.classList.remove('active'));
            this.classList.add('active');
            
            const mapType = this.dataset.mapType;
            loadMapData(mapType);
        });
    });
}

// Load map data
async function loadMapData(type) {
    showNotification(`Cargando mapa: ${type}`, 'info');
    
    try {
        const response = await fetch(`/api/events/heatmap?type=${type}`);
        if (!response.ok) throw new Error(response.status);
        const data = await response.json();
        updateMapWithHeatmap(data, type);
    } catch (error) {
        console.error(`Error loading ${type} map:`, error);
        showMapError(`Error al cargar el mapa de ${type}`);
    } finally {
        hideMapLoading();
    }
}

// Update statistics
function updateStatistics() {
    if (articlesData.length > 0) {
        const highRisk = articlesData.filter(a => (a.risk_score || 0) >= 0.7).length;
        const countries = [...new Set(articlesData.map(a => a.location || a.country).filter(Boolean))].length;
        
        document.getElementById('totalArticles').textContent = articlesData.length;
        document.getElementById('highRiskArticles').textContent = highRisk;
        document.getElementById('countriesCount').textContent = countries;
        document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
    }
}

// Notification system
function showNotification(message, type = 'info') {
    console.log(`[${type.toUpperCase()}] ${message}`);
    
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed; top: 20px; right: 20px; z-index: 10000;
        padding: 15px 20px; border-radius: 8px; color: white; font-weight: 600;
        background: ${type === 'error' ? '#ef4444' : type === 'success' ? '#10b981' : '#3b82f6'};
        box-shadow: 0 4px 20px rgba(0,0,0,0.3); backdrop-filter: blur(10px);
        transform: translateX(100%); transition: transform 0.3s ease;
    `;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 100);
    
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// Map helper functions
function updateMapWithHeatmap(data, type) {
    console.log(`Updating map with ${type} data:`, data);
    // TODO: Implement actual map update logic
}

function showMapError(message) {
    const mapContainer = document.getElementById('main-map');
    if (mapContainer) {
        mapContainer.innerHTML = `<p style="color: #ef4444;">${message}</p>`;
    }
}

function hideMapLoading() {
    // TODO: Hide loading indicator
}

// Expose functions globally for debugging
window.dashboardFunctions = {
    initializeSocketConnection,
    loadNewsMosaic,
    renderMosaic,
    loadDashboardStats,
    showNotification,
    openArticleModal,
    calculateArticleImportance,
    updateStatistics,
    setupMapControls,
    loadMapData
};
</script>
{% endblock %}
