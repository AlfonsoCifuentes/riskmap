{% extends "base_navigation.html" %}

{% block title %}An√°lisis de Noticias - Stratosight{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/article_cards.css') }}">
<style>
    :root {
        --bg-primary: linear-gradient(180deg, #0a0f2c 0%, #1a2040 40%, #2a3558 80%, #3a4a70 100%);
        --bg-secondary: #141824;
        --text-primary: #e8eaed;
        --text-secondary: #b0b8c4;
        --accent-cyan: #00d4ff;
        --accent-glow: 0 0 15px rgba(0, 212, 255, 0.4), 0 0 25px rgba(0, 212, 255, 0.2);
        --border-color: rgba(255, 255, 255, 0.1);
    }

    html, body {
        margin: 0;
        padding: 0;
        min-height: 100vh;
        background: #1a237e;
        color: var(--text-primary);
        font-family: 'Inter', sans-serif;
        position: relative;
    }
    
    .dashboard-content {
        max-width: 96%;
        margin: 0 auto !important;
        margin-top: 0 !important;
        padding: 0 20px;
        width: 100%;
        box-sizing: border-box;
    }
    
    /* Ensure no gaps between header and content */
    .news-dashboard {
        padding: 0;
        max-width: none;
        margin: 0;
        position: relative;
        z-index: 1;
        display: flex;
        flex-direction: column;
        min-height: calc(100vh - 80px);
        background: rgba(10, 15, 44, 0.08);
        backdrop-filter: blur(2px);
        gap: 0;
    }
    
    /* Remove any potential spacing issues */
    .header-stats-container + .dashboard-content {
        margin-top: 0 !important;
        padding-top: 0 !important;
    }
    
    /* Header and Stats Container */
    .header-stats-container {
        width: 100vw;
        position: relative;
        left: 50%;
        right: 50%;
        margin-left: -50vw;
        margin-right: -50vw;
        margin-bottom: 0;
        top: 0;
        z-index: 0;
        background: transparent;
        border-radius: 0;
        height: auto;
        min-height: auto;
    }
    
    .page-header {
        text-align: center;
        margin: 0;
        color: #fff;
        padding: 30px 0 20px 0;
        width: 100%;
        position: relative;
        background: linear-gradient(135deg, rgba(26, 32, 64, 0.75) 0%, rgba(16, 24, 48, 0.8) 50%, rgba(20, 28, 56, 0.75) 100%);
        backdrop-filter: blur(10px);
        box-shadow: 0 2px 20px rgba(0, 0, 0, 0.3);
    }
    
    .page-title {
        font-family: 'Orbitron', monospace;
        font-size: clamp(1.5rem, 6vw, 4rem);
        font-weight: 700;
        margin-bottom: 10px;
        background: linear-gradient(135deg, #00d4ff 0%, #00a3cc 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        width: 75%;
        margin-left: auto;
        margin-right: auto;
        line-height: 1.2;
        word-wrap: break-word;
        hyphens: auto;
    }
    
    .page-subtitle {
        font-size: 1rem;
        color: rgba(255, 255, 255, 0.7);
        margin-bottom: 20px;
    }

    /* Stats Cards - Responsive Grid */
    .news-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 0;
        margin: 0;
        width: 100%;
        position: relative;
    }
    
    .news-stat-card {
        background: transparent;
        border: none;
        border-radius: 0;
        padding: 20px;
        text-align: center;
        transition: all 0.3s ease;
        backdrop-filter: blur(3px);
        box-shadow: none;
        border-right: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .news-stat-card:last-child {
        border-right: none;
    }
    
    .news-stat-card:nth-child(1) {
        background: linear-gradient(135deg, rgba(0, 119, 255, 0.4) 0%, rgba(30, 144, 255, 0.35) 100%);
    }
    
    .news-stat-card:nth-child(2) {
        background: linear-gradient(135deg, rgba(220, 38, 38, 0.45) 0%, rgba(239, 68, 68, 0.4) 100%);
    }
    
    .news-stat-card:nth-child(3) {
        background: linear-gradient(135deg, rgba(70, 234, 215, 0.4) 0%, rgba(45, 212, 191, 0.35) 100%);
    }
    
    .news-stat-card:nth-child(4) {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.4) 0%, rgba(37, 99, 235, 0.35) 100%);
    }
    
    .news-stat-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    }
    
    .news-stat-card:nth-child(1):hover {
        background: linear-gradient(135deg, rgba(0, 119, 255, 0.6) 0%, rgba(30, 144, 255, 0.5) 100%);
    }
    
    .news-stat-card:nth-child(2):hover {
        background: linear-gradient(135deg, rgba(220, 38, 38, 0.65) 0%, rgba(239, 68, 68, 0.55) 100%);
    }
    
    .news-stat-card:nth-child(3):hover {
        background: linear-gradient(135deg, rgba(70, 234, 215, 0.6) 0%, rgba(45, 212, 191, 0.5) 100%);
    }
    
    .news-stat-card:nth-child(4):hover {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.6) 0%, rgba(37, 99, 235, 0.5) 100%);
    }
    
    .stat-icon {
        width: 50px;
        height: 50px;
        margin: 0 auto 15px;
        background: linear-gradient(135deg, #00d4ff 0%, #00a3cc 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.3rem;
        color: #fff;
    }
    
    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: #fff;
        margin-bottom: 5px;
        font-family: 'Orbitron', monospace;
    }
    
    .stat-label {
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    /* Section styling - Mobile-First */
    .news-section {
        background: rgba(26, 32, 64, 0.7);
        border: 1px solid rgba(70, 234, 215, 0.3);
        border-radius: 12px;
        padding: 20px;
        backdrop-filter: blur(15px);
        margin-bottom: 25px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }
    
    .section-header {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--border-color);
        gap: 15px;
    }
    
    .section-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #fff;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .section-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: center;
    }
    
    .btn-control {
        flex: 1 1 auto;
        max-width: 140px;
        min-width: 80px;
        text-align: center;
        padding: 8px 12px;
        font-size: 0.8rem;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
        border: 1px solid rgba(255, 255, 255, 0.2);
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .btn-control:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateY(-2px);
    }

    .btn-control.active {
        background: rgba(70, 234, 215, 0.3);
        border-color: rgba(70, 234, 215, 0.5);
        color: #fff;
    }

    /* High Risk Articles Grid - Responsive */
    .high-risk-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .high-risk-card {
        background: linear-gradient(145deg, rgba(239, 68, 68, 0.15), rgba(220, 38, 38, 0.08));
        border: 1px solid rgba(239, 68, 68, 0.4);
        border-radius: 12px;
        padding: 15px;
        transition: all 0.3s ease;
        backdrop-filter: blur(15px);
    }
    
    .high-risk-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(239, 68, 68, 0.3);
        border-color: rgba(239, 68, 68, 0.5);
    }
    
    .high-risk-title {
        font-size: 1rem;
        font-weight: 600;
        color: #fff;
        margin-bottom: 8px;
        line-height: 1.3;
    }
    
    .high-risk-description {
        color: rgba(255, 255, 255, 0.8);
        font-size: 0.85rem;
        line-height: 1.5;
        margin-bottom: 12px;
    }
    
    .high-risk-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.75rem;
        flex-wrap: wrap;
        gap: 8px;
    }
    
    .high-risk-location {
        color: rgba(255, 255, 255, 0.6);
        display: flex;
        align-items: center;
        gap: 4px;
    }
    
    .high-risk-badge {
        background: rgba(239, 68, 68, 0.2);
        color: #ef4444;
        padding: 3px 6px;
        border-radius: 4px;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.65rem;
    }

    /* Latest Articles - Full width cards - Mobile-First */
    .latest-articles-grid {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    
    .latest-article-card {
        background: rgba(26, 32, 64, 0.7);
        border: 1px solid rgba(70, 234, 215, 0.25);
        border-radius: 12px;
        padding: 15px;
        transition: all 0.3s ease;
        backdrop-filter: blur(15px);
        display: flex;
        flex-direction: column;
        gap: 12px;
        box-shadow: 0 2px 15px rgba(0, 0, 0, 0.2);
    }
    
    .latest-article-card:hover {
        background: rgba(26, 32, 64, 0.85);
        border-color: rgba(70, 234, 215, 0.4);
        transform: translateY(-2px);
    }
    
    .latest-article-content {
        flex: 1;
    }
    
    .latest-article-title {
        font-size: 1rem;
        font-weight: 600;
        color: #fff;
        margin-bottom: 6px;
        line-height: 1.3;
    }
    
    .latest-article-description {
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.85rem;
        line-height: 1.5;
        margin-bottom: 8px;
    }
    
    .latest-article-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.6);
    }
    
    .latest-article-meta-item {
        display: flex;
        align-items: center;
        gap: 4px;
    }
    
    .latest-article-sidebar {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 8px;
    }
    
    .latest-risk-badge {
        padding: 3px 6px;
        border-radius: 4px;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.65rem;
    }
    
    .latest-risk-badge.high {
        background: rgba(239, 68, 68, 0.2);
        color: #ef4444;
    }
    
    .latest-risk-badge.medium {
        background: rgba(245, 158, 11, 0.2);
        color: #f59e0b;
    }
    
    .latest-risk-badge.low {
        background: rgba(34, 197, 94, 0.2);
        color: #22c55e;
    }

    /* News Mosaic Section - Dynamic Collage Layout */
    .news-mosaic-section {
        width: 100vw;
        position: relative;
        left: 50%;
        right: 50%;
        margin-left: -50vw;
        margin-right: -50vw;
        margin-top: 0;
        padding: 0;
        background: transparent;
        z-index: 1;
        margin-top: 0 !important;
    }

    .mosaic-controls-container {
        width: 100%;
        padding: 20px;
        background: rgba(10, 15, 44, 0.5);
        backdrop-filter: blur(5px);
        z-index: 5;
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
        left: 50%;
        right: 50%;
        margin-left: -50vw;
        margin-right: -50vw;
        width: 100vw;
        box-sizing: border-box;
    }
    
    .mosaic-controls {
        display: flex;
        gap: 15px;
        justify-content: center;
    }
    
    .news-mosaic-container {
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        grid-auto-rows: calc(16.666vw / 1.2);
        gap: 0;
        grid-auto-flow: dense;
        width: 100vw;
        min-height: 100vh;
        background: rgba(0, 0, 0, 0.1);
        padding: 0;
    }

    /* Load More Button Container */
    .load-more-container {
        width: 100vw;
        position: relative;
        left: 50%;
        right: 50%;
        margin-left: -50vw;
        margin-right: -50vw;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 30px 0;
        background: rgba(10, 15, 44, 0.3);
        backdrop-filter: blur(5px);
    }

    .load-more-btn {
        width: 66.666%;
        max-width: 800px;
        padding: 15px 30px;
        background: linear-gradient(135deg, rgba(70, 234, 215, 0.2) 0%, rgba(70, 234, 215, 0.4) 100%);
        border: 2px solid rgba(70, 234, 215, 0.5);
        color: #46ead7;
        font-size: 1.1rem;
        font-weight: 600;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 1px;
        backdrop-filter: blur(15px);
        box-shadow: 0 4px 20px rgba(70, 234, 215, 0.2);
    }

    .load-more-btn:hover {
        background: linear-gradient(135deg, rgba(70, 234, 215, 0.4) 0%, rgba(70, 234, 215, 0.6) 100%);
        border-color: rgba(70, 234, 215, 0.8);
        transform: translateY(-2px);
        box-shadow: 0 8px 30px rgba(70, 234, 215, 0.3);
        color: #fff;
    }

    .load-more-btn:active {
        transform: translateY(0);
    }
    
    /* Mosaic Article Tiles - Irregular Sizes */
    .mosaic-article {
        position: relative;
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        border: 1px solid #0a0f2c;
        box-sizing: border-box;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(2px);
    }
    
    .mosaic-article::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
            135deg,
            rgba(0, 0, 0, 0.2) 0%,
            rgba(0, 0, 0, 0.1) 40%,
            rgba(0, 0, 0, 0.5) 100%
        );
        border-radius: 0;
        z-index: 1;
    }
    
    .mosaic-article:hover {
        transform: scale(1.02);
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.5);
        z-index: 5;
        border: 1px solid var(--accent-cyan);
    }
    
    .mosaic-article:hover::before {
        background: linear-gradient(
            135deg,
            rgba(0, 0, 0, 0.1) 0%,
            rgba(0, 0, 0, 0.05) 40%,
            rgba(0, 0, 0, 0.4) 100%
        );
    }
    
    /* Irregular size variants based on importance score - 6-column grid */
    .mosaic-article.size-1 { grid-column: span 3; grid-row: span 2; } /* Hero article - half width */
    .mosaic-article.size-2 { grid-column: span 2; grid-row: span 2; } /* Large vertical */
    .mosaic-article.size-3 { grid-column: span 1; grid-row: span 2; } /* Tall thin */
    .mosaic-article.size-4 { grid-column: span 2; grid-row: span 1; } /* Wide horizontal */
    .mosaic-article.size-5 { grid-column: span 1; grid-row: span 1; } /* Small square */
    .mosaic-article.size-6 { grid-column: span 1; grid-row: span 1; } /* Small square */
    .mosaic-article.size-7 { grid-column: span 1; grid-row: span 1; } /* Small square */
    .mosaic-article.size-8 { grid-column: span 2; grid-row: span 1; } /* Wide horizontal */
    .mosaic-article.size-9 { grid-column: span 1; grid-row: span 2; } /* Tall thin */
    .mosaic-article.size-10 { grid-column: span 1; grid-row: span 1; } /* Small square */
    .mosaic-article.size-11 { grid-column: span 1; grid-row: span 1; } /* Small square */
    .mosaic-article.size-12 { grid-column: span 1; grid-row: span 1; } /* Small square */
    .mosaic-article.size-13 { grid-column: span 3; grid-row: span 1; } /* Extra wide */
    .mosaic-article.size-14 { grid-column: span 1; grid-row: span 2; } /* Tall thin */
    .mosaic-article.size-15 { grid-column: span 2; grid-row: span 1; } /* Wide horizontal */
    .mosaic-article.size-16 { grid-column: span 1; grid-row: span 1; } /* Small square */
    .mosaic-article.size-17 { grid-column: span 1; grid-row: span 1; } /* Small square */
    .mosaic-article.size-18 { grid-column: span 1; grid-row: span 1; } /* Small square */

    /* Fallback sizes for additional articles */
    .mosaic-article.size-default-lg-wide { grid-column: span 3; grid-row: span 1; }
    .mosaic-article.size-default-lg-tall { grid-column: span 1; grid-row: span 2; }
    .mosaic-article.size-default-md-wide { grid-column: span 2; grid-row: span 1; }
    .mosaic-article.size-default-md-sq { grid-column: span 1; grid-row: span 1; }
    
    /* Article content overlay with fixed padding */
    .mosaic-content {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 15px;
        z-index: 2;
        color: white;
        background: linear-gradient(
            transparent 0%,
            rgba(0, 0, 0, 0.3) 20%,
            rgba(0, 0, 0, 0.7) 70%,
            rgba(0, 0, 0, 0.9) 100%
        );
        border-radius: 0;
        min-height: 80px;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
    }
    
    .mosaic-title {
        font-size: 1.1rem;
        font-weight: 600;
        line-height: 1.3;
        margin: 0 0 8px 0;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
        display: -webkit-box;
        -webkit-line-clamp: 3;
        line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .mosaic-article.size-1 .mosaic-title {
        font-size: 1.6rem;
        -webkit-line-clamp: 4;
        line-clamp: 4;
    }
    .mosaic-article.size-2 .mosaic-title {
        font-size: 1.2rem;
        -webkit-line-clamp: 3;
        line-clamp: 3;
    }
    
    .mosaic-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: auto;
    }
    
    .mosaic-location {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.9);
        background: rgba(0, 0, 0, 0.4);
        padding: 6px 10px;
        border-radius: 15px;
        backdrop-filter: blur(8px);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .mosaic-risk-badge {
        font-size: 0.65rem;
        font-weight: 700;
        padding: 6px 10px;
        border-radius: 15px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        text-shadow: none;
        backdrop-filter: blur(8px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .mosaic-risk-badge.hero {
        background: linear-gradient(135deg, #dc2626, #ef4444);
        color: white;
        font-size: 0.8rem;
        padding: 8px 12px;
        box-shadow: 0 4px 15px rgba(220, 38, 38, 0.4);
    }
    
    .mosaic-risk-badge.high {
        background: rgba(220, 38, 38, 0.9);
        color: white;
        box-shadow: 0 2px 10px rgba(220, 38, 38, 0.3);
    }
    
    .mosaic-risk-badge.medium {
        background: rgba(245, 158, 11, 0.9);
        color: white;
        box-shadow: 0 2px 10px rgba(245, 158, 11, 0.3);
    }
    
    .mosaic-risk-badge.low {
        background: rgba(34, 197, 94, 0.9);
        color: white;
        box-shadow: 0 2px 10px rgba(34, 197, 94, 0.3);
    }

    /* Filler articles styling */
    .mosaic-article.filler-article {
        opacity: 0.85;
    }
    
    .mosaic-article.filler-article::before {
        background: linear-gradient(
            135deg,
            rgba(0, 0, 0, 0.3) 0%,
            rgba(0, 0, 0, 0.2) 40%,
            rgba(0, 0, 0, 0.6) 100%
        );
    }
    
    .mosaic-article.filler-article:hover {
        opacity: 1;
        transform: scale(1.01); /* Slightly less dramatic hover for filler */
    }

    /* Articles without real images - enhanced gradient overlay */
    .mosaic-article.no-real-image::before {
        background: linear-gradient(
            135deg,
            rgba(26, 32, 64, 0.4) 0%,
            rgba(42, 53, 88, 0.3) 40%,
            rgba(0, 0, 0, 0.7) 100%
        );
    }

    /* Importance indicator styles */
    .importance-indicator {
        position: absolute;
        top: 12px;
        right: 12px;
        background: linear-gradient(135deg, rgba(0, 123, 255, 0.9), rgba(0, 86, 179, 0.9));
        color: white;
        padding: 6px 10px;
        border-radius: 16px;
        font-size: 0.8rem;
        font-weight: 600;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(8px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        z-index: 2;
        display: flex;
        align-items: center;
        gap: 4px;
        transition: all 0.3s ease;
    }
    
    .importance-indicator:hover {
        transform: scale(1.05);
        background: linear-gradient(135deg, rgba(0, 123, 255, 1), rgba(0, 86, 179, 1));
    }
    
    .importance-indicator[data-importance="100"],
    .importance-indicator[data-importance="99"],
    .importance-indicator[data-importance="98"] {
        background: linear-gradient(135deg, rgba(255, 69, 58, 0.9), rgba(255, 45, 85, 0.9));
    }
    
    .importance-indicator[data-importance^="9"] {
        background: linear-gradient(135deg, rgba(255, 149, 0, 0.9), rgba(255, 159, 10, 0.9));
    }
    
    .importance-indicator[data-importance^="8"] {
        background: linear-gradient(135deg, rgba(255, 204, 0, 0.9), rgba(255, 214, 10, 0.9));
    }

    /* Loading state */
    .mosaic-loading {
        grid-column: 1 / -1;
        grid-row: 1 / -1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: rgba(255, 255, 255, 0.7);
        font-size: 1.2rem;
    }
    
    .mosaic-loading i {
        font-size: 2rem;
        margin-bottom: 15px;
        color: #46ead7;
    }

    /* AI Analysis Article Styles */
    .ai-article-container {
        padding: 0;
    }
    
    .ai-loading-state {
        text-align: center;
        padding: 40px 20px;
        color: rgba(255,255,255,0.7);
    }
    
    .ai-article-content {
        background: rgba(26, 32, 64, 0.7);
        border: 1px solid rgba(70, 234, 215, 0.25);
        border-radius: 12px;
        padding: 0;
        font-family: 'Inter', serif;
        line-height: 1.7;
        color: #e8eaed;
        backdrop-filter: blur(15px);
        box-shadow: 0 4px 25px rgba(0, 0, 0, 0.3);
        overflow: hidden;
    }
    
    .ai-article-header {
        background: linear-gradient(135deg, rgba(26, 32, 64, 0.9) 0%, rgba(16, 24, 48, 0.9) 100%);
        padding: 40px 30px 30px 30px;
        border-bottom: 2px solid rgba(70, 234, 215, 0.3);
        text-align: center;
    }
    
    .ai-article-title {
        font-family: 'Orbitron', sans-serif;
        font-size: clamp(1.8rem, 4vw, 2.5rem);
        font-weight: 700;
        color: #fff;
        margin-bottom: 15px;
        line-height: 1.2;
        background: linear-gradient(135deg, #00d4ff 0%, #00a3cc 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .ai-article-subtitle {
        font-size: 1.1rem;
        color: rgba(255, 255, 255, 0.8);
        font-style: italic;
        margin-bottom: 20px;
    }
    
    .ai-article-meta {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 20px;
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.6);
    }
    
    .ai-meta-item {
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .ai-article-body {
        padding: 30px;
        font-size: 1rem;
        line-height: 1.8;
        columns: 4;
        column-gap: 30px;
        column-rule: 1px solid rgba(255, 255, 255, 0.1);
        text-align: justify;
        hyphens: auto;
    }
    
    .ai-article-body p:first-child::first-letter {
        font-size: 4em;
        line-height: 0.8;
        float: left;
        margin: 0.1em 0.1em 0 0;
        font-weight: bold;
        color: #00d4ff;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        font-family: 'Orbitron', serif;
    }
    
    .ai-article-section {
        break-inside: avoid;
        margin-bottom: 25px;
    }
    
    .ai-section-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #00d4ff;
        margin-bottom: 12px;
        padding-left: 15px;
        border-left: 3px solid #00d4ff;
        break-after: avoid;
    }
    
    .ai-article-paragraph {
        margin-bottom: 15px;
        text-align: justify;
        break-inside: avoid;
    }
    
    .ai-highlight {
        background: rgba(70, 234, 215, 0.2);
        padding: 2px 4px;
        border-radius: 3px;
        color: #fff;
        font-weight: 500;
    }
    
    .ai-quote {
        border-left: 4px solid #00d4ff;
        padding: 15px 20px;
        margin: 20px 0;
        background: rgba(0, 212, 255, 0.1);
        font-style: italic;
        color: rgba(255, 255, 255, 0.9);
        break-inside: avoid;
        column-span: all;
    }
    
    .ai-article-footer {
        margin-top: 30px;
        padding: 20px 30px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.6);
        text-align: center;
        background: rgba(10, 15, 44, 0.3);
        column-span: all;
    }
    
    .ai-byline {
        font-style: italic;
        color: rgba(255, 255, 255, 0.7);
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
        .ai-article-body {
            columns: 3;
            column-gap: 25px;
        }
        
        .news-mosaic-container {
            grid-template-columns: repeat(4, 1fr);
            grid-auto-rows: calc(25vw / 1.2);
        }
        
        .mosaic-article.size-1 { grid-column: span 2; grid-row: span 2; }
        .mosaic-article.size-2 { grid-column: span 2; grid-row: span 1; }
        .mosaic-article.size-13 { grid-column: span 2; grid-row: span 1; }
        .mosaic-article.size-default-lg-wide { grid-column: span 2; grid-row: span 1; }
    }

    @media (max-width: 768px) {
        .ai-article-body {
            columns: 2;
            column-gap: 20px;
        }
        
        .news-mosaic-container {
            grid-template-columns: repeat(3, 1fr);
            grid-auto-rows: calc(33.333vw / 1.2);
        }
        
        .mosaic-article.size-1 { grid-column: span 3; grid-row: span 1; }
        .mosaic-article.size-2 { grid-column: span 2; grid-row: span 1; }
        .mosaic-article.size-7 { grid-column: span 2; grid-row: span 1; }
        .mosaic-article.size-8 { grid-column: span 2; grid-row: span 1; }
        .mosaic-article.size-12 { grid-column: span 2; grid-row: span 1; }
        .mosaic-article.size-13 { grid-column: span 3; grid-row: span 1; }
        .mosaic-article.size-15 { grid-column: span 2; grid-row: span 1; }
        .mosaic-article.size-default-lg-wide { grid-column: span 2; grid-row: span 1; }
        .mosaic-article.size-default-md-wide { grid-column: span 2; grid-row: span 1; }
        
        .load-more-btn {
            width: 85%;
            font-size: 1rem;
        }
    }

    @media (max-width: 480px) {
        .ai-article-body {
            columns: 1;
            column-gap: 0;
        }
        
        .ai-article-header {
            padding: 30px 20px 20px 20px;
        }
        
        .ai-article-body {
            padding: 20px;
        }
        
        .news-mosaic-container {
            grid-template-columns: repeat(2, 1fr);
            grid-auto-rows: 50vw;
        }
        
        .mosaic-article { grid-column: span 1; grid-row: span 1; }
        .mosaic-article.size-1 { grid-column: span 2; grid-row: span 1; }
        .mosaic-article.size-7 { grid-column: span 2; grid-row: span 1; }
        .mosaic-article.size-8 { grid-column: span 2; grid-row: span 1; }
        .mosaic-article.size-12 { grid-column: span 2; grid-row: span 1; }
        .mosaic-article.size-13 { grid-column: span 2; grid-row: span 1; }
        .mosaic-article.size-15 { grid-column: span 2; grid-row: span 1; }
        
        .load-more-btn {
            width: 90%;
            font-size: 0.9rem;
            padding: 12px 20px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="news-dashboard">
    <!-- Header and Stats Section -->
    <div class="header-stats-container">
        <div class="page-header">
            <h1 class="page-title">An√°lisis Estrat√©gico de Noticias</h1>
            <p class="page-subtitle">Monitoreo en tiempo real de riesgos y amenazas globales</p>
            
            <!-- Statistics Cards -->
            <div class="news-stats" id="newsStats">
                <div class="news-stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-newspaper"></i>
                    </div>
                    <div class="stat-value" id="totalArticles">-</div>
                    <div class="stat-label">Total Art√≠culos</div>
                </div>
                <div class="news-stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="stat-value" id="highRiskArticles">-</div>
                    <div class="stat-label">Alto Riesgo</div>
                </div>
                <div class="news-stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-globe"></i>
                    </div>
                    <div class="stat-value" id="countriesCount">-</div>
                    <div class="stat-label">Pa√≠ses</div>
                </div>
                <div class="news-stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-value" id="lastUpdate">-</div>
                    <div class="stat-label">√öltima Actualizaci√≥n</div>
                </div>
            </div>
        </div>
    </div>

    <div class="dashboard-content">
        <!-- News Mosaic Section -->
        <div class="news-mosaic-section">
            <div class="mosaic-controls-container">
                <div class="mosaic-controls">
                    <button class="btn-control active" data-filter="all">
                        <i class="fas fa-th"></i> Todos
                    </button>
                    <button class="btn-control" data-filter="high">
                        <i class="fas fa-exclamation-triangle"></i> Alto Riesgo
                    </button>
                    <button class="btn-control" data-filter="medium">
                        <i class="fas fa-exclamation-circle"></i> Medio Riesgo
                    </button>
                    <button class="btn-control" data-filter="recent">
                        <i class="fas fa-clock"></i> Recientes
                    </button>
                </div>
            </div>
            
            <div class="news-mosaic-container" id="newsMosaic">
                <div class="mosaic-loading">
                    <i class="fas fa-spinner fa-spin"></i>
                    <div>Cargando noticias...</div>
                </div>
            </div>
            
            <!-- Load More Button -->
            <div class="load-more-container">
                <button class="load-more-btn" id="loadMoreBtn">
                    <i class="fas fa-plus"></i> Cargar M√°s Noticias
                </button>
            </div>
        </div>

        <!-- Map Section - Enhanced -->
        <div class="map-section-enhanced">
            <div class="section-header">
                <h3 class="section-title">
                    <i class="fas fa-map-marked-alt"></i>
                    Mapas de An√°lisis Geopol√≠tico
                </h3>
                <div class="section-controls">
                    <button class="btn-control active" data-map-type="general">
                        <i class="fas fa-globe"></i> General
                    </button>
                    <button class="btn-control" data-map-type="conflict_risk">
                        <i class="fas fa-exclamation-triangle"></i> Riesgo Conflicto
                    </button>
                    <button class="btn-control" data-map-type="historical_conflicts">
                        <i class="fas fa-history"></i> Conflictos Hist√≥ricos
                    </button>
                    <button class="btn-control" data-map-type="oil">
                        <i class="fas fa-oil-can"></i> Petr√≥leo
                    </button>
                    <button class="btn-control" data-map-type="energy">
                        <i class="fas fa-bolt"></i> Energ√≠a
                    </button>
                    <button class="btn-control" data-map-type="supplies">
                        <i class="fas fa-shipping-fast"></i> Suministros
                    </button>
                    <button class="btn-control" data-map-type="internet_cables">
                        <i class="fas fa-network-wired"></i> Internet
                    </button>
                    <button class="btn-control" data-map-type="military_bases">
                        <i class="fas fa-shield-alt"></i> Militar
                    </button>
                    <button class="btn-control" data-map-type="trade_routes">
                        <i class="fas fa-route"></i> Comercio
                    </button>
                </div>
            </div>
            <div class="section-body">
                <div id="map" class="h-96 rounded-lg bg-gray-800/50 border border-gray-700/50"></div>
            </div>
            <div class="map-container" id="main-map">
                <i class="fas fa-map" style="font-size: 3rem; opacity: 0.3;"></i>
                <p style="margin-top: 1rem; opacity: 0.6;">Mapa de calor cargando...</p>
            </div>
        </div>

        <!-- Enhanced AI Analysis Section -->
        <div id="aiArticleSection" class="news-section">
            <div class="section-header">
                <h3 class="section-title">
                    <i class="fas fa-brain"></i>
                    An√°lisis Geopol√≠tico Avanzado por IA
                </h3>
                <div class="section-controls">
                    <button class="btn-control" id="refreshAIAnalysis">
                        <i class="fas fa-sync-alt"></i> Actualizar An√°lisis
                    </button>
                    <button class="btn-control" id="generateAIReport">
                        <i class="fas fa-file-download"></i> Exportar Art√≠culo
                    </button>
                </div>
            </div>
            <div class="section-body">
                <div id="aiAnalysisContent" class="ai-article-container">
                    <div class="ai-loading-state">
                        <i class="fas fa-edit" style="font-size: 2rem; margin-bottom: 15px; opacity: 0.6; color: #46ead7;"></i>
                        <h4 style="margin-bottom: 10px; color: #fff;">Generando an√°lisis geopol√≠tico...</h4>
                        <p style="color: rgba(255,255,255,0.7); font-size: 0.9rem;">Nuestro periodista de IA est√° preparando un resumen exhaustivo de la actualidad mundial</p>
                        <div class="loading-spinner" style="margin-top: 20px;">
                            <i class="fas fa-spinner fa-spin" style="color: #46ead7; font-size: 1.5rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analytics Charts Section -->
        <div class="news-section">
            <div class="section-header">
                <h3 class="section-title"><i class="fas fa-chart-pie"></i> An√°lisis de Categor√≠as</h3>
            </div>
            <div class="section-body grid grid-cols-1 md:grid-cols-3 gap-6">
                <div id="categoryChart" style="height:300px;"></div>
                <div id="timelineChart" style="height:300px;"></div>
                <div id="sentimentChart" style="height:300px;"></div>
            </div>
        </div>

    </div> <!-- close dashboard-content -->
</div>
{% endblock %}

{% block extra_js %}
<script>
// Global variables
let articlesData = [];
let mosaicOffset = 0;
const mosaicPageSize = 10;
let currentPage = 1;
let isLoading = false;
let currentFilter = 'all';

// Initialize dashboard when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Add error handling for external libraries
    window.addEventListener('error', function(e) {
        if (e.message && (e.message.includes('getElementsByClassName') || 
                         e.message.includes('particles') || 
                         e.message.includes('particlesJS') ||
                         e.message.includes('city_lights'))) {
            console.warn('External library DOM/particle access error (handled):', e.message);
            e.preventDefault();
            return false;
        }
    });
    
    initializeNews();
    initializeSocketConnection();
    setupEventListeners();
    setupMapControls();
    loadNewsMosaic(0);
    loadDashboardStats();
    
    // Initialize AI analysis after a short delay
    setTimeout(() => {
        generateAIGeopoliticalAnalysis();
    }, 2000);
});

// Socket.IO connection for real-time updates
function initializeSocketConnection() {
    try {
        if (typeof io !== 'undefined') {
            window.dashboardSocket = io();
            
            window.dashboardSocket.on('connect', function() {
                console.log('Connected to real-time updates');
                showNotification('Conectado a actualizaciones en tiempo real', 'success');
            });
            
            window.dashboardSocket.on('new_article', function(article) {
                console.log('New article received:', article);
                showNotification(`Nueva noticia: ${article.title.substring(0, 50)}...`, 'info');
                loadNewsMosaic(0);
            });
            
            window.dashboardSocket.on('disconnect', function() {
                console.log('Disconnected from real-time updates');
                showNotification('Desconectado de actualizaciones en tiempo real', 'error');
            });
        } else {
            console.warn('Socket.IO not available');
        }
    } catch (error) {
        console.error('Socket connection initialization failed:', error);
    }
}

// Load dashboard statistics
function loadDashboardStats() {
    fetch('http://localhost:5001/api/dashboard/stats')
        .then(response => response.json())
        .then(data => {
            document.getElementById('totalArticles').textContent = data.total_articles || 0;
            document.getElementById('highRiskArticles').textContent = data.high_risk_articles || 0;
            document.getElementById('countriesCount').textContent = data.countries_count || 0;
            document.getElementById('lastUpdate').textContent = data.last_update || 'N/A';
        })
        .catch(error => {
            console.error('Error loading stats:', error);
        });
}

// News Mosaic Functions - Hybrid: Real data with Mock fallback
async function loadNewsMosaic(offset = 0) {
    const container = document.querySelector('.news-mosaic-container');
    if (!container) return;
    
    if (offset === 0) container.innerHTML = '';
    container.insertAdjacentHTML('beforeend', '<p>Cargando noticias...</p>');
    
    // Mock articles for fallback - Extended to 18 for better grid filling
    const mockArticles = [
        {
            id: 1, title: 'Tensiones geopol√≠ticas aumentan en Europa Oriental', 
            content: 'An√°lisis de la situaci√≥n actual en la regi√≥n...', 
            risk_level: 'high', location: 'Europa Oriental',
            created_at: new Date().toISOString(),
            url: 'https://example.com/news1',
            risk_score: 0.8
        },
        {
            id: 2, title: 'Nuevo acuerdo comercial entre potencias mundiales',
            content: 'Las negociaciones han llegado a un punto crucial...',
            risk_level: 'medium', location: 'Global',
            created_at: new Date(Date.now() - 3600000).toISOString(),
            url: 'https://example.com/news2',
            risk_score: 0.5
        },
        {
            id: 3, title: 'Desarrollo en tecnolog√≠a de defensa', 
            content: 'Avances significativos en sistemas defensivos...',
            risk_level: 'low', location: 'Asia Pac√≠fico',
            created_at: new Date(Date.now() - 7200000).toISOString(),
            url: 'https://example.com/news3',
            risk_score: 0.2
        },
        {
            id: 4, title: 'Crisis econ√≥mica mundial se agrava',
            content: 'Los mercados financieros muestran signos de inestabilidad...',
            risk_level: 'high', location: 'Mundial',
            created_at: new Date(Date.now() - 10800000).toISOString(),
            url: 'https://example.com/news4',
            risk_score: 0.75
        },
        {
            id: 5, title: 'Avances en energ√≠a renovable',
            content: 'Nuevas tecnolog√≠as prometen revolucionar el sector...',
            risk_level: 'low', location: 'Europa',
            created_at: new Date(Date.now() - 14400000).toISOString(),
            url: 'https://example.com/news5',
            risk_score: 0.1
        },
        {
            id: 6, title: 'Conflicto regional se intensifica',
            content: 'Las tensiones en la regi√≥n han escalado significativamente...',
            risk_level: 'high', location: 'Medio Oriente',
            created_at: new Date(Date.now() - 18000000).toISOString(),
            url: 'https://example.com/news6',
            risk_score: 0.9
        },
        {
            id: 7, title: 'Cumbre diplom√°tica busca soluciones',
            content: 'L√≠deres mundiales se re√∫nen para abordar crisis global...',
            risk_level: 'medium', location: 'Suiza',
            created_at: new Date(Date.now() - 21600000).toISOString(),
            url: 'https://example.com/news7',
            risk_score: 0.6
        },
        {
            id: 8, title: 'Innovaci√≥n en ciberseguridad',
            content: 'Nuevos protocolos de seguridad digital...',
            risk_level: 'low', location: 'Estados Unidos',
            created_at: new Date(Date.now() - 25200000).toISOString(),
            url: 'https://example.com/news8',
            risk_score: 0.3
        },
        {
            id: 9, title: 'Amenaza nuclear aumenta',
            content: 'Expertos expresan preocupaci√≥n por la escalada...',
            risk_level: 'high', location: 'Asia',
            created_at: new Date(Date.now() - 28800000).toISOString(),
            url: 'https://example.com/news9',
            risk_score: 0.85
        },
        {
            id: 10, title: 'Cooperaci√≥n internacional fortalecida',
            content: 'Nuevos acuerdos multilaterales prometen estabilidad...',
            risk_level: 'low', location: 'Internacional',
            created_at: new Date(Date.now() - 32400000).toISOString(),
            url: 'https://example.com/news10',
            risk_score: 0.15
        },
        {
            id: 11, title: 'Crisis migratoria se agudiza',
            content: 'Aumenta el flujo de refugiados en la frontera...',
            risk_level: 'medium', location: 'Europa',
            created_at: new Date(Date.now() - 36000000).toISOString(),
            url: 'https://example.com/news11',
            risk_score: 0.65
        },
        {
            id: 12, title: 'Nuevos hallazgos cient√≠ficos',
            content: 'Investigadores descubren avances prometedores...',
            risk_level: 'low', location: 'Jap√≥n',
            created_at: new Date(Date.now() - 39600000).toISOString(),
            url: 'https://example.com/news12',
            risk_score: 0.05
        },
        {
            id: 13, title: 'Tensiones comerciales escalan globalmente',
            content: 'Nuevas sanciones afectan el comercio internacional...',
            risk_level: 'high', location: 'Global',
            created_at: new Date(Date.now() - 43200000).toISOString(),
            url: 'https://example.com/news13',
            risk_score: 0.7
        },
        {
            id: 14, title: 'Avances en inteligencia artificial',
            content: 'Nueva generaci√≥n de IA promete revolucionar industrias...',
            risk_level: 'medium', location: 'Silicon Valley',
            created_at: new Date(Date.now() - 46800000).toISOString(),
            url: 'https://example.com/news14',
            risk_score: 0.4
        },
        {
            id: 15, title: 'Crisis clim√°tica acelera cambios pol√≠ticos',
            content: 'Gobiernos implementan medidas urgentes contra el cambio clim√°tico...',
            risk_level: 'high', location: 'Mundial',
            created_at: new Date(Date.now() - 50400000).toISOString(),
            url: 'https://example.com/news15',
            risk_score: 0.8
        },
        {
            id: 16, title: 'Nuevas alianzas militares se forman',
            content: 'Pa√≠ses estrat√©gicos establecen acuerdos de defensa...',
            risk_level: 'medium', location: 'Asia-Pac√≠fico',
            created_at: new Date(Date.now() - 54000000).toISOString(),
            url: 'https://example.com/news16',
            risk_score: 0.55
        },
        {
            id: 17, title: 'Revoluci√≥n en transporte sostenible',
            content: 'Nuevas tecnolog√≠as de transporte limpio ganan tracci√≥n...',
            risk_level: 'low', location: 'Europa',
            created_at: new Date(Date.now() - 57600000).toISOString(),
            url: 'https://example.com/news17',
            risk_score: 0.2
        },
        {
            id: 18, title: 'Ciberataques amenazan infraestructura cr√≠tica',
            content: 'Expertos alertan sobre vulnerabilidades en sistemas vitales...',
            risk_level: 'high', location: 'Internacional',
            created_at: new Date(Date.now() - 61200000).toISOString(),
            url: 'https://example.com/news18',
            risk_score: 0.85
        }
    ];
    
    const initialLoadCount = offset === 0 ? 18 : mosaicPageSize;
    
    try {
        const response = await fetch(`http://localhost:5001/api/articles?limit=${initialLoadCount}&offset=${offset}`);
        if (response.ok) {
            const data = await response.json();
            if (data && data.length > 0) {
                renderMosaic(data, offset > 0);
                updateStatistics();
                mosaicOffset = offset + data.length;
                return;
            }
        }
        throw new Error('No hay art√≠culos reales disponibles');
    } catch (error) {
        console.warn('Carga de datos reales fall√≥:', error.message);
        console.log('Usando datos de demostraci√≥n');
        const articlesToShow = offset === 0 ? mockArticles : mockArticles.slice(0, mosaicPageSize);
        renderMosaic(articlesToShow);
        updateStatistics();
    }
}

async function renderMosaic(articles, append = false) {
    const container = document.querySelector('.news-mosaic-container');
    if (!container) return;
    
    if (!articles || articles.length === 0) {
        container.insertAdjacentHTML('beforeend', '<p>No hay art√≠culos disponibles</p>');
        return;
    }
    
    // Update global articles data for statistics
    if (!append) {
        articlesData = [...articles];
    } else {
        articlesData = [...articlesData, ...articles];
    }
    
    // Show loading indicator for AI analysis
    if (!append) {
        container.innerHTML = '<div class="mosaic-loading"><i class="fas fa-brain fa-spin"></i><div>Analizando importancia con IA...</div></div>';
    }
    
    // Calculate advanced importance for each article using BERT model
    const articlesWithAdvancedImportance = await Promise.all(
        articles.map(async (article, index) => {
            const importance = await calculateAdvancedImportanceRiskFactor(article);
            
            // Smart size assignment based on position and importance
            let sizeClass;
            if (index < 18) {
                sizeClass = `size-${index + 1}`;
            } else {
                const fallbackPatterns = ['default-md-sq', 'default-lg-wide', 'default-lg-tall', 'default-md-wide'];
                const patternIndex = (index - 18) % fallbackPatterns.length;
                sizeClass = `size-${fallbackPatterns[patternIndex]}`;
            }
            
            return {
                ...article,
                importance,
                advancedRiskFactor: importance,
                sizeClass,
                isFiller: false
            };
        })
    );
    
    // Sort by advanced importance/risk factor for optimal layout
    articlesWithAdvancedImportance.sort((a, b) => {
        const scoreDiff = b.advancedRiskFactor - a.advancedRiskFactor;
        // Less randomness for more predictable important article placement
        const randomFactor = (Math.random() - 0.5) * 5;
        return scoreDiff + randomFactor;
    });
    
    // Calculate how many grid spaces we're using and add filler to complete rows
    let totalSpacesUsed = 0;
    articlesWithAdvancedImportance.forEach(article => {
        const spaces = getGridSpacesForSize(article.sizeClass);
        totalSpacesUsed += spaces;
    });
    
    // Calculate how many spaces we need to fill to complete the grid (multiples of 6)
    const remainderSpaces = totalSpacesUsed % 6;
    let spacesToAdd = 0;
    
    if (remainderSpaces > 0) {
        spacesToAdd = 6 - remainderSpaces;
        console.log(`üîß Grid usa ${totalSpacesUsed} espacios, resto: ${remainderSpaces}, agregando ${spacesToAdd} espacios`);
        
        // Add small filler articles (1x1) to fill the remaining spaces
        for (let i = 0; i < spacesToAdd; i++) {
            const fillerArticle = {
                id: `filler-${Date.now()}-${i}`,
                title: generateFillerTitle(),
                content: 'Art√≠culo de relleno para mantener la cohesi√≥n del dise√±o.',
                risk_level: ['low', 'medium'][Math.floor(Math.random() * 2)],
                location: ['Global', 'Internacional', 'Mundo'][Math.floor(Math.random() * 3)],
                created_at: new Date().toISOString(),
                risk_score: 0.1 + Math.random() * 0.4,
                importance: 10,
                advancedRiskFactor: 10,
                sizeClass: 'size-default-md-sq',
                isFiller: true
            };
            articlesWithAdvancedImportance.push(fillerArticle);
        }
    }
    
    const mosaicHTML = articlesWithAdvancedImportance.map((article, index) => {
        const title = (article.title || 'Sin t√≠tulo').substring(0, 120);
        const location = article.location || article.country || 'Global';
        const riskLevel = getRiskLevel(article.risk_score);
        const riskClass = riskLevel.toLowerCase();
        
        // Use real article images - prefer authentic sources over fallbacks
        let backgroundImage = '';
        
        // Priority order: real article images first
        if (article.image_url && article.image_url !== null && article.image_url !== '') {
            backgroundImage = article.image_url;
        } else if (article.image && article.image !== null && article.image !== '') {
            backgroundImage = article.image;
        } else if (article.urlToImage && article.urlToImage !== null && article.urlToImage !== '') {
            backgroundImage = article.urlToImage;
        } else if (article.media && article.media.length > 0) {
            // Check for media array
            backgroundImage = article.media[0];
        } else if (article.links && article.links.image) {
            // Check for links object
            backgroundImage = article.links.image;
        } else if (article.multimedia && article.multimedia.length > 0) {
            // NY Times style multimedia
            backgroundImage = article.multimedia[0].url;
        } else {
            // Use minimal gradient fallback only when no real image exists
            console.log('üì∑ No real image found for:', article.title?.substring(0, 30));
            backgroundImage = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAwIiBoZWlnaHQ9IjYwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZGVmcz4KICAgIDxsaW5lYXJHcmFkaWVudCBpZD0iZ3JhZCIgeDE9IjAlIiB5MT0iMCUiIHgyPSIxMDAlIiB5Mj0iMTAwJSI+CiAgICAgIDxzdG9wIG9mZnNldD0iMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiMxYTIwNDA7c3RvcC1vcGFjaXR5OjEiIC8+CiAgICAgIDxzdG9wIG9mZnNldD0iMTAwJSIgc3R5bGU9InN0b3AtY29sb3I6IzJhMzU1ODtzdG9wLW9wYWNpdHk6MSIgLz4KICAgIDwvbGluZWFyR3JhZGllbnQ+CiAgPC9kZWZzPgogIDxyZWN0IHdpZHRoPSI4MDAiIGhlaWdodD0iNjAwIiBmaWxsPSJ1cmwoI2dyYWQpIiAvPgo8L3N2Zz4K';
        }
        
        // Add subtle styling for filler articles
        const fillerClass = article.isFiller ? ' filler-article' : '';
        
        // Add class for articles without real images
        const hasRealImage = article.image_url || article.image || article.urlToImage || 
                           (article.media && article.media.length > 0) ||
                           (article.links && article.links.image) ||
                           (article.multimedia && article.multimedia.length > 0);
        const imageClass = !hasRealImage ? ' no-real-image' : '';
        
        // Remove importance indicator per user request
        const importanceIndicator = '';
        
        return `
            <div class="mosaic-article ${article.sizeClass}${fillerClass}${imageClass}" 
                 style="background-image: url('${backgroundImage}')"
                 data-article-id="${article.id || index}"
                 data-importance="${article.advancedRiskFactor}"
                 data-is-filler="${article.isFiller || false}"
                 onclick="openArticleModal(${JSON.stringify(article).replace(/"/g, '&quot;')})">
                ${importanceIndicator}
                <div class="mosaic-content">
                    <h3 class="mosaic-title">${title}</h3>
                    <div class="mosaic-meta">
                        <span class="mosaic-location">
                            <i class="fas fa-map-marker-alt"></i>
                            ${location}
                        </span>
                        <span class="mosaic-risk-badge ${!article.isFiller && index === 0 ? 'hero' : riskClass}">
                            ${!article.isFiller && index === 0 ? 'DESTACADO' : riskLevel}
                        </span>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    if (append) container.insertAdjacentHTML('beforeend', mosaicHTML);
    else container.innerHTML = mosaicHTML;
    
    const finalSpaceCount = totalSpacesUsed + spacesToAdd;
    console.log('‚úÖ Mosaico renderizado con an√°lisis BERT avanzado');
    console.log('üß† Art√≠culos analizados:', articlesWithAdvancedImportance.filter(a => !a.isFiller).length);
    console.log('üìä Espacios totales:', finalSpaceCount, '- M√∫ltiplo de 6:', finalSpaceCount % 6 === 0 ? 'S√ç' : 'NO');
    console.log('üéØ Ranking por factor de importancia aplicado');
}

// Advanced importance and risk factor calculation with BERT model integration
async function calculateAdvancedImportanceRiskFactor(article) {
    try {
        // Prepare comprehensive article data for BERT analysis
        const articleData = {
            title: article.title || '',
            content: article.content || article.description || '',
            location: article.location || article.country || '',
            risk_level: article.risk_level || getRiskLevel(article.risk_score),
            created_at: article.created_at || article.published_at || article.published_date || new Date().toISOString(),
            risk_score: article.risk_score || 0.5
        };
        
        // Call the enhanced BERT-powered endpoint
        const response = await fetch('http://localhost:5003/api/analyze-importance', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(articleData)
        });

        if (response.ok) {
            const result = await response.json();
            
            // Log BERT analysis results for debugging
            if (result.bert_analysis && !result.fallback_used) {
                console.log('üß† BERT Success:', {
                    title: articleData.title.substring(0, 40),
                    importance: result.importance_factor,
                    negative: result.bert_analysis.negative_sentiment,
                    confidence: result.bert_analysis.confidence
                });
            }
            
            return result.importance_factor || result.risk_factor || 50;
        } else {
            throw new Error(`API Error: ${response.status}`);
        }
    } catch (error) {
        console.warn('üîÑ BERT API failed, using enhanced fallback:', error.message);
    }
    
    return calculateFallbackImportance(article);
}

// Enhanced fallback importance calculation
function calculateFallbackImportance(article) {
    let baseScore = 40;
    
    // 1. Database risk level weight (40% of importance)
    const existingImportance = article.importance || 0;
    const riskWeights = { 'high': 40, 'medium': 24, 'low': 12 };
    const riskScore = riskWeights[article.risk_level] || (existingImportance * 0.4) || 20;
    baseScore += riskScore;
    
    // 2. Recency factor with exponential decay (35% of importance)
    const recencyScore = calculateRecencyScore(article);
    baseScore += recencyScore;
    
    // 3. Geopolitical keywords impact (15% of importance)
    const keywordScore = calculateKeywordImpact(article);
    baseScore += keywordScore;
    
    // 4. Location-based risk assessment (10% of importance)
    const locationScore = calculateLocationRisk(article);
    baseScore += locationScore;
    
    return Math.min(Math.max(baseScore, 0), 100);
}

// Calculate recency score with time decay
function calculateRecencyScore(article) {
    try {
        const pubDate = new Date(article.published_date || article.date_published || article.created_at || Date.now());
        const now = new Date();
        const minutesOld = (now - pubDate) / (1000 * 60);
        
        // Exponential decay: newer articles get higher scores
        let recencyScore = 35;
        
        if (minutesOld <= 60) {
            // Last hour: maximum score
            recencyScore = 35;
        } else if (minutesOld <= 360) {
            // Last 6 hours: high score
            recencyScore = 30;
        } else if (minutesOld <= 1440) {
            // Last 24 hours: good score
            recencyScore = 25;
        } else if (minutesOld <= 4320) {
            // Last 3 days: medium score
            recencyScore = 20;
        } else if (minutesOld <= 10080) {
            // Last week: low score
            recencyScore = 10;
        } else {
            // Older than a week: minimal score
            recencyScore = 5;
        }
        
        return recencyScore;
    } catch {
        return 15; // Default recency score
    }
}

// Enhanced keyword impact analysis
function calculateKeywordImpact(article) {
    const criticalKeywords = [
        // Military/Conflict
        'guerra', 'conflicto', 'ataque', 'bomba', 'militar', 'ej√©rcito', 'batalla',
        'invasi√≥n', 'ocupaci√≥n', 'asedio', 'bombardeo', 'misil', 'dron',
        
        // Political Crisis
        'crisis', 'emergencia', 'golpe', 'revoluci√≥n', 'protestas', 'disturbios',
        'tensi√≥n', 'disputa', 'sanci√≥n', 'embargo', 'bloqueo',
        
        // Violence/Terrorism
        'terrorismo', 'atentado', 'secuestro', 'asesinato', 'v√≠ctimas', 'muertos',
        'heridos', 'evacuaci√≥n', 'refugiados', 'desplazados',
        
        // Natural Disasters
        'terremoto', 'tsunami', 'hurac√°n', 'tif√≥n', 'inundaci√≥n', 'incendio',
        'erupci√≥n', 'volc√°n', 'desastre', 'cat√°strofe',
        
        // Economic Crisis
        'colapso', 'crash', 'crisis econ√≥mica', 'recesi√≥n', 'inflaci√≥n',
        'devaluaci√≥n', 'bancarrota', 'default'
    ];
    
    const moderateKeywords = [
        'negociaci√≥n', 'acuerdo', 'tratado', 'diplomacia', 'cumbre',
        'elecciones', 'votaci√≥n', 'refer√©ndum', 'pol√≠tica', 'gobierno'
    ];
    
    const content = (article.title + ' ' + (article.content || article.description || '')).toLowerCase();
    
    // Critical keywords: 2 points each, max 15 points
    const criticalMatches = criticalKeywords.filter(keyword => content.includes(keyword)).length;
    const criticalScore = Math.min(criticalMatches * 2, 15);
    
    // Moderate keywords: 0.5 points each, max 3 points
    const moderateMatches = moderateKeywords.filter(keyword => content.includes(keyword)).length;
    const moderateScore = Math.min(moderateMatches * 0.5, 3);
    
    return criticalScore + moderateScore;
}

// Enhanced location-based risk assessment
function calculateLocationRisk(article) {
    const highRiskLocations = [
        // Active conflict zones
        'ucrania', 'gaza', 'israel', 'palestina', 'siria', 'afganist√°n', 'yemen',
        'somalia', 'sud√°n', 'myanmar', 'mali', 'burkina faso', 'n√≠ger',
        
        // Geopolitical tensions
        'taiw√°n', 'corea del norte', 'ir√°n', 'venezuela', 'bielorrusia',
        'hong kong', 'xinjiang', 'cachemira',
        
        // Regional instability
        'sahel', 'cuerno de √°frica', 'balcanes', 'c√°ucaso'
    ];
    
    const mediumRiskLocations = [
        'china', 'rusia', 'turqu√≠a', 'egipto', 'pakist√°n', 'india',
        'brasil', 'm√©xico', 'colombia', 'per√∫', 'argentina'
    ];
    
    const location = (article.location + ' ' + (article.country || '')).toLowerCase();
    
    if (highRiskLocations.some(loc => location.includes(loc))) {
        return 10;
    } else if (mediumRiskLocations.some(loc => location.includes(loc))) {
        return 6;
    } else {
        return 3; // Default score for other locations
    }
}

// Calculate article importance based on multiple factors (keeping original for compatibility)
function calculateArticleImportance(article) {
    return calculateFallbackImportance(article);
}

// Calculate total grid spaces needed for articles
function calculateGridSpaces(articles) {
    const sizeMap = {
        'size-1': 6,  // 3x2 = 6 spaces
        'size-2': 4,  // 2x2 = 4 spaces
        'size-3': 2,  // 1x2 = 2 spaces
        'size-4': 2,  // 2x1 = 2 spaces
        'size-5': 1,  // 1x1 = 1 space
        'size-6': 1,  // 1x1 = 1 space
        'size-7': 1,  // 1x1 = 1 space
        'size-8': 2,  // 2x1 = 2 spaces
        'size-9': 2,  // 1x2 = 2 spaces
        'size-10': 1, // 1x1 = 1 space
        'size-11': 1, // 1x1 = 1 space
        'size-12': 1, // 1x1 = 1 space
        'size-13': 3, // 3x1 = 3 spaces
        'size-14': 2, // 1x2 = 2 spaces
        'size-15': 2, // 2x1 = 2 spaces
        'size-16': 1, // 1x1 = 1 space
        'size-17': 1, // 1x1 = 1 space
        'size-18': 1, // 1x1 = 1 space
        'size-default-lg-wide': 3, // 3x1 = 3 spaces
        'size-default-lg-tall': 2,  // 1x2 = 2 spaces
        'size-default-md-wide': 2,  // 2x1 = 2 spaces
        'size-default-md-sq': 1     // 1x1 = 1 space
    };
    
    let totalSpaces = 0;
    articles.forEach((article, index) => {
        let sizeClass;
        if (index < 18) {
            sizeClass = `size-${index + 1}`;
        } else {
            const fallbackPatterns = ['default-md-sq', 'default-lg-wide', 'default-lg-tall', 'default-md-wide'];
            const patternIndex = (index - 18) % fallbackPatterns.length;
            sizeClass = `size-${fallbackPatterns[patternIndex]}`;
        }
        totalSpaces += sizeMap[sizeClass] || 1;
    });
    
    return totalSpaces;
}

// Get grid spaces for a specific size class
function getGridSpacesForSize(sizeClass) {
    const sizeMap = {
        'size-1': 6,  // 3x2 = 6 spaces
        'size-2': 4,  // 2x2 = 4 spaces
        'size-3': 2,  // 1x2 = 2 spaces
        'size-4': 2,  // 2x1 = 2 spaces
        'size-5': 1,  // 1x1 = 1 space
        'size-6': 1,  // 1x1 = 1 space
        'size-7': 1,  // 1x1 = 1 space
        'size-8': 2,  // 2x1 = 2 spaces
        'size-9': 2,  // 1x2 = 2 spaces
        'size-10': 1, // 1x1 = 1 space
        'size-11': 1, // 1x1 = 1 space
        'size-12': 1, // 1x1 = 1 space
        'size-13': 3, // 3x1 = 3 spaces
        'size-14': 2, // 1x2 = 2 spaces
        'size-15': 2, // 2x1 = 2 spaces
        'size-16': 1, // 1x1 = 1 space
        'size-17': 1, // 1x1 = 1 space
        'size-18': 1, // 1x1 = 1 space
        'size-default-lg-wide': 3, // 3x1 = 3 spaces
        'size-default-lg-tall': 2,  // 1x2 = 2 spaces
        'size-default-md-wide': 2,  // 2x1 = 2 spaces
        'size-default-md-sq': 1     // 1x1 = 1 space
    };
    
    return sizeMap[sizeClass] || 1;
}

// Generate filler article titles
function generateFillerTitle() {
    const fillerTitles = [
        'Desarrollo sostenible avanza en nuevas regiones',
        'Innovaci√≥n tecnol√≥gica impulsa crecimiento econ√≥mico',
        'Cooperaci√≥n internacional fortalece lazos diplom√°ticos',
        'Avances en salud p√∫blica mejoran calidad de vida',
        'Educaci√≥n digital transforma el aprendizaje global',
        'Energ√≠as renovables ganan terreno mundialmente',
        'Investigaci√≥n cient√≠fica revela nuevos hallazgos',
        'Programas de desarrollo rural muestran progreso',
        'Iniciativas culturales promueven diversidad global',
        'Modernizaci√≥n de infraestructuras beneficia comunidades',
        'Pol√≠ticas ambientales generan cambios positivos',
        'Colaboraci√≥n empresarial impulsa innovaci√≥n'
    ];
    
    return fillerTitles[Math.floor(Math.random() * fillerTitles.length)];
}

// Helper function to determine risk level
function getRiskLevel(riskScore) {
    if (riskScore >= 0.7) return 'RIESGO ALTO';
    if (riskScore >= 0.4) return 'RIESGO MEDIO';
    return 'RIESGO BAJO';
}

// Enhanced article modal functionality
function openArticleModal(article) {
    console.log('Opening article:', article);
    
    // Create modal backdrop
    const modalBackdrop = document.createElement('div');
    modalBackdrop.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.8); z-index: 1000; display: flex; 
        align-items: center; justify-content: center; backdrop-filter: blur(5px);
    `;
    
    // Create modal content
    const modalContent = document.createElement('div');
    modalContent.style.cssText = `
        background: linear-gradient(135deg, #1a2040 0%, #2a3558 100%);
        border-radius: 12px; max-width: 800px; max-height: 90vh; 
        overflow-y: auto; margin: 20px; color: white; position: relative;
        box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    `;
    
    modalContent.innerHTML = `
        <div style="padding: 30px;">
            <button onclick="this.closest('.modal-backdrop').remove()" 
                    style="position: absolute; top: 15px; right: 15px; background: none; 
                           border: none; color: white; font-size: 24px; cursor: pointer;">√ó</button>
            <h2 style="margin-bottom: 20px; color: #00d4ff;">${article.title}</h2>
            <div style="margin-bottom: 20px;">
                <span style="background: rgba(70, 234, 215, 0.2); color: #46ead7; 
                           padding: 5px 10px; border-radius: 5px; margin-right: 10px;">
                    ${article.location || 'Ubicaci√≥n desconocida'}
                </span>
                <span style="background: ${getRiskLevel(article.risk_score) === 'RIESGO ALTO' ? 'rgba(220, 38, 38, 0.3)' : 
                                         getRiskLevel(article.risk_score) === 'RIESGO MEDIO' ? 'rgba(245, 158, 11, 0.3)' : 
                                         'rgba(34, 197, 94, 0.3)'};
                           color: ${getRiskLevel(article.risk_score) === 'RIESGO ALTO' ? '#ef4444' : 
                                   getRiskLevel(article.risk_score) === 'RIESGO MEDIO' ? '#f59e0b' : '#22c55e'};
                           padding: 5px 10px; border-radius: 5px;">
                    Riesgo: ${getRiskLevel(article.risk_score)}
                </span>
            </div>
            ${article.image_url ? `<img src="${article.image_url}" style="width: 100%; border-radius: 8px; margin-bottom: 20px;">` : ''}
            <p style="line-height: 1.6; color: rgba(255,255,255,0.9);">
                ${article.content || article.description || 'No hay contenido disponible para este art√≠culo.'}
            </p>
            ${article.url ? `<a href="${article.url}" target="_blank" 
                              style="display: inline-block; margin-top: 20px; padding: 10px 20px; 
                                     background: linear-gradient(135deg, #00d4ff 0%, #00a3cc 100%); 
                                     color: white; text-decoration: none; border-radius: 8px;">
                              Leer art√≠culo completo
                              </a>` : ''}
        </div>
    `;
    
    modalBackdrop.className = 'modal-backdrop';
    modalBackdrop.appendChild(modalContent);
    document.body.appendChild(modalBackdrop);
    
    // Close on backdrop click
    modalBackdrop.addEventListener('click', (e) => {
        if (e.target === modalBackdrop) {
            modalBackdrop.remove();
        }
    });
}

// Initialize news system
function initializeNews() {
    console.log('üì∞ Inicializando sistema de noticias...');
    setupMosaicControls();
}

// Setup mosaic controls
function setupMosaicControls() {
    const controls = document.querySelectorAll('.btn-control[data-filter]');
    const loadMoreBtn = document.getElementById('loadMoreBtn');
    
    controls.forEach(control => {
        control.addEventListener('click', function() {
            controls.forEach(c => c.classList.remove('active'));
            this.classList.add('active');
            
            currentFilter = this.dataset.filter;
            currentPage = 1;
            loadNewsMosaic(0);
        });
    });
    
    if (loadMoreBtn) {
        loadMoreBtn.addEventListener('click', function() {
            loadNewsMosaic(mosaicOffset);
        });
    }
}

// Setup event listeners
function setupEventListeners() {
    // AI Analysis refresh
    const refreshAIBtn = document.getElementById('refreshAIAnalysis');
    if (refreshAIBtn) {
        refreshAIBtn.addEventListener('click', () => {
            showNotification('Generando an√°lisis geopol√≠tico con IA...', 'info');
            generateAIGeopoliticalAnalysis();
        });
    }
    
    // AI Report generation
    const generateReportBtn = document.getElementById('generateAIReport');
    if (generateReportBtn) {
        generateReportBtn.addEventListener('click', () => {
            exportAIArticleToHTML();
        });
    }
}

// Setup map controls
function setupMapControls() {
    const mapControls = document.querySelectorAll('[data-map-type]');
    mapControls.forEach(control => {
        control.addEventListener('click', function() {
            mapControls.forEach(c => c.classList.remove('active'));
            this.classList.add('active');
            
            const mapType = this.dataset.mapType;
            loadMapData(mapType);
        });
    });
}

// Load map data
async function loadMapData(type) {
    showNotification(`Cargando mapa: ${type}`, 'info');
    
    try {
        const response = await fetch(`/api/events/heatmap?type=${type}`);
        if (!response.ok) throw new Error(response.status);
        const data = await response.json();
        updateMapWithHeatmap(data, type);
    } catch (error) {
        console.error(`Error loading ${type} map:`, error);
        showMapError(`Error al cargar el mapa de ${type}`);
    } finally {
        hideMapLoading();
    }
}

// Update statistics
function updateStatistics() {
    if (articlesData.length > 0) {
        const highRisk = articlesData.filter(a => (a.risk_score || 0) >= 0.7).length;
        const countries = [...new Set(articlesData.map(a => a.location || a.country).filter(Boolean))].length;
        
        document.getElementById('totalArticles').textContent = articlesData.length;
        document.getElementById('highRiskArticles').textContent = highRisk;
        document.getElementById('countriesCount').textContent = countries;
        document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
    }
}

// Notification system
function showNotification(message, type = 'info') {
    console.log(`[${type.toUpperCase()}] ${message}`);
    
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed; top: 20px; right: 20px; z-index: 10000;
        padding: 15px 20px; border-radius: 8px; color: white; font-weight: 600;
        background: ${type === 'error' ? '#ef4444' : type === 'success' ? '#10b981' : '#3b82f6'};
        box-shadow: 0 4px 20px rgba(0,0,0,0.3); backdrop-filter: blur(10px);
        transform: translateX(100%); transition: transform 0.3s ease;
    `;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 100);
    
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// AI Article Generation Functions
async function generateAIGeopoliticalAnalysis() {
    const aiContainer = document.getElementById('aiAnalysisContent');
    if (!aiContainer) return;
    
    // Show loading state
    aiContainer.innerHTML = `
        <div class="ai-loading-state">
            <i class="fas fa-brain" style="font-size: 2rem; margin-bottom: 15px; opacity: 0.6; color: #46ead7;"></i>
            <h4 style="margin-bottom: 10px; color: #fff;">Generando an√°lisis geopol√≠tico avanzado...</h4>
            <p style="color: rgba(255,255,255,0.7); font-size: 0.9rem;">Nuestro periodista de IA est√° analizando los 20 art√≠culos m√°s importantes</p>
            <div class="loading-spinner" style="margin-top: 20px;">
                <i class="fas fa-spinner fa-spin" style="color: #46ead7; font-size: 1.5rem;"></i>
            </div>
        </div>
    `;
    
    try {
        // Get top 20 most important articles from global data
        const topArticles = getTopImportantArticles(20);
        
        // Generate AI analysis with Groq
        const aiArticle = await generateGroqAnalysis(topArticles);
        
        // Render the article
        renderAIArticle(aiArticle);
        
        showNotification('‚úÖ An√°lisis geopol√≠tico generado exitosamente', 'success');
        
    } catch (error) {
        console.error('Error generating AI analysis:', error);
        aiContainer.innerHTML = `
            <div class="ai-loading-state">
                <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 15px; color: #ef4444;"></i>
                <h4 style="margin-bottom: 10px; color: #ef4444;">Error al generar an√°lisis</h4>
                <p style="color: rgba(255,255,255,0.7); font-size: 0.9rem;">No se pudo conectar con el servicio de IA. Mostrando an√°lisis de ejemplo.</p>
            </div>
        `;
        
        // Show example analysis
        setTimeout(() => {
            renderExampleAIArticle();
        }, 2000);
        
        showNotification('‚ö†Ô∏è Mostrando an√°lisis de ejemplo', 'warning');
    }
}

function getTopImportantArticles(count = 20) {
    // Use global articlesData or mock data if not available
    const articles = window.articlesData || [
        {
            title: 'Escalada militar en conflicto internacional',
            content: 'Las tensiones militares han aumentado significativamente en la regi√≥n con movilizaci√≥n de tropas',
            location: 'Europa Oriental',
            risk_level: 'high',
            risk_score: 0.85,
            country: 'Ukraine',
            importance: 90
        },
        {
            title: 'Amenaza nuclear en Asia Pacific aumenta tensiones',
            content: 'Expertos en seguridad expresan preocupaci√≥n por el desarrollo de armas nucleares en la regi√≥n',
            location: 'Asia Pacific',
            risk_level: 'critical', 
            risk_score: 0.95,
            country: 'Multiple',
            importance: 95
        },
        {
            title: 'Crisis energ√©tica afecta suministros europeos',
            content: 'Los cortes de suministro energ√©tico generan preocupaci√≥n en varios pa√≠ses europeos',
            location: 'Europa',
            risk_level: 'high',
            risk_score: 0.75,
            country: 'Germany',
            importance: 80
        }
    ];
    
    // Sort by importance and get top articles
    return articles
        .sort((a, b) => (b.importance || 0) - (a.importance || 0))
        .slice(0, count);
}

async function generateGroqAnalysis(articles) {
    const response = await fetch('http://127.0.0.1:5003/api/generate-ai-analysis', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            articles: articles,
            analysis_type: 'geopolitical_journalistic',
            language: 'spanish'
        })
    });
    
    if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    return await response.json();
}

function renderAIArticle(aiData) {
    const aiContainer = document.getElementById('aiAnalysisContent');
    if (!aiContainer) return;
    
    const currentDate = new Date().toLocaleDateString('es-ES', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    });
    
    aiContainer.innerHTML = `
        <div class="ai-article-content">
            <div class="ai-article-header">
                <h1 class="ai-article-title">${aiData.title || 'An√°lisis Geopol√≠tico Global'}</h1>
                <p class="ai-article-subtitle">${aiData.subtitle || 'Perspectiva period√≠stica sobre la situaci√≥n mundial actual'}</p>
                <div class="ai-article-meta">
                    <div class="ai-meta-item">
                        <i class="fas fa-robot"></i>
                        <span>An√°lisis generado por IA</span>
                    </div>
                    <div class="ai-meta-item">
                        <i class="fas fa-calendar"></i>
                        <span>${currentDate}</span>
                    </div>
                    <div class="ai-meta-item">
                        <i class="fas fa-newspaper"></i>
                        <span>Basado en ${aiData.sources_count || 20} fuentes</span>
                    </div>
                </div>
            </div>
            <div class="ai-article-body">
                ${aiData.content || generateExampleContent()}
            </div>
            <div class="ai-article-footer">
                <p class="ai-byline">Este an√°lisis ha sido generado por inteligencia artificial bas√°ndose en las noticias m√°s relevantes del momento. Las opiniones expresadas reflejan tendencias identificadas en los datos analizados.</p>
            </div>
        </div>
    `;
}

function renderExampleAIArticle() {
    const aiContainer = document.getElementById('aiAnalysisContent');
    if (!aiContainer) return;
    
    const exampleArticle = {
        title: 'El Tablero Geopol√≠tico se Reconfigura',
        subtitle: 'Un an√°lisis de las tensiones que est√°n redefiniendo el orden mundial',
        content: generateExampleContent(),
        sources_count: 20
    };
    
    renderAIArticle(exampleArticle);
}

function generateExampleContent() {
    return `
        <p>El panorama geopol√≠tico mundial atraviesa uno de sus momentos m√°s complejos de las √∫ltimas d√©cadas. Las tensiones que se extienden desde Europa Oriental hasta el Pac√≠fico est√°n redibujando las alianzas internacionales y poniendo a prueba el orden establecido tras la Guerra Fr√≠a.</p>
        
        <p>En Europa, el conflicto en Ucrania ha consolidado la posici√≥n de la OTAN como un actor determinante en la seguridad continental. La respuesta occidental, liderada por Estados Unidos y respaldada firmemente por Reino Unido y Polonia, ha demostrado una cohesi√≥n que pocos predec√≠an. Sin embargo, las fisuras emergen cuando se analiza la dependencia energ√©tica europea, particularmente de Alemania, que se ve obligada a reconsiderar d√©cadas de pol√≠tica energ√©tica.</p>

        <p>El presidente Zelensky ha logrado mantener el apoyo internacional, aunque las elecciones en Estados Unidos podr√≠an alterar significativamente este respaldo. La fatiga b√©lica en algunos sectores de la opini√≥n p√∫blica occidental es palpable, y l√≠deres como Orb√°n en Hungr√≠a han sido voces discordantes dentro de la alianza europea.</p>

        <p>En el frente asi√°tico, las tensiones en el estrecho de Taiw√°n han escalado a niveles que recuerdan los momentos m√°s √°lgidos de la Guerra Fr√≠a. Xi Jinping ha intensificado la ret√≥rica sobre la reunificaci√≥n, mientras que la administraci√≥n estadounidense, junto con Jap√≥n y Australia, han reforzado su presencia militar en la regi√≥n. Corea del Norte, bajo Kim Jong-un, ha aprovechado estas tensiones para acelerar su programa nuclear, convirtiendo la pen√≠nsula en un nuevo punto de fricci√≥n.</p>

        <p>La crisis energ√©tica global ha puesto de manifiesto la vulnerabilidad de las cadenas de suministro internacionales. Los pa√≠ses del Golfo, liderados por Arabia Saud√≠ y Emiratos √Årabes Unidos, han recuperado protagonismo geopol√≠tico, navegando h√°bilmente entre las presiones occidentales y sus relaciones con Rusia y China. Mohammed bin Salman ha demostrado una diplomacia pragm√°tica que desaf√≠a las expectativas tradicionales.</p>

        <p>En Am√©rica Latina, el escenario es igualmente complejo. Brasil, bajo Lula da Silva, busca posicionarse como mediador en los conflictos globales, mientras que pa√≠ses como Colombia y Chile redefinen sus alianzas regionales. La influencia china en la regi√≥n crece silenciosamente, ofreciendo alternativas de inversi√≥n que compiten directamente con los tradicionales socios occidentales.</p>

        <p>√Åfrica emerge como el continente donde se libra una nueva guerra fr√≠a silenciosa. Rusia, a trav√©s del Grupo Wagner, y China, mediante su iniciativa de la Franja y la Ruta, compiten por la influencia en un continente que alberga recursos cruciales para la transici√≥n energ√©tica mundial. Francia ve erosionada su influencia tradicional en el Sahel, mientras que nuevos actores como Turqu√≠a e India buscan su espacio.</p>

        <p>El multilateralismo atraviesa una crisis profunda. Las Naciones Unidas muestran signos evidentes de obsolescencia institucional, con un Consejo de Seguridad paralizado por los vetos cruzados entre las potencias. Organizaciones como el G7 y el G20 luchan por mantener relevancia en un mundo cada vez m√°s fragmentado en bloques regionales.</p>

        <p>La tecnolog√≠a se ha convertido en el nuevo campo de batalla geopol√≠tico. La competencia entre Estados Unidos y China por el dominio de la inteligencia artificial, los semiconductores y las tecnolog√≠as 5G est√° redefiniendo las cadenas de valor globales. Europa intenta mantener su autonom√≠a estrat√©gica, pero se encuentra atrapada entre las dos superpotencias tecnol√≥gicas.</p>

        <p>Mirando hacia el futuro, tres escenarios parecen posibles: una bipolarizaci√≥n renovada entre bloques liderados por Washington y Beijing, una multipolaridad ca√≥tica donde las potencias medias ganen protagonismo, o una fragmentaci√≥n regional que privilegie las alianzas geogr√°ficas sobre las ideol√≥gicas. La pr√≥xima d√©cada ser√° crucial para determinar cu√°l de estas tendencias prevalece.</p>

        <p>Como observadores de este complejo tablero, debemos resistir la tentaci√≥n de las predicciones categ√≥ricas. La historia nos ense√±a que los momentos de mayor incertidumbre son tambi√©n los de mayor oportunidad para el cambio. Lo que s√≠ parece claro es que el orden mundial tal como lo conocemos est√° siendo desafiado desde m√∫ltiples frentes, y las decisiones que tomen los l√≠deres mundiales en los pr√≥ximos meses definir√°n el rumbo de las pr√≥ximas d√©cadas.</p>
    `;
}

function exportAIArticleToHTML() {
    const aiContent = document.querySelector('.ai-article-content');
    if (!aiContent) {
        showNotification('‚ùå No hay art√≠culo de IA para exportar', 'error');
        return;
    }
    
    const htmlContent = `
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>An√°lisis Geopol√≠tico - Stratosight AI</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: linear-gradient(180deg, #0a0f2c 0%, #1a2040 40%, #2a3558 80%, #3a4a70 100%);
            --text-primary: #e8eaed;
            --text-secondary: #b0b8c4;
            --accent-cyan: #00d4ff;
            --border-color: rgba(255, 255, 255, 0.1);
        }
        
        body {
            margin: 0;
            padding: 40px 20px;
            min-height: 100vh;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        ${document.querySelector('style').innerHTML.match(/\/\* AI Analysis Article Styles \*\/[\s\S]*?(?=\/\* Responsive Design \*\/)/)[0]}
    </style>
</head>
<body>
    <div class="container">
        ${aiContent.outerHTML}
    </div>
</body>
</html>
    `.trim();
    
    // Create and download file
    const blob = new Blob([htmlContent], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `analisis-geopolitico-${new Date().toISOString().split('T')[0]}.html`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showNotification('üìÑ Art√≠culo exportado exitosamente', 'success');
}

// Map helper functions
function updateMapWithHeatmap(data, type) {
    console.log(`Updating map with ${type} data:`, data);
    // TODO: Implement actual map update logic
}

function showMapError(message) {
    const mapContainer = document.getElementById('main-map');
    if (mapContainer) {
        mapContainer.innerHTML = `<p style="color: #ef4444;">${message}</p>`;
    }
}

function hideMapLoading() {
    // TODO: Hide loading indicator
}

// Expose functions globally for debugging
window.dashboardFunctions = {
    initializeSocketConnection,
    loadNewsMosaic,
    renderMosaic,
    loadDashboardStats,
    showNotification,
    openArticleModal,
    calculateArticleImportance,
    updateStatistics,
    setupMapControls,
    loadMapData,
    generateAIGeopoliticalAnalysis,
    exportAIArticleToHTML,
    renderExampleAIArticle
};
</script>
{% endblock %}
