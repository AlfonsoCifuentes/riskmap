{% extends "base.html" %}

{% block title %}Dashboard - Geopolitical Intelligence{% endblock %}

{% block content %}
<style>
    :root {
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        --dark-gradient: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 50%, #16213e 100%);
        --card-gradient: linear-gradient(145deg, rgba(22, 27, 34, 0.95) 0%, rgba(22, 27, 34, 0.8) 100%);
        --primary-color: #667eea;
        --secondary-color: #764ba2;
        --accent-color: #f093fb;
        --danger-color: #ff4757;
        --success-color: #2ed573;
        --warning-color: #ffa502;
        --info-color: #3742fa;
        --dark-bg: #0c0c0c;
        --card-bg: rgba(22, 27, 34, 0.9);
        --border-color: rgba(102, 126, 234, 0.2);
        --text-primary: #ffffff;
        --text-secondary: #b8bcc8;
        --text-muted: #6c7293;
        --shadow-lg: 0 20px 40px rgba(0, 0, 0, 0.4);
        --shadow-xl: 0 25px 50px rgba(0, 0, 0, 0.6);
        --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    body {
        background: var(--dark-gradient);
        color: var(--text-primary);
        font-family: 'Inter', 'Segoe UI', sans-serif;
        min-height: 100vh;
        margin: 0;
        overflow-x: hidden;
        position: relative;
    }

    /* Geopolitical particles background */
    #particles-js {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        background: linear-gradient(
            135deg, 
            rgba(13, 25, 43, 0.95) 0%, 
            rgba(27, 39, 53, 0.95) 25%,
            rgba(15, 32, 46, 0.95) 50%,
            rgba(8, 22, 36, 0.95) 75%,
            rgba(11, 19, 32, 0.95) 100%
        );
        background-attachment: fixed;
    }

    /* Enhanced glass morphism for geopolitical theme */ Glass morphism cards */
    .glass-card {
        background: var(--card-gradient);
        border: 1px solid var(--border-color);
        border-radius: 20px;
        backdrop-filter: blur(20px);
        box-shadow: var(--shadow-lg);
        transition: var(--transition);
        position: relative;
        overflow: hidden;
    }

    .glass-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent, var(--primary-color), transparent);
        opacity: 0.5;
    }

    .glass-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-xl);
        border-color: var(--primary-color);
    }

    /* Header */
    .hero-section {
        background: var(--primary-gradient);
        padding: 3rem 0;
        margin-bottom: 2rem;
        position: relative;
        overflow: hidden;
    }

    .hero-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 100" fill="rgba(255,255,255,0.1)"><polygon points="1000,100 1000,0 0,100"/></svg>');
        background-size: cover;
    }

    .hero-title {
        font-size: 3rem;
        font-weight: 700;
        color: white;
        text-shadow: 0 4px 20px rgba(0,0,0,0.3);
        margin-bottom: 1rem;
    }

    .hero-subtitle {
        font-size: 1.2rem;
        color: rgba(255,255,255,0.9);
        margin-bottom: 0;
    }

    /* Stats cards */
    .stat-card {
        background: var(--card-gradient);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 2rem;
        text-align: center;
        transition: var(--transition);
        position: relative;
        overflow: hidden;
        backdrop-filter: blur(20px);
        margin: 0.5rem 0;
        min-height: 140px;
        height: 140px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: var(--primary-gradient);
    }

    .stat-card:hover {
        transform: translateY(-8px);
        box-shadow: var(--shadow-xl);
    }

    .stat-number {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--text-primary) !important;
        margin-bottom: 0.5rem;
        display: block;
        line-height: 1.1;
        word-wrap: break-word;
        overflow-wrap: break-word;
        max-width: 100%;
    }

    .stat-number.risk-high {
        color: var(--danger-color) !important;
    }

    .stat-number.risk-medium {
        color: var(--warning-color) !important;
    }

    .stat-number.risk-low {
        color: var(--success-color) !important;
    }

    .stat-label {
        color: var(--text-secondary);
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 500;
        line-height: 1.2;
    }

    /* Article of the day */
    .article-of-day {
        background: var(--card-gradient);
        border: 1px solid var(--border-color);
        border-radius: 20px;
        overflow: hidden;
        position: relative;
        box-shadow: var(--shadow-lg);
        backdrop-filter: blur(20px);
        margin-bottom: 2rem;
    }

    .article-hero-image {
        width: 100%;
        height: 250px;
        object-fit: cover;
        filter: brightness(0.8);
        transition: var(--transition);
    }

    .article-of-day:hover .article-hero-image {
        filter: brightness(1);
        transform: scale(1.05);
    }

    .article-content {
        padding: 2rem;
        position: relative;
    }

    .risk-badge {
        position: absolute;
        top: 1rem;
        right: 1rem;
        padding: 0.5rem 1rem;
        border-radius: 25px;
        font-weight: 700;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        backdrop-filter: blur(10px);
        background: rgba(0, 0, 0, 0.7);
        border: 2px solid transparent;
    }

    .risk-critical {
        color: #ff3333;
        border-color: #ff3333;
        background: rgba(255, 51, 51, 0.1);
        text-shadow: 0 0 10px rgba(255, 51, 51, 0.8);
    }

    .risk-high {
        color: #ff4757;
        border-color: #ff4757;
        background: rgba(255, 71, 87, 0.1);
        text-shadow: 0 0 8px rgba(255, 71, 87, 0.6);
    }

    .risk-medium {
        color: #ffa502;
        border-color: #ffa502;
        background: rgba(255, 165, 2, 0.1);
        text-shadow: 0 0 8px rgba(255, 165, 2, 0.6);
    }

    .risk-low {
        color: #2ed573;
        border-color: #2ed573;
        background: rgba(46, 213, 115, 0.1);
        text-shadow: 0 0 8px rgba(46, 213, 115, 0.6);
    }

    /* Table styling */
    .modern-table {
        background: var(--card-gradient);
        border-radius: 20px;
        overflow: hidden;
        border: 1px solid var(--border-color);
        backdrop-filter: blur(20px);
        width: 100%;
        margin-bottom: 0;
    }

    .table-responsive {
        border-radius: 20px;
        overflow-x: auto;
        overflow-y: hidden;
        max-height: 600px;
        margin-bottom: 0;
    }

    .modern-table th {
        background: rgba(102, 126, 234, 0.1);
        border: none;
        color: var(--text-primary);
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.8rem;
        letter-spacing: 0.5px;
        padding: 1.5rem 1rem;
        position: sticky;
        top: 0;
        z-index: 10;
        white-space: nowrap;
    }

    .modern-table td {
        border: none;
        color: var(--text-secondary);
        padding: 1.5rem 1rem;
        vertical-align: middle;
        border-bottom: 1px solid rgba(102, 126, 234, 0.1);
        background: transparent !important;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 200px;
    }

    .modern-table td.article-title {
        max-width: 300px;
        white-space: normal;
        word-wrap: break-word;
        overflow-wrap: break-word;
        line-height: 1.4;
    }

    .modern-table tbody tr:hover {
        background: rgba(102, 126, 234, 0.1) !important;
        transform: scale(1.01);
        transition: var(--transition);
    }

    /* Article table specific styles */
    .article-image {
        width: 60px;
        height: 40px;
        object-fit: cover;
        border-radius: 8px;
        margin-right: 1rem;
    }

    .article-meta {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .source-link {
        color: var(--primary-color);
        text-decoration: none;
        font-weight: 500;
    }

    .source-link:hover {
        color: var(--accent-color);
        text-decoration: underline;
    }

    /* Fix margins and spacing */
    .container {
        padding-left: 2rem;
        padding-right: 2rem;
    }

    .card-body {
        padding: 2rem;
    }

    .glass-card .card-header {
        background: transparent !important;
        border-bottom: 1px solid var(--border-color);
        padding: 1.5rem 2rem;
    }

    .glass-card .card-body {
        padding: 2rem;
    }

    /* Language badges */
    .language-badge {
        padding: 0.4rem 0.8rem;
        border-radius: 15px;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        backdrop-filter: blur(10px);
    }

    .lang-es {
        background: linear-gradient(45deg, #ff9a9e, #fecfef);
        color: #4a4a4a;
    }

    .lang-en {
        background: linear-gradient(45deg, #a8edea, #fed6e3);
        color: #4a4a4a;
    }

    .lang-fr {
        background: linear-gradient(45deg, #ffecd2, #fcb69f);
        color: #4a4a4a;
    }

    /* Progress bars */
    .custom-progress {
        height: 10px;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.1);
        overflow: hidden;
        margin-bottom: 1rem;
    }

    .custom-progress-bar {
        height: 100%;
        border-radius: 10px;
        background: var(--primary-gradient);
        transition: width 0.8s ease;
        position: relative;
    }

    .custom-progress-bar::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }

    /* Loading states */
    .loading-spinner {
        display: inline-block;
        width: 40px;
        height: 40px;
        border: 3px solid rgba(102, 126, 234, 0.3);
        border-radius: 50%;
        border-top-color: var(--primary-color);
        animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Animations */
    .fade-in {
        animation: fadeIn 0.6s ease-out;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Responsive */
    @media (max-width: 768px) {
        .hero-title {
            font-size: 2rem;
        }
        
        .stat-number {
            font-size: 2rem;
        }
        
        .article-hero-image {
            height: 200px;
        }
        
        .article-content {
            padding: 1.5rem;
        }
        
        .container {
            padding-left: 1rem;
            padding-right: 1rem;
        }
        
        .stat-card {
            padding: 1.5rem;
            margin: 0.25rem 0;
        }
        
        .glass-card .card-body {
            padding: 1.5rem;
        }
        
        .glass-card .card-header {
            padding: 1rem 1.5rem;
        }
    }

    @media (max-width: 576px) {
        .stat-number {
            font-size: 1.8rem;
        }
        
        .stat-card {
            padding: 1rem;
        }
        
        .container {
            padding-left: 0.5rem;
            padding-right: 0.5rem;
        }
    }
    
    /* Alert Cards Styles */
    .alert-card {
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 1rem;
        border-left: 4px solid;
        transition: var(--transition);
        background: var(--card-bg);
    }

    .alert-critical {
        border-color: #dc2626;
        background: rgba(220, 38, 38, 0.1);
    }

    .alert-high {
        border-color: #ef4444;
        background: rgba(239, 68, 68, 0.1);
    }

    .alert-medium {
        border-color: #f59e0b;
        background: rgba(245, 158, 11, 0.1);
    }

    .alert-card:hover {
        transform: translateX(4px);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    }

    .alert-icon {
        font-size: 1.5rem;
        margin-right: 1rem;
        opacity: 0.8;
    }

    /* AI Badge Styles */
    .ai-badge {
        background: linear-gradient(45deg, var(--primary-color), #06b6d4);
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
    }

    /* Heatmap Styles */
    .heatmap-region {
        position: absolute;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .heatmap-region:hover {
        transform: scale(1.5);
        z-index: 10;
    }

    .heatmap-region.risk-critical {
        background: radial-gradient(circle, #dc2626, #ef4444);
        box-shadow: 0 0 20px #dc2626;
    }

    .heatmap-region.risk-high {
        background: radial-gradient(circle, #ef4444, #f97316);
        box-shadow: 0 0 15px #ef4444;
    }

    .heatmap-region.risk-medium {
        background: radial-gradient(circle, #f59e0b, #eab308);
        box-shadow: 0 0 10px #f59e0b;
    }

    .heatmap-region.risk-low {
        background: radial-gradient(circle, #10b981, #06b6d4);
        box-shadow: 0 0 8px #10b981;
    }

    /* Chart placeholder improvements */
    .chart-placeholder {
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-muted);
        font-style: italic;
        background: repeating-linear-gradient(
            45deg,
            transparent,
            transparent 10px,
            rgba(102, 126, 234, 0.05) 10px,
            rgba(102, 126, 234, 0.05) 20px
        );
    }

    /* Enhanced news items */
    .news-item-enhanced {
        padding: 1rem;
        border-bottom: 1px solid var(--border-color);
        transition: var(--transition);
        cursor: pointer;
        display: flex;
        align-items: flex-start;
        gap: 1rem;
    }

    .news-item-enhanced:hover {
        background: var(--bg-tertiary);
        border-radius: 8px;
    }

    .news-item-enhanced:last-child {
        border-bottom: none;
    }

    .news-risk-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-top: 5px;
        flex-shrink: 0;
        box-shadow: 0 0 8px rgba(0, 0, 0, 0.3);
    }

    /* Language Distribution Styles */
    .language-summary .stat-item {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        padding: 0.75rem;
        margin-bottom: 0.75rem;
    }

    .region-badge {
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
        display: inline-block;
        width: 100%;
        text-align: center;
        margin-bottom: 0.5rem;
    }

    .region-badge.critical {
        background: rgba(220, 53, 69, 0.2);
        border: 1px solid rgba(220, 53, 69, 0.5);
        color: #ff6b7a;
    }

    .region-badge.high {
        background: rgba(255, 193, 7, 0.2);
        border: 1px solid rgba(255, 193, 7, 0.5);
        color: #ffc107;
    }

    .language-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }

    .language-card {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border-color);
        border-radius: 15px;
        padding: 1rem;
        text-align: center;
        transition: var(--transition);
        position: relative;
        overflow: hidden;
    }

    .language-card:hover {
        background: rgba(255, 255, 255, 0.1);
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    .language-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: var(--primary-gradient);
        opacity: 0;
        transition: var(--transition);
    }

    .language-card:hover::before {
        opacity: 1;
    }

    .language-flag {
        font-size: 2rem;
        margin-bottom: 0.5rem;
        display: block;
    }

    .language-name {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.25rem;
    }

    .language-sources {
        color: var(--text-secondary);
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
    }

    .language-priority {
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .priority-critical {
        background: rgba(220, 53, 69, 0.2);
        color: #ff6b7a;
        border: 1px solid rgba(220, 53, 69, 0.3);
    }

    .priority-high {
        background: rgba(255, 193, 7, 0.2);
        color: #ffc107;
        border: 1px solid rgba(255, 193, 7, 0.3);
    }

    .priority-medium {
        background: rgba(13, 202, 240, 0.2);
        color: #0dcaf0;
        border: 1px solid rgba(13, 202, 240, 0.3);
    }
</style>

<!-- Splash Sonar Animation -->
<div id="splash-screen" style="position:fixed;z-index:9999;top:0;left:0;width:100vw;height:100vh;background:radial-gradient(circle at 50% 50%, #16213e 0%, #0c0c0c 100%);display:flex;align-items:center;justify-content:center;">
  <div style="position:relative;width:320px;height:320px;">
    <div id="sonar-circle" style="position:absolute;top:0;left:0;width:100%;height:100%;border-radius:50%;border:4px solid #667eea;box-shadow:0 0 60px #667eea;animation:sonarPulse 2.5s infinite;"></div>
    <div id="sonar-sweep" style="position:absolute;top:0;left:0;width:100%;height:100%;border-radius:50%;background:conic-gradient(from 0deg, rgba(102,126,234,0.2) 0deg, rgba(102,126,234,0.5) 60deg, transparent 120deg, transparent 360deg);animation:sonarSweep 2.5s linear infinite;"></div>
    <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);">
      <h1 style="font-size:2.8rem;font-weight:900;color:#fff;text-shadow:0 0 30px #667eea,0 0 10px #16213e;letter-spacing:2px;">Riskmap</h1>
      <div style="text-align:center;color:#b8bcc8;font-size:1.1rem;margin-top:0.5rem;">Geopolitical Intelligence powered by AI</div>
    </div>
  </div>
</div>
<style>
@keyframes sonarPulse {
  0% { box-shadow:0 0 60px #667eea,0 0 0px #667eea; }
  70% { box-shadow:0 0 120px #667eea,0 0 40px #667eea; }
  100% { box-shadow:0 0 60px #667eea,0 0 0px #667eea; }
}
@keyframes sonarSweep {
  0% { transform:rotate(0deg); }
  100% { transform:rotate(360deg); }
}
</style>
<script>
document.addEventListener('DOMContentLoaded',function(){
  setTimeout(function(){
    document.getElementById('splash-screen').style.opacity='0';
    setTimeout(function(){document.getElementById('splash-screen').style.display='none';},600);
  },2200);
});
</script>

<!-- Hero Section -->
<div class="hero-section">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="hero-title">
                    <i class="fas fa-globe-americas me-3"></i>
                    <span data-i18n="riskmap_title">Riskmap-Geopolitical Intelligence powered by AI</span>
                </h1>
                <p class="hero-subtitle"><span data-i18n="hero_subtitle">Real-time monitoring and analysis of global geopolitical events</span></p>
            </div>
            <div class="col-md-4 text-end">
                <div class="d-flex align-items-center justify-content-end">
                    <div class="me-3">
                        <select id="language-selector" class="form-select form-select-sm" style="width: auto; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white;">
                            <option value="en">🇺🇸 English</option>
                            <option value="es">🇪🇸 Español</option>
                            <option value="de">🇩🇪 Deutsch</option>
                            <option value="fr">🇫🇷 Français</option>
                            <option value="it">🇮🇹 Italiano</option>
                            <option value="ru">🇷🇺 Русский</option>
                            <option value="zh">🇨🇳 中文</option>
                            <option value="ja">🇯🇵 日本語</option>
                        </select>
                    </div>
                    <div class="me-3">
                        <div class="text-white-50 small" data-i18n="last_update">Last Update</div>
                        <div class="text-white" id="last-update">--</div>
                    </div>
                    <div class="loading-spinner" id="loading-indicator" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="stat-card fade-in">
                <div class="stat-number" id="total-articles">-</div>
                <div class="stat-label"><span data-i18n="total_articles">Total Articles</span></div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="stat-card fade-in" style="animation-delay: 0.1s;">
                <div class="stat-number" id="articles-week">-</div>
                <div class="stat-label">This Week</div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="stat-card fade-in" style="animation-delay: 0.2s;">
                <div class="stat-number" id="languages-count">-</div>
                <div class="stat-label">Languages</div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="stat-card fade-in" style="animation-delay: 0.3s;">
                <div class="stat-number" id="risk-level">-</div>
                <div class="stat-label">Risk Level</div>
            </div>
        </div>
    </div>

    <!-- Article of the Day -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="article-of-day fade-in position-relative d-flex flex-column flex-md-row align-items-stretch" style="animation-delay: 0.4s; cursor:pointer;">
                <!-- Image Section -->
                <div class="flex-shrink-0 position-relative" style="flex: 0 0 40%; min-height: 260px;">
                    <img src="" alt="Article of the Day" class="article-hero-image" id="article-image" style="width:100%;height:100%;object-fit:cover;">
                    <div class="position-absolute top-0 start-0 p-3" style="z-index:2;">
                        <span class="risk-badge" id="article-risk-badge">HIGH RISK</span>
                    </div>
                    <div class="position-absolute bottom-0 start-0 p-3 d-md-none w-100" style="background:rgba(0,0,0,0.6);color:#fff;">
                        <span class="language-badge" id="article-language-mobile">EN</span>
                        <span class="ms-2" id="article-source-mobile">Source loading...</span>
                        <span class="ms-2" id="article-date-mobile">Date loading...</span>
                    </div>
                </div>
                
                <!-- Content Section -->
                <div class="article-content flex-grow-1 d-flex flex-column justify-content-center p-4" style="flex: 1 1 60%; min-width:0;">
                    <h3 class="mb-3 fw-bold" id="article-title" style="color: var(--text-primary); line-height: 1.3;">Article of the Day Loading...</h3>
                    <p class="mb-4" id="article-summary" style="color: #87ceeb; line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;">Loading the most relevant geopolitical article...</p>
                    
                    <!-- Desktop metadata -->
                    <div class="d-flex justify-content-between align-items-center d-none d-md-flex mt-auto">
                        <div class="d-flex align-items-center">
                            <span class="language-badge me-2" id="article-language">EN</span>
                            <small class="text-muted" id="article-source">Source loading...</small>
                        </div>
                        <small class="text-muted" id="article-date">Date loading...</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Interactive Heatmap Section -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="glass-card fade-in" style="animation-delay:0.45s;">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-fire-alt me-2"></i>Mapa de Calor de Conflictos Geopolíticos</h5>
            <div>
              <label for="conflictType" class="me-2" style="color: var(--text-color);">Tipo de Conflicto:</label>
              <select id="conflictType" class="form-select form-select-sm" style="width:auto;display:inline-block;background-color: rgba(255, 255, 255, 0.1);color: var(--text-color);border: 1px solid rgba(255, 255, 255, 0.2);">
                <option value="all">Todos</option>
                <option value="Military">Militar</option>
                <option value="Political">Político</option>
                <option value="Economic">Económico</option>
                <option value="Social">Social</option>
                <option value="Cybersecurity">Ciberseguridad</option>
                <option value="Natural Disaster">Desastres Naturales</option>
              </select>
            </div>
          </div>
          <div class="card-body" style="min-height:450px;position:relative;">
            <div id="heatmap-container" style="width:100%;height:400px;border-radius:16px;overflow:hidden;"></div>
            <div id="heatmap-legend" class="mt-3 d-flex gap-3 justify-content-center">
              <!-- La leyenda se puede generar dinámicamente con el mapa si es necesario -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- AI Generated Analysis -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="glass-card fade-in" style="animation-delay:0.5s;">
          <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-robot me-2"></i>Análisis Geopolítico por IA</h5>
          </div>
          <div class="card-body p-0" id="ai-analysis-content">
            <div class="text-center py-5">
              <div class="loading-spinner"></div>
              <p class="mt-3" style="color: var(--text-color-secondary);">Generando análisis de inteligencia en tiempo real...</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Language Distribution (Enhanced - Above articles table) -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="glass-card fade-in" style="animation-delay: 0.55s;">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-language me-2"></i>Distribución de Idiomas Globales
                    </h5>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-light active" onclick="updateLanguageView('chart')" id="chart-view-btn">
                            <i class="fas fa-chart-pie me-1"></i>Gráfico
                        </button>
                        <button type="button" class="btn btn-outline-light" onclick="updateLanguageView('grid')" id="grid-view-btn">
                            <i class="fas fa-th me-1"></i>Cuadrícula
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Chart View -->
                    <div id="language-chart-view">
                        <div class="row">
                            <div class="col-lg-8">
                                <div id="language-stats" style="height: 350px;">
                                    <div class="text-center py-4">
                                        <div class="loading-spinner"></div>
                                        <div class="mt-2 text-muted">Cargando distribución de idiomas...</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="language-summary">
                                    <h6 class="text-muted mb-3">
                                        <i class="fas fa-info-circle me-2"></i>Resumen de Cobertura
                                    </h6>
                                    <div class="stats-grid">
                                        <div class="stat-item mb-3">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span class="stat-label">Total de Idiomas</span>
                                                <span class="stat-value text-primary fw-bold" id="total-languages-count">15+</span>
                                            </div>
                                        </div>
                                        <div class="stat-item mb-3">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span class="stat-label">Fuentes Activas</span>
                                                <span class="stat-value text-success fw-bold" id="active-sources-count">200+</span>
                                            </div>
                                        </div>
                                        <div class="stat-item mb-3">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span class="stat-label">Zonas de Conflicto</span>
                                                <span class="stat-value text-warning fw-bold" id="conflict-zones-count">8</span>
                                            </div>
                                        </div>
                                        <div class="stat-item mb-3">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span class="stat-label">Cobertura Global</span>
                                                <span class="stat-value text-info fw-bold" id="global-coverage">90%</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-4">
                                        <h6 class="text-muted mb-3">
                                            <i class="fas fa-globe-americas me-2"></i>Regiones Prioritarias
                                        </h6>
                                        <div class="priority-regions">
                                            <div class="region-badge critical mb-2">
                                                <i class="fas fa-exclamation-triangle me-1"></i>
                                                Europa Oriental
                                            </div>
                                            <div class="region-badge critical mb-2">
                                                <i class="fas fa-exclamation-triangle me-1"></i>
                                                Medio Oriente
                                            </div>
                                            <div class="region-badge high mb-2">
                                                <i class="fas fa-exclamation-circle me-1"></i>
                                                Asia Central
                                            </div>
                                            <div class="region-badge high mb-2">
                                                <i class="fas fa-exclamation-circle me-1"></i>
                                                Cáucaso
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Grid View -->
                    <div id="language-grid-view" style="display: none;">
                        <div class="language-grid" id="language-grid">
                            <!-- Grid will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Articles (Full Width) -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="glass-card fade-in" style="animation-delay: 0.6s;">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-newspaper me-2"></i><span data-i18n="recent_articles">Artículos Recientes</span>
                    </h5>
                    <button class="btn btn-sm" style="background: var(--primary-gradient); color: white; border: none; border-radius: 10px;" onclick="fetchRecentArticles()">
                        <i class="fas fa-sync-alt me-1"></i><span data-i18n="refresh">Actualizar</span>
                    </button>
                </div>
                
                <!-- Filtros y Ordenamiento -->
                <div class="p-3" style="background: rgba(255,255,255,0.05); border-top: 1px solid rgba(179, 197, 255, 0.2);">
                    <div class="row g-2">
                        <div class="col-md-3">
                            <label class="form-label small" style="color: #b3c5ff; font-size: 0.85em;">Filtrar por Riesgo:</label>
                            <select id="risk-filter" class="form-select form-select-sm" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(179, 197, 255, 0.3); color: white; font-size: 0.85em;">
                                <option value="">Todos los Niveles</option>
                                <option value="high">Alto</option>
                                <option value="medium">Medio</option>
                                <option value="low">Bajo</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small" style="color: #b3c5ff; font-size: 0.85em;">Filtrar por Fuente:</label>
                            <select id="source-filter" class="form-select form-select-sm" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(179, 197, 255, 0.3); color: white; font-size: 0.85em;">
                                <option value="">Todas las Fuentes</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small" style="color: #b3c5ff; font-size: 0.85em;">Filtrar por Idioma:</label>
                            <select id="language-filter" class="form-select form-select-sm" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(179, 197, 255, 0.3); color: white; font-size: 0.85em;">
                                <option value="">Todos los Idiomas</option>
                                <option value="es">Español</option>
                                <option value="en">Inglés</option>
                                <option value="fr">Francés</option>
                                <option value="de">Alemán</option>
                                <option value="it">Italiano</option>
                                <option value="pt">Portugués</option>
                                <option value="ru">Ruso</option>
                                <option value="zh">Chino</option>
                                <option value="ar">Árabe</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small" style="color: #b3c5ff; font-size: 0.85em;">Ordenar por:</label>
                            <select id="sort-filter" class="form-select form-select-sm" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(179, 197, 255, 0.3); color: white; font-size: 0.85em;">
                                <option value="published_at_desc">Fecha (Más Reciente)</option>
                                <option value="published_at_asc">Fecha (Más Antigua)</option>
                                <option value="risk_desc">Riesgo (Alto a Bajo)</option>
                                <option value="risk_asc">Riesgo (Bajo a Alto)</option>
                                <option value="title_asc">Título (A a Z)</option>
                                <option value="title_desc">Título (Z a A)</option>
                                <option value="source_asc">Fuente (A a Z)</option>
                                <option value="source_desc">Fuente (Z a A)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="card-body" style="padding: 0;">
                    <div class="table-responsive">
                        <table class="table modern-table mb-0">
                            <thead>
                                <tr>
                                    <th style="color: var(--text-color);"><span data-i18n="article">Artículo</span></th>
                                    <th style="color: var(--text-color);"><span data-i18n="source">Fuente</span></th>
                                    <th style="color: var(--text-color);"><span data-i18n="language">Idioma</span></th>
                                    <th style="color: var(--text-color);"><span data-i18n="risk_level">Riesgo</span></th>
                                    <th style="color: var(--text-color);"><span data-i18n="type">Tipo</span></th>
                                    <th style="color: var(--text-color);"><span data-i18n="published">Fecha</span></th>
                                    <th style="color: var(--text-color);"><span data-i18n="action">Acción</span></th>
                                </tr>
                            </thead>
                            <tbody id="articles-table-body">
                                <!-- Las filas de artículos se insertarán aquí dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- High Risk Articles Table -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="glass-card fade-in" style="animation-delay: 0.8s;">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-exclamation-triangle me-2" style="color: #ff6b6b;"></i><span data-i18n="high_risk_articles">Artículos de Mayor Riesgo</span>
                    </h5>
                    <button class="btn btn-sm" style="background: linear-gradient(45deg, #ff6b6b, #ff8e8e); color: white; border: none; border-radius: 10px;" onclick="fetchHighRiskArticles()">
                        <i class="fas fa-sync-alt me-1"></i><span data-i18n="refresh">Actualizar</span>
                    </button>
                </div>
                
                <div class="card-body" style="padding: 0;">
                    <div class="table-responsive">
                        <table class="table modern-table mb-0">
                            <thead>
                                <tr>
                                    <th style="color: var(--text-color);"><span data-i18n="article">Artículo</span></th>
                                    <th style="color: var(--text-color);"><span data-i18n="source">Fuente</span></th>
                                    <th style="color: var(--text-color);"><span data-i18n="location">Ubicación</span></th>
                                    <th style="color: var(--text-color);"><span data-i18n="risk_score">Puntaje de Riesgo</span></th>
                                    <th style="color: var(--text-color);"><span data-i18n="language">Idioma</span></th>
                                    <th style="color: var(--text-color);"><span data-i18n="published">Fecha</span></th>
                                    <th style="color: var(--text-color);"><span data-i18n="action">Acción</span></th>
                                </tr>
                            </thead>
                            <tbody id="high-risk-table-body">
                                <!-- Las filas de artículos de alto riesgo se insertarán aquí dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="particles-js" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
// Global variables
let summaryData = {};
let articlesData = [];

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 Dashboard initializing...');
    loadDashboardData();
    setInterval(loadDashboardData, 30000); // Refresh every 30 seconds
});

// Load dashboard data
async function loadDashboardData() {
    console.log('📊 Loading dashboard data...');
    const loadingIndicator = document.getElementById('loading-indicator');
    if (loadingIndicator) {
        loadingIndicator.style.display = 'block';
    }
    
    try {
        console.log('🌐 Fetching /api/summary...');
        const response = await fetch('/api/summary');
        console.log('📥 Response status:', response.status);
        summaryData = await response.json();
        console.log('✅ Summary data loaded:', summaryData);
        
        updateStats();
        updateArticleOfDay();
        updateLanguageStats();
        loadArticles();
        
        document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
        console.log('✅ Dashboard data loaded successfully');
    } catch (error) {
        console.error('❌ Error loading dashboard data:', error);
    } finally {
        if (loadingIndicator) {
            loadingIndicator.style.display = 'none';
        }
    }
}

// Update statistics
function updateStats() {
    document.getElementById('total-articles').textContent = summaryData.total_articles || '0';
    document.getElementById('articles-week').textContent = summaryData.articles_week || '0';
    document.getElementById('languages-count').textContent = summaryData.languages_count || '0';
    
    const riskLevel = summaryData.global_risk_level || 'LOW';
    const riskElement = document.getElementById('risk-level');
    riskElement.textContent = riskLevel;
    riskElement.className = 'stat-number risk-' + riskLevel.toLowerCase();
}

// Update article of the day
async function updateArticleOfDay() {
    try {
        console.log('🔄 updateArticleOfDay: Starting...');
        const response = await fetch('/api/article-of-day');
        console.log('🔄 updateArticleOfDay: Response received, status:', response.status);
        
        const data = await response.json();
        console.log('🔄 updateArticleOfDay: Data parsed:', data);
        
        if (response.ok && data) {
            console.log('✅ updateArticleOfDay: Response OK and data exists');
            // El endpoint devuelve directamente el artículo, no dentro de data.article
            const article = data;
            
            // Verificar si los elementos existen antes de actualizar
            const titleElement = document.getElementById('article-title');
            const summaryElement = document.getElementById('article-summary');
            const sourceElement = document.getElementById('article-source');
            const dateElement = document.getElementById('article-date');
            const imageElement = document.getElementById('article-image');
            
            console.log('🔍 updateArticleOfDay: Element check:');
            console.log('  article-title:', titleElement ? '✅' : '❌');
            console.log('  article-summary:', summaryElement ? '✅' : '❌');
            console.log('  article-source:', sourceElement ? '✅' : '❌');
            console.log('  article-date:', dateElement ? '✅' : '❌');
            console.log('  article-image:', imageElement ? '✅' : '❌');
            
            // Actualizar elementos principales
            if (titleElement) {
                titleElement.textContent = article.title;
                console.log('✅ Title updated:', article.title);
            }
            if (summaryElement) {
                summaryElement.textContent = article.content || 'No summary available';
                console.log('✅ Summary updated');
            }
            if (sourceElement) {
                sourceElement.textContent = article.source;
                console.log('✅ Source updated:', article.source);
            }
            if (dateElement) {
                dateElement.textContent = new Date(article.created_at).toLocaleDateString();
                console.log('✅ Date updated');
            }
            
            // Actualizar elementos móviles
            const sourceMobileElement = document.getElementById('article-source-mobile');
            const dateMobileElement = document.getElementById('article-date-mobile');
            if (sourceMobileElement) {
                sourceMobileElement.textContent = article.source;
                console.log('✅ Mobile source updated');
            }
            if (dateMobileElement) {
                dateMobileElement.textContent = new Date(article.created_at).toLocaleDateString();
                console.log('✅ Mobile date updated');
            }
            
            // Update image
            if (imageElement) {
                imageElement.src = article.image_url || 'https://images.unsplash.com/photo-1504711434969-e33886168f5c?ixlib=rb-4.0.3&auto=format&fit=crop&w=1000&q=80';
                imageElement.alt = article.title;
                console.log('✅ Image updated:', imageElement.src);
            }
            
            // Update language badges (both desktop and mobile)
            const langBadge = document.getElementById('article-language');
            const langBadgeMobile = document.getElementById('article-language-mobile');
            if (langBadge && article.language) {
                langBadge.textContent = article.language.toUpperCase();
                langBadge.className = `language-badge lang-${article.language}`;
                console.log('✅ Language badge updated:', article.language);
            }
            if (langBadgeMobile && article.language) {
                langBadgeMobile.textContent = article.language.toUpperCase();
                langBadgeMobile.className = `language-badge lang-${article.language}`;
                console.log('✅ Mobile language badge updated');
            }
            
            // Update risk badge
            const riskBadge = document.getElementById('article-risk-badge');
            if (riskBadge && article.risk_level) {
                riskBadge.className = `risk-badge risk-${article.risk_level.toLowerCase()}`;
                riskBadge.textContent = article.risk_level + ' RISK';
                console.log('✅ Risk badge updated:', article.risk_level);
            }
            
            // Make article clickable
            const articleElement = document.querySelector('.article-of-day');
            if (articleElement) {
                articleElement.style.cursor = 'pointer';
                articleElement.onclick = () => {
                    if (article.url) {
                        window.open(article.url, '_blank');
                    }
                };
                console.log('✅ Article clickable updated');
            }
            
            console.log('🎉 updateArticleOfDay: Article loaded successfully:', article.title);
        } else {
            console.error('❌ updateArticleOfDay: Article of day response not OK or empty data');
            console.error('   Response ok:', response.ok);
            console.error('   Data:', data);
        }
    } catch (error) {
        console.error('Error loading article of the day:', error);
        // Fallback to recent articles data
        if (summaryData.recent_articles && summaryData.recent_articles.length > 0) {
            const article = summaryData.recent_articles[0];
            document.getElementById('article-title').textContent = article.title;
            document.getElementById('article-summary').textContent = 'Click to read more...';
            document.getElementById('article-source').textContent = article.source;
            document.getElementById('article-date').textContent = new Date(article.created_at).toLocaleDateString();
            
            // Fallback para elementos móviles
            document.getElementById('article-source-mobile').textContent = article.source;
            document.getElementById('article-date-mobile').textContent = new Date(article.created_at).toLocaleDateString();
            
            const langBadge = document.getElementById('article-language');
            const langBadgeMobile = document.getElementById('article-language-mobile');
            if (langBadge) {
                langBadge.textContent = article.language.toUpperCase();
                langBadge.className = `language-badge lang-${article.language}`;
            }
            if (langBadgeMobile) {
                langBadgeMobile.textContent = article.language.toUpperCase();
                langBadgeMobile.className = `language-badge lang-${article.language}`;
            }
            const imageElement = document.getElementById('article-image');
            if (imageElement) {
                imageElement.src = article.image_url || 'https://images.unsplash.com/photo-1504711434969-e33886168f5c?ixlib=rb-4.0.3&auto=format&fit=crop&w=1000&q=80';
                imageElement.alt = article.title;
            }
        }
    }
}

// Update language statistics with enhanced multilingual support
function updateLanguageStats() {
    const container = document.getElementById('language-stats');
    
    // Enhanced language data with comprehensive multilingual support
    const enhancedLanguageData = {
        'uk': { name: 'Українська (Ukrainian)', flag: '🇺🇦', priority: 'critical', region: 'Europa Oriental', sources: 45 },
        'en': { name: 'English', flag: '🇺🇸', priority: 'high', region: 'Global', sources: 65 },
        'es': { name: 'Español', flag: '🇪🇸', priority: 'high', region: 'Global', sources: 38 },
        'ar': { name: 'العربية (Arabic)', flag: '🇸🇦', priority: 'critical', region: 'Medio Oriente', sources: 42 },
        'he': { name: 'עברית (Hebrew)', flag: '🇮🇱', priority: 'critical', region: 'Medio Oriente', sources: 35 },
        'tr': { name: 'Türkçe (Turkish)', flag: '🇹🇷', priority: 'critical', region: 'Eurasia', sources: 28 },
        'fa': { name: 'فارسی (Persian)', flag: '🇮🇷', priority: 'critical', region: 'Asia Central', sources: 25 },
        'ru': { name: 'Русский (Russian)', flag: '🇷🇺', priority: 'high', region: 'Europa Oriental', sources: 32 },
        'my': { name: 'မြန်မာ (Myanmar)', flag: '🇲🇲', priority: 'critical', region: 'Asia Sudoriental', sources: 18 },
        'hi': { name: 'हिन्दी (Hindi)', flag: '🇮🇳', priority: 'high', region: 'Asia Meridional', sources: 22 },
        'ur': { name: 'اردو (Urdu)', flag: '🇵🇰', priority: 'high', region: 'Asia Meridional', sources: 20 },
        'ps': { name: 'پښتو (Pashto)', flag: '🇦🇫', priority: 'critical', region: 'Asia Central', sources: 15 },
        'ku': { name: 'کوردی (Kurdish)', flag: '🏴󠁧󠁢󠁥󠁮󠁧󠁿', priority: 'critical', region: 'Medio Oriente', sources: 12 },
        'hy': { name: 'Հայերեն (Armenian)', flag: '🇦🇲', priority: 'high', region: 'Cáucaso', sources: 14 },
        'az': { name: 'Azərbaycan (Azerbaijani)', flag: '🇦🇿', priority: 'high', region: 'Cáucaso', sources: 11 },
        'zh': { name: '中文 (Chinese)', flag: '🇨🇳', priority: 'medium', region: 'Asia Oriental', sources: 28 },
        'fr': { name: 'Français', flag: '🇫🇷', priority: 'medium', region: 'Europa Occidental', sources: 24 },
        'de': { name: 'Deutsch', flag: '🇩🇪', priority: 'medium', region: 'Europa Central', sources: 26 }
    };
    
    // Get actual data or use enhanced defaults
    const actualData = summaryData.language_distribution || {};
    
    // Combine actual data with enhanced language info
    const combinedData = Object.keys(enhancedLanguageData).map(lang => {
        const count = actualData[lang] || enhancedLanguageData[lang].sources;
        return {
            code: lang,
            count: count,
            ...enhancedLanguageData[lang]
        };
    });
    
    const total = combinedData.reduce((sum, item) => sum + item.count, 0);
    
    // Create Plotly chart
    const chartData = [{
        values: combinedData.map(item => item.count),
        labels: combinedData.map(item => `${item.flag} ${item.name.split('(')[0].trim()}`),
        type: 'pie',
        hole: 0.4,
        marker: {
            colors: [
                '#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe', '#00f2fe',
                '#43e97b', '#38f9d7', '#ffecd2', '#fcb69f', '#a8edea', '#fed6e3',
                '#d299c2', '#fef9d7', '#667eea', '#764ba2', '#f093fb', '#f5576c'
            ]
        },
        textinfo: 'label+percent',
        textposition: 'outside',
        hovertemplate: '<b>%{label}</b><br>Fuentes: %{value}<br>Porcentaje: %{percent}<extra></extra>'
    }];
    
    const layout = {
        showlegend: false,
        margin: { t: 40, b: 40, l: 40, r: 40 },
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        font: {
            color: '#e2e8f0',
            family: 'Inter, system-ui, sans-serif'
        },
        annotations: [{
            text: `${combinedData.length}<br><span style="font-size:14px;">Idiomas</span>`,
            x: 0.5, y: 0.5,
            font: { size: 24, color: '#667eea', family: 'Inter' },
            showarrow: false
        }]
    };
    
    const config = {
        responsive: true,
        displayModeBar: false
    };
    
    Plotly.newPlot(container, chartData, layout, config);
    
    // Update stats
    updateLanguageGridView(combinedData);
    updateLanguageCounters(combinedData, total);
}

// Language view switching
function updateLanguageView(viewType) {
    const chartView = document.getElementById('language-chart-view');
    const gridView = document.getElementById('language-grid-view');
    const chartBtn = document.getElementById('chart-view-btn');
    const gridBtn = document.getElementById('grid-view-btn');
    
    if (viewType === 'chart') {
        chartView.style.display = 'block';
        gridView.style.display = 'none';
        chartBtn.classList.add('active');
        gridBtn.classList.remove('active');
    } else {
        chartView.style.display = 'none';
        gridView.style.display = 'block';
        chartBtn.classList.remove('active');
        gridBtn.classList.add('active');
    }
}

// Update language grid view
function updateLanguageGridView(languageData) {
    const gridContainer = document.getElementById('language-grid');
    
    const html = languageData.map(lang => `
        <div class="language-card">
            <div class="language-flag">${lang.flag}</div>
            <div class="language-name">${lang.name.split('(')[0].trim()}</div>
            <div class="language-sources">${lang.count} fuentes</div>
            <div class="language-priority priority-${lang.priority}">${lang.priority}</div>
            <div class="mt-2 small text-muted">${lang.region}</div>
        </div>
    `).join('');
    
    gridContainer.innerHTML = html;
}

// Update language counters
function updateLanguageCounters(languageData, total) {
    document.getElementById('total-languages-count').textContent = languageData.length;
    document.getElementById('active-sources-count').textContent = `${total}+`;
    
    const criticalCount = languageData.filter(lang => lang.priority === 'critical').length;
    document.getElementById('conflict-zones-count').textContent = criticalCount;
    
    const coverage = Math.round((languageData.length / 18) * 100);
    document.getElementById('global-coverage').textContent = `${coverage}%`;
}

// Load articles
async function loadArticles() {
    console.log('📰 Loading articles...');
    try {
        const response = await fetch('/api/articles?limit=20');
        console.log('📰 Articles API response status:', response.status);
        const data = await response.json();
        console.log('📰 Articles data received:', data);
        
        articlesData = data.articles || [];
        filteredArticlesData = [...articlesData]; // Inicializar datos filtrados
        console.log('📰 Articles count:', articlesData.length);
        
        // Poblar filtro de fuentes y configurar listeners
        populateSourceFilter();
        setupFilterListeners();
        
        // Aplicar filtros iniciales
        filterAndSortArticles();
        
    } catch (error) {
        console.error('❌ Error loading articles:', error);
        const tbody = document.getElementById('articles-table-body');
        if (tbody) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger py-4">Failed to load articles</td></tr>';
        }
    }
}

// Update articles table
function updateArticlesTable() {
    console.log('📊 Updating articles table with', articlesData.length, 'articles');
    const tbody = document.getElementById('articles-table-body');
    
    if (!tbody) {
        console.error('❌ articles-table-body element not found');
        return;
    }
    
    if (articlesData.length === 0) {
        console.log('⚠️ No articles to display');
        tbody.innerHTML = '<tr><td colspan="7" class="text-center" style="color: var(--text-color-secondary);">No articles found.</td></tr>';
        return;
    }

    const html = articlesData.slice(0, 10).map(article => {
        // Función para obtener el color del riesgo
        const getRiskColor = (risk) => {
            switch(risk?.toLowerCase()) {
                case 'critical': return '#ff3333';
                case 'high': return '#ff4757';
                case 'medium': return '#ffa502';
                case 'low': return '#2ed573';
                default: return '#6c7293';
            }
        };

        return `
        <tr>
            <td>
                <div style="max-width: 300px;">
                    <div class="fw-semibold text-primary mb-1" style="font-size: 0.9rem; line-height: 1.3;">
                        ${article.title && article.title.length > 80 ? article.title.substring(0, 80) + '...' : (article.title || 'Sin título')}
                    </div>
                    ${article.content ? `<small style="color: #87ceeb;">${article.content.substring(0, 100)}...</small>` : ''}
                </div>
            </td>
            <td>
                <span class="text-secondary">${article.source || 'Fuente desconocida'}</span>
            </td>
            <td>
                <span class="language-badge lang-${article.language || 'unknown'}">${(article.language || 'N/A').toUpperCase()}</span>
            </td>
            <td>
                <span style="color: ${getRiskColor(article.risk_level)}; font-weight: 600; font-size: 0.85rem;">
                    ${article.risk_level || 'N/A'}
                </span>
            </td>
            <td>
                <span style="color: var(--text-secondary); font-size: 0.85rem;">
                    ${article.conflict_type || 'N/A'}
                </span>
            </td>
            <td>
                <small class="text-muted">${article.created_at ? new Date(article.created_at).toLocaleDateString() : 'Sin fecha'}</small>
            </td>
            <td>
                <button class="btn btn-sm" style="background: var(--primary-gradient); color: white; border: none; border-radius: 8px;" 
                        onclick="viewArticle('${article.url || '#'}')">
                    <i class="fas fa-eye"></i>
                </button>
            </td>
        </tr>
        `;
    }).join('');

    tbody.innerHTML = html;
    console.log('✅ Articles table updated successfully with', articlesData.slice(0, 10).length, 'rows');
}

// Variables para filtrado y ordenamiento
let filteredArticlesData = [];

// Filtrar y ordenar artículos
function filterAndSortArticles() {
    const riskFilter = document.getElementById('risk-filter').value;
    const sourceFilter = document.getElementById('source-filter').value;
    const sortFilter = document.getElementById('sort-filter').value;
    
    // Filtrar datos
    filteredArticlesData = articlesData.filter(article => {
        let passRiskFilter = !riskFilter || (article.risk_level && article.risk_level.toLowerCase() === riskFilter);
        let passSourceFilter = !sourceFilter || (article.source && article.source.toLowerCase().includes(sourceFilter.toLowerCase()));
        return passRiskFilter && passSourceFilter;
    });
    
    // Ordenar datos
    filteredArticlesData.sort((a, b) => {
        switch(sortFilter) {
            case 'published_at_desc':
                return new Date(b.published_at || b.created_at) - new Date(a.published_at || a.created_at);
            case 'published_at_asc':
                return new Date(a.published_at || a.created_at) - new Date(b.published_at || b.created_at);
            case 'risk_desc':
                const riskOrder = {'high': 3, 'medium': 2, 'low': 1};
                return (riskOrder[b.risk_level?.toLowerCase()] || 0) - (riskOrder[a.risk_level?.toLowerCase()] || 0);
            case 'risk_asc':
                const riskOrderAsc = {'high': 3, 'medium': 2, 'low': 1};
                return (riskOrderAsc[a.risk_level?.toLowerCase()] || 0) - (riskOrderAsc[b.risk_level?.toLowerCase()] || 0);
            case 'source_asc':
                return (a.source || '').localeCompare(b.source || '');
            case 'source_desc':
                return (b.source || '').localeCompare(a.source || '');
            default:
                return 0;
        }
    });
    
    // Actualizar tabla con datos filtrados
    updateFilteredArticlesTable();
}

// Actualizar tabla con datos filtrados
function updateFilteredArticlesTable() {
    const tbody = document.getElementById('articles-table-body');
    if (!tbody) return;

    if (filteredArticlesData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4">No se encontraron artículos con los filtros aplicados</td></tr>';
        return;
    }

    const html = filteredArticlesData.slice(0, 20).map(article => {
        const summary = article.ai_summary || article.summary || 'No summary available';
        const shortSummary = summary.length > 100 ? summary.substring(0, 100) + '...' : summary;
        const riskLevel = article.risk_level || 'unknown';
        const conflictType = article.conflict_type || 'General';
        const publishedDate = article.published_at || article.created_at;
        const formattedDate = publishedDate ? new Date(publishedDate).toLocaleDateString('es-ES') : 'N/A';
        
        let riskBadgeClass = '';
        let riskText = '';
        switch(riskLevel.toLowerCase()) {
            case 'high':
                riskBadgeClass = 'danger';
                riskText = 'Alto';
                break;
            case 'medium':
                riskBadgeClass = 'warning';
                riskText = 'Medio';
                break;
            case 'low':
                riskBadgeClass = 'success';
                riskText = 'Bajo';
                break;
            default:
                riskBadgeClass = 'secondary';
                riskText = 'N/A';
        }

        return `
        <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
            <td>
                <div class="d-flex align-items-center">
                    <div class="me-3" style="min-width: 60px;">
                        <img src="${article.image_url || 'https://via.placeholder.com/60x40/1a1a2e/ffffff?text=News'}" 
                             alt="Article" 
                             style="width: 60px; height: 40px; object-fit: cover; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);"
                             onerror="this.src='https://via.placeholder.com/60x40/1a1a2e/ffffff?text=News'">
                    </div>
                    <div>
                        <div class="fw-semibold text-light mb-1" style="font-size: 0.9rem; line-height: 1.2;">
                            ${article.title.substring(0, 80)}${article.title.length > 80 ? '...' : ''}
                        </div>
                        <div class="text-muted small" style="color: #b3c5ff !important; font-size: 0.8rem;">
                            ${shortSummary}
                        </div>
                    </div>
                </div>
            </td>
            <td style="color: var(--text-color); font-size: 0.85rem;">${article.source || 'Unknown'}</td>
            <td style="color: var(--text-color); font-size: 0.85rem;">${article.language || 'N/A'}</td>
            <td>
                <span class="badge bg-${riskBadgeClass}" style="font-size: 0.75rem;">${riskText}</span>
            </td>
            <td style="color: var(--text-color); font-size: 0.85rem;">${conflictType}</td>
            <td style="color: var(--text-color); font-size: 0.85rem;">${formattedDate}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="viewArticle('${article.url}')" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;">
                    <i class="fas fa-external-link-alt"></i>
                </button>
            </td>
        </tr>
        `;
    }).join('');

    tbody.innerHTML = html;
    console.log('✅ Filtered articles table updated with', filteredArticlesData.slice(0, 20).length, 'rows');
}

// Poblar filtro de fuentes
function populateSourceFilter() {
    const sourceFilter = document.getElementById('source-filter');
    if (!sourceFilter || !articlesData) return;
    
    const sources = [...new Set(articlesData.map(article => article.source).filter(Boolean))].sort();
    
    // Limpiar opciones existentes (excepto "Todas las Fuentes")
    sourceFilter.innerHTML = '<option value="">Todas las Fuentes</option>';
    
    sources.forEach(source => {
        const option = document.createElement('option');
        option.value = source;
        option.textContent = source;
        sourceFilter.appendChild(option);
    });
}

// Configurar event listeners para filtros
function setupFilterListeners() {
    const riskFilter = document.getElementById('risk-filter');
    const sourceFilter = document.getElementById('source-filter');
    const sortFilter = document.getElementById('sort-filter');
    
    if (riskFilter) riskFilter.addEventListener('change', filterAndSortArticles);
    if (sourceFilter) sourceFilter.addEventListener('change', filterAndSortArticles);
    if (sortFilter) sortFilter.addEventListener('change', filterAndSortArticles);
}

// Refresh articles
function refreshArticles() {
    fetchRecentArticles();
}

// View article
function viewArticle(url) {
    if (url) {
        window.open(url, '_blank');
    }
}

// Enhanced Intelligence Dashboard for new API endpoints
class IntelligenceDashboard {
    constructor() {
        this.refreshInterval = 30000;
        this.setupEventListeners();
        this.loadAllData();
    }

    setupEventListeners() {
        // Map type selector
        const mapSelectors = document.querySelectorAll('input[name="mapType"]');
        if (mapSelectors) {
            mapSelectors.forEach(radio => {
                radio.addEventListener('change', () => this.updateHeatmap());
            });
        }
    }

    async loadAllData() {
        try {
            await Promise.all([
                this.loadCriticalAlerts(),
                this.loadTrendsAnalysis(),
                this.loadHeatmapData()
            ]);
        } catch (error) {
            console.error('Error loading enhanced dashboard data:', error);
        }
    }

    async loadCriticalAlerts() {
        try {
            const response = await fetch('/api/alerts');
            const data = await response.json();
            this.renderCriticalAlerts(data);
        } catch (error) {
            console.error('Error loading alerts:', error);
            this.renderEmptyAlerts();
        }
    }

    async loadTrendsAnalysis() {
        try {
            const response = await fetch('/api/trends');
            const data = await response.json();
            this.renderTrendsAnalysis(data);
        } catch (error) {
            console.error('Error loading trends:', error);
            this.renderEmptyTrends();
        }
    }

    async loadHeatmapData() {
        try {
            const response = await fetch('/api/heatmap');
            const data = await response.json();
            this.renderHeatmap(data);
        } catch (error) {
            console.error('Error loading heatmap:', error);
            this.renderEmptyHeatmap();
        }
    }

    renderCriticalAlerts(data) {
        const container = document.getElementById('critical-alerts-container');
        
        if (!container) return;
        
        if (!data.alerts || !data.alerts.length) {
            container.innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-shield-check text-success mb-3" style="font-size: 3rem; opacity: 0.5;"></i>
                    <p class="text-muted mb-0">No hay alertas críticas</p>
                    <small class="text-muted">Sistema monitoreando continuamente</small>
                </div>
            `;
            return;
        }

        // Update global alerts count
        const alertsCountEl = document.getElementById('critical-alerts-count');
        if (alertsCountEl) {
            alertsCountEl.textContent = data.high_priority || data.alerts.length;
        }

        const alertsHtml = data.alerts.slice(0, 5).map(alert => {
            const alertClass = `alert-${alert.level}`;
            const iconColor = alert.level === 'high' ? 'text-danger' : alert.level === 'medium' ? 'text-warning' : 'text-info';
            
            return `
                <div class="alert-card ${alertClass} mb-3">
                    <div class="d-flex align-items-start">
                        <i class="fas fa-${alert.icon} alert-icon ${iconColor}"></i>
                        <div class="flex-grow-1">
                            <h6 class="text-white mb-1">${alert.title}</h6>
                            <p class="text-muted small mb-2">${alert.description}</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="badge bg-dark text-light">${alert.source}</span>
                                <span class="text-info small">${alert.probability || 85}% confianza</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        container.innerHTML = alertsHtml;
    }

    renderTrendsAnalysis(data) {
        // Update global risk index
        const riskIndexEl = document.getElementById('global-risk-index');
        if (data.global_risk_index && riskIndexEl) {
            riskIndexEl.textContent = data.global_risk_index.toFixed(1);
        }

        // Update ML confidence
        const mlConfidenceEl = document.getElementById('ml-confidence');
        if (data.ai_predictions && mlConfidenceEl) {
            mlConfidenceEl.textContent = `${data.ai_predictions.confidence || 87}%`;
        }

        // Render AI insights
        const insightsContainer = document.getElementById('ai-insights');
        if (insightsContainer && data.ai_predictions) {
            insightsContainer.innerHTML = `
                <div class="row g-2">
                    <div class="col-12">
                        <strong>Predicción próximos 7 días:</strong> 
                        <span class="text-warning">${data.ai_predictions.next_7_days_risk || 55}% riesgo</span>
                        <span class="text-muted ms-2">(${data.ai_predictions.confidence || 87}% confianza)</span>
                    </div>
                    <div class="col-12 mt-2">
                        <small class="text-muted">
                            Factores clave: ${(data.ai_predictions.key_factors || ['Patrones militares', 'Indicadores económicos']).join(', ')}
                        </small>
                    </div>
                    ${data.ml_insights ? `
                        <div class="col-12 mt-2">
                            <div class="d-flex gap-2 flex-wrap">
                                ${data.ml_insights.pattern_recognition ? '<span class="badge bg-success">Reconocimiento de Patrones</span>' : ''}
                                ${data.ml_insights.sentiment_analysis ? '<span class="badge bg-info">Análisis de Sentimientos</span>' : ''}
                                ${data.ml_insights.predictive_modeling ? '<span class="badge bg-warning">Modelado Predictivo</span>' : ''}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // Update chart placeholders
        this.updateTrendCharts(data);
    }

    renderHeatmap(data) {
        const summaryContainer = document.getElementById('heatmap-summary');
        
        if (summaryContainer && data && typeof data.high_risk_regions !== 'undefined') {
            summaryContainer.innerHTML = `
                <div class="col-3">
                    <div class="text-danger fw-bold">${data.high_risk_regions || 0}</div>
                    <small class="text-muted">Alto Riesgo</small>
                </div>
                <div class="col-3">
                    <div class="text-warning fw-bold">${data.medium_risk_regions || 0}</div>
                    <small class="text-muted">Medio Riesgo</small>
                </div>
                <div class="col-3">
                    <div class="text-success fw-bold">${data.low_risk_regions || 0}</div>
                    <small class="text-muted">Bajo Riesgo</small>
                </div>
                <div class="col-3">
                    <div class="text-info fw-bold">${data.total_regions || 0}</div>
                    <small class="text-muted">Total Regiones</small>
                </div>
            `;
        }
    }

    updateTrendCharts(data) {
        const timelineChart = document.getElementById('risk-timeline-chart');
        const distributionChart = document.getElementById('risk-distribution-chart');
        
        if (timelineChart) {
            if (data.risk_timeline && data.risk_timeline.length) {
                const latestRisk = data.risk_timeline[data.risk_timeline.length - 1];
                timelineChart.innerHTML = `
                    <div class="text-center p-4">
                        <div class="h2 text-warning mb-2">${latestRisk.risk_index}%</div>
                        <div class="text-muted">Índice Actual</div>
                        <small class="text-muted d-block mt-2">${latestRisk.events} eventos detectados</small>
                        <div class="mt-3">
                            <div class="d-flex justify-content-between text-xs">
                                ${data.risk_timeline.slice(-5).map(point => `
                                    <div class="text-center">
                                        <div class="text-warning small">${point.risk_index}%</div>
                                        <div class="text-muted" style="font-size: 0.7rem;">${point.date.split('-')[2]}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            } else {
                timelineChart.innerHTML = '<div class="text-center text-muted p-4">Sin datos de tendencia</div>';
            }
        }
        
        if (distributionChart) {
            if (data.language_trends) {
                const languages = Object.keys(data.language_trends);
                distributionChart.innerHTML = `
                    <div class="text-center p-4">
                        <div class="h4 text-info mb-2">${languages.length}</div>
                        <div class="text-muted">Idiomas Activos</div>
                        <small class="text-muted d-block mt-2">${languages.join(', ').toUpperCase()}</small>
                        <div class="mt-3">
                            ${languages.slice(0, 4).map(lang => `
                                <span class="badge bg-primary me-1 mb-1">${lang.toUpperCase()}</span>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else {
                distributionChart.innerHTML = '<div class="text-center text-muted p-4">Sin datos de distribución</div>';
            }
        }
    }

    renderEmptyAlerts() {
        const container = document.getElementById('critical-alerts-container');
        if (container) {
            container.innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-exclamation-triangle text-warning mb-3" style="font-size: 2rem; opacity: 0.5;"></i>
                    <p class="text-muted mb-0">Error cargando alertas</p>
                </div>
            `;
        }
    }

    renderEmptyTrends() {
        const insightsContainer = document.getElementById('ai-insights');
        if (insightsContainer) {
            insightsContainer.innerHTML = `
                <div class="text-center">
                    <i class="fas fa-chart-line text-muted me-2"></i>
                    <span class="text-muted">Error cargando análisis de tendencias</span>
                </div>
            `;
        }
    }

    renderEmptyHeatmap() {
        const summaryContainer = document.getElementById('heatmap-summary');
        if (summaryContainer) {
            summaryContainer.innerHTML = `
                <div class="col-12 text-center">
                    <span class="text-muted">Error cargando mapa de calor</span>
                </div>
            `;
        }
    }

    updateHeatmap() {
        // Reload heatmap data when filter changes
        this.loadHeatmapData();
    }
}

// Initialize enhanced dashboard after DOM loads
document.addEventListener('DOMContentLoaded', () => {
    // Wait a bit for the main dashboard to load first
    setTimeout(() => {
        const enhancedDashboard = new IntelligenceDashboard();
        
        // Set up refresh interval for enhanced features
        setInterval(() => {
            enhancedDashboard.loadAllData();
        }, 30000);
        
        console.log('Enhanced Intelligence Dashboard initialized');
    }, 2000);
});

function fetchRecentArticles(sortBy = 'published_at', sortOrder = 'desc') {
        const url = `/api/articles?limit=20&sort_by=${sortBy}&sort_order=${sortOrder}`;
        fetch(url)
            .then(response => response.json())
            .then(data => {
                const articlesTableBody = document.getElementById('articles-table-body');
                articlesTableBody.innerHTML = '';
                if (data.length === 0) {
                    articlesTableBody.innerHTML = '<tr><td colspan="4" class="text-center" style="color: var(--text-color-secondary);">No articles found.</td></tr>';
                    return;
                }
                data.forEach(article => {
                    const row = document.createElement('tr');
                    row.style.cursor = 'pointer';
                    row.onclick = () => window.open(article.url, '_blank');
                    
                    const riskColor = getRiskColor(article.risk_level);

                    row.innerHTML = `
                        <td>
                            <div class="article-title-cell">${article.title}</div>
                            <div class="article-source-cell">${article.source} - ${new Date(article.published_at).toLocaleDateString()}</div>
                        </td>
                        <td><span class="risk-badge-table" style="background-color:${riskColor};">${article.risk_level || 'N/A'}</span></td>
                        <td><span class="conflict-type-badge">${article.conflict_type || 'N/A'}</span></td>
                        <td>${article.country || 'Global'}<br><small class="text-muted">${article.region || ''}</small></td>
                    `;
                    articlesTableBody.appendChild(row);
                });
            })
            .catch(error => {
                console.error('Error fetching recent articles:', error);
                const articlesTableBody = document.getElementById('articles-table-body');
                articlesTableBody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">Failed to load articles.</td></tr>';
            });
    }

    function fetchAiAnalysis() {
        fetch('/api/ai_analysis')
            .then(response => response.json())
            .then(data => {
                const aiAnalysisContent = document.getElementById('ai-analysis-content');
                if (data.analysis) {
                    // Format similar to article of the day
                    const imageUrl = data.image_url || 'https://images.unsplash.com/photo-1526304640581-d334cdbbf45e?ixlib=rb-4.0.3&auto=format&fit=crop&w=1000&q=80';
                    const generatedAt = data.generated_at ? new Date(data.generated_at).toLocaleString('es-ES') : new Date().toLocaleString('es-ES');
                    const hasGeneratedImage = data.has_generated_image ? '🎨 Imagen generada por IA' : '📷 Imagen ilustrativa';
                    
                    aiAnalysisContent.innerHTML = `
                        <div class="row g-0">
                            <div class="col-md-4">
                                <div class="position-relative" style="height: 300px;">
                                    <img src="${imageUrl}" 
                                         alt="Análisis Geopolítico" 
                                         class="w-100 h-100" 
                                         style="object-fit: cover; border-radius: 16px 0 0 16px;"
                                         onerror="this.src='https://images.unsplash.com/photo-1526304640581-d334cdbbf45e?ixlib=rb-4.0.3&auto=format&fit=crop&w=1000&q=80'">
                                    <div class="position-absolute bottom-0 start-0 p-3">
                                        <small class="badge bg-dark bg-opacity-75" style="font-size: 0.7rem;">
                                            ${hasGeneratedImage}
                                        </small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <div class="p-4">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="rounded-circle bg-primary bg-opacity-20 p-2 me-3">
                                            <i class="fas fa-robot text-primary"></i>
                                        </div>
                                        <div>
                                            <h6 class="mb-1 fw-bold" style="color: var(--text-color);">Análisis Generado por IA</h6>
                                            <small style="color: var(--text-color-secondary);">
                                                <i class="fas fa-clock me-1"></i>Generado: ${generatedAt}
                                            </small>
                                        </div>
                                    </div>
                                    
                                    <div class="analysis-content" style="max-height: 200px; overflow-y: auto; color: #b3c5ff; line-height: 1.6; font-size: 0.9rem;">
                                        ${data.analysis.replace(/\n/g, '<br>')}
                                    </div>
                                    
                                    <div class="d-flex justify-content-between align-items-center mt-3">
                                        <small class="text-muted">
                                            <i class="fas fa-brain me-1"></i>Modelo: ${data.source || 'AI Multi-Model'}
                                        </small>
                                        <button class="btn btn-sm btn-outline-primary" onclick="fetchAiAnalysis()" style="font-size: 0.75rem;">
                                            <i class="fas fa-sync-alt me-1"></i>Actualizar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    aiAnalysisContent.innerHTML = `
                        <div class="text-center py-4">
                            <i class="fas fa-exclamation-triangle text-warning mb-3" style="font-size: 2rem;"></i>
                            <p class="text-danger mb-2">No se pudo generar el análisis de IA</p>
                            <p class="text-muted small">${data.error || 'Error desconocido'}</p>
                            <button class="btn btn-sm btn-outline-primary" onclick="fetchAiAnalysis()">
                                <i class="fas fa-redo me-1"></i>Reintentar
                            </button>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error fetching AI analysis:', error);
                document.getElementById('ai-analysis-content').innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-wifi-slash text-danger mb-3" style="font-size: 2rem;"></i>
                        <p class="text-danger mb-2">Error de conexión con el endpoint de análisis de IA</p>
                        <button class="btn btn-sm btn-outline-primary" onclick="fetchAiAnalysis()">
                            <i class="fas fa-redo me-1"></i>Reintentar
                        </button>
                    </div>
                `;
            });
    }

    function createHeatmap(conflictType = 'all') {
        fetch(`/api/heatmap_data?conflict_type=${conflictType}`)
            .then(response => response.json())
            .then(data => {
                const plotData = [{
                    type: 'densitymapbox',
                    lon: data.map(p => p.lon),
                    lat: data.map(p => p.lat),
                    z: data.map(p => p.intensity),
                    radius: data.map(p => p.intensity * 20),
                    colorscale: 'YlOrRd',
                    showscale: false,
                    hoverinfo: 'skip'
                }];

                const layout = {
                    mapbox: {
                        style: 'carto-darkmatter',
                        center: { lon: 10, lat: 30 },
                        zoom: 1.5
                    },
                    margin: { r: 0, t: 0, b: 0, l: 0 },
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)'
                };

                Plotly.newPlot('heatmap-container', plotData, layout, {responsive: true});
            })
            .catch(error => {
                console.error('Error fetching heatmap data:', error);
                document.getElementById('heatmap-container').innerHTML = '<div class="text-center text-danger">Failed to load heatmap data.</div>';
            });
    }

    // Helper functions
    function getRiskColor(riskLevel) {
        switch(riskLevel) {
            case 'HIGH': return '#ff4757';
            case 'MEDIUM': return '#ffa502';
            case 'LOW': return '#2ed573';
            default: return '#6c7293';
        }
    }

    // Initialize geopolitical themed particles background
    function initParticles() {
        if (typeof particlesJS !== 'undefined') {
            particlesJS('particles-js', {
                "particles": {
                    "number": { 
                        "value": 120, 
                        "density": { 
                            "enable": true, 
                            "value_area": 1000 
                        } 
                    },
                    "color": { 
                        "value": ["#00d4aa", "#0099cc", "#ff6b6b", "#ffd93d", "#ff8c42"] 
                    },
                    "shape": { 
                        "type": ["circle", "triangle", "edge"], 
                        "stroke": { 
                            "width": 1, 
                            "color": "#00d4aa" 
                        },
                        "polygon": { 
                            "nb_sides": 6 
                        }
                    },
                    "opacity": { 
                        "value": 0.7, 
                        "random": true, 
                        "anim": { 
                            "enable": true, 
                            "speed": 1.5, 
                            "opacity_min": 0.2, 
                            "sync": false 
                        } 
                    },
                    "size": { 
                        "value": 4, 
                        "random": true, 
                        "anim": { 
                            "enable": true, 
                            "speed": 3, 
                            "size_min": 0.5, 
                            "sync": false 
                        } 
                    },
                    "line_linked": { 
                        "enable": true, 
                        "distance": 200, 
                        "color": "#00d4aa", 
                        "opacity": 0.3, 
                        "width": 1.5,
                        "shadow": {
                            "enable": true,
                            "color": "#00d4aa",
                            "blur": 5
                        }
                    },
                    "move": { 
                        "enable": true, 
                        "speed": 1.5, 
                        "direction": "none", 
                        "random": true, 
                        "straight": false, 
                        "out_mode": "bounce", 
                        "bounce": true,
                        "attract": {
                            "enable": true,
                            "rotateX": 600,
                            "rotateY": 1200
                        }
                    }
                },
                "interactivity": {
                    "detect_on": "canvas",
                    "events": { 
                        "onhover": { 
                            "enable": true, 
                            "mode": ["grab", "bubble"] 
                        }, 
                        "onclick": { 
                            "enable": true, 
                            "mode": "repulse" 
                        }, 
                        "resize": true 
                    },
                    "modes": { 
                        "grab": {
                            "distance": 250,
                            "line_linked": {
                                "opacity": 0.8
                            }
                        },
                        "bubble": {
                            "distance": 300,
                            "size": 8,
                            "duration": 2,
                            "opacity": 0.9,
                            "speed": 3
                        },
                        "repulse": { 
                            "distance": 150, 
                            "duration": 0.6 
                        }
                    }
                },
                "retina_detect": true
            });
        }
    }

    // Create heatmap with Plotly
    function createHeatmap(conflictType = 'all') {
        const container = document.getElementById('heatmap-container');
        if (!container) return;
        
        // Sample data for demonstration
        const sampleData = [
            {lat: 40.7128, lon: -74.0060, intensity: 0.8, name: 'New York'},
            {lat: 51.5074, lon: -0.1278, intensity: 0.6, name: 'London'},
            {lat: 35.6762, lon: 139.6503, intensity: 0.4, name: 'Tokyo'},
            {lat: 48.8566, lon: 2.3522, intensity: 0.7, name: 'Paris'},
            {lat: -33.8688, lon: 151.2093, intensity: 0.3, name: 'Sydney'}
        ];

        if (typeof Plotly !== 'undefined') {
            const plotData = [{
                type: 'scattermapbox',
                lon: sampleData.map(p => p.lon),
                lat: sampleData.map(p => p.lat),
                mode: 'markers',
                marker: {
                    size: sampleData.map(p => p.intensity * 30),
                    color: sampleData.map(p => p.intensity),
                    colorscale: 'Reds',
                    showscale: false
                },
                text: sampleData.map(p => p.name),
                hoverinfo: 'text'
            }];

            const layout = {
                mapbox: {
                    style: 'carto-darkmatter',
                    center: { lon: 10, lat: 30 },
                    zoom: 1.5
                },
                margin: { r: 0, t: 0, b: 0, l: 0 },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)'
            };

            Plotly.newPlot('heatmap-container', plotData, layout, {responsive: true});
        } else {
            container.innerHTML = '<div class="text-center text-warning">Plotly not loaded. Using fallback visualization.</div>';
        }
    }

    // AI Analysis function
    function fetchAiAnalysis() {
        const container = document.getElementById('ai-analysis-content');
        if (!container) return;
        
        fetch('/api/ai_analysis')
            .then(response => response.json())
            .then(data => {
                if (data.analysis) {
                    container.innerHTML = `<p style="color: var(--text-primary); white-space: pre-wrap; line-height: 1.6;">${data.analysis}</p>`;
                } else {
                    container.innerHTML = `<p class="text-warning">Could not generate AI analysis at this time.</p>`;
                }
            })
            .catch(error => {
                console.error('Error fetching AI analysis:', error);
                container.innerHTML = '<p class="text-danger">Error loading AI analysis.</p>';
            });
    }

    // Initialize everything when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
        console.log('🚀 Dashboard initialized');
        
        // Initialize components
        initParticles();
        createHeatmap();
        fetchAiAnalysis();
        
        // Set up conflict type selector
        const conflictSelector = document.getElementById('conflictType');
        if (conflictSelector) {
            conflictSelector.addEventListener('change', function() {
                createHeatmap(this.value);
            });
        }
        
        // DEBUG: Test article of the day after everything loads
        console.log('🔍 DEBUG: Page loaded, testing article of the day...');
        setTimeout(() => {
            console.log('🔍 DEBUG: Running delayed test...');
            
            // Check if elements exist
            const elementsToCheck = [
                'article-title',
                'article-summary', 
                'article-source',
                'article-date',
                'article-image',
                'article-language',
                'article-risk-badge'
            ];

            console.log('📋 DEBUG: Checking if elements exist:');
            elementsToCheck.forEach(id => {
                const element = document.getElementById(id);
                console.log(`${id}: ${element ? '✅ Found' : '❌ Not found'}`);
                if (element) {
                    console.log(`  Current content: "${element.textContent || element.src}"`);
                }
            });
            
            // Force update article of the day
            console.log('🔄 DEBUG: Forcing article of the day update...');
            updateArticleOfDay();
        }, 2000);
    });

    // Language selector functionality
    let currentLanguage = 'en';
    let translations = {};

    document.addEventListener('DOMContentLoaded', function() {
        const languageSelector = document.getElementById('language-selector');
        if (languageSelector) {
            languageSelector.addEventListener('change', function() {
                changeLanguage(this.value);
            });
        }
        
        // Load initial translations
        loadTranslations('en');
        
        // Load high risk articles on page load
        fetchHighRiskArticles();
    });

    async function changeLanguage(lang) {
        currentLanguage = lang;
        
        // Update UI immediately with loading state
        showLanguageLoading();
        
        try {
            // Load translations
            await loadTranslations(lang);
            
            // Apply translations
            applyTranslations();
            
            // Reload articles in new language
            await Promise.all([
                fetchRecentArticles(),
                fetchHighRiskArticles(),
                loadAIAnalysis()
            ]);
            
            console.log(`✅ Language changed to ${lang}`);
        } catch (error) {
            console.error('Error changing language:', error);
            showToast('Error changing language', 'error');
        }
    }

    async function loadTranslations(lang) {
        try {
            const response = await fetch(`/api/translate?lang=${lang}&ui_only=true`);
            const data = await response.json();
            translations = data.ui || {};
        } catch (error) {
            console.error('Error loading translations:', error);
            translations = {};
        }
    }

    function applyTranslations() {
        document.querySelectorAll('[data-i18n]').forEach(element => {
            const key = element.getAttribute('data-i18n');
            if (translations[key]) {
                element.textContent = translations[key];
            }
        });
    }

    function showLanguageLoading() {
        const loadingElements = ['articles-table-body', 'high-risk-table-body'];
        loadingElements.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.innerHTML = '<tr><td colspan="7" class="text-center"><i class="fas fa-spinner fa-spin"></i> Traduciendo...</td></tr>';
            }
        });
    }

    async function fetchHighRiskArticles() {
        try {
            const response = await fetch(`/api/high_risk_articles?limit=20&lang=${currentLanguage}`);
            const data = await response.json();
            
            const tableBody = document.getElementById('high-risk-table-body');
            if (!tableBody) {
                console.error('❌ high-risk-table-body element not found');
                return;
            }
            
            tableBody.innerHTML = '';
            
            if (data.articles && data.articles.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center" style="color: var(--text-color-secondary);">No high risk articles found.</td></tr>';
                return;
            }
            
            data.articles.forEach(article => {
                const row = document.createElement('tr');
                row.style.cursor = 'pointer';
                row.onclick = () => window.open(article.url, '_blank');
                
                const riskScore = article.risk_score || 0;
                const riskColor = getRiskScoreColor(riskScore);
                const riskText = getRiskScoreText(riskScore);
                
                const sentiment = article.sentiment_score || 0;
                const sentimentIcon = getSentimentIcon(sentiment);
                const sentimentClass = getSentimentClass(sentiment);
                
                row.innerHTML = `
                    <td>
                        <div class="article-title-cell" style="font-weight: 500; color: var(--text-color);">${article.title}</div>
                        <div class="article-description-cell" style="font-size: 0.85em; color: var(--text-color-secondary); margin-top: 4px;">${article.description ? article.description.substring(0, 100) + '...' : ''}</div>
                    </td>
                    <td><span style="color: var(--text-color-secondary); font-size: 0.9em;">${article.source_name || 'Unknown'}</span></td>
                    <td><span style="color: var(--text-color-secondary); font-size: 0.9em;">${article.location || 'Global'}</span></td>
                    <td>
                        <div style="display: flex; align-items: center;">
                            <span class="risk-score-badge" style="background: ${riskColor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em; font-weight: 600;">${riskScore.toFixed(1)}</span>
                        </div>
                    </td>
                    <td>
                        <span class="language-badge" style="background: var(--secondary-color); color: white; padding: 2px 6px; border-radius: 8px; font-size: 0.75em; text-transform: uppercase;">${article.language}</span>
                    </td>
                    <td style="color: var(--text-color-secondary); font-size: 0.85em;">${new Date(article.published_at).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-light" onclick="event.stopPropagation(); window.open('${article.url}', '_blank')" style="font-size: 0.75em; padding: 2px 8px;">
                            <i class="fas fa-external-link-alt"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
        } catch (error) {
            console.error('Error fetching high risk articles:', error);
            const tableBody = document.getElementById('high-risk-table-body');
            if (tableBody) {
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center text-danger py-4">Failed to load high risk articles</td></tr>';
            }
        }
    }

    function getRiskScoreColor(score) {
        if (score >= 7) return '#dc2626'; // High risk - red
        if (score >= 4) return '#f59e0b'; // Medium risk - amber
        return '#059669'; // Low risk - green
    }

    function getRiskScoreText(score) {
        if (score >= 7) return 'High';
        if (score >= 4) return 'Medium';
        return 'Low';
    }

    function getSentimentIcon(sentiment) {
        if (sentiment > 0.1) return 'fas fa-smile';
        if (sentiment < -0.1) return 'fas fa-frown';
        return 'fas fa-meh';
    }

    function getSentimentClass(sentiment) {
        if (sentiment > 0.1) return 'text-success';
        if (sentiment < -0.1) return 'text-danger';
        return 'text-warning';
    }

    async function loadAIAnalysis() {
        try {
            const response = await fetch(`/api/ai_analysis?lang=${currentLanguage}`);
            const data = await response.json();
            
            // Update AI analysis content with translated data if needed
            // (Implementation depends on how the AI analysis is structured)
            
        } catch (error) {
            console.error('Error loading AI analysis:', error);
        }
    }

    function showToast(message, type = 'info') {
        // Simple toast implementation
        const toast = document.createElement('div');
        toast.className = `alert alert-${type} position-fixed`;
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        toast.textContent = message;
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
            document.body.removeChild(toast);
        }, 3000);
    }
</script>
{% endblock %}
