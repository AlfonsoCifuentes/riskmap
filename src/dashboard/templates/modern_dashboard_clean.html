{% extends "base_navigation.html" %}

{% block title %}An√°lisis de Noticias - Stratosight{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/article_cards.css') }}">
<style>
    :root {
        --bg-primary: linear-gradient(180deg, #0a0f2c 0%, #1a2040 40%, #2a3558 80%, #3a4a70 100%);
        --bg-secondary: #141824;
        --text-primary: #e8eaed;
        --text-secondary: #b0b8c4;
        --accent-cyan: #00d4ff;
        --accent-glow: 0 0 15px rgba(0, 212, 255, 0.4), 0 0 25px rgba(0, 212, 255, 0.2);
        --border-color: rgba(255, 255, 255, 0.1);
    }

    html, body {
        margin: 0;
        padding: 0;
        min-height: 100vh;
        background: #1a237e;
        color: var(--text-primary);
        font-family: 'Inter', sans-serif;
        position: relative;
    }

    /* News Analysis Dashboard Styles */
    .news-dashboard {
        padding: 0;
        max-width: none;
        margin: 0;
        position: relative;
        z-index: 1;
        display: flex;
        flex-direction: column;
        min-height: calc(100vh - 80px);
        background: rgba(10, 15, 44, 0.08);
        backdrop-filter: blur(2px);
        gap: 0;
        width: 100vw;
    }
    
    .dashboard-content {
        max-width: 96%;
        margin: 0 auto;
        padding: 0 20px;
        width: 100%;
        box-sizing: border-box;
    }
    
    /* Header and Stats Container */
    .header-stats-container {
        width: 100vw;
        position: relative;
        left: 50%;
        right: 50%;
        margin-left: -50vw;
        margin-right: -50vw;
        margin-bottom: -80px;
        top: -80px;
        z-index: 0;
        background: transparent;
        border-radius: 0;
    }
    
    .page-header {
        text-align: center;
        margin: 0;
        color: #fff;
        padding: 180px 0 100px 0;
        width: 100%;
        position: relative;
        background: linear-gradient(135deg, rgba(26, 32, 64, 0.75) 0%, rgba(16, 24, 48, 0.8) 50%, rgba(20, 28, 56, 0.75) 100%);
        backdrop-filter: blur(10px);
        box-shadow: 0 2px 20px rgba(0, 0, 0, 0.3);
    }
    
    .page-title {
        font-family: 'Orbitron', monospace;
        font-size: clamp(1.5rem, 6vw, 4rem);
        font-weight: 700;
        margin-bottom: 10px;
        background: linear-gradient(135deg, #00d4ff 0%, #00a3cc 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        width: 75%;
        margin-left: auto;
        margin-right: auto;
        line-height: 1.2;
        word-wrap: break-word;
        hyphens: auto;
    }
    
    .page-subtitle {
        font-size: 1rem;
        color: rgba(255, 255, 255, 0.7);
        margin-bottom: 20px;
    }

    /* Stats Container */
    .stats-container {
        display: flex;
        justify-content: center;
        gap: 20px;
        flex-wrap: wrap;
        padding: 0 20px;
        margin-top: 20px;
    }
    
    .stat-item {
        background: rgba(26, 32, 64, 0.6);
        border: 1px solid rgba(70, 234, 215, 0.3);
        border-radius: 12px;
        padding: 15px 20px;
        text-align: center;
        backdrop-filter: blur(10px);
        min-width: 120px;
        transition: all 0.3s ease;
    }
    
    .stat-item:hover {
        border-color: rgba(70, 234, 215, 0.6);
        box-shadow: 0 0 20px rgba(70, 234, 215, 0.2);
    }
    
    .stat-number {
        font-size: 1.6rem;
        font-weight: 700;
        color: #00d4ff;
        margin-bottom: 5px;
    }
    
    .stat-label {
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.8);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Mosaic Section Styles */
    .news-mosaic-section {
        padding: 20px 0;
        width: 100%;
        position: relative;
        z-index: 2;
        margin-top: 80px;
    }
    
    .news-mosaic-container {
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        grid-auto-rows: 120px;
        gap: 15px;
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 20px;
        box-sizing: border-box;
    }

    /* Mosaic Article Styles */
    .mosaic-article {
        position: relative;
        border-radius: 12px;
        overflow: hidden;
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(5px);
    }
    
    .mosaic-article::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, 
            rgba(0, 0, 0, 0.3) 0%, 
            rgba(0, 0, 0, 0.5) 50%, 
            rgba(0, 0, 0, 0.7) 100%
        );
        z-index: 1;
        transition: opacity 0.3s ease;
    }
    
    .mosaic-article:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(70, 234, 215, 0.3);
    }
    
    .mosaic-article:hover::before {
        opacity: 0.8;
    }
    
    .mosaic-content {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 15px;
        z-index: 2;
        color: white;
        background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
    }
    
    .mosaic-title {
        font-size: 0.9rem;
        font-weight: 600;
        margin-bottom: 8px;
        line-height: 1.3;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    
    .mosaic-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.75rem;
        gap: 10px;
    }
    
    .mosaic-location {
        display: flex;
        align-items: center;
        gap: 4px;
        color: rgba(255, 255, 255, 0.8);
    }
    
    .mosaic-risk-badge {
        padding: 3px 8px;
        border-radius: 10px;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.7rem;
        letter-spacing: 0.3px;
    }
    
    .mosaic-risk-badge.high {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
    }
    
    .mosaic-risk-badge.medium {
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
    }
    
    .mosaic-risk-badge.low {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
    }
    
    .mosaic-risk-badge.hero {
        background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        color: white;
        animation: heroGlow 2s ease-in-out infinite alternate;
    }
    
    @keyframes heroGlow {
        from { box-shadow: 0 0 10px rgba(139, 92, 246, 0.4); }
        to { box-shadow: 0 0 20px rgba(139, 92, 246, 0.8); }
    }

    /* Size Classes for Irregular Mosaic */
    .size-hero {
        grid-column: span 6;
        grid-row: span 4;
    }
    
    .size-large-wide {
        grid-column: span 4;
        grid-row: span 3;
    }
    
    .size-large-tall {
        grid-column: span 3;
        grid-row: span 4;
    }
    
    .size-medium-wide {
        grid-column: span 4;
        grid-row: span 2;
    }
    
    .size-medium-square {
        grid-column: span 3;
        grid-row: span 3;
    }
    
    .size-medium-tall {
        grid-column: span 2;
        grid-row: span 3;
    }
    
    .size-small-wide {
        grid-column: span 3;
        grid-row: span 2;
    }
    
    .size-small-square {
        grid-column: span 2;
        grid-row: span 2;
    }
    
    .size-small-tall {
        grid-column: span 2;
        grid-row: span 3;
    }
    
    .size-mini-wide {
        grid-column: span 3;
        grid-row: span 1;
    }
    
    .size-mini-square {
        grid-column: span 2;
        grid-row: span 2;
    }
    
    .size-tiny {
        grid-column: span 2;
        grid-row: span 1;
    }

    /* Loading State */
    .mosaic-loading {
        grid-column: 1 / -1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 60px 20px;
        color: rgba(255, 255, 255, 0.7);
        text-align: center;
    }
    
    .mosaic-loading i {
        font-size: 3rem;
        margin-bottom: 20px;
        animation: spin 1s linear infinite;
        color: #00d4ff;
    }
    
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    /* Responsive Design */
    @media (max-width: 1200px) {
        .news-mosaic-container {
            grid-template-columns: repeat(8, 1fr);
        }
        
        .size-hero { grid-column: span 4; grid-row: span 3; }
        .size-large-wide { grid-column: span 4; grid-row: span 2; }
        .size-large-tall { grid-column: span 2; grid-row: span 3; }
    }
    
    @media (max-width: 768px) {
        .news-mosaic-container {
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        
        .size-hero { grid-column: span 4; grid-row: span 2; }
        .size-large-wide { grid-column: span 4; grid-row: span 2; }
        .size-large-tall { grid-column: span 2; grid-row: span 2; }
        .size-medium-wide { grid-column: span 4; grid-row: span 1; }
        .size-medium-square { grid-column: span 2; grid-row: span 2; }
        .size-medium-tall { grid-column: span 2; grid-row: span 2; }
    }
    
    @media (max-width: 480px) {
        .news-mosaic-container {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .mosaic-article {
            grid-column: span 2;
            grid-row: span 1;
        }
        
        .size-hero {
            grid-row: span 2;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="news-dashboard">
    <!-- Header and Stats Container -->
    <div class="header-stats-container">
        <div class="page-header">
            <h1 class="page-title">Centro de An√°lisis Geopol√≠tico</h1>
            <p class="page-subtitle">Monitoreo inteligente de riesgos globales en tiempo real</p>
            
            <!-- Statistics -->
            <div class="stats-container">
                <div class="stat-item">
                    <div class="stat-number" id="totalArticles">-</div>
                    <div class="stat-label">Art√≠culos</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="highRiskCount">-</div>
                    <div class="stat-label">Alto Riesgo</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="activeAlerts">-</div>
                    <div class="stat-label">Alertas</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="lastUpdate">-</div>
                    <div class="stat-label">√öltima Act.</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard Content -->
    <div class="dashboard-content">
        <!-- News Mosaic Section -->
        <div class="news-mosaic-section">
            <div class="news-mosaic-container">
                <!-- Mosaic content will be dynamically loaded here -->
                <div class="mosaic-loading">
                    <i class="fas fa-globe-americas"></i>
                    <p>Inicializando an√°lisis geopol√≠tico...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Global variables
    let articlesData = [];
    
    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ Inicializando dashboard moderno...');
        loadNewsMosaic();
        updateStatistics();
    });

    // News Mosaic Functions - Hybrid: Real data with Mock fallback
    async function loadNewsMosaic() {
        console.log('Loading news mosaic - HYBRID VERSION (real + mock fallback)...');
        const container = document.querySelector('.news-mosaic-container');
        
        if (!container) {
            console.error('Container .news-mosaic-container not found!');
            return;
        }
        
        // Show loading state
        container.innerHTML = `
            <div class="mosaic-loading">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Cargando mosaico de noticias...</p>
            </div>
        `;
        
        // Mock data for fallback
        const mockArticles = [
            {
                id: 1,
                title: "Crisis diplom√°tica se intensifica en Europa Oriental",
                location: "Ucrania",
                risk_level: "high",
                image_url: "https://images.unsplash.com/photo-1504711434969-e33886168f5c?w=800&h=600&fit=crop"
            },
            {
                id: 2,
                title: "Negociaciones comerciales entre potencias mundiales",
                location: "Estados Unidos", 
                risk_level: "medium",
                image_url: "https://images.unsplash.com/photo-1526304640581-d334cdbbf45e?w=800&h=600&fit=crop"
            },
            {
                id: 3,
                title: "Tensiones geopol√≠ticas en el Mar del Sur de China",
                location: "China",
                risk_level: "high",
                image_url: "https://images.unsplash.com/photo-1445019980597-93fa8acb246c?w=800&h=600&fit=crop"
            },
            {
                id: 4,
                title: "Cumbre de l√≠deres regionales aborda seguridad",
                location: "Medio Oriente",
                risk_level: "medium",
                image_url: "https://images.unsplash.com/photo-1541336032412-2048a678540d?w=800&h=600&fit=crop"
            },
            {
                id: 5,
                title: "Ejercicios militares conjuntos preocupan a vecinos",
                location: "Corea del Norte",
                risk_level: "high",
                image_url: "https://images.unsplash.com/photo-1526304640581-d334cdbbf45e?w=800&h=600&fit=crop"
            },
            {
                id: 6,
                title: "Acuerdo energ√©tico estrat√©gico entre naciones",
                location: "Rusia",
                risk_level: "low",
                image_url: "https://images.unsplash.com/photo-1473649085228-583485e6e4d7?w=800&h=600&fit=crop"
            },
            {
                id: 7,
                title: "Migraci√≥n masiva causa tensiones fronterizas",
                location: "Europa",
                risk_level: "medium",
                image_url: "https://images.unsplash.com/photo-1544161515-4ab6ce6db874?w=800&h=600&fit=crop"
            },
            {
                id: 8,
                title: "Disputa territorial escalada en zona fronteriza",
                location: "India",
                risk_level: "high",
                image_url: "https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=800&h=600&fit=crop"
            },
            {
                id: 9,
                title: "Reuni√≥n de emergencia en consejo de seguridad",
                location: "Nueva York",
                risk_level: "medium",
                image_url: "https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=800&h=600&fit=crop"
            },
            {
                id: 10,
                title: "Operaciones de paz se intensifican en regi√≥n",
                location: "√Åfrica",
                risk_level: "low",
                image_url: "https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=800&h=600&fit=crop"
            }
        ];
        
        try {
            console.log('Step 1: Attempting to fetch real articles...');
            
            // Try to fetch real data with timeout
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 second timeout
            
            const response = await fetch('/api/articles?limit=15', {
                signal: controller.signal,
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            clearTimeout(timeoutId);
            
            if (response.ok) {
                const data = await response.json();
                console.log('Step 2: Real data received:', data);
                
                // Handle different possible response formats
                let articles = [];
                if (Array.isArray(data)) {
                    articles = data;
                } else if (data.articles && Array.isArray(data.articles)) {
                    articles = data.articles;
                } else if (data.data && Array.isArray(data.data)) {
                    articles = data.data;
                }
                
                if (articles.length > 0) {
                    console.log(`Step 3: Using ${articles.length} real articles`);
                    articlesData = articles;
                    setTimeout(() => renderMosaic(articles), 500);
                    return;
                }
            }
            
            throw new Error('No real articles available');
            
        } catch (error) {
            console.warn('Real data fetch failed:', error.message);
            console.log('Step 3: Falling back to mock data...');
            
            // Use mock data as fallback
            setTimeout(() => {
                console.log('Step 4: Rendering mock mosaic...');
                articlesData = mockArticles;
                renderMosaic(mockArticles);
            }, 1000);
        }
    }

    // Enhanced mosaic renderer
    function renderMosaic(articles) {
        const container = document.querySelector('.news-mosaic-container');
        console.log('Rendering mosaic with', articles.length, 'articles');
        
        if (!container) {
            console.error('Container not found for rendering!');
            return;
        }
        
        if (!articles || articles.length === 0) {
            container.innerHTML = `
                <div class="mosaic-loading">
                    <i class="fas fa-exclamation-triangle" style="color: #f59e0b;"></i>
                    <p>No hay art√≠culos disponibles para el mosaico</p>
                </div>
            `;
            return;
        }
        
        const mosaicHTML = articles.map((article, index) => {
            // Enhanced size assignment for better visual variety
            let sizeClass = 'size-small-square';
            
            // First article is always hero
            if (index === 0) {
                sizeClass = 'size-hero';
            }
            // Next articles get varied sizes based on index and content
            else if (index === 1) {
                sizeClass = 'size-large-wide';
            }
            else if (index === 2) {
                sizeClass = 'size-large-tall';
            }
            else if (index === 3) {
                sizeClass = 'size-medium-wide';
            }
            else if (index === 4) {
                sizeClass = 'size-medium-square';
            }
            else if (index === 5) {
                sizeClass = 'size-medium-tall';
            }
            else if (index === 6) {
                sizeClass = 'size-small-wide';
            }
            else if (index === 7) {
                sizeClass = 'size-small-tall';
            }
            else if (index === 8) {
                sizeClass = 'size-mini-wide';
            }
            else if (index === 9) {
                sizeClass = 'size-mini-square';
            }
            else {
                sizeClass = 'size-tiny';
            }
            
            const title = (article.title || 'Sin t√≠tulo').substring(0, 100);
            const location = article.location || article.country || 'Global';
            const riskLevel = article.risk_level || 'low';
            const defaultImage = 'https://images.unsplash.com/photo-1504711434969-e33886168f5c?w=800&h=600&fit=crop';
            const backgroundImage = article.image_url || article.image || article.urlToImage || defaultImage;
            
            // Escape quotes for onclick
            const titleEscaped = title.replace(/'/g, "\\'").replace(/"/g, '\\"');
            
            return `
                <div class="mosaic-article ${sizeClass}" 
                     style="background-image: url('${backgroundImage}')"
                     data-article-id="${article.id || index}"
                     data-size="${sizeClass}"
                     onclick="openArticleModal(${JSON.stringify(article).replace(/"/g, '&quot;')})">
                    <div class="mosaic-content">
                        <h3 class="mosaic-title">${title}</h3>
                        <div class="mosaic-meta">
                            <span class="mosaic-location">
                                <i class="fas fa-map-marker-alt"></i>
                                ${location}
                            </span>
                            <span class="mosaic-risk-badge ${index === 0 ? 'hero' : riskLevel}">
                                ${index === 0 ? 'DESTACADO' : riskLevel.toUpperCase()}
                            </span>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        container.innerHTML = mosaicHTML;
        console.log('‚úÖ Mosaic rendered successfully with', articles.length, 'articles!');
    }

    // Modal for article details
    function openArticleModal(article) {
        const modal = document.createElement('div');
        modal.className = 'article-modal';
        modal.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0, 0, 0, 0.8); z-index: 1000; display: flex; 
            align-items: center; justify-content: center; padding: 20px;
        `;
        
        modal.innerHTML = `
            <div class="modal-content" style="
                background: linear-gradient(135deg, rgba(26, 32, 64, 0.95) 0%, rgba(16, 24, 48, 0.95) 100%);
                padding: 30px; border-radius: 12px; max-width: 600px; width: 100%;
                color: white; position: relative; backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.1);
            ">
                <span class="modal-close" style="
                    position: absolute; top: 10px; right: 15px; font-size: 24px;
                    cursor: pointer; color: rgba(255, 255, 255, 0.7);
                ">&times;</span>
                <h2>${article.title || 'Sin t√≠tulo'}</h2>
                <div class="modal-meta" style="margin: 15px 0; display: flex; gap: 15px; flex-wrap: wrap;">
                    <span><i class="fas fa-map-marker-alt"></i> ${article.location || article.country || 'Global'}</span>
                    <span><i class="fas fa-calendar"></i> ${new Date(article.published_date || article.date_published || Date.now()).toLocaleDateString()}</span>
                    <span class="risk-badge" style="
                        padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600;
                        background: ${article.risk_level === 'high' ? '#ef4444' : article.risk_level === 'medium' ? '#f59e0b' : '#10b981'};
                    ">${(article.risk_level || 'low').toUpperCase()}</span>
                </div>
                <p>${article.description || article.summary || 'No hay descripci√≥n disponible.'}</p>
                <div class="modal-actions" style="margin-top: 20px;">
                    <a href="${article.source_url || article.url || article.link || '#'}" target="_blank" 
                       style="display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px;
                              background: linear-gradient(135deg, #00d4ff 0%, #00a3cc 100%);
                              color: white; text-decoration: none; border-radius: 8px; font-weight: 600;">
                        <i class="fas fa-external-link-alt"></i> Leer art√≠culo completo
                    </a>
                </div>
            </div>
        `;
        
        // Close modal handlers
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
        
        modal.querySelector('.modal-close').addEventListener('click', () => {
            modal.remove();
        });
        
        document.body.appendChild(modal);
    }

    // Update statistics
    function updateStatistics() {
        document.getElementById('totalArticles').textContent = articlesData.length || '0';
        document.getElementById('highRiskCount').textContent = articlesData.filter(a => a.risk_level === 'high').length || '0';
        document.getElementById('activeAlerts').textContent = '3';
        document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'});
    }

    // Notification system
    function showNotification(message, type = 'info') {
        console.log(`[${type.toUpperCase()}] ${message}`);
    }
</script>
{% endblock %}
