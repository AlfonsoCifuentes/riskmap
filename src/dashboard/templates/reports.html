{% extends "base.html" %}

{% block title %}Reports - Geopolitical Intelligence{% endblock %}

{% block content %}
<style>
    .reports-section {
        background: var(--card-gradient);
        border: 1px solid var(--border-color);
        border-radius: 20px;
        padding: 2rem;
        margin-bottom: 2rem;
        backdrop-filter: blur(20px);
    }

    .report-card {
        background: rgba(22, 27, 34, 0.9);
        border: 1px solid var(--border-color);
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        transition: var(--transition);
        cursor: pointer;
    }

    .report-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
    }

    .report-form {
        background: rgba(22, 27, 34, 0.95);
        border: 1px solid var(--border-color);
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
    }

    .form-control, .form-select {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
        border-radius: 8px;
    }

    .form-control:focus, .form-select:focus {
        background: rgba(255, 255, 255, 0.15);
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        color: var(--text-primary);
    }

    .btn-generate {
        background: var(--primary-gradient);
        border: none;
        color: white;
        padding: 0.75rem 2rem;
        border-radius: 10px;
        font-weight: 600;
        transition: var(--transition);
    }

    .btn-generate:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    .report-preview {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        padding: 1.5rem;
        margin-top: 1rem;
        max-height: 500px;
        overflow-y: auto;
    }

    .loading-report {
        text-align: center;
        padding: 3rem;
    }

    .report-actions {
        margin-top: 1rem;
        text-align: right;
    }

    .report-meta {
        background: rgba(102, 126, 234, 0.1);
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
    }
</style>

<div class="container-fluid">
    <!-- Header -->
    <div class="reports-section text-center">
        <h1><i class="fas fa-file-alt me-3"></i>Generador de Reportes</h1>
        <p class="lead">Genera reportes personalizados basados en análisis de IA</p>
    </div>

    <div class="row">
        <div class="col-lg-4">
            <!-- Report Generator Form -->
            <div class="report-form">
                <h3><i class="fas fa-cog me-2"></i>Configuración del Reporte</h3>
                
                <form id="report-form">
                    <div class="mb-3">
                        <label for="report-type" class="form-label">Tipo de Reporte</label>
                        <select class="form-select" id="report-type" required>
                            <option value="summary">Resumen Ejecutivo</option>
                            <option value="detailed">Análisis Detallado</option>
                            <option value="trends">Tendencias y Patrones</option>
                            <option value="regional">Análisis Regional</option>
                            <option value="risk_assessment">Evaluación de Riesgos</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="date-range" class="form-label">Período de Análisis</label>
                        <select class="form-select" id="date-range" required>
                            <option value="1">Último día</option>
                            <option value="3">Últimos 3 días</option>
                            <option value="7" selected>Última semana</option>
                            <option value="14">Últimas 2 semanas</option>
                            <option value="30">Último mes</option>
                            <option value="90">Últimos 3 meses</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="risk-filter" class="form-label">Filtrar por Nivel de Riesgo</label>
                        <select class="form-select" id="risk-filter">
                            <option value="">Todos los niveles</option>
                            <option value="CRITICAL">Solo Crítico</option>
                            <option value="HIGH">Alto y Crítico</option>
                            <option value="MEDIUM">Medio y superior</option>
                            <option value="LOW">Todos los niveles</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="region-filter" class="form-label">Región Específica (Opcional)</label>
                        <input type="text" class="form-control" id="region-filter" 
                               placeholder="ej. Medio Oriente, Europa, Asia">
                    </div>

                    <div class="mb-3">
                        <label for="language-filter" class="form-label">Fuentes por Idioma</label>
                        <select class="form-select" id="language-filter">
                            <option value="">Todos los idiomas</option>
                            <option value="es">Español</option>
                            <option value="en">Inglés</option>
                            <option value="fr">Francés</option>
                            <option value="de">Alemán</option>
                            <option value="ru">Ruso</option>
                            <option value="zh">Chino</option>
                            <option value="ar">Árabe</option>
                        </select>
                    </div>

                    <button type="submit" class="btn btn-generate w-100">
                        <i class="fas fa-magic me-2"></i>Generar Reporte
                    </button>
                </form>
            </div>

            <!-- Preset Reports -->
            <div class="reports-section">
                <h4><i class="fas fa-bookmark me-2"></i>Reportes Predefinidos</h4>
                
                <div class="report-card" onclick="generatePresetReport('daily')">
                    <h5><i class="fas fa-calendar-day me-2"></i>Reporte Diario</h5>
                    <p>Resumen de eventos de las últimas 24 horas</p>
                    <small class="text-muted">Actualizado cada hora</small>
                </div>

                <div class="report-card" onclick="generatePresetReport('weekly')">
                    <h5><i class="fas fa-calendar-week me-2"></i>Reporte Semanal</h5>
                    <p>Análisis de tendencias de la semana</p>
                    <small class="text-muted">Disponible los lunes</small>
                </div>

                <div class="report-card" onclick="generatePresetReport('critical')">
                    <h5><i class="fas fa-exclamation-triangle me-2"></i>Alertas Críticas</h5>
                    <p>Solo eventos de riesgo crítico y alto</p>
                    <small class="text-muted">Tiempo real</small>
                </div>

                <div class="report-card" onclick="generatePresetReport('regional')">
                    <h5><i class="fas fa-globe me-2"></i>Análisis Regional</h5>
                    <p>Focos de tensión por continente</p>
                    <small class="text-muted">Actualizado diariamente</small>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <!-- Report Display Area -->
            <div class="reports-section">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3><i class="fas fa-document me-2"></i>Reporte Generado</h3>
                    <div class="report-actions" id="report-actions" style="display: none;">
                        <button class="btn btn-outline-primary btn-sm me-2" onclick="downloadReport()">
                            <i class="fas fa-download me-1"></i>Descargar PDF
                        </button>
                        <button class="btn btn-outline-secondary btn-sm me-2" onclick="exportReport()">
                            <i class="fas fa-file-export me-1"></i>Exportar JSON
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="shareReport()">
                            <i class="fas fa-share me-1"></i>Compartir
                        </button>
                    </div>
                </div>

                <div id="report-display">
                    <div class="text-center py-5" style="color: var(--text-muted);">
                        <i class="fas fa-file-alt fa-4x mb-3"></i>
                        <h4>No hay reporte generado</h4>
                        <p>Selecciona las opciones de configuración y haz clic en "Generar Reporte" para comenzar</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const reportForm = document.getElementById('report-form');
    const reportDisplay = document.getElementById('report-display');
    const reportActions = document.getElementById('report-actions');
    
    let currentReport = null;

    reportForm.addEventListener('submit', function(e) {
        e.preventDefault();
        generateCustomReport();
    });

    function generateCustomReport() {
        const formData = {
            type: document.getElementById('report-type').value,
            date_range: document.getElementById('date-range').value,
            risk_filter: document.getElementById('risk-filter').value,
            region_filter: document.getElementById('region-filter').value,
            language_filter: document.getElementById('language-filter').value
        };

        showLoading();
        
        fetch('/api/generate_report', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayReport(data.report);
                currentReport = data.report;
                reportActions.style.display = 'block';
            } else {
                showError('Error generando el reporte: ' + (data.error || 'Error desconocido'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('Error de conexión al generar el reporte');
        });
    }

    function showLoading() {
        reportDisplay.innerHTML = `
            <div class="loading-report">
                <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
                <h4 class="mt-3">Generando reporte con IA...</h4>
                <p class="text-muted">Analizando datos geopolíticos y creando insights</p>
            </div>
        `;
        reportActions.style.display = 'none';
    }

    function showError(message) {
        reportDisplay.innerHTML = `
            <div class="alert alert-danger" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>
                ${message}
            </div>
        `;
        reportActions.style.display = 'none';
    }

    function displayReport(report) {
        const reportHtml = `
            <div class="report-meta">
                <div class="row">
                    <div class="col-md-6">
                        <strong>Tipo:</strong> ${report.title}<br>
                        <strong>Generado:</strong> ${new Date(report.generated_at).toLocaleString()}
                    </div>
                    <div class="col-md-6">
                        <strong>Artículos analizados:</strong> ${report.article_count || 'N/A'}<br>
                        <strong>Período:</strong> ${report.date_range || 'N/A'}
                    </div>
                </div>
            </div>
            <div class="report-preview">
                ${report.content || formatDetailedReport(report)}
            </div>
        `;
        reportDisplay.innerHTML = reportHtml;
    }

    function formatDetailedReport(report) {
        if (report.articles) {
            let html = '<h4>Artículos Analizados</h4>';
            report.articles.forEach(article => {
                html += `
                    <div class="article-item mb-3 p-3" style="border-left: 3px solid var(--primary-color); background: rgba(255,255,255,0.05);">
                        <h6>${article.title}</h6>
                        <p>${article.summary}</p>
                        <small class="text-muted">
                            <i class="fas fa-calendar me-1"></i>${new Date(article.published_at).toLocaleDateString()}
                            <i class="fas fa-source me-1 ms-2"></i>${article.source_name}
                            <span class="badge bg-${getRiskColor(article.risk_level)} ms-2">${article.risk_level}</span>
                        </small>
                    </div>
                `;
            });
            return html;
        }
        return '<p>Reporte generado sin contenido específico.</p>';
    }

    function getRiskColor(risk) {
        switch(risk?.toUpperCase()) {
            case 'CRITICAL': return 'danger';
            case 'HIGH': return 'warning';
            case 'MEDIUM': return 'info';
            case 'LOW': return 'success';
            default: return 'secondary';
        }
    }

    // Global functions for preset reports
    window.generatePresetReport = function(type) {
        const presetConfigs = {
            'daily': { type: 'summary', date_range: '1' },
            'weekly': { type: 'trends', date_range: '7' },
            'critical': { type: 'risk_assessment', date_range: '3', risk_filter: 'CRITICAL' },
            'regional': { type: 'regional', date_range: '7' }
        };

        const config = presetConfigs[type];
        if (config) {
            // Set form values
            document.getElementById('report-type').value = config.type;
            document.getElementById('date-range').value = config.date_range;
            document.getElementById('risk-filter').value = config.risk_filter || '';
            
            // Generate report
            generateCustomReport();
        }
    };

    window.downloadReport = function() {
        if (currentReport) {
            // Create and download PDF (simplified version)
            const element = document.createElement('a');
            const content = `
                ${currentReport.title}
                Generado: ${new Date(currentReport.generated_at).toLocaleString()}
                
                ${currentReport.content || 'Ver reporte completo en la plataforma'}
            `;
            const file = new Blob([content], { type: 'text/plain' });
            element.href = URL.createObjectURL(file);
            element.download = `reporte_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        }
    };

    window.exportReport = function() {
        if (currentReport) {
            const element = document.createElement('a');
            const file = new Blob([JSON.stringify(currentReport, null, 2)], { type: 'application/json' });
            element.href = URL.createObjectURL(file);
            element.download = `reporte_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        }
    };

    window.shareReport = function() {
        if (currentReport && navigator.share) {
            navigator.share({
                title: currentReport.title,
                text: 'Reporte de Inteligencia Geopolítica',
                url: window.location.href
            });
        } else {
            // Fallback - copy link to clipboard
            navigator.clipboard.writeText(window.location.href).then(() => {
                alert('Enlace copiado al portapapeles');
            });
        }
    };
});
</script>

{% endblock %}
