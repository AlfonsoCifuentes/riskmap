{% extends "base.html" %}

{% block title %}{{ translations['analysis'] }}{% endblock %}

{% block content %}
<div class="container">
    <!-- News Analysis Section -->
    <div class="glass-card section-spacing">
        <div class="card-header">
            <h2 class="mb-0">
                <i class="fas fa-newspaper me-2"></i>
                Análisis de Noticias Geopolíticas
            </h2>
        </div>
        <div class="card-body">
            <div class="row g-4">
                <div class="col-12 col-lg-8">
                    <div class="mb-4">
                        <textarea 
                            id="analysis-input" 
                            class="form-control" 
                            rows="8" 
                            placeholder="Ingresa el texto de noticias para análisis geopolítico..."></textarea>
                    </div>
                    <button id="analysis-button" class="btn btn-primary w-100 w-lg-auto">
                        <i class="fas fa-brain me-2"></i>
                        Analizar Contenido
                    </button>
                </div>
                <div class="col-12 col-lg-4">
                    <div class="glass-card">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fas fa-info-circle me-2"></i>
                                Información del Análisis
                            </h5>
                            <p class="card-text text-muted">
                                El sistema analizará el contenido para identificar:
                            </p>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-check text-success me-2"></i>Sentimiento geopolítico</li>
                                <li><i class="fas fa-check text-success me-2"></i>Entidades mencionadas</li>
                                <li><i class="fas fa-check text-success me-2"></i>Nivel de riesgo</li>
                                <li><i class="fas fa-check text-success me-2"></i>Categorización de eventos</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="analysis-output" class="mt-4 glass-card" style="display: none;">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-chart-line me-2"></i>
                        Resultados del Análisis
                    </h5>
                    <div id="analysis-results"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Global Heat Map Section -->
    <div class="glass-card section-spacing">
        <div class="card-header">
            <h2 class="mb-0">
                <i class="fas fa-globe-americas me-2"></i>
                Mapa de Calor Global de Riesgos
            </h2>
        </div>
        <div class="card-body">
                <div class="row g-4">
                <div class="col-12 col-lg-9">
                    <div id="global-heatmap" style="height: 500px !important; width: 100%; background-color: #1f2937; border-radius: 15px; overflow: hidden; position: relative; z-index: 1;"></div>
                </div>
                <div class="col-12 col-lg-3">
                    <div class="glass-card">
                        <div class="card-body">
                            <h6 class="card-title">Leyenda de Riesgos</h6>
                            <div class="risk-legend">
                                <div class="d-flex align-items-center mb-2">
                                    <div class="risk-indicator risk-critical me-2"></div>
                                    <span class="small">Crítico (9-10)</span>
                                </div>
                                <div class="d-flex align-items-center mb-2">
                                    <div class="risk-indicator risk-high me-2"></div>
                                    <span class="small">Alto (7-8)</span>
                                </div>
                                <div class="d-flex align-items-center mb-2">
                                    <div class="risk-indicator risk-medium me-2"></div>
                                    <span class="small">Medio (4-6)</span>
                                </div>
                                <div class="d-flex align-items-center">
                                    <div class="risk-indicator risk-low me-2"></div>
                                    <span class="small">Bajo (1-3)</span>
                                </div>
                            </div>
                            
                            <hr>
                            
                            <h6 class="card-title mt-3">Estadísticas</h6>
                            <div id="heatmap-stats">
                                <div class="stat-item mb-2">
                                    <small class="text-muted">Países monitoreados:</small>
                                    <div class="fw-bold" id="countries-count">195</div>
                                </div>
                                <div class="stat-item mb-2">
                                    <small class="text-muted">Eventos activos:</small>
                                    <div class="fw-bold" id="active-events">1,247</div>
                                </div>
                                <div class="stat-item">
                                    <small class="text-muted">Última actualización:</small>
                                    <div class="fw-bold small" id="last-update">Hace 5 min</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Analysis Results -->
    <div class="glass-card section-spacing">
        <div class="card-header">
            <h2 class="mb-0">
                <i class="fas fa-history me-2"></i>
                Análisis Recientes
            </h2>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table modern-table">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Fuente</th>
                            <th>Región</th>
                            <th>Sentimiento</th>
                            <th>Riesgo</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="recent-analysis-table">
                        <!-- Datos se cargarán dinámicamente -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

<style>
/* Risk indicators for the legend */
.risk-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
}

.risk-critical {
    background-color: #dc2626;
}

.risk-high {
    background-color: #ef4444;
}

.risk-medium {
    background-color: #f59e0b;
}

.risk-low {
    background-color: #10b981;
}

/* Ensure map container has proper styling */
#global-heatmap {
    background-color: #1f2937;
    border-radius: 15px;
    width: 100%;
    height: 500px !important;
    min-height: 500px;
    position: relative;
    z-index: 1;
}

/* Fix for mobile responsiveness */
@media (max-width: 991px) {
    #global-heatmap {
        height: 300px !important;
        min-height: 300px;
    }
}

/* Leaflet specific fixes */
.leaflet-container {
    background: #1f2937 !important;
    border-radius: 15px;
}

.leaflet-control-container .leaflet-top.leaflet-left {
    top: 10px;
    left: 10px;
}

.leaflet-control-container .leaflet-top.leaflet-right {
    top: 10px;
    right: 10px;
}

/* Popup styling */
.leaflet-popup-content-wrapper {
    background-color: #374151 !important;
    color: #f3f4f6 !important;
    border-radius: 8px !important;
}

.leaflet-popup-tip {
    background-color: #374151 !important;
}

.popup-content {
    color: #f3f4f6;
    font-size: 0.9rem;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing components...');
    
    // Wait for page layout to complete before initializing map
    setTimeout(() => {
        // Initialize components with error handling
        try {
            initializeGlobalHeatmap();
        } catch (error) {
            console.error('Error initializing heatmap:', error);
        }
        
        try {
            loadRecentAnalysis();
        } catch (error) {
            console.error('Error loading recent analysis:', error);
        }
    }, 250);
    
    // Analysis button functionality
    const analysisButton = document.getElementById('analysis-button');
    if (analysisButton) {
        analysisButton.addEventListener('click', performAnalysis);
    }
});

function initializeGlobalHeatmap() {
    const mapContainer = document.getElementById('global-heatmap');
    if (!mapContainer) {
        console.error('Map container not found');
        return;
    }

    // Log container dimensions for debugging
    const { offsetWidth, offsetHeight } = mapContainer;
    console.log(`Map container dimensions: ${offsetWidth}px x ${offsetHeight}px`);

    if (offsetWidth === 0 || offsetHeight === 0) {
        console.error('Map container has invalid dimensions');
        return;
    }

    console.log('Initializing map...');
    
    // Clear any existing map instance
    if (window.globalMap) {
        window.globalMap.remove();
    }

    // Initialize Leaflet map with specific options
    const map = L.map('global-heatmap', {
        center: [20, 0],
        zoom: 2,
        zoomControl: true,
        attributionControl: true,
        scrollWheelZoom: true,
        doubleClickZoom: true,
        boxZoom: true,
        keyboard: true,
        dragging: true,
        touchZoom: true
    });
    
    // Store map reference globally
    window.globalMap = map;
    
    console.log('Map created, adding tile layer...');
    
    // Add tile layer with dark theme
    const tileLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd',
        maxZoom: 19
    });
    
    tileLayer.addTo(map);

    // Force map size recalculation
    setTimeout(() => {
        map.invalidateSize();
        console.log('Map size invalidated after initialization');
    }, 100);

    console.log('Heatmap initialization complete');
}

function updateHeatmapStats() {
    // Simulate real-time updates
    setInterval(() => {
        const events = Math.floor(Math.random() * 100) + 1200;
        document.getElementById('active-events').textContent = events.toLocaleString();
        
        const now = new Date();
        document.getElementById('last-update').textContent = `Hace ${Math.floor(Math.random() * 10) + 1} min`;
    }, 30000);
}

function performAnalysis() {
    const input = document.getElementById('analysis-input');
    if (!input) {
        console.error('Analysis input not found');
        return;
    }
    
    const inputValue = input.value.trim();
    if (!inputValue) {
        console.warn('Please enter text to analyze');
        return;
    }
    
    const button = document.getElementById('analysis-button');
    if (!button) {
        console.error('Analysis button not found');
        return;
    }
    
    const originalText = button.innerHTML;
    
    // Show loading state
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Analizando...';
    button.disabled = true;
    
    // Simulate API call
    setTimeout(() => {
        const results = generateMockAnalysis(inputValue);
        displayAnalysisResults(results);
        
        // Reset button
        button.innerHTML = originalText;
        button.disabled = false;
        
        console.log('Analysis completed successfully');
    }, 2000);
}

function generateMockAnalysis(text) {
    const sentiment = (Math.random() - 0.5) * 2; // -1 to 1
    const riskLevel = Math.random() * 10; // 0 to 10
    const entities = ['Estados Unidos', 'China', 'Rusia', 'Ucrania', 'Israel'];
    
    return {
        sentiment: sentiment,
        riskLevel: riskLevel,
        entities: entities.slice(0, Math.floor(Math.random() * 3) + 1),
        category: ['military_conflict', 'diplomatic_crisis', 'economic_tension'][Math.floor(Math.random() * 3)],
        confidence: Math.random() * 0.3 + 0.7,
        wordCount: text.split(' ').length
    };
}

function displayAnalysisResults(results) {
    const outputDiv = document.getElementById('analysis-output');
    const resultsDiv = document.getElementById('analysis-results');
    
    if (!outputDiv || !resultsDiv) {
        console.error('Analysis output containers not found');
        return;
    }
    
    const sentimentClass = results.sentiment > 0.1 ? 'success' : results.sentiment < -0.1 ? 'danger' : 'warning';
    const riskClass = results.riskLevel > 7 ? 'danger' : results.riskLevel > 4 ? 'warning' : 'success';
    
    resultsDiv.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <div class="stat-card mb-3">
                    <div class="stat-number text-${sentimentClass}">
                        ${results.sentiment.toFixed(2)}
                    </div>
                    <div class="stat-label">Sentimiento</div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="stat-card mb-3">
                    <div class="stat-number text-${riskClass}">
                        ${results.riskLevel.toFixed(1)}/10
                    </div>
                    <div class="stat-label">Nivel de Riesgo</div>
                </div>
            </div>
        </div>
        
        <div class="row mt-3">
            <div class="col-md-6">
                <h6>Entidades Detectadas:</h6>
                <div class="mb-3">
                    ${results.entities.map(entity => `<span class="badge bg-primary me-1">${entity}</span>`).join('')}
                </div>
            </div>
            <div class="col-md-6">
                <h6>Detalles del Análisis:</h6>
                <ul class="list-unstyled">
                    <li><strong>Categoría:</strong> <span class="badge bg-secondary">${results.category}</span></li>
                    <li><strong>Confianza:</strong> ${(results.confidence * 100).toFixed(1)}%</li>
                    <li><strong>Palabras analizadas:</strong> ${results.wordCount}</li>
                </ul>
            </div>
        </div>
    `;
    
    outputDiv.style.display = 'block';
}

function loadRecentAnalysis() {
    const tableBody = document.getElementById('recent-analysis-table');
    
    if (!tableBody) {
        console.error('Recent analysis table not found');
        return;
    }
    
    // Mock data for recent analysis
    const recentData = [
        {
            date: '2025-01-15 14:30',
            source: 'Reuters',
            region: 'Europa Oriental',
            sentiment: 0.2,
            risk: 6.5
        },
        {
            date: '2025-01-15 13:45',
            source: 'BBC',
            region: 'Medio Oriente',
            sentiment: -0.7,
            risk: 8.2
        },
        {
            date: '2025-01-15 12:15',
            source: 'CNN',
            region: 'Asia Pacífico',
            sentiment: 0.1,
            risk: 4.3
        }
    ];
    
    tableBody.innerHTML = recentData.map(item => {
        const sentimentClass = item.sentiment > 0.1 ? 'success' : item.sentiment < -0.1 ? 'danger' : 'warning';
        const riskClass = item.risk > 7 ? 'danger' : item.risk > 4 ? 'warning' : 'success';
        
        return `
            <tr>
                <td>${item.date}</td>
                <td>${item.source}</td>
                <td>${item.region}</td>
                <td><span class="badge bg-${sentimentClass}">${item.sentiment.toFixed(2)}</span></td>
                <td><span class="badge bg-${riskClass}">${item.risk.toFixed(1)}</span></td>
                <td>
                    <button class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-eye"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}
</script>
{% endblock %}