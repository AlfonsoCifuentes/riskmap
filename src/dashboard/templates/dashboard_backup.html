{% extends "base.html" %}

{% block title %}Dashboard - Geopolitical Intelligence{% endblock %}

{% block content %}
<div class="row">
    <!-- Summary Statistics -->
    <div class="col-12 mb-4">
        <h1 class="display-4 mb-4">
            <i class="fas fa-globe-americas me-3"></i>
            Geopolitical Intelligence Dashboard
        </h1>
        <p class="lead text-muted">Real-time monitoring and analysis of global geopolitical events</p>
    </div>

    <!-- Key Metrics Cards -->
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card stat-card">
            <div class="stat-number" id="total-articles">-</div>
            <div class="stat-label">Articles This Week</div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card stat-card">
            <div class="stat-number" id="total-processed">-</div>
            <div class="stat-label">Processed Articles</div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card stat-card">
            <div class="stat-number" id="active-regions">-</div>
            <div class="stat-label">Active Regions</div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card stat-card">
            <div class="stat-number" id="risk-level">-</div>
            <div class="stat-label">Global Risk Level</div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Filters -->
    <div class="col-12">
        <div class="filter-section">
            <h5><i class="fas fa-filter me-2"></i>Filters</h5>
            <div class="row">
                <div class="col-md-2">
                    <label for="days-filter" class="form-label">Time Period</label>
                    <select class="form-select" id="days-filter">
                        <option value="1">Last 24 hours</option>
                        <option value="3">Last 3 days</option>
                        <option value="7" selected>Last week</option>
                        <option value="30">Last month</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="category-filter" class="form-label">Category</label>
                    <select class="form-select" id="category-filter">
                        <option value="">All Categories</option>
                        <option value="military_conflict">Military Conflict</option>
                        <option value="protest">Protest</option>
                        <option value="diplomatic_crisis">Diplomatic Crisis</option>
                        <option value="natural_disaster">Natural Disaster</option>
                        <option value="neutral">Neutral</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="language-filter" class="form-label">Language</label>
                    <select class="form-select" id="language-filter">
                        <option value="">All Languages</option>
                        <option value="en">English</option>
                        <option value="es">Spanish</option>
                        <option value="ru">Russian</option>
                        <option value="zh">Chinese</option>
                        <option value="ar">Arabic</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="sentiment-filter" class="form-label">Sentiment</label>
                    <select class="form-select" id="sentiment-filter">
                        <option value="">All Sentiments</option>
                        <option value="positive">Positive</option>
                        <option value="neutral">Neutral</option>
                        <option value="negative">Negative</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="limit-filter" class="form-label">Limit</label>
                    <select class="form-select" id="limit-filter">
                        <option value="25">25 articles</option>
                        <option value="50" selected>50 articles</option>
                        <option value="100">100 articles</option>
                    </select>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button class="btn btn-primary w-100" onclick="applyFilters()">
                        <i class="fas fa-search me-2"></i>Apply
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Charts Section -->
    <div class="col-lg-8">
        <!-- Sentiment Timeline Chart -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-chart-line me-2"></i>Sentiment Timeline</h5>
            </div>
            <div class="card-body">
                <div id="sentiment-timeline"></div>
            </div>
        </div>

        <!-- Category Distribution Chart -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-chart-pie me-2"></i>Event Categories</h5>
            </div>
            <div class="card-body">
                <div id="category-distribution"></div>
            </div>
        </div>
    </div>

    <!-- Risk Regions Sidebar -->
    <div class="col-lg-4">
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-newspaper me-2"></i>Recent Articles</h5>
            </div>
            <div class="card-body">
                <div id="risk-regions"></div>
            </div>
        </div>

        <!-- Language Distribution -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-language me-2"></i>Languages</h5>
            </div>
            <div class="card-body">
                <div id="language-stats"></div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Recent Articles Table -->
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-newspaper me-2"></i>Recent Articles</h5>
                <button class="btn btn-outline-light btn-sm" onclick="refreshArticles()">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-dark table-hover">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Source</th>
                                <th>Category</th>
                                <th>Sentiment</th>
                                <th>Language</th>
                                <th>Published</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="articles-table">
                            <tr>
                                <td colspan="7" class="text-center">
                                    <div class="loading">
                                        <div class="spinner-border" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Article Modal -->
<div class="modal fade" id="articleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="articleModalTitle">Article Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="articleModalBody">
                <!-- Article content will be loaded here -->
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a id="articleModalLink" href="#" target="_blank" class="btn btn-primary">
                    <i class="fas fa-external-link-alt me-1"></i>Read Full Article
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Global variables
    let summaryData = {};
    let articlesData = [];

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function() {
        loadSummary();
        loadArticles();
        loadCharts();
    });

    // Load summary statistics
    async function loadSummary() {
        try {
            const response = await fetch('/api/summary');
            summaryData = await response.json();
            
            updateSummaryCards();
            updateRiskRegions();
            updateLanguageStats();
            
        } catch (error) {
            console.error('Error loading summary:', error);
            showToast('Failed to load summary data', 'error');
        }
    }

    // Update summary cards
    function updateSummaryCards() {
        document.getElementById('total-articles').textContent = summaryData.articles_week || 0;
        document.getElementById('total-processed').textContent = summaryData.processed_articles || 0;
        document.getElementById('active-regions').textContent = summaryData.active_regions || 0;
        
        // Calculate global risk level
        const riskLevel = calculateGlobalRisk();
        document.getElementById('risk-level').textContent = riskLevel.level;
        document.getElementById('risk-level').className = `stat-number text-${riskLevel.color}`;
    }

    // Calculate global risk level
    function calculateGlobalRisk() {
        // Use the risk level from API
        const level = summaryData.global_risk_level || 'LOW';
        let color = 'success';
        
        if (level === 'HIGH') {
            color = 'danger';
        } else if (level === 'MEDIUM') {
            color = 'warning';
        }
        
        return { level: level, color: color };
    }

    // Update recent articles (replacing risk regions)
    function updateRiskRegions() {
        const container = document.getElementById('risk-regions');
        
        if (!summaryData.recent_articles || summaryData.recent_articles.length === 0) {
            container.innerHTML = '<p class="text-muted">No recent articles available</p>';
            return;
        }

        const html = summaryData.recent_articles.map(article => {
            return `
                <div class="d-flex justify-content-between align-items-center mb-3 p-3 rounded" 
                     style="background: rgba(255,255,255,0.05);">
                    <div>
                        <span class="risk-indicator risk-medium"></span>
                        <strong style="font-size: 0.9rem;">${article.title.substring(0, 50)}${article.title.length > 50 ? '...' : ''}</strong>
                        <br>
                        <small class="text-muted">${article.source} • ${article.language}</small>
                    </div>
                    <div class="text-end">
                        <span class="badge badge-info">${article.language.toUpperCase()}</span>
                        <br>
                        <small class="text-muted">
                            ${new Date(article.created_at).toLocaleDateString()}
                        </small>
                    </div>
                </div>
            `;
        }).join('');

        container.innerHTML = html;
    }

    // Update language statistics
    function updateLanguageStats() {
        const container = document.getElementById('language-stats');
        
        if (!summaryData.language_distribution) {
            container.innerHTML = '<p class="text-muted">No language data available</p>';
            return;
        }

        const total = Object.values(summaryData.language_distribution).reduce((sum, count) => sum + count, 0);
        
        const html = Object.entries(summaryData.language_distribution).map(([lang, count]) => {
            const percentage = ((count / total) * 100).toFixed(1);
            const langName = {
                'en': 'English',
                'es': 'Spanish', 
                'ru': 'Russian',
                'zh': 'Chinese',
                'ar': 'Arabic',
                'fr': 'French',
                'de': 'German',
                'pt': 'Portuguese',
                'it': 'Italian'
            }[lang] || lang.toUpperCase();

            return `
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span>${langName}</span>
                        <span class="text-muted">${count} (${percentage}%)</span>
                    </div>
                    <div class="progress" style="height: 6px;">
                        <div class="progress-bar bg-primary" style="width: ${percentage}%"></div>
                    </div>
                </div>
            `;
        }).join('');

        container.innerHTML = html;
    }

    // Load articles
    async function loadArticles() {
        const filters = getFilters();
        const params = new URLSearchParams(filters);
        
        try {
            showLoading('articles-table');
            
            const response = await fetch(`/api/articles?${params}`);
            const data = await response.json();
            
            articlesData = data.articles || [];
            updateArticlesTable();
            
        } catch (error) {
            console.error('Error loading articles:', error);
            showError('articles-table', 'Failed to load articles');
        }
    }

    // Get current filter values
    function getFilters() {
        return {
            days: document.getElementById('days-filter').value,
            category: document.getElementById('category-filter').value,
            language: document.getElementById('language-filter').value,
            sentiment: document.getElementById('sentiment-filter').value,
            limit: document.getElementById('limit-filter').value
        };
    }

    // Update articles table
    function updateArticlesTable() {
        const tbody = document.getElementById('articles-table');
        
        if (articlesData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No articles found</td></tr>';
            return;
        }

        const html = articlesData.map(article => `
            <tr>
                <td>
                    <div class="d-flex align-items-start">
                        <div>
                            <strong class="text-truncate d-block" style="max-width: 300px;" 
                                    title="${article.title}">
                                ${article.title}
                            </strong>
                            ${article.summary ? `
                                <small class="text-muted d-block mt-1" style="max-width: 300px;">
                                    ${article.summary.substring(0, 100)}...
                                </small>
                            ` : ''}
                        </div>
                    </div>
                </td>
                <td>
                    <span class="badge bg-secondary">${article.source}</span>
                </td>
                <td>
                    ${article.category ? 
                        `<span class="badge ${getCategoryBadgeClass(article.category)}">${article.category}</span>` 
                        : '<span class="text-muted">-</span>'
                    }
                </td>
                <td>
                    ${article.sentiment !== null ? `
                        <span class="${getSentimentClass(article.sentiment)}">
                            <i class="${getSentimentIcon(article.sentiment)}"></i>
                            ${article.sentiment.toFixed(2)}
                        </span>
                    ` : '<span class="text-muted">-</span>'}
                </td>
                <td>
                    <span class="badge bg-info">${article.language.toUpperCase()}</span>
                </td>
                <td>
                    <small>${formatDate(article.published_at)}</small>
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-primary me-1" 
                            onclick="showArticleModal(${article.id})"
                            title="View Details">
                        <i class="fas fa-eye"></i>
                    </button>
                    <a href="${article.url}" target="_blank" 
                       class="btn btn-sm btn-outline-secondary"
                       title="Open Original">
                        <i class="fas fa-external-link-alt"></i>
                    </a>
                </td>
            </tr>
        `).join('');

        tbody.innerHTML = html;
    }

    // Show article in modal
    function showArticleModal(articleId) {
        const article = articlesData.find(a => a.id === articleId);
        if (!article) return;

        document.getElementById('articleModalTitle').textContent = article.title;
        document.getElementById('articleModalLink').href = article.url;
        
        const entities = article.entities || {};
        const entitiesHtml = Object.entries(entities).map(([type, values]) => {
            if (values && values.length > 0) {
                return `
                    <div class="mb-2">
                        <strong>${type}:</strong> 
                        ${values.map(v => `<span class="badge bg-secondary me-1">${v}</span>`).join('')}
                    </div>
                `;
            }
            return '';
        }).join('');

        document.getElementById('articleModalBody').innerHTML = `
            <div class="mb-3">
                <h6>Summary</h6>
                <p>${article.summary || 'No summary available'}</p>
            </div>
            
            <div class="mb-3">
                <h6>Content Preview</h6>
                <p class="text-muted">${article.content}</p>
            </div>
            
            <div class="mb-3">
                <h6>Analysis</h6>
                <div class="row">
                    <div class="col-md-6">
                        <strong>Category:</strong> 
                        ${article.category ? 
                            `<span class="badge ${getCategoryBadgeClass(article.category)}">${article.category}</span>` 
                            : 'Not classified'
                        }
                    </div>
                    <div class="col-md-6">
                        <strong>Sentiment:</strong> 
                        ${article.sentiment !== null ? 
                            `<span class="${getSentimentClass(article.sentiment)}">${article.sentiment.toFixed(2)}</span>` 
                            : 'Not analyzed'
                        }
                    </div>
                </div>
            </div>
            
            ${entitiesHtml ? `
                <div class="mb-3">
                    <h6>Extracted Entities</h6>
                    ${entitiesHtml}
                </div>
            ` : ''}
            
            <div class="mb-3">
                <h6>Metadata</h6>
                <small class="text-muted">
                    Source: ${article.source} | 
                    Language: ${article.language.toUpperCase()} | 
                    Published: ${formatDate(article.published_at)}
                    ${article.confidence_score ? ` | Confidence: ${(article.confidence_score * 100).toFixed(1)}%` : ''}
                </small>
            </div>
        `;

        new bootstrap.Modal(document.getElementById('articleModal')).show();
    }

    // Load charts
    async function loadCharts() {
        await loadSentimentTimeline();
        await loadCategoryDistribution();
    }

    // Load sentiment timeline chart
    async function loadSentimentTimeline() {
        const filters = getFilters();
        const params = new URLSearchParams({ days: filters.days });
        
        try {
            const response = await fetch(`/api/charts/sentiment-timeline?${params}`);
            const data = await response.json();
            
            // Process data for Plotly
            const traces = {};
            const categories = ['military_conflict', 'protest', 'diplomatic_crisis', 'natural_disaster', 'neutral'];
            
            categories.forEach(category => {
                traces[category] = {
                    x: [],
                    y: [],
                    name: category.replace('_', ' ').toUpperCase(),
                    type: 'scatter',
                    mode: 'lines+markers'
                };
            });

            Object.entries(data.timeline || {}).forEach(([date, categoryData]) => {
                categories.forEach(category => {
                    traces[category].x.push(date);
                    traces[category].y.push(categoryData[category]?.sentiment || 0);
                });
            });

            const layout = {
                title: 'Sentiment Timeline by Category',
                xaxis: { title: 'Date' },
                yaxis: { title: 'Average Sentiment' },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: '#f0f6fc' }
            };

            Plotly.newPlot('sentiment-timeline', Object.values(traces), layout, {responsive: true});
            
        } catch (error) {
            console.error('Error loading sentiment timeline:', error);
            document.getElementById('sentiment-timeline').innerHTML = 
                '<div class="alert alert-danger">Failed to load sentiment timeline</div>';
        }
    }

    // Load category distribution chart
    async function loadCategoryDistribution() {
        const filters = getFilters();
        const params = new URLSearchParams({ days: filters.days });
        
        try {
            const response = await fetch(`/api/charts/category-distribution?${params}`);
            const data = await response.json();
            
            const categories = data.distribution || [];
            
            const trace = {
                labels: categories.map(c => c.category.replace('_', ' ').toUpperCase()),
                values: categories.map(c => c.count),
                type: 'pie',
                textinfo: 'label+percent',
                textposition: 'outside'
            };

            const layout = {
                title: 'Event Distribution by Category',
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: '#f0f6fc' }
            };

            Plotly.newPlot('category-distribution', [trace], layout, {responsive: true});
            
        } catch (error) {
            console.error('Error loading category distribution:', error);
            document.getElementById('category-distribution').innerHTML = 
                '<div class="alert alert-danger">Failed to load category distribution</div>';
        }
    }

    // Apply filters
    function applyFilters() {
        loadArticles();
        loadCharts();
        showToast('Filters applied successfully', 'success');
    }

    // Refresh articles
    function refreshArticles() {
        loadArticles();
        showToast('Articles refreshed', 'info');
    }

    // Auto-refresh every 5 minutes
    setInterval(() => {
        loadSummary();
        loadArticles();
    }, 300000);
</script>
{% endblock %}
