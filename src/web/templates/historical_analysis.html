{% extends "base_navigation.html" %}

{% block title %}An√°lisis Hist√≥rico - Stratosight{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<style>
    :root {
        --bg-primary: linear-gradient(180deg, #0a0f2c 0%, #1a2040 40%, #2a3558 80%, #3a4a70 100%);
        --bg-secondary: #141824;
        --text-primary: #e8eaed;
        --text-secondary: #b0b8c4;
        --accent-cyan: #00d4ff;
        --accent-glow: 0 0 15px rgba(0, 212, 255, 0.4), 0 0 25px rgba(0, 212, 255, 0.2);
        --border-color: rgba(255, 255, 255, 0.1);
    }

    /* Header Section Styling */
    .header-section {
        width: 100vw;
        position: relative;
        left: 50%;
        right: 50%;
        margin-left: -50vw;
        margin-right: -50vw;
        top: -80px;
        margin-bottom: -80px;
        z-index: 0;
        background: linear-gradient(135deg, rgba(26, 32, 64, 0.75) 0%, rgba(16, 24, 48, 0.8) 50%, rgba(20, 28, 56, 0.75) 100%);
        backdrop-filter: blur(10px);
        box-shadow: 0 2px 20px rgba(0, 0, 0, 0.3);
        padding: 180px 0 80px 0;
        text-align: center;
    }

    .page-title {
        font-family: 'Orbitron', monospace;
        font-size: clamp(2rem, 6vw, 4rem);
        font-weight: 700;
        margin-bottom: 10px;
        background: linear-gradient(135deg, #00d4ff 0%, #00a3cc 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        line-height: 1.2;
    }

    .page-subtitle {
        font-size: 1.2rem;
        color: var(--text-secondary);
        margin-bottom: 30px;
    }

    /* Historical Analysis Specific Styles - Unified Design */
    .historical-dashboard {
        padding: 20px;
        max-width: none;
        margin: 40px auto 0 auto;
        position: relative;
        z-index: 2;
        display: flex;
        flex-direction: column;
        min-height: calc(100vh - 80px);
        background: rgba(10, 15, 44, 0.08);
        backdrop-filter: blur(2px);
        gap: 0;
        width: 100vw;
        box-sizing: border-box;
    }
    
    .dashboard-content {
        max-width: 96%;
        margin: 0 auto !important;
        padding: 50px 40px;
        width: 100%;
        box-sizing: border-box;
    }
    
    /* Glass card mejorado */
    .glass-card {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        backdrop-filter: blur(10px);
        margin-bottom: 30px;
        padding: 40px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    
    .page-header {
        text-align: center;
        margin-bottom: 40px;
        color: #fff;
    }

    /* Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: rgba(255, 255, 255, 0.03);
        border-radius: 15px;
        padding: 1.5rem;
        text-align: center;
        transition: all 0.3s ease;
        border: 1px solid rgba(255, 255, 255, 0.05);
        position: relative;
        overflow: hidden;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        background: rgba(255, 255, 255, 0.08);
        box-shadow: 0 15px 35px rgba(0, 212, 255, 0.1);
    }

    .stat-icon {
        font-size: 2.5rem;
        color: #00d4ff;
        margin-bottom: 1rem;
    }

    .stat-number {
        font-size: 2rem;
        font-weight: 700;
        color: #ffffff;
        margin-bottom: 0.5rem;
    }

    .stat-label {
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.9rem;
        font-weight: 500;
    }

    /* Modern Dashboard Styles - Integrated from modern template */
    .tab-navigation {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
    }

    .tab-button {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: rgba(255, 255, 255, 0.8);
        padding: 0.75rem 1.5rem;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
        font-weight: 500;
    }

    .tab-button:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(0, 212, 255, 0.5);
    }

    .tab-button.active {
        color: #00d4ff;
        background: rgba(0, 212, 255, 0.15);
        box-shadow: 0 4px 15px rgba(0, 212, 255, 0.2);
    }

    .filter-panel {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .filter-group {
        position: relative;
    }

    .filter-label {
        display: block;
        color: #00d4ff;
        font-size: 0.9rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .filter-select, .filter-input {
        width: 100%;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 0.75rem;
        color: #ffffff;
        font-size: 0.9rem;
        transition: all 0.3s ease;
    }

    .filter-select:focus, .filter-input:focus {
        outline: none;
        border-color: #00d4ff;
        box-shadow: 0 0 15px rgba(0, 212, 255, 0.3);
    }

    .content-area {
        display: none;
    }

    .content-area.active {
        display: block;
    }

    .content-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-bottom: 2rem;
    }

    .chart-container {
        background: rgba(255, 255, 255, 0.03);
        border-radius: 15px;
        padding: 1.5rem;
        border: 1px solid rgba(255, 255, 255, 0.05);
        min-height: 300px;
    }

    .map-container {
        height: 400px;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 15px;
        margin-bottom: 2rem;
        border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
        background: rgba(255, 255, 255, 0.02);
        border-radius: 10px;
        overflow: hidden;
        margin-top: 1rem;
    }

    .data-table th,
    .data-table td {
        padding: 1rem;
        text-align: left;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .data-table th {
        background: rgba(0, 212, 255, 0.1);
        color: #00d4ff;
        font-weight: 600;
    }

    .data-table tr:hover {
        background: rgba(255, 255, 255, 0.05);
    }

    .header-controls {
        display: flex;
        gap: 1rem;
        align-items: center;
    }

    .btn {
        background: linear-gradient(45deg, #00d4ff, #0097a7);
        border: none;
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 10px;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 600;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(0, 212, 255, 0.3);
    }

    .btn-secondary {
        background: rgba(255, 255, 255, 0.1);
    }

    .alerts-panel {
        min-height: 300px;
    }

    .alert-item {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
        border-left: 4px solid;
    }

    .alert-high {
        border-left-color: #ff4757;
    }

    .alert-medium {
        border-left-color: #ffa726;
    }

    .alert-low {
        border-left-color: #66bb6a;
    }

    .alert-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }

    .alert-severity {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .severity-high {
        background: rgba(255, 71, 87, 0.2);
        color: #ff4757;
    }

    .severity-medium {
        background: rgba(255, 167, 38, 0.2);
        color: #ffa726;
    }

    .severity-low {
        background: rgba(102, 187, 106, 0.2);
        color: #66bb6a;
    }

    .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 200px;
        color: rgba(255, 255, 255, 0.7);
    }

    .spinner {
        animation: spin 1s linear infinite;
        margin-right: 1rem;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .heatmap-container {
        background: rgba(255, 255, 255, 0.03);
        border-radius: 15px;
        padding: 1.5rem;
        border: 1px solid rgba(255, 255, 255, 0.05);
        min-height: 400px;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .historical-dashboard {
            padding: 20px;
        }
        
        .page-title {
            font-size: 2rem;
        }
        
        .content-grid {
            grid-template-columns: 1fr;
        }
        
        .filter-panel {
            grid-template-columns: 1fr;
        }
        
        .tab-navigation {
            overflow-x: auto;
            white-space: nowrap;
        }
        
        .tab-button {
            flex-shrink: 0;
        }
        
        .stats-grid {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }
    }

    /* New styles for expanded dashboard */
    
    /* Timeline controls */
    .timeline-controls {
        margin-bottom: 1.5rem;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        border: 1px solid rgba(0, 212, 255, 0.2);
    }

    .time-range-selector {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .time-range-selector button {
        padding: 0.5rem 1rem;
        border: 1px solid rgba(0, 212, 255, 0.3);
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .time-range-selector button:hover,
    .time-range-selector button.active {
        background: rgba(0, 212, 255, 0.3);
        border-color: rgba(0, 212, 255, 0.8);
    }

    /* Stats grid for datasets */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(0, 212, 255, 0.3);
        border-radius: 12px;
        padding: 1.5rem;
        text-align: center;
        transition: all 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        border-color: rgba(0, 212, 255, 0.6);
        box-shadow: 0 10px 30px rgba(0, 212, 255, 0.2);
    }

    .stat-icon {
        font-size: 2rem;
        color: #00d4ff;
        margin-bottom: 0.5rem;
    }

    .stat-number {
        font-size: 2.5rem;
        font-weight: bold;
        color: #fff;
        margin-bottom: 0.5rem;
    }

    .stat-label {
        color: #ccc;
        font-size: 0.9rem;
    }

    /* AI Analysis controls */
    .ai-analysis-controls {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
    }

    .ai-analysis-controls .btn {
        padding: 0.8rem 1.5rem;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    /* Comparison controls */
    .comparison-controls {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
        align-items: center;
        flex-wrap: wrap;
    }

    /* Scenario controls */
    .scenario-controls {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
        align-items: center;
        flex-wrap: wrap;
    }

    .scenario-selector {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    /* Interactive timeline */
    #interactiveTimeline {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(0, 212, 255, 0.2);
        border-radius: 8px;
        padding: 1rem;
    }

    /* Executive summary */
    #executiveSummary {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(0, 212, 255, 0.2);
        border-radius: 8px;
        padding: 1.5rem;
        line-height: 1.6;
    }

    /* High risk articles grid */
    #highRiskArticlesGrid {
        display: grid;
        gap: 1rem;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    }

    .article-card {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 0, 100, 0.3);
        border-radius: 8px;
        padding: 1rem;
        transition: all 0.3s ease;
    }

    .article-card:hover {
        border-color: rgba(255, 0, 100, 0.6);
        transform: translateY(-2px);
    }

    .article-title {
        color: #ff0064;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }

    .article-meta {
        color: #ccc;
        font-size: 0.8rem;
        margin-bottom: 0.5rem;
    }

    .article-risk-score {
        background: rgba(255, 0, 100, 0.2);
        color: #ff0064;
        padding: 0.3rem 0.8rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: bold;
        display: inline-block;
    }

    /* Latest articles list */
    #latestArticlesList {
        max-height: 400px;
        overflow-y: auto;
    }

    .article-item {
        padding: 1rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        transition: all 0.3s ease;
    }

    .article-item:hover {
        background: rgba(255, 255, 255, 0.05);
    }

    .article-item:last-child {
        border-bottom: none;
    }

    /* Data sources status */
    #dataSourcesStatus {
        display: grid;
        gap: 1rem;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    }

    .source-status-card {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(0, 212, 255, 0.2);
        border-radius: 8px;
        padding: 1rem;
    }

    .source-status-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }

    .source-name {
        font-weight: bold;
        color: #00d4ff;
    }

    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #00ff00;
    }

    .status-indicator.warning {
        background: #ffaa00;
    }

    .status-indicator.error {
        background: #ff0000;
    }

    .source-metrics {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    .metric-item {
        font-size: 0.8rem;
        color: #ccc;
    }

    .metric-value {
        color: #fff;
        font-weight: bold;
    }

    /* Patterns and analysis */
    #identifiedPatterns {
        display: grid;
        gap: 1rem;
    }

    .pattern-item {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(0, 212, 255, 0.2);
        border-radius: 8px;
        padding: 1rem;
    }

    .pattern-title {
        color: #00d4ff;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }

    .pattern-description {
        color: #ccc;
        line-height: 1.5;
        margin-bottom: 0.5rem;
    }

    .pattern-confidence {
        background: rgba(0, 212, 255, 0.2);
        color: #00d4ff;
        padding: 0.2rem 0.5rem;
        border-radius: 12px;
        font-size: 0.8rem;
        display: inline-block;
    }

    /* Additional responsive design for new elements */
    @media (max-width: 768px) {
        .tab-button {
            min-width: auto;
            width: 100%;
        }
        
        .comparison-controls,
        .scenario-controls,
        .ai-analysis-controls {
            flex-direction: column;
            align-items: stretch;
        }
        
        #highRiskArticlesGrid {
            grid-template-columns: 1fr;
        }
        
        #dataSourcesStatus {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Header Section -->
<div class="header-section">
    <h1 class="page-title">üèõÔ∏è An√°lisis Hist√≥rico</h1>
    <p class="page-subtitle">Patrones Geopol√≠ticos ‚Ä¢ Conflictos Hist√≥ricos ‚Ä¢ Lecciones Estrat√©gicas</p>
</div>

<div class="historical-dashboard">
    <div class="dashboard-content">
        <!-- Header Controls -->
        <div class="glass-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <i class="fas fa-chart-line" style="color: #00d4ff; font-size: 2rem;"></i>
                    <h1 style="color: #00d4ff; margin: 0;">An√°lisis Hist√≥rico Avanzado</h1>
                </div>
                <div class="header-controls">
                    <button class="btn" onclick="triggerETLUpdate()">
                        <i class="fas fa-sync-alt"></i>
                        Actualizar Datos
                    </button>
                    <button class="btn btn-secondary" onclick="exportData()">
                        <i class="fas fa-download"></i>
                        Exportar
                    </button>
                </div>
            </div>

            <!-- Filter Panel -->
            <div class="filter-panel">
                <div class="filter-group">
                    <label class="filter-label">Fecha Desde</label>
                    <input type="date" id="dateFrom" class="filter-input">
                </div>
                <div class="filter-group">
                    <label class="filter-label">Fecha Hasta</label>
                    <input type="date" id="dateTo" class="filter-input">
                </div>
                <div class="filter-group">
                    <label class="filter-label">Pa√≠ses</label>
                    <select id="countryFilter" class="filter-select" multiple>
                        <option value="">Todos los Pa√≠ses</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Categor√≠as</label>
                    <select id="categoryFilter" class="filter-select" multiple>
                        <option value="">Todas las Categor√≠as</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Acciones</label>
                    <button class="btn" onclick="applyFilters()" style="width: 100%;">
                        <i class="fas fa-filter"></i>
                        Aplicar Filtros
                    </button>
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="glass-card">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="stat-number" id="totalEvents">-</div>
                    <div class="stat-label">Total de Eventos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-number" id="recentEvents">-</div>
                    <div class="stat-label">Recientes (7 d√≠as)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-globe"></i>
                    </div>
                    <div class="stat-number" id="countriesAffected">-</div>
                    <div class="stat-label">Pa√≠ses Afectados</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    <div class="stat-number" id="avgEventsPerDay">-</div>
                    <div class="stat-label">Promedio Eventos/D√≠a</div>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="glass-card">
            <div class="tab-navigation">
                <button class="tab-button active" onclick="switchTab('overview')">
                    <i class="fas fa-chart-pie"></i>
                    Panorama General
                </button>
                <button class="tab-button" onclick="switchTab('timeline')">
                    <i class="fas fa-clock"></i>
                    L√≠nea Temporal
                </button>
                <button class="tab-button" onclick="switchTab('events')">
                    <i class="fas fa-calendar-alt"></i>
                    Eventos Hist√≥ricos
                </button>
                <button class="tab-button" onclick="switchTab('patterns')">
                    <i class="fas fa-search-plus"></i>
                    Patrones & Tendencias
                </button>
                <button class="tab-button" onclick="switchTab('geography')">
                    <i class="fas fa-globe"></i>
                    An√°lisis Geogr√°fico
                </button>
                <button class="tab-button" onclick="switchTab('predictions')">
                    <i class="fas fa-crystal-ball"></i>
                    Predicciones
                </button>
                <button class="tab-button" onclick="switchTab('intelligence')">
                    <i class="fas fa-brain"></i>
                    Inteligencia IA
                </button>
                <button class="tab-button" onclick="switchTab('datasets')">
                    <i class="fas fa-database"></i>
                    Fuentes de Datos
                </button>
                <button class="tab-button" onclick="switchTab('comparisons')">
                    <i class="fas fa-balance-scale"></i>
                    Comparativas
                </button>
                <button class="tab-button" onclick="switchTab('scenarios')">
                    <i class="fas fa-road"></i>
                    Escenarios
                </button>
            </div>

            <!-- Overview Tab -->
            <div id="overviewTab" class="content-area active">
                <div class="content-grid">
                    <div class="chart-container">
                        <h3 style="color: #00d4ff; margin-bottom: 1rem;">Cronolog√≠a Global de Eventos</h3>
                        <div id="globalTimelineChart"></div>
                    </div>
                    <div class="chart-container">
                        <h3 style="color: #00d4ff; margin-bottom: 1rem;">Intensidad de Conflictos</h3>
                        <div id="conflictIntensityChart"></div>
                    </div>
                </div>
                <div class="content-grid">
                    <div class="chart-container">
                        <h3 style="color: #00d4ff; margin-bottom: 1rem;">Distribuci√≥n Regional</h3>
                        <div id="regionalDistributionChart"></div>
                    </div>
                    <div class="chart-container">
                        <h3 style="color: #00d4ff; margin-bottom: 1rem;">Tendencias de Sentimiento</h3>
                        <div id="sentimentTrendsChart"></div>
                    </div>
                </div>
                <div class="map-container" id="overviewMap"></div>
                <div class="glass-panel">
                    <h3 style="color: #00d4ff; margin-bottom: 1rem;">Resumen Ejecutivo √öltimas 24h</h3>
                    <div id="executiveSummary"></div>
                </div>
            </div>

            <!-- Timeline Tab -->
            <div id="timelineTab" class="content-area">
                <div class="glass-panel">
                    <h3 style="color: #00d4ff; margin-bottom: 1rem;">L√≠nea Temporal Interactiva</h3>
                    <div class="timeline-controls">
                        <div class="time-range-selector">
                            <button class="btn btn-secondary" onclick="setTimeRange('1d')">24h</button>
                            <button class="btn btn-secondary" onclick="setTimeRange('7d')">7 d√≠as</button>
                            <button class="btn btn-secondary" onclick="setTimeRange('30d')">30 d√≠as</button>
                            <button class="btn btn-secondary" onclick="setTimeRange('90d')">90 d√≠as</button>
                            <button class="btn btn-secondary" onclick="setTimeRange('1y')">1 a√±o</button>
                            <button class="btn btn-secondary" onclick="setTimeRange('all')">Todo</button>
                        </div>
                    </div>
                    <div id="interactiveTimeline" style="height: 400px;"></div>
                </div>
                <div class="content-grid">
                    <div class="chart-container">
                        <h3 style="color: #00d4ff; margin-bottom: 1rem;">Eventos por Per√≠odo</h3>
                        <div id="eventsByPeriodChart"></div>
                    </div>
                    <div class="chart-container">
                        <h3 style="color: #00d4ff; margin-bottom: 1rem;">Correlaci√≥n Temporal</h3>
                        <div id="temporalCorrelationChart"></div>
                    </div>
                </div>
                <div class="glass-panel">
                    <h3 style="color: #00d4ff; margin-bottom: 1rem;">Cronolog√≠a Detallada</h3>
                    <div id="detailedTimeline"></div>
                </div>
            </div>

            <!-- Events Tab -->
            <div id="eventsTab" class="content-area">
                <div class="content-grid">
                    <div class="chart-container">
                        <h3 style="color: #00d4ff; margin-bottom: 1rem;">Cronolog√≠a de Eventos</h3>
                        <div id="eventsTimeChart"></div>
                    </div>
                    <div class="chart-container">
                        <h3 style="color: #00d4ff; margin-bottom: 1rem;">Distribuci√≥n por Categor√≠a</h3>
                        <div id="categoryChart"></div>
                    </div>
                </div>
                <div class="map-container" id="eventsMap"></div>
                <div class="glass-panel">
                    <h3 style="color: #00d4ff; margin-bottom: 1rem;">Eventos Recientes</h3>
                    <div id="eventsTable"></div>
                </div>
                <div class="glass-panel">
                    <h3 style="color: #00d4ff; margin-bottom: 1rem;">An√°lisis de Impacto</h3>
                    <div id="impactAnalysis"></div>
                </div>
            </div>

            <!-- Patterns Tab -->
            <div id="patternsTab" class="content-area">
                <div class="content-grid">
                    <div class="chart-container">
                        <h3 style="color: #00d4ff; margin-bottom: 1rem;">Patrones C√≠clicos</h3>
                        <div id="cyclicalPatternsChart"></div>
                    </div>
                    <div class="chart-container">
                        <h3 style="color: #00d4ff; margin-bottom: 1rem;">Anomal√≠as Detectadas</h3>
                        <div id="anomaliesChart"></div>
                    </div>
                </div>
                <div class="content-grid">
                    <div class="chart-container">
                        <h3 style="color: #00d4ff; margin-bottom: 1rem;">Tendencias Emergentes</h3>
                        <div id="emergingTrendsChart"></div>
                    </div>
                    <div class="chart-container">
                        <h3 style="color: #00d4ff; margin-bottom: 1rem;">An√°lisis de Frecuencia</h3>
                        <div id="frequencyAnalysisChart"></div>
                    </div>
                </div>
                <div class="glass-panel">
                    <h3 style="color: #00d4ff; margin-bottom: 1rem;">Patrones Identificados</h3>
                    <div id="identifiedPatterns"></div>
                </div>
            </div>

            <!-- Geography Tab -->
            <div id="geographyTab" class="content-area">
                <div class="map-container" id="geographyMap" style="height: 500px;"></div>
                <div class="content-grid">
                    <div class="chart-container">
                        <h3 style="color: #00d4ff; margin-bottom: 1rem;">Mapa de Calor Regional</h3>
                        <div id="regionalHeatmapChart"></div>
                    </div>
                    <div class="chart-container">
                        <h3 style="color: #00d4ff; margin-bottom: 1rem;">Flujos Migratorios</h3>
                        <div id="migrationFlowsChart"></div>
                    </div>
                </div>
                <div class="content-grid">
                    <div class="chart-container">
                        <h3 style="color: #00d4ff; margin-bottom: 1rem;">√çndices de Estabilidad</h3>
                        <div id="stabilityIndicesChart"></div>
                    </div>
                    <div class="chart-container">
                        <h3 style="color: #00d4ff; margin-bottom: 1rem;">Conexiones Geopol√≠ticas</h3>
                        <div id="geopoliticalConnectionsChart"></div>
                    </div>
                </div>
            </div>

            <!-- Predictions Tab -->
            <div id="predictionsTab" class="content-area">
                <div class="content-grid">
                    <div class="chart-container">
                        <h3 style="color: #00d4ff; margin-bottom: 1rem;">Modelos Predictivos</h3>
                        <div id="predictiveModelsChart"></div>
                    </div>
                    <div class="chart-container">
                        <h3 style="color: #00d4ff; margin-bottom: 1rem;">Probabilidades de Escenarios</h3>
                        <div id="scenarioProbabilitiesChart"></div>
                    </div>
                </div>
                <div class="content-grid">
                    <div class="chart-container">
                        <h3 style="color: #00d4ff; margin-bottom: 1rem;">Tendencias Futuras</h3>
                        <div id="futureTrendsChart"></div>
                    </div>
                    <div class="chart-container">
                        <h3 style="color: #00d4ff; margin-bottom: 1rem;">Factores de Riesgo</h3>
                        <div id="riskFactorsChart"></div>
                    </div>
                </div>
                <div class="glass-panel">
                    <h3 style="color: #00d4ff; margin-bottom: 1rem;">Predicciones IA</h3>
                    <div id="aiPredictions"></div>
                </div>
            </div>

            <!-- Intelligence Tab -->
            <div id="intelligenceTab" class="content-area">
                <div class="glass-panel">
                    <h3 style="color: #00d4ff; margin-bottom: 1rem;">An√°lisis de Inteligencia Artificial</h3>
                    <div class="ai-analysis-controls">
                        <button class="btn" onclick="generateAIAnalysis()">
                            <i class="fas fa-brain"></i>
                            Generar An√°lisis IA
                        </button>
                        <button class="btn btn-secondary" onclick="exportAIReport()">
                            <i class="fas fa-file-pdf"></i>
                            Exportar Reporte
                        </button>
                    </div>
                    <div id="aiAnalysisContent"></div>
                </div>
                <div class="content-grid">
                    <div class="chart-container">
                        <h3 style="color: #00d4ff; margin-bottom: 1rem;">An√°lisis de Sentimiento</h3>
                        <div id="aiSentimentChart"></div>
                    </div>
                    <div class="chart-container">
                        <h3 style="color: #00d4ff; margin-bottom: 1rem;">Extracci√≥n de Entidades</h3>
                        <div id="entityExtractionChart"></div>
                    </div>
                </div>
                <div class="glass-panel">
                    <h3 style="color: #00d4ff; margin-bottom: 1rem;">Art√≠culos de Alto Riesgo</h3>
                    <div id="highRiskArticlesGrid"></div>
                </div>
                <div class="glass-panel">
                    <h3 style="color: #00d4ff; margin-bottom: 1rem;">√öltimos Art√≠culos Analizados</h3>
                    <div id="latestArticlesList"></div>
                </div>
            </div>

            <!-- Datasets Tab -->
            <div id="datasetsTab" class="content-area">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-newspaper"></i></div>
                        <div class="stat-number" id="articlesCount">-</div>
                        <div class="stat-label">Art√≠culos Procesados</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-satellite"></i></div>
                        <div class="stat-number" id="gdeltRecords">-</div>
                        <div class="stat-label">Registros GDELT</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-exclamation-triangle"></i></div>
                        <div class="stat-number" id="acledEvents">-</div>
                        <div class="stat-label">Eventos ACLED</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-chart-line"></i></div>
                        <div class="stat-number" id="gprIndicators">-</div>
                        <div class="stat-label">Indicadores GPR</div>
                    </div>
                </div>
                <div class="content-grid">
                    <div class="chart-container">
                        <h3 style="color: #00d4ff; margin-bottom: 1rem;">Cobertura de Fuentes</h3>
                        <div id="sourceCoverageChart"></div>
                    </div>
                    <div class="chart-container">
                        <h3 style="color: #00d4ff; margin-bottom: 1rem;">Calidad de Datos</h3>
                        <div id="dataQualityChart"></div>
                    </div>
                </div>
                <div class="glass-panel">
                    <h3 style="color: #00d4ff; margin-bottom: 1rem;">Estado de Fuentes de Datos</h3>
                    <div id="dataSourcesStatus"></div>
                </div>
            </div>

            <!-- Comparisons Tab -->
            <div id="comparisonsTab" class="content-area">
                <div class="glass-panel">
                    <h3 style="color: #00d4ff; margin-bottom: 1rem;">Comparativas Hist√≥ricas</h3>
                    <div class="comparison-controls">
                        <select id="comparisonType" class="filter-select">
                            <option value="regions">Comparar Regiones</option>
                            <option value="periods">Comparar Per√≠odos</option>
                            <option value="categories">Comparar Categor√≠as</option>
                            <option value="countries">Comparar Pa√≠ses</option>
                        </select>
                        <button class="btn" onclick="generateComparison()">
                            <i class="fas fa-chart-bar"></i>
                            Generar Comparativa
                        </button>
                    </div>
                    <div id="comparisonResults"></div>
                </div>
                <div class="content-grid">
                    <div class="chart-container">
                        <h3 style="color: #00d4ff; margin-bottom: 1rem;">An√°lisis Comparativo</h3>
                        <div id="comparativeAnalysisChart"></div>
                    </div>
                    <div class="chart-container">
                        <h3 style="color: #00d4ff; margin-bottom: 1rem;">M√©tricas de Rendimiento</h3>
                        <div id="performanceMetricsChart"></div>
                    </div>
                </div>
            </div>

            <!-- Scenarios Tab -->
            <div id="scenariosTab" class="content-area">
                <div class="glass-panel">
                    <h3 style="color: #00d4ff; margin-bottom: 1rem;">Simulaci√≥n de Escenarios</h3>
                    <div class="scenario-controls">
                        <div class="scenario-selector">
                            <label class="filter-label">Tipo de Escenario:</label>
                            <select id="scenarioType" class="filter-select">
                                <option value="conflict_escalation">Escalada de Conflicto</option>
                                <option value="economic_crisis">Crisis Econ√≥mica</option>
                                <option value="climate_change">Cambio Clim√°tico</option>
                                <option value="political_instability">Inestabilidad Pol√≠tica</option>
                                <option value="pandemic">Pandemia</option>
                                <option value="cyber_attack">Ataque Cibern√©tico</option>
                            </select>
                        </div>
                        <button class="btn" onclick="runScenarioSimulation()">
                            <i class="fas fa-play"></i>
                            Ejecutar Simulaci√≥n
                        </button>
                    </div>
                    <div id="scenarioSimulation"></div>
                </div>
                <div class="content-grid">
                    <div class="chart-container">
                        <h3 style="color: #00d4ff; margin-bottom: 1rem;">Impacto Proyectado</h3>
                        <div id="projectedImpactChart"></div>
                    </div>
                    <div class="chart-container">
                        <h3 style="color: #00d4ff; margin-bottom: 1rem;">L√≠nea Temporal del Escenario</h3>
                        <div id="scenarioTimelineChart"></div>
                    </div>
                </div>
                <div class="glass-panel">
                    <h3 style="color: #00d4ff; margin-bottom: 1rem;">Recomendaciones de Mitigaci√≥n</h3>
                    <div id="mitigationRecommendations"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/plotly.js@2.29.1/dist/plotly.min.js"></script>
<script>
    // Global variables
    let currentData = null;
    let maps = {};
    let charts = {};

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function() {
        initializeDashboard();
        loadFilters();
        loadDashboardData();
    });

    // Initialize dashboard components
    function initializeDashboard() {
        // Set default date range (last 90 days)
        const today = new Date();
        const ninetyDaysAgo = new Date(today.getTime() - (90 * 24 * 60 * 60 * 1000));
        
        document.getElementById('dateTo').value = today.toISOString().split('T')[0];
        document.getElementById('dateFrom').value = ninetyDaysAgo.toISOString().split('T')[0];

        // Initialize maps for each tab
        initializeMaps();
    }

    // Initialize maps
    function initializeMaps() {
        const mapContainers = ['eventsMap', 'resourcesMap', 'risksMap', 'displacementMap'];
        
        mapContainers.forEach(mapId => {
            const mapElement = document.getElementById(mapId);
            if (mapElement) {
                const map = L.map(mapId).setView([20, 0], 2);
                
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                    subdomains: 'abcd',
                    maxZoom: 19
                }).addTo(map);
                
                maps[mapId] = map;
            }
        });
    }

    // Load filter options
    async function loadFilters() {
        try {
            const response = await fetch('/api/historical/filters');
            const result = await response.json();
            
            if (result.success) {
                populateFilterSelects(result.data);
            }
        } catch (error) {
            console.error('Failed to load filters:', error);
        }
    }

    // Populate filter select elements
    function populateFilterSelects(filterData) {
        // Countries
        const countrySelect = document.getElementById('countryFilter');
        if (filterData.countries) {
            filterData.countries.forEach(country => {
                const option = document.createElement('option');
                option.value = country.iso3;
                option.textContent = country.country;
                countrySelect.appendChild(option);
            });
        }

        // Categories
        const categorySelect = document.getElementById('categoryFilter');
        if (filterData.categories) {
            filterData.categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.category;
                option.textContent = category.category.charAt(0).toUpperCase() + category.category.slice(1);
                categorySelect.appendChild(option);
            });
        }
    }

    // Load dashboard data
    async function loadDashboardData() {
        try {
            showLoading();
            
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            const countries = Array.from(document.getElementById('countryFilter').selectedOptions).map(o => o.value);
            const categories = Array.from(document.getElementById('categoryFilter').selectedOptions).map(o => o.value);

            const params = new URLSearchParams();
            if (dateFrom) params.append('date_from', dateFrom);
            if (dateTo) params.append('date_to', dateTo);
            countries.forEach(c => params.append('countries', c));
            categories.forEach(c => params.append('categories', c));

            const response = await fetch(`/api/historical/dashboard?${params}`);
            const result = await response.json();
            
            if (result.success) {
                currentData = result.data;
                updateDashboard(result.data);
            } else {
                showError('Failed to load dashboard data: ' + result.message);
            }
        } catch (error) {
            showError('Network error: ' + error.message);
        } finally {
            hideLoading();
        }
    }

    // Update dashboard with new data
    function updateDashboard(data) {
        updateStatistics(data.summary_stats || {});
        updateEventsTab(data);
        updateResourcesTab(data);
        updateRisksTab(data);
        updateDisplacementTab(data);
        updateAlertsTab(data.alerts || []);
        updateCorrelationsTab();
    }

    // Update statistics cards
    function updateStatistics(stats) {
        document.getElementById('totalEvents').textContent = (stats.total_events || 0).toLocaleString();
        document.getElementById('recentEvents').textContent = (stats.recent_events || 0).toLocaleString();
        document.getElementById('countriesAffected').textContent = (stats.countries_affected || 0).toLocaleString();
        document.getElementById('avgEventsPerDay').textContent = stats.avg_events_per_day || '0';
    }

    // Update events tab
    function updateEventsTab(data) {
        // Events timeline chart
        if (data.time_series) {
            const timelineData = [];
            Object.keys(data.time_series).forEach(category => {
                const series = data.time_series[category];
                timelineData.push({
                    x: series.dates,
                    y: series.counts,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: category.charAt(0).toUpperCase() + category.slice(1),
                    line: { width: 3 }
                });
            });

            Plotly.newPlot('eventsTimeChart', timelineData, {
                title: '',
                paper_bgcolor: 'transparent',
                plot_bgcolor: 'transparent',
                font: { color: '#ffffff' },
                xaxis: { 
                    gridcolor: 'rgba(255,255,255,0.1)',
                    zerolinecolor: 'rgba(255,255,255,0.1)'
                },
                yaxis: { 
                    gridcolor: 'rgba(255,255,255,0.1)',
                    zerolinecolor: 'rgba(255,255,255,0.1)'
                }
            });
        }

        // Category breakdown pie chart
        if (data.category_breakdown) {
            const categoryData = [{
                values: data.category_breakdown.map(c => c.count),
                labels: data.category_breakdown.map(c => c.category),
                type: 'pie',
                textinfo: 'label+percent',
                textposition: 'outside',
                marker: {
                    colors: ['#00d4ff', '#0097a7', '#00695c', '#004d40', '#26a69a']
                }
            }];

            Plotly.newPlot('categoryChart', categoryData, {
                paper_bgcolor: 'transparent',
                plot_bgcolor: 'transparent',
                font: { color: '#ffffff' }
            });
        }

        // Update events map
        if (data.geographic_data) {
            updateEventsMap(data.geographic_data);
        }

        // Update events table
        if (data.recent_events) {
            updateEventsTable(data.recent_events);
        }
    }

    // Update events map
    function updateEventsMap(geoData) {
        const map = maps['eventsMap'];
        if (!map) return;
        
        // Clear existing markers
        map.eachLayer(layer => {
            if (layer instanceof L.Marker) {
                map.removeLayer(layer);
            }
        });

        // Add new markers
        geoData.forEach(location => {
            if (location.avg_lat && location.avg_lon) {
                const marker = L.marker([location.avg_lat, location.avg_lon])
                    .bindPopup(`
                        <strong>${location.country}</strong><br>
                        Category: ${location.category}<br>
                        Events: ${location.event_count}<br>
                        Last Activity: ${location.last_activity}
                    `);
                marker.addTo(map);
            }
        });
    }

    // Update events table
    function updateEventsTable(events) {
        const container = document.getElementById('eventsTable');
        
        if (events.length === 0) {
            container.innerHTML = '<p style="color: rgba(255,255,255,0.7);">No se encontraron eventos para los criterios seleccionados.</p>';
            return;
        }

        let tableHTML = `
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Pa√≠s</th>
                        <th>Categor√≠a</th>
                        <th>Indicador</th>
                        <th>Valor</th>
                        <th>Fuente</th>
                    </tr>
                </thead>
                <tbody>
        `;

        events.slice(0, 20).forEach(event => {
            tableHTML += `
                <tr>
                    <td>${event.date}</td>
                    <td>${event.country || 'Desconocido'}</td>
                    <td>${event.category}</td>
                    <td>${event.indicator}</td>
                    <td>${typeof event.value === 'number' ? event.value.toLocaleString() : event.value}</td>
                    <td>${event.source}</td>
                </tr>
            `;
        });

        tableHTML += '</tbody></table>';
        container.innerHTML = tableHTML;
    }

    // Update resources tab
    function updateResourcesTab(data) {
        // Filter resource data
        const resourceData = (data.recent_events || []).filter(e => e.category === 'energy');
        
        if (resourceData.length > 0) {
            // Energy trends chart
            const energyByDate = {};
            resourceData.forEach(event => {
                if (!energyByDate[event.date]) {
                    energyByDate[event.date] = 0;
                }
                energyByDate[event.date] += event.value || 0;
            });

            const energyChartData = [{
                x: Object.keys(energyByDate),
                y: Object.values(energyByDate),
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Energy Supply',
                line: { color: '#00d4ff', width: 3 }
            }];

            Plotly.newPlot('energyChart', energyChartData, {
                paper_bgcolor: 'transparent',
                plot_bgcolor: 'transparent',
                font: { color: '#ffffff' },
                xaxis: { gridcolor: 'rgba(255,255,255,0.1)' },
                yaxis: { gridcolor: 'rgba(255,255,255,0.1)' }
            });
        }
    }

    // Update risks tab
    function updateRisksTab(data) {
        // Filter risk data
        const riskData = (data.recent_events || []).filter(e => 
            e.category === 'governance' || e.indicator.includes('stability')
        );
        
        if (riskData.length > 0) {
            // Stability chart
            const stabilityByCountry = {};
            riskData.forEach(event => {
                if (event.indicator.includes('stability')) {
                    stabilityByCountry[event.country] = event.value;
                }
            });

            const stabilityChartData = [{
                x: Object.keys(stabilityByCountry),
                y: Object.values(stabilityByCountry),
                type: 'bar',
                marker: { color: '#00d4ff' }
            }];

            Plotly.newPlot('stabilityChart', stabilityChartData, {
                paper_bgcolor: 'transparent',
                plot_bgcolor: 'transparent',
                font: { color: '#ffffff' },
                xaxis: { gridcolor: 'rgba(255,255,255,0.1)' },
                yaxis: { gridcolor: 'rgba(255,255,255,0.1)' }
            });
        }
    }

    // Update displacement tab
    function updateDisplacementTab(data) {
        // Filter displacement data
        const displacementData = (data.recent_events || []).filter(e => e.category === 'displacement');
        
        if (displacementData.length > 0) {
            // Displacement trends
            const displacementByDate = {};
            displacementData.forEach(event => {
                if (!displacementByDate[event.date]) {
                    displacementByDate[event.date] = 0;
                }
                displacementByDate[event.date] += event.value || 0;
            });

            const displacementChartData = [{
                x: Object.keys(displacementByDate),
                y: Object.values(displacementByDate),
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Displaced Population',
                line: { color: '#ffa726', width: 3 }
            }];

            Plotly.newPlot('displacementChart', displacementChartData, {
                paper_bgcolor: 'transparent',
                plot_bgcolor: 'transparent',
                font: { color: '#ffffff' },
                xaxis: { gridcolor: 'rgba(255,255,255,0.1)' },
                yaxis: { gridcolor: 'rgba(255,255,255,0.1)' }
            });
        }
    }

    // Update alerts tab
    function updateAlertsTab(alerts) {
        const container = document.getElementById('alertsPanel');
        
        if (!alerts || alerts.length === 0) {
            container.innerHTML = '<p style="color: rgba(255,255,255,0.7); text-align: center; padding: 2rem;">No hay alertas activas</p>';
            return;
        }

        let alertsHTML = '';
        alerts.forEach(alert => {
            alertsHTML += `
                <div class="alert-item alert-${alert.severity}">
                    <div class="alert-header">
                        <div>
                            <strong>${alert.country}</strong>
                            <span class="alert-severity severity-${alert.severity}">${alert.severity}</span>
                        </div>
                        <small>${new Date(alert.timestamp).toLocaleDateString()}</small>
                    </div>
                    <p>${alert.message}</p>
                </div>
            `;
        });

        container.innerHTML = alertsHTML;
    }

    // Update correlations tab
    async function updateCorrelationsTab() {
        try {
            const indicators = ['political_stability', 'violence_events', 'energy_supply', 'displacement'];
            
            const response = await fetch('/api/historical/correlation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ indicators, time_window: 90 })
            });

            const result = await response.json();
            
            if (result.success && result.data.correlations) {
                displayCorrelationHeatmap(result.data.correlations, indicators);
                displayStrongCorrelations(result.data.strong_correlations);
            }
        } catch (error) {
            console.error('Failed to load correlation data:', error);
        }
    }

    // Display correlation heatmap
    function displayCorrelationHeatmap(correlations, indicators) {
        const z = [];
        const x = indicators;
        const y = indicators;

        indicators.forEach(ind1 => {
            const row = [];
            indicators.forEach(ind2 => {
                row.push(correlations[ind1] ? correlations[ind1][ind2] || 0 : 0);
            });
            z.push(row);
        });

        const data = [{
            z: z,
            x: x,
            y: y,
            type: 'heatmap',
            colorscale: [
                [0, '#000051'],
                [0.5, '#00d4ff'],
                [1, '#ffffff']
            ]
        }];

        Plotly.newPlot('correlationHeatmap', data, {
            paper_bgcolor: 'transparent',
            plot_bgcolor: 'transparent',
            font: { color: '#ffffff' }
        });
    }

    // Display strong correlations
    function displayStrongCorrelations(strongCorrelations) {
        const container = document.getElementById('correlationList');
        
        if (!strongCorrelations || strongCorrelations.length === 0) {
            container.innerHTML = '<p style="color: rgba(255,255,255,0.7);">No se encontraron correlaciones fuertes</p>';
            return;
        }

        let html = '<div style="padding: 1rem;">';
        strongCorrelations.forEach(corr => {
            const strength = corr.strength === 'strong' ? 'high' : 'medium';
            html += `
                <div class="alert-item alert-${strength}" style="margin-bottom: 1rem;">
                    <strong>${corr.indicator1}</strong> ‚Üî <strong>${corr.indicator2}</strong>
                    <br>
                    <span style="color: #00d4ff;">Correlaci√≥n: ${corr.correlation}</span>
                    <span class="alert-severity severity-${strength}">${corr.strength}</span>
                </div>
            `;
        });
        html += '</div>';
        
        container.innerHTML = html;
    }

    // Tab switching
    function switchTab(tabName) {
        // Update tab buttons
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');

        // Update content areas
        document.querySelectorAll('.content-area').forEach(area => area.classList.remove('active'));
        const targetTab = document.getElementById(tabName + 'Tab');
        if (targetTab) {
            targetTab.classList.add('active');
        }

        // Refresh map if switching to a map tab
        if (maps[tabName + 'Map']) {
            setTimeout(() => {
                maps[tabName + 'Map'].invalidateSize();
            }, 100);
        }
    }

    // Apply filters
    function applyFilters() {
        loadDashboardData();
    }

    // Trigger ETL update
    async function triggerETLUpdate() {
        try {
            showLoading();
            
            const response = await fetch('/api/historical/etl/trigger', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ force_refresh: true })
            });

            const result = await response.json();
            
            if (result.success) {
                showSuccess('¬°Datos actualizados exitosamente!');
                loadDashboardData();
            } else {
                showError('Error al actualizar datos: ' + result.message);
            }
        } catch (error) {
            showError('Error de red: ' + error.message);
        } finally {
            hideLoading();
        }
    }

    // Export data
    function exportData() {
        if (!currentData) {
            showError('No hay datos para exportar');
            return;
        }

        const dataStr = JSON.stringify(currentData, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = `analisis_historico_${new Date().toISOString().split('T')[0]}.json`;
        link.click();
    }

    // Utility functions
    function showLoading() {
        document.body.style.cursor = 'wait';
    }

    function hideLoading() {
        document.body.style.cursor = 'default';
    }

    function showError(message) {
        alert('Error: ' + message);
    }

    function showSuccess(message) {
        alert('√âxito: ' + message);
    }
</script>

<!-- Chart.js for visualizations -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Historical Dashboard Expanded JavaScript -->
<script src="{{ url_for('static', filename='js/historical_dashboard_expanded.js') }}"></script>
{% endblock %}
