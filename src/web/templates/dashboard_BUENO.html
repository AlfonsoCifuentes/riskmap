{% extends "base_navigation.html" %}

{% block title %}An√°lisis de Noticias - Stratosight{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/article_cards.css') }}">
<style>
    :root {
        --bg-primary: linear-gradient(180deg, #0a0f2c 0%, #1a2040 40%, #2a3558 80%, #3a4a70 100%);
        --bg-secondary: #141824;
        --text-primary: #e8eaed;
        --text-secondary: #b0b8c4;
        --accent-cyan: #00d4ff;
        --accent-glow: 0 0 15px rgba(0, 212, 255, 0.4), 0 0 25px rgba(0, 212, 255, 0.2);
        --border-color: rgba(255, 255, 255, 0.1);
    }

    html, body {
        margin: 0;
        padding: 0;
        min-height: 100vh;
        background: #1a237e;
        color: var(--text-primary);
        font-family: 'Inter', sans-serif;
        position: relative;
    }

    /* News Analysis Dashboard Styles - Responsive y Mobile-First */
    .news-dashboard {
        padding: 0;
        max-width: none;
        margin: 0;
        position: relative;
        z-index: 1;
        display: flex;
        flex-direction: column;
        
        min-height: calc(100vh - 80px);
        background: rgba(10, 15, 44, 0.08);
        backdrop-filter: blur(2px);
        gap: 0;
        width: 100vw;
    }
    
    .dashboard-content {
        max-width: 96%;
        margin: 0 auto !important;
        
        padding: 0 20px;
        width: 100%;
        box-sizing: border-box;
    }
    
    /* Header and Stats Container */
    .header-stats-container {
        width: 100vw;
        position: relative;
        left: 50%;
        right: 50%;
        margin-left: -50vw;
        margin-right: -50vw;
        
        top: -80px;
        margin-bottom: -80px;
        z-index: 0;
        background: transparent;
        border-radius: 0;
    }
    
    .page-header {
        text-align: center;
        margin: 0;
        color: #fff;
        padding: 180px 0 80px 0; /* Aumentado el padding inferior para dar espacio al news-stats */
        width: 100%;
        position: relative;
        background: linear-gradient(135deg, rgba(26, 32, 64, 0.75) 0%, rgba(16, 24, 48, 0.8) 50%, rgba(20, 28, 56, 0.75) 100%);
        backdrop-filter: blur(10px);
        box-shadow: 0 2px 20px rgba(0, 0, 0, 0.3);
    }
    
    .page-title {
        font-family: 'Orbitron', monospace;
        font-size: clamp(1.5rem, 6vw, 4rem);
        font-weight: 700;
        margin-bottom: 10px;
        background: linear-gradient(135deg, #00d4ff 0%, #00a3cc 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        width: 75%;
        margin-left: auto;
        margin-right: auto;
        line-height: 1.2;
        word-wrap: break-word;
        hyphens: auto;
    }
    
    .page-subtitle {
        font-size: 1rem;
        color: rgba(255, 255, 255, 0.7);
        margin-bottom: 20px;
    }

    /* Stats Cards - Responsive Grid */
    .news-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 0;
        margin: 0;
        width: 100%;
        position: relative;
        left: 0;
        right: 0;
        z-index: 10;
    }
    
    .news-stat-card {
        background: transparent;
        border: none;
        border-radius: 0;
        padding: 20px;
        text-align: center;
        transition: all 0.3s ease;
        backdrop-filter: blur(3px);
        box-shadow: none;
        border-right: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .news-stat-card:last-child {
        border-right: none;
    }
    
    .news-stat-card:nth-child(1) {
        background: linear-gradient(135deg, rgba(0, 119, 255, 0.4) 0%, rgba(30, 144, 255, 0.35) 100%);
    }
    
    .news-stat-card:nth-child(2) {
        background: linear-gradient(135deg, rgba(220, 38, 38, 0.45) 0%, rgba(239, 68, 68, 0.4) 100%);
    }
    
    .news-stat-card:nth-child(3) {
        background: linear-gradient(135deg, rgba(70, 234, 215, 0.4) 0%, rgba(45, 212, 191, 0.35) 100%);
    }
    
    .news-stat-card:nth-child(4) {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.4) 0%, rgba(37, 99, 235, 0.35) 100%);
    }
    
    .news-stat-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    }
    
    .news-stat-card:nth-child(1):hover {
        background: linear-gradient(135deg, rgba(0, 119, 255, 0.6) 0%, rgba(30, 144, 255, 0.5) 100%);
    }
    
    .news-stat-card:nth-child(2):hover {
        background: linear-gradient(135deg, rgba(220, 38, 38, 0.65) 0%, rgba(239, 68, 68, 0.55) 100%);
    }
    
    .news-stat-card:nth-child(3):hover {
        background: linear-gradient(135deg, rgba(70, 234, 215, 0.6) 0%, rgba(45, 212, 191, 0.5) 100%);
    }
    
    .news-stat-card:nth-child(4):hover {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.6) 0%, rgba(37, 99, 235, 0.5) 100%);
    }
    
    .stat-icon {
        width: 50px;
        height: 50px;
        margin: 0 auto 15px;
        background: linear-gradient(135deg, #00d4ff 0%, #00a3cc 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.3rem;
        color: #fff;
    }
    
    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: #fff;
        margin-bottom: 5px;
        font-family: 'Orbitron', monospace;
    }
    
    .stat-label {
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    /* Section styling - Mobile-First */
    .news-section {
        background: rgba(26, 32, 64, 0.7);
        border: 1px solid rgba(70, 234, 215, 0.3);
        border-radius: 12px;
        padding: 20px;
        backdrop-filter: blur(15px);
        margin-bottom: 25px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }
    
    .section-header {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--border-color);
        gap: 15px;
    }
    
    .section-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #fff;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .section-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: center;
    }
    
    .btn-control {
        flex: 1 1 auto;
        max-width: 140px;
        min-width: 80px;
        text-align: center;
        padding: 8px 12px;
        font-size: 0.8rem;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
        border: 1px solid rgba(255, 255, 255, 0.2);
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .btn-control:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateY(-2px);
    }

    .btn-control.active {
        background: rgba(70, 234, 215, 0.3);
        border-color: rgba(70, 234, 215, 0.5);
        color: #fff;
    }

    /* High Risk Articles Grid - Responsive */
    .high-risk-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .high-risk-card {
        background: linear-gradient(145deg, rgba(239, 68, 68, 0.15), rgba(220, 38, 38, 0.08));
        border: 1px solid rgba(239, 68, 68, 0.4);
        border-radius: 12px;
        padding: 15px;
        transition: all 0.3s ease;
        backdrop-filter: blur(15px);
    }
    
    .high-risk-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(239, 68, 68, 0.3);
        border-color: rgba(239, 68, 68, 0.5);
    }
    
    .high-risk-title {
        font-size: 1rem;
        font-weight: 600;
        color: #fff;
        margin-bottom: 8px;
        line-height: 1.3;
    }
    
    .high-risk-description {
        color: rgba(255, 255, 255, 0.8);
        font-size: 0.85rem;
        line-height: 1.5;
        margin-bottom: 12px;
    }
    
    .high-risk-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.75rem;
        flex-wrap: wrap;
        gap: 8px;
    }
    
    .high-risk-location {
        color: rgba(255, 255, 255, 0.6);
        display: flex;
        align-items: center;
        gap: 4px;
    }
    
    .high-risk-badge {
        background: rgba(239, 68, 68, 0.2);
        color: #ef4444;
        padding: 3px 6px;
        border-radius: 4px;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.65rem;
    }

    /* Latest Articles - Full width cards - Mobile-First */
    .latest-articles-grid {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    
    .latest-article-card {
        background: rgba(26, 32, 64, 0.7);
        border: 1px solid rgba(70, 234, 215, 0.25);
        border-radius: 12px;
        padding: 15px;
        transition: all 0.3s ease;
        backdrop-filter: blur(15px);
        display: flex;
        flex-direction: column;
        gap: 12px;
        box-shadow: 0 2px 15px rgba(0, 0, 0, 0.2);
    }
    
    .latest-article-card:hover {
        background: rgba(26, 32, 64, 0.85);
        border-color: rgba(70, 234, 215, 0.4);
        transform: translateY(-2px);
    }
    
    .latest-article-content {
        flex: 1;
    }
    
    .latest-article-title {
        font-size: 1rem;
        font-weight: 600;
        color: #fff;
        margin-bottom: 6px;
        line-height: 1.3;
    }
    
    .latest-article-description {
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.85rem;
        line-height: 1.5;
        margin-bottom: 8px;
    }
    
    .latest-article-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.6);
    }
    
    .latest-article-meta-item {
        display: flex;
        align-items: center;
        gap: 4px;
    }
    
    .latest-article-sidebar {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 8px;
    }
    
    .latest-risk-badge {
        padding: 3px 6px;
        border-radius: 4px;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.65rem;
    }
    
    .latest-risk-badge.high {
        background: rgba(239, 68, 68, 0.2);
        color: #ef4444;
    }
    
    .latest-risk-badge.medium {
        background: rgba(245, 158, 11, 0.2);
        color: #f59e0b;
    }
    
    .latest-risk-badge.low {
        background: rgba(34, 197, 94, 0.2);
        color: #22c55e;
    }

    /* News Mosaic Section - Dynamic Collage Layout */
    .news-mosaic-section {
        width: 100vw;
        position: relative;
        left: 50%;
        right: 50%;
        margin-left: -50vw;
        margin-right: -50vw;
        margin-top: -60 !important;
        padding: 0;
        background: transparent;
        z-index: 1;
    }

    .mosaic-controls-container {
        width: 100%;
        padding: 20px;
        background: rgba(10, 15, 44, 0.5);
        backdrop-filter: blur(5px);
        z-index: 5;
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
        left: 50%;
        right: 50%;
        margin-left: -50vw;
        margin-right: -50vw;
        width: 100vw;
        box-sizing: border-box;
    }
    
    .mosaic-controls {
        display: flex;
        gap: 15px;
        justify-content: center;
    }
    
    .news-mosaic-container {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        grid-auto-rows: calc(25vw / 1.618);
        gap: 0;
        grid-auto-flow: dense;
        width: 100vw;
        min-height: 100vh;
        background: rgba(0, 0, 0, 0.1);
        padding: 0;
    }
    
    /* Mosaic Article Tiles - Irregular Sizes */
    .mosaic-article {
        position: relative;
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        border: 1px solid #0a0f2c;
        box-sizing: border-box;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(2px);
    }
    
    .mosaic-article::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
            135deg,
            rgba(0, 0, 0, 0.2) 0%,
            rgba(0, 0, 0, 0.1) 40%,
            rgba(0, 0, 0, 0.5) 100%
        );
        border-radius: 0;
        z-index: 1;
    }
    
    .mosaic-article:hover {
        transform: scale(1.02);
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.5);
        z-index: 5;
        border: 1px solid var(--accent-cyan);
    }
    
    /* Computer Vision Quality Indicators */
    .cv-quality-indicator {
        position: absolute !important;
        top: 8px !important;
        right: 8px !important;
        background: rgba(34, 197, 94, 0.9) !important;
        color: white !important;
        padding: 3px 8px !important;
        border-radius: 12px !important;
        font-size: 11px !important;
        font-weight: bold !important;
        z-index: 20 !important;
        backdrop-filter: blur(4px) !important;
        border: 1px solid rgba(255, 255, 255, 0.2) !important;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3) !important;
        transition: all 0.3s ease !important;
        font-family: 'Inter', monospace !important;
        letter-spacing: 0.5px !important;
    }
    
    .cv-quality-indicator:hover {
        transform: scale(1.1) !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4) !important;
    }
    
    /* Computer Vision Optimized Articles */
    .mosaic-article[data-cv-optimized="true"] {
        border: 2px solid rgba(34, 197, 94, 0.3) !important;
    }
    
    .mosaic-article[data-cv-optimized="true"]::after {
        content: 'ü§ñ';
        position: absolute;
        top: 8px;
        left: 8px;
        font-size: 16px;
        z-index: 15;
        opacity: 0.8;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5));
        transition: all 0.3s ease;
    }
    
    .mosaic-article[data-cv-optimized="true"]:hover::after {
        transform: scale(1.2);
        opacity: 1;
    }
    
    .mosaic-article:hover::before {
        background: linear-gradient(
            135deg,
            rgba(0, 0, 0, 0.1) 0%,
            rgba(0, 0, 0, 0.05) 40%,
            rgba(0, 0, 0, 0.4) 100%
        );
    }
    
    /* Irregular size variants based on importance score */
    .mosaic-article.size-1 { grid-column: span 2; grid-row: span 2; } /* Golden ratio-like */
    .mosaic-article.size-2 { grid-column: span 1; grid-row: span 2; } /* Vertical */
    .mosaic-article.size-3 { grid-column: span 1; grid-row: span 1; } /* Small Square 1 */
    .mosaic-article.size-4 { grid-column: span 1; grid-row: span 1; } /* Small Square 2 */
    .mosaic-article.size-5 { grid-column: span 1; grid-row: span 1; }
    .mosaic-article.size-6 { grid-column: span 1; grid-row: span 1; }
    .mosaic-article.size-7 { grid-column: span 2; grid-row: span 1; }
    .mosaic-article.size-8 { grid-column: span 1; grid-row: span 1; }
    .mosaic-article.size-9 { grid-column: span 1; grid-row: span 1; }
    .mosaic-article.size-10 { grid-column: span 1; grid-row: span 1; }
    .mosaic-article.size-11 { grid-column: span 1; grid-row: span 1; }
    .mosaic-article.size-12 { grid-column: span 2; grid-row: span 1; }

    /* Custom sizes for specific designed layouts */
    .mosaic-article.size-custom-wide-2 { grid-column: span 2; grid-row: span 1; } /* 1 fila x 2 columnas */
    .mosaic-article.size-custom-single { grid-column: span 1; grid-row: span 1; } /* 1 fila x 1 columna */
    .mosaic-article.size-custom-tall-2 { grid-column: span 1; grid-row: span 2; } /* 2 filas x 1 columna */
    .mosaic-article.size-custom-big-4 { grid-column: span 2; grid-row: span 2; } /* 2 filas x 2 columnas */

    /* Puzzle layout sizes - Rejilla 3x4 perfecta */
    .mosaic-article.size-puzzle-big { grid-column: span 2; grid-row: span 2; } /* 2 filas x 2 columnas = 4 cuadrados */
    .mosaic-article.size-puzzle-single { grid-column: span 1; grid-row: span 1; } /* 1 fila x 1 columna = 1 cuadrado */
    .mosaic-article.size-puzzle-wide { grid-column: span 2; grid-row: span 1; } /* 1 fila x 2 columnas = 2 cuadrados */
    .mosaic-article.size-puzzle-tall { grid-column: span 1; grid-row: span 2; } /* 2 filas x 1 columna = 2 cuadrados */

    /* Fallback sizes for additional articles */
    .mosaic-article.size-default-lg-wide { grid-column: span 2; grid-row: span 1; }
    .mosaic-article.size-default-lg-tall { grid-column: span 1; grid-row: span 2; }
    .mosaic-article.size-default-md-sq { grid-column: span 1; grid-row: span 1; }
    
    /* Article content overlay with fixed padding */
    .mosaic-content {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 15px;
        z-index: 2;
        color: white;
        background: linear-gradient(
            transparent 0%,
            rgba(0, 0, 0, 0.3) 20%,
            rgba(0, 0, 0, 0.7) 70%,
            rgba(0, 0, 0, 0.9) 100%
        );
        border-radius: 0;
        min-height: 80px;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
    }
    
    .mosaic-title {
        font-size: 1.1rem;
        font-weight: 600;
        line-height: 1.3;
        margin: 0 0 8px 0;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .mosaic-article.size-1 .mosaic-title {
        font-size: 1.6rem;
        -webkit-line-clamp: 4;
    }
    .mosaic-article.size-2 .mosaic-title {
        font-size: 1.2rem;
        -webkit-line-clamp: 3;
    }
    
    .mosaic-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: auto;
    }
    
    .mosaic-location {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.9);
        background: rgba(0, 0, 0, 0.4);
        padding: 6px 10px;
        border-radius: 15px;
        backdrop-filter: blur(8px);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .mosaic-risk-badge {
        font-size: 0.65rem;
        font-weight: 700;
        padding: 6px 10px;
        border-radius: 15px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        text-shadow: none;
        backdrop-filter: blur(8px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .mosaic-risk-badge.hero {
        background: linear-gradient(135deg, #dc2626, #ef4444);
        color: white;
        font-size: 0.8rem;
        padding: 8px 12px;
        box-shadow: 0 4px 15px rgba(220, 38, 38, 0.4);
    }
    
    .mosaic-risk-badge.high {
        background: rgba(220, 38, 38, 0.9);
        color: white;
        box-shadow: 0 2px 10px rgba(220, 38, 38, 0.3);
    }
    
    .mosaic-risk-badge.medium {
        background: rgba(245, 158, 11, 0.9);
        color: white;
        box-shadow: 0 2px 10px rgba(245, 158, 11, 0.3);
    }
    
    .mosaic-risk-badge.low {
        background: rgba(34, 197, 94, 0.9);
        color: white;
        box-shadow: 0 2px 10px rgba(34, 197, 94, 0.3);
    }
    
    /* Loading state */
    .mosaic-loading {
        grid-column: 1 / -1;
        grid-row: 1 / -1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: rgba(255, 255, 255, 0.7);
        font-size: 1.2rem;
    }
    
    .mosaic-loading i {
        font-size: 2rem;
        margin-bottom: 15px;
        color: #46ead7;
    }

    /* Load More Button */
    .load-more-container {
        width: 100%;
        padding: 30px 0;
        background: rgba(10, 15, 44, 0.3);
        backdrop-filter: blur(5px);
        display: flex;
        justify-content: center;
        align-items: center;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .btn-load-more {
        background: linear-gradient(135deg, rgba(70, 234, 215, 0.2) 0%, rgba(0, 212, 255, 0.2) 100%);
        border: 2px solid rgba(70, 234, 215, 0.4);
        color: #46ead7;
        padding: 15px 30px;
        border-radius: 25px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
        display: flex;
        align-items: center;
        gap: 10px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .btn-load-more:hover {
        background: linear-gradient(135deg, rgba(70, 234, 215, 0.3) 0%, rgba(0, 212, 255, 0.3) 100%);
        border-color: rgba(70, 234, 215, 0.6);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(70, 234, 215, 0.3);
    }

    .btn-load-more i {
        font-size: 1.2rem;
    }

    /* ===========================================
       ANALYTICS SECTION STYLES
       =========================================== */
    
    .analytics-section {
        width: 100vw;
        position: relative;
        left: 50%;
        right: 50%;
        margin-left: -50vw;
        margin-right: -50vw;
        margin-top: 40px;
        padding: 60px 0;
        background: linear-gradient(135deg, rgba(10, 15, 44, 0.95) 0%, rgba(16, 24, 48, 0.9) 50%, rgba(20, 28, 56, 0.95) 100%);
        backdrop-filter: blur(15px);
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .analytics-header {
        text-align: center;
        margin-bottom: 40px;
        padding: 0 20px;
    }

    .analytics-title {
        font-family: 'Orbitron', monospace;
        font-size: clamp(2rem, 5vw, 3rem);
        font-weight: 700;
        margin-bottom: 10px;
        background: linear-gradient(135deg, #00d4ff 0%, #46ead7 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
    }

    .analytics-title i {
        background: linear-gradient(135deg, #00d4ff 0%, #46ead7 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .analytics-subtitle {
        font-size: 1.1rem;
        color: rgba(255, 255, 255, 0.7);
        margin: 0;
        font-weight: 300;
    }

    .analytics-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 0 auto 40px auto;
        max-width: 1400px;
        padding: 0 20px;
        flex-wrap: wrap;
        gap: 20px;
    }

    .analytics-filters {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .btn-analytics {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: rgba(255, 255, 255, 0.8);
        padding: 12px 20px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
    }

    .btn-analytics:hover,
    .btn-analytics.active {
        background: linear-gradient(135deg, rgba(0, 212, 255, 0.3) 0%, rgba(70, 234, 215, 0.3) 100%);
        border-color: rgba(0, 212, 255, 0.5);
        color: #fff;
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(0, 212, 255, 0.2);
    }

    .analytics-options {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .analytics-select {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: #fff;
        padding: 10px 15px;
        border-radius: 15px;
        font-size: 0.9rem;
        backdrop-filter: blur(10px);
        cursor: pointer;
    }

    .analytics-select option {
        background: #1a237e;
        color: #fff;
    }

    .btn-export {
        background: linear-gradient(135deg, rgba(46, 125, 50, 0.8) 0%, rgba(76, 175, 80, 0.8) 100%);
        border: 1px solid rgba(76, 175, 80, 0.5);
        color: #fff;
        padding: 10px 20px;
        border-radius: 15px;
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .btn-export:hover {
        background: linear-gradient(135deg, rgba(56, 142, 60, 0.9) 0%, rgba(102, 187, 106, 0.9) 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
    }

    .analytics-grid {
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 20px;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
        gap: 30px;
        align-items: start;
        grid-auto-flow: row dense;
    }

    .chart-container {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        padding: 25px;
        backdrop-filter: blur(15px);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        min-height: 400px;
        display: flex;
        flex-direction: column;
    }

    .chart-container:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
        border-color: rgba(0, 212, 255, 0.3);
    }

    .chart-container.wide {
        grid-column: 1 / -1;
        min-height: 500px;
    }

    .chart-title {
        font-size: 1.3rem;
        font-weight: 600;
        color: #fff;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .chart-subtitle {
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.6);
        font-weight: 400;
    }

    .chart-content {
        position: relative;
        height: 280px;
        margin-bottom: 15px;
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .chart-content canvas {
        width: 100% !important;
        height: 100% !important;
        max-height: 280px;
    }

    .chart-stats {
        display: flex;
        justify-content: space-around;
        gap: 20px;
        margin-top: 20px;
    }

    .stat-item {
        text-align: center;
        flex: 1;
    }

    .analytics-stat-value {
        display: block;
        font-size: 2rem;
        font-weight: 700;
        color: #00d4ff;
        margin-bottom: 5px;
    }

    .analytics-stat-label {
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.7);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .chart-legend {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-top: 15px;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.8);
    }

    .legend-color {
        width: 12px;
        height: 12px;
        border-radius: 2px;
    }

    /* Map Container Styles */
    .map-container {
        position: relative;
        height: 450px;
        border-radius: 15px;
        overflow: hidden;
        margin-bottom: 20px;
        flex: 1;
    }

    .heatmap-container {
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
        position: relative;
        border-radius: 15px;
        overflow: hidden;
    }

    .heatmap-svg {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
    }

    .map-loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        color: rgba(255, 255, 255, 0.7);
    }

    .map-loading i {
        font-size: 3rem;
        margin-bottom: 15px;
        color: #46ead7;
    }

    .map-controls {
        position: absolute;
        top: 15px;
        right: 15px;
        display: flex;
        gap: 8px;
        z-index: 10;
    }

    .map-btn {
        background: rgba(0, 0, 0, 0.7);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: rgba(255, 255, 255, 0.9);
        padding: 8px 15px;
        border-radius: 12px;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
    }

    .map-btn:hover,
    .map-btn.active {
        background: rgba(0, 212, 255, 0.8);
        border-color: rgba(0, 212, 255, 0.9);
        color: #fff;
    }

    .heatmap-legend {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-top: 15px;
        padding: 15px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
    }

    .legend-title {
        font-weight: 600;
        color: #fff;
        font-size: 0.9rem;
    }

    .legend-gradient {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.7);
    }

    .gradient-bar {
        width: 100px;
        height: 8px;
        background: linear-gradient(90deg, #4caf50 0%, #ffeb3b 30%, #ff9800 60%, #f44336 100%);
        border-radius: 4px;
    }

    .auto-download-status {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 10px;
        padding: 8px 15px;
        background: rgba(76, 175, 80, 0.1);
        border: 1px solid rgba(76, 175, 80, 0.3);
        border-radius: 8px;
        color: #4caf50;
        font-size: 0.85rem;
    }

    /* Categories and Prediction Styles */
    .categories-list {
        margin-top: 15px;
    }

    .category-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .category-name {
        font-weight: 500;
        color: #fff;
    }

    .category-count {
        color: #00d4ff;
        font-weight: 600;
    }

    .prediction-content {
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 30px;
        align-items: start;
    }

    .score-circle {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        background: conic-gradient(from 0deg, #4caf50 0%, #4caf50 var(--score-percentage, 75%), rgba(255, 255, 255, 0.1) var(--score-percentage, 75%), rgba(255, 255, 255, 0.1) 100%);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        position: relative;
        margin: 0 auto;
    }

    .score-circle::before {
        content: '';
        position: absolute;
        width: 90px;
        height: 90px;
        background: rgba(10, 15, 44, 0.9);
        border-radius: 50%;
        z-index: 1;
    }

    .score-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #4caf50;
        z-index: 2;
        position: relative;
    }

    .score-label {
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.7);
        z-index: 2;
        position: relative;
    }

    .factors-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .factor-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 15px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        border-left: 3px solid var(--factor-color, #00d4ff);
    }

    .factor-name {
        font-weight: 500;
        color: #fff;
    }

    .factor-impact {
        font-size: 0.9rem;
        color: var(--factor-color, #00d4ff);
        font-weight: 600;
    }

    /* Sources Grid */
    .sources-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        align-items: center;
    }

    .sources-chart {
        height: 250px;
    }

    .sources-stats {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .source-stat {
        text-align: center;
        padding: 20px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 15px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .stat-number {
        display: block;
        font-size: 2.5rem;
        font-weight: 700;
        color: #46ead7;
        margin-bottom: 5px;
    }

    .stat-desc {
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.7);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Analytics Footer */
    .analytics-footer {
        max-width: 1400px;
        margin: 40px auto 0 auto;
        padding: 0 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        padding-top: 25px;
    }

    .update-info {
        display: flex;
        align-items: center;
        gap: 10px;
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.9rem;
    }

    .update-info i {
        color: #46ead7;
        animation: spin 2s linear infinite;
    }

    .ai-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .ai-indicator.active {
        background: rgba(76, 175, 80, 0.2);
        border: 1px solid rgba(76, 175, 80, 0.4);
        color: #4caf50;
    }

    .ai-indicator.inactive {
        background: rgba(244, 67, 54, 0.2);
        border: 1px solid rgba(244, 67, 54, 0.4);
        color: #f44336;
    }

    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    /* Responsive Design for Analytics */
    @media (max-width: 768px) {
        .analytics-controls {
            flex-direction: column;
            align-items: stretch;
        }

        .analytics-filters {
            justify-content: center;
        }

        .analytics-options {
            justify-content: center;
        }

        .analytics-grid {
            grid-template-columns: 1fr;
        }

        .prediction-content {
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .sources-grid {
            grid-template-columns: 1fr;
        }

        .analytics-footer {
            flex-direction: column;
            gap: 15px;
            text-align: center;
        }
    }

    @media (max-width: 480px) {
        .chart-container {
            padding: 20px 15px;
        }

        .analytics-section {
            padding: 40px 0;
        }

        .map-container {
            height: 300px;
        }

        .map-controls {
            top: 10px;
            right: 10px;
            flex-direction: column;
        }
    }

    /* Hero Article Section - Full Width Featured Story */
    .hero-article-section {
        width: 100vw;
        position: relative;
        left: 50%;
        right: 50%;
        margin-left: -50vw;
        margin-right: -50vw;
        margin-top: 0;
        margin-bottom: 0;
        padding: 0;
        background: transparent;
        z-index: 1;
    }

    .hero-article {
        position: relative;
        width: 100%;
        height: 60vh;
        min-height: 400px;
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        display: flex;
        align-items: flex-end;
        overflow: hidden;
        border: none;
    }

    .hero-article::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
            180deg,
            rgba(0, 0, 0, 0.1) 0%,
            rgba(0, 0, 0, 0.3) 40%,
            rgba(0, 0, 0, 0.7) 80%,
            rgba(0, 0, 0, 0.9) 100%
        );
        z-index: 1;
    }

    .hero-content {
        position: relative;
        z-index: 2;
        padding: 40px 5% 40px 4%; /* Reducido padding izquierdo para pegar m√°s a la izquierda */
        color: white;
        width: 100%;
        max-width: 1200px;
        margin: 0;
        box-sizing: border-box;
        text-align: left; /* Alineaci√≥n expl√≠cita a la izquierda */
    }

    .hero-title {
        font-size: clamp(1.8rem, 4vw, 3.5rem);
        font-weight: 700;
        line-height: 1.2;
        margin: 0 0 15px 0;
        text-shadow: 0 4px 8px rgba(0, 0, 0, 0.8);
        color: #fff;
        max-width: 65%; /* Reducido para mejor lectura alineado a la izquierda */
        text-align: left;
    }

    .hero-text {
        font-size: clamp(1rem, 2vw, 1.2rem);
        line-height: 1.6;
        margin: 0 0 20px 0;
        color: rgba(255, 255, 255, 0.9);
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
        max-width: 55%; /* Reducido para mejor lectura alineado a la izquierda */
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-align: left;
    }

    .hero-meta {
        display: flex;
        align-items: center;
        gap: 20px;
        flex-wrap: wrap;
        margin-top: 15px;
        justify-content: flex-start; /* Alineaci√≥n a la izquierda */
    }

    .hero-location {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 1rem;
        color: rgba(255, 255, 255, 0.9);
        background: rgba(0, 0, 0, 0.5);
        padding: 10px 15px;
        border-radius: 25px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        text-shadow: none;
    }

    .hero-risk-badge {
        font-size: 0.9rem;
        font-weight: 700;
        padding: 10px 20px;
        border-radius: 25px;
        text-transform: uppercase;
        letter-spacing: 1px;
        text-shadow: none;
        backdrop-filter: blur(10px);
        border: 2px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }

    .hero-risk-badge.high {
        background: linear-gradient(135deg, #dc2626, #ef4444);
        color: white;
        border-color: rgba(220, 38, 38, 0.5);
        box-shadow: 0 4px 20px rgba(220, 38, 38, 0.4);
    }

    .hero-risk-badge.medium {
        background: linear-gradient(135deg, #d97706, #f59e0b);
        color: white;
        border-color: rgba(245, 158, 11, 0.5);
        box-shadow: 0 4px 20px rgba(245, 158, 11, 0.4);
    }

    .hero-risk-badge.low {
        background: linear-gradient(135deg, #059669, #10b981);
        color: white;
        border-color: rgba(16, 185, 129, 0.5);
        box-shadow: 0 4px 20px rgba(16, 185, 129, 0.4);
    }

    .hero-risk-badge.critical {
        background: linear-gradient(135deg, #991b1b, #dc2626);
        color: white;
        border-color: rgba(153, 27, 27, 0.5);
        box-shadow: 0 4px 20px rgba(153, 27, 27, 0.5);
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }

    /* Responsive adjustments for hero article */
    @media (max-width: 768px) {
        .hero-article {
            height: 50vh;
            min-height: 350px;
        }
        
        .hero-content {
            padding: 30px 6% 30px 4%; /* Reducido padding izquierdo para m√≥viles tambi√©n */
            text-align: left;
        }
        
        .hero-title {
            max-width: 85%; /* Ajustado para m√≥viles pero manteniendo alineaci√≥n izquierda */
            text-align: left;
        }
        
        .hero-text {
            max-width: 80%; /* Ajustado para m√≥viles pero manteniendo alineaci√≥n izquierda */
            text-align: left;
        }
        
        .hero-meta {
            gap: 10px;
            justify-content: flex-start; /* Mantenido alineaci√≥n a la izquierda en m√≥viles */
        }
        
        .hero-location, .hero-risk-badge {
            font-size: 0.85rem;
            padding: 8px 12px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="news-dashboard">
    <!-- Header and Statistics -->
    <div class="header-stats-container">
        <div class="page-header">
            <div>
                <h1 class="page-title">Tablero Geopol√≠tico</h1>
                <div class="page-subtitle">An√°lisis en tiempo real del panorama geopol√≠tico mundial</div>
            </div>
                        
        </div>
        <!-- Statistics Grid -->
        <div class="news-stats">
                <div class="news-stat-card">
                    <div class="stat-icon">üì∞</div>
                    <div class="stat-value" id="total-articles">{{ total_articles | default(0) }}</div>
                    <div class="stat-label">Art√≠culos Analizados</div>
                </div>
                <div class="news-stat-card">
                    <div class="stat-icon">üö®</div>
                    <div class="stat-value" id="high-risk-count">{{ high_risk_count | default(0) }}</div>
                    <div class="stat-label">Alertas Cr√≠ticas</div>
                </div>
                <div class="news-stat-card">
                    <div class="stat-icon">üåç</div>
                    <div class="stat-value" id="countries-monitored">{{ countries_monitored | default(0) }}</div>
                    <div class="stat-label">Regiones</div>
                </div>
                <div class="news-stat-card">
                    <div class="stat-icon">üìä</div>
                    <div class="stat-value" id="sources-count">{{ sources_count | default(0) }}</div>
                    <div class="stat-label">Fuentes Activas</div>
                </div>
            </div>
    </div>

    <!-- Hero Article Section - Featured Story -->
    <section class="hero-article-section">
        <div class="hero-article" id="hero-article" style="background-image: url('https://picsum.photos/1920/800?random=hero')">
            <div class="hero-content">
                <h1 class="hero-title" id="hero-title">Escalada de tensiones geopol√≠ticas marca el panorama internacional</h1>
                <p class="hero-text" id="hero-text">Los √∫ltimos desarrollos en el escenario global han intensificado las preocupaciones sobre la estabilidad regional, con implicaciones que se extienden m√°s all√° de las fronteras inmediatas y afectan los mercados internacionales, las alianzas diplom√°ticas y la seguridad energ√©tica mundial.</p>
                <div class="hero-meta">
                    <span class="hero-location" id="hero-location">
                        <i class="fas fa-map-marker-alt"></i>
                        <span id="hero-location-text">Europa Oriental</span>
                    </span>
                    <span class="hero-risk-badge high" id="hero-risk-badge">ALTO RIESGO</span>
                </div>
            </div>
        </div>
    </section>

    <!-- Dashboard Content -->
    <div class="dashboard-content">




        <!-- News Mosaic Section - Full Width -->
        <section class="news-mosaic-section">
            <div class="mosaic-controls-container">
                <div class="mosaic-controls">
                    <button class="btn-control active" onclick="loadMosaic('importance', this)">Por Importancia</button>
                    <button class="btn-control" onclick="loadMosaic('geographic', this)">Por Regi√≥n</button>
                    <button class="btn-control" onclick="loadMosaic('temporal', this)">Por Tiempo</button>
                    <button class="btn-control" onclick="loadMosaic('risk', this)">Por Riesgo</button>
                </div>
            </div>
            
            <div class="news-mosaic-container" id="news-mosaic">
                <div class="mosaic-loading">
                    <i class="fas fa-spinner fa-spin"></i>
                    <div>Cargando mosaico de noticias...</div>
                </div>
            </div>
            
            <!-- Load More Button -->
            <div class="load-more-container" id="load-more-container" style="display: none;">
                <button class="btn-load-more" onclick="loadMoreNews()">
                    <i class="fas fa-plus-circle"></i>
                    Cargar m√°s noticias
                </button>
            </div>
        </section>

        <!-- Data Analytics Section - New Enhanced Analytics -->
        <section class="analytics-section">
            <div class="analytics-header">
                <h2 class="analytics-title">
                    <i class="fas fa-chart-area"></i>
                    An√°lisis de Datos Geopol√≠ticos
                </h2>
                <p class="analytics-subtitle">An√°lisis inteligente de tendencias de conflicto y riesgo global</p>
            </div>

            <!-- Analytics Controls -->
            <div class="analytics-controls">
                <div class="analytics-filters">
                    <button class="btn-analytics active" onclick="loadAnalytics('overview', this)">Vista General</button>
                    <button class="btn-analytics" onclick="loadAnalytics('conflicts', this)">Zonas de Conflicto</button>
                    <button class="btn-analytics" onclick="loadAnalytics('trends', this)">Tendencias</button>
                    <button class="btn-analytics" onclick="loadAnalytics('predictions', this)">Predicciones</button>
                </div>
                <div class="analytics-options">
                    <select class="analytics-select" id="timeframe-select" onchange="updateAnalytics()">
                        <option value="24h">√öltimas 24 horas</option>
                        <option value="7d" selected>√öltimos 7 d√≠as</option>
                        <option value="30d">√öltimo mes</option>
                        <option value="90d">√öltimos 3 meses</option>
                    </select>
                    <button class="btn-export" onclick="exportGeoJSON()">
                        <i class="fas fa-download"></i>
                        Exportar GeoJSON
                    </button>
                </div>
            </div>

            <!-- Analytics Grid -->
            <div class="analytics-grid" id="analytics-grid">
                <!-- Overview Charts -->
                <div class="chart-container" id="risk-distribution-chart">
                    <h3 class="chart-title">Distribuci√≥n de Riesgo Global</h3>
                    <div class="chart-content">
                        <canvas id="riskDistributionCanvas"></canvas>
                    </div>
                    <div class="chart-stats">
                        <div class="stat-item">
                            <span class="analytics-stat-value" id="high-risk-regions">0</span>
                            <span class="analytics-stat-label">Regiones Alto Riesgo</span>
                        </div>
                        <div class="stat-item">
                            <span class="analytics-stat-value" id="medium-risk-regions">0</span>
                            <span class="analytics-stat-label">Regiones Riesgo Medio</span>
                        </div>
                    </div>
                </div>

                <div class="chart-container" id="temporal-trends-chart">
                    <h3 class="chart-title">Tendencias Temporales</h3>
                    <div class="chart-content">
                        <canvas id="temporalTrendsCanvas"></canvas>
                    </div>
                    <div class="chart-legend">
                        <div class="legend-item">
                            <span class="legend-color" style="background: #ff4757;"></span>
                            <span>Conflictos Activos</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background: #ffa726;"></span>
                            <span>Tensiones</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background: #26c6da;"></span>
                            <span>Estabilidad</span>
                        </div>
                    </div>
                </div>

                <div class="chart-container wide" id="geographic-analysis">
                    <h3 class="chart-title">
                        Mapa de Calor de Conflictos
                        <span class="chart-subtitle">Zonas de conflicto detectadas por IA</span>
                    </h3>
                    <div class="map-container">
                        <div id="conflict-heatmap" class="heatmap-container">
                            <div class="map-loading">
                                <i class="fas fa-globe-americas fa-spin"></i>
                                <p>Cargando mapa de calor...</p>
                            </div>
                        </div>
                        <div class="map-controls">
                            <button class="map-btn active" onclick="toggleMapLayer('conflicts', this)">Conflictos</button>
                            <button class="map-btn" onclick="toggleMapLayer('tensions', this)">Tensiones</button>
                            <button class="map-btn" onclick="toggleMapLayer('all', this)">Todo</button>
                        </div>
                    </div>
                    <div class="heatmap-legend">
                        <div class="legend-title">Intensidad de Conflicto</div>
                        <div class="legend-gradient">
                            <span class="legend-min">Bajo</span>
                            <div class="gradient-bar"></div>
                            <span class="legend-max">Alto</span>
                        </div>
                    </div>
                    <div class="auto-download-status">
                        <i class="fas fa-download"></i>
                        <span id="geojson-auto-status">GeoJSON guardado autom√°ticamente</span>
                    </div>
                </div>

                <div class="chart-container" id="conflict-categories">
                    <h3 class="chart-title">Categor√≠as de Conflicto</h3>
                    <div class="chart-content">
                        <canvas id="conflictCategoriesCanvas"></canvas>
                    </div>
                    <div class="categories-list" id="categories-list">
                        <!-- Categories will be populated dynamically -->
                    </div>
                </div>

                <div class="chart-container" id="prediction-model">
                    <h3 class="chart-title">Modelo Predictivo</h3>
                    <div class="prediction-content">
                        <div class="prediction-score">
                            <div class="score-circle" id="prediction-score">
                                <span class="score-value">0%</span>
                                <span class="score-label">Precisi√≥n</span>
                            </div>
                        </div>
                        <div class="prediction-factors">
                            <h4>Factores Clave</h4>
                            <div class="factors-list" id="factors-list">
                                <!-- Factors will be populated dynamically -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="chart-container wide" id="news-analysis">
                    <h3 class="chart-title">An√°lisis de Fuentes</h3>
                    <div class="sources-grid">
                        <div class="sources-chart">
                            <canvas id="sourcesCanvas"></canvas>
                        </div>
                        <div class="sources-stats">
                            <div class="source-stat">
                                <span class="stat-number" id="total-sources">0</span>
                                <span class="stat-desc">Fuentes Monitoreadas</span>
                            </div>
                            <div class="source-stat">
                                <span class="stat-number" id="active-sources">0</span>
                                <span class="stat-desc">Fuentes Activas</span>
                            </div>
                            <div class="source-stat">
                                <span class="stat-number" id="reliability-score">0%</span>
                                <span class="stat-desc">Confiabilidad Media</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Real-time Updates -->
            <div class="analytics-footer">
                <div class="update-info">
                    <i class="fas fa-sync-alt"></i>
                    <span>√öltima actualizaci√≥n: <span id="last-update">Cargando...</span></span>
                </div>
                <div class="ai-status">
                    <div class="ai-indicator active" id="ai-status">
                        <i class="fas fa-brain"></i>
                        <span>IA Activa</span>
                    </div>
                </div>
            </div>
        </section>
    </div>    
</div>

{% block dashboard_js %}
<!-- Dashboard-specific scripts loaded here -->
{% endblock %}

<script>
// Global variables
let currentFilter = 'all';
let mosaicData = [];
let currentNewsSet = 0; // Track which news set we're showing
let totalNewsSets = 4; // Total number of news sets available (4 dise√±os)

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    loadRealNewsData();  // Cargar datos reales primero
    loadHeroArticle();
    loadMosaic('importance', null);  // Pass null for initial load
    updateStatistics();
    
    // Auto-refresh every 5 minutes
    setInterval(function() {
        loadRealNewsData();  // Recargar datos reales
        updateStatistics();
        loadHeroArticle();
        refreshLatest();
    }, 300000);
});

// Cargar datos reales de la API
function loadRealNewsData() {
    fetch('/api/articles?limit=40')  // Cargar suficientes art√≠culos para 4+ sets
        .then(response => response.json())
        .then(data => {
            if (data.success && data.articles) {
                window.realNewsData = data.articles;
                console.log(`‚úÖ Cargados ${data.articles.length} art√≠culos reales de la base de datos`);
                
                // Iniciar an√°lisis de computer vision en background para art√≠culos con im√°genes
                const articlesWithImages = data.articles.filter(article => article.image_url);
                if (articlesWithImages.length > 0) {
                    console.log(`üîç Iniciando an√°lisis CV en background para ${articlesWithImages.length} art√≠culos con im√°genes`);
                    
                    // Llamar al endpoint de an√°lisis en batch de forma as√≠ncrona
                    fetch('/api/vision/analyze-article-images', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            article_ids: articlesWithImages.map(a => a.id).slice(0, 20) // Limitar a 20 para no sobrecargar
                        })
                    })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            console.log(`üéØ An√°lisis CV iniciado para ${result.started_count || 0} art√≠culos`);
                            
                            // Mostrar notificaci√≥n al usuario
                            showCVAnalysisNotification(`An√°lisis de computer vision iniciado para ${result.started_count || 0} im√°genes`);
                        } else {
                            console.warn('No se pudo iniciar an√°lisis CV:', result.error);
                        }
                    })
                    .catch(error => {
                        console.warn('Error iniciando an√°lisis CV:', error);
                    });
                }
            } else {
                console.warn('No se pudieron cargar art√≠culos reales, usando datos mock');
                window.realNewsData = [];
            }
        })
        .catch(error => {
            console.error('Error cargando datos reales:', error);
            window.realNewsData = [];
        });
}

// Mostrar notificaci√≥n de an√°lisis CV
function showCVAnalysisNotification(message) {
    // Crear elemento de notificaci√≥n
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(34, 197, 94, 0.9);
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        z-index: 1000;
        backdrop-filter: blur(8px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        transform: translateX(100%);
        transition: transform 0.3s ease;
    `;
    notification.innerHTML = `
        <i class="fas fa-robot" style="margin-right: 8px;"></i>
        ${message}
    `;
    
    document.body.appendChild(notification);
    
    // Animar entrada
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 100);
    
    // Auto-ocultar despu√©s de 5 segundos
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 5000);
}

// Load hero article (most important news)
function loadHeroArticle() {
    // Fetch real data from our API
    fetch('/api/hero-article')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.article) {
                const heroArticle = data.article;
                
                // Update hero article content
                document.getElementById('hero-title').textContent = heroArticle.title;
                document.getElementById('hero-text').textContent = heroArticle.text;
                document.getElementById('hero-location-text').textContent = heroArticle.location;
                
                // Update risk badge
                const riskBadge = document.getElementById('hero-risk-badge');
                riskBadge.className = `hero-risk-badge ${heroArticle.risk}`;
                riskBadge.textContent = heroArticle.risk.toUpperCase().replace('_', ' ') + ' RIESGO';
                
                // Update background image
                document.getElementById('hero-article').style.backgroundImage = `url('${heroArticle.image}')`;
            } else {
                console.warn('No se pudo cargar el art√≠culo h√©roe, usando datos de fallback');
                loadHeroArticleFallback();
            }
        })
        .catch(error => {
            console.error('Error cargando art√≠culo h√©roe:', error);
            loadHeroArticleFallback();
        });
}

function loadHeroArticleFallback() {
    // Fallback data if API fails
    const heroArticles = [
        {
            title: "Crisis diplom√°tica escalas en Europa Oriental con implicaciones globales",
            text: "Los √∫ltimos desarrollos han intensificado las preocupaciones sobre la estabilidad regional, con movimientos militares que sugieren una preparaci√≥n para posibles acciones de mayor envergadura.",
            location: "Europa Oriental",
            risk: "high",
            image: "https://picsum.photos/1920/800?random=hero1"
        },
        {
            title: "Tensiones comerciales amenazan la estabilidad econ√≥mica mundial",
            text: "Las nuevas restricciones comerciales han generado ondas de choque en los mercados globales, con preocupaciones crecientes sobre una posible guerra comercial.",
            location: "Global",
            risk: "high", 
            image: "https://picsum.photos/1920/800?random=hero2"
        },
        {
            title: "Desarrollos cr√≠ticos en el Medio Oriente alteran el equilibrio regional",
            text: "Los eventos recientes han reconfigurado las alianzas tradicionales en la regi√≥n, con implicaciones significativas para la seguridad energ√©tica global.",
            location: "Medio Oriente",
            risk: "critical",
            image: "https://picsum.photos/1920/800?random=hero3"
        }
    ];
    
    // Select random hero article
    const heroArticle = heroArticles[Math.floor(Math.random() * heroArticles.length)];
    
    // Update hero article content
    document.getElementById('hero-title').textContent = heroArticle.title;
    document.getElementById('hero-text').textContent = heroArticle.text;
    document.getElementById('hero-location-text').textContent = heroArticle.location;
    
    // Update risk badge
    const riskBadge = document.getElementById('hero-risk-badge');
    riskBadge.className = `hero-risk-badge ${heroArticle.risk}`;
    riskBadge.textContent = heroArticle.risk.toUpperCase().replace('_', ' ') + ' RIESGO';
    
    // Update background image
    document.getElementById('hero-article').style.backgroundImage = `url('${heroArticle.image}')`;
}

// High risk articles filtering
function filterHighRisk(category, buttonElement) {
    currentFilter = category;
    
    // Update button states
    document.querySelectorAll('.section-controls .btn-control').forEach(btn => {
        btn.classList.remove('active');
    });
    if (buttonElement) {
        buttonElement.classList.add('active');
    }
    
    // Filter articles
    const articles = document.querySelectorAll('.high-risk-card');
    articles.forEach(article => {
        const articleCategory = article.dataset.category || 'general';
        if (category === 'all' || articleCategory === category) {
            article.style.display = 'block';
        } else {
            article.style.display = 'none';
        }
    });
}

// Latest articles filtering
function filterLatest(timeframe, buttonElement) {
    const articles = document.querySelectorAll('.latest-article-card');
    const now = new Date();
    
    // Update button states
    if (buttonElement) {
        buttonElement.parentElement.querySelectorAll('.btn-control').forEach(btn => {
            btn.classList.remove('active');
        });
        buttonElement.classList.add('active');
    }
    
    articles.forEach(article => {
        const articleDate = new Date(article.dataset.date);
        let show = true;
        
        if (timeframe === 'today') {
            show = articleDate.toDateString() === now.toDateString();
        } else if (timeframe === 'week') {
            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            show = articleDate >= weekAgo;
        }
        
        article.style.display = show ? 'flex' : 'none';
    });
}

// Refresh latest articles
function refreshLatest() {
    // Show loading state
    const container = document.getElementById('latest-articles');
    container.innerHTML = '<div class="latest-article-card"><div class="latest-article-content"><h3 class="latest-article-title">Actualizando...</h3><p class="latest-article-description">Obteniendo las √∫ltimas noticias...</p></div></div>';
    
    // Simulate API call
    setTimeout(() => {
        location.reload();
    }, 1000);
}

// Load news mosaic
function loadMosaic(mode, buttonElement) {
    const container = document.getElementById('news-mosaic');
    
    // Reset news set counter when changing filter
    currentNewsSet = 0;
    
    // Update button states
    document.querySelectorAll('.mosaic-controls .btn-control').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Add active class to the clicked button
    if (buttonElement) {
        buttonElement.classList.add('active');
    } else {
        // Fallback: find button by mode
        const activeButton = document.querySelector(`.btn-control[onclick*="${mode}"]`);
        if (activeButton) {
            activeButton.classList.add('active');
        }
    }
    
    // Show loading
    container.innerHTML = `
        <div class="mosaic-loading">
            <i class="fas fa-spinner fa-spin"></i>
            <div>Cargando mosaico ${mode}...</div>
        </div>
    `;
    
    // Hide load more button during initial load
    const loadMoreContainer = document.getElementById('load-more-container');
    loadMoreContainer.style.display = 'none';
    
    // Simulate loading and populate with sample data
    setTimeout(() => {
        generateMosaicTiles(mode);
    }, 1500);
}

// Computer Vision Integration for Image Optimization
async function getImageAnalysis(articleId) {
    try {
        const response = await fetch(`/api/vision/get-analysis/${articleId}`);
        if (response.ok) {
            const analysis = await response.json();
            console.log(`üîç An√°lisis CV obtenido para art√≠culo ${articleId}:`, analysis);
            return analysis;
        }
    } catch (error) {
        console.warn(`No se pudo obtener an√°lisis CV para art√≠culo ${articleId}:`, error);
    }
    return null;
}

function optimizeImagePositioning(imageElement, analysis) {
    if (!analysis || !analysis.positioning_recommendation) {
        console.log('No hay recomendaciones de posicionamiento CV disponibles');
        return;
    }

    const positioning = analysis.positioning_recommendation;
    const container = imageElement.closest('.mosaic-article');
    
    // Aplicar posicionamiento optimizado basado en an√°lisis CV
    if (positioning.position) {
        const positions = {
            'top-left': '0% 0%',
            'top-center': '50% 0%',
            'top-right': '100% 0%',
            'center-left': '0% 50%',
            'center': '50% 50%',
            'center-right': '100% 50%',
            'bottom-left': '0% 100%',
            'bottom-center': '50% 100%',
            'bottom-right': '100% 100%'
        };
        
        const objectPosition = positions[positioning.position] || positions['center'];
        imageElement.style.objectPosition = objectPosition;
        console.log(`üìç Posicionamiento CV aplicado: ${positioning.position} (${objectPosition})`);
    }

    // Agregar indicador de calidad visual
    if (analysis.quality_score && container) {
        const existingIndicator = container.querySelector('.cv-quality-indicator');
        if (existingIndicator) {
            existingIndicator.remove();
        }

        const qualityIndicator = document.createElement('div');
        qualityIndicator.className = 'cv-quality-indicator';
        qualityIndicator.style.cssText = `
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0, 255, 0, 0.9);
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            z-index: 20;
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        `;
        qualityIndicator.textContent = `CV: ${(analysis.quality_score * 100).toFixed(0)}%`;
        
        // Color basado en calidad
        if (analysis.quality_score >= 0.8) {
            qualityIndicator.style.background = 'rgba(34, 197, 94, 0.9)'; // Verde
        } else if (analysis.quality_score >= 0.6) {
            qualityIndicator.style.background = 'rgba(249, 115, 22, 0.9)'; // Naranja
        } else {
            qualityIndicator.style.background = 'rgba(239, 68, 68, 0.9)'; // Rojo
        }
        
        container.appendChild(qualityIndicator);
        console.log(`‚ú® Indicador de calidad CV a√±adido: ${(analysis.quality_score * 100).toFixed(0)}%`);
    }
}

async function applyComputerVisionOptimization(articleElement, article) {
    if (!article.id) {
        console.warn('Art√≠culo sin ID, no se puede aplicar an√°lisis CV');
        return;
    }

    try {
        // Obtener an√°lisis CV para este art√≠culo
        const cvAnalysis = await getImageAnalysis(article.id);
        
        if (cvAnalysis && !cvAnalysis.error) {
            // Encontrar la imagen en el elemento del art√≠culo
            const imageDiv = articleElement.querySelector('.mosaic-article');
            
            if (imageDiv && article.image) {
                // Aplicar optimizaci√≥n de posicionamiento a background-image
                if (cvAnalysis.positioning_recommendation) {
                    const position = cvAnalysis.positioning_recommendation.position || 'center';
                    const positions = {
                        'top-left': '0% 0%',
                        'top-center': '50% 0%',
                        'top-right': '100% 0%',
                        'center-left': '0% 50%',
                        'center': '50% 50%',
                        'center-right': '100% 50%',
                        'bottom-left': '0% 100%',
                        'bottom-center': '50% 100%',
                        'bottom-right': '100% 100%'
                    };
                    
                    imageDiv.style.backgroundPosition = positions[position] || positions['center'];
                    console.log(`üéØ CV: Posici√≥n optimizada aplicada - ${position}`);
                }
                
                // A√±adir indicador de calidad
                if (cvAnalysis.quality_score) {
                    const existingIndicator = imageDiv.querySelector('.cv-quality-indicator');
                    if (existingIndicator) {
                        existingIndicator.remove();
                    }

                    const qualityIndicator = document.createElement('div');
                    qualityIndicator.className = 'cv-quality-indicator';
                    qualityIndicator.style.cssText = `
                        position: absolute;
                        top: 8px;
                        right: 8px;
                        background: rgba(0, 255, 0, 0.9);
                        color: white;
                        padding: 3px 8px;
                        border-radius: 12px;
                        font-size: 11px;
                        font-weight: bold;
                        z-index: 20;
                        backdrop-filter: blur(4px);
                        border: 1px solid rgba(255, 255, 255, 0.2);
                        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
                    `;
                    qualityIndicator.textContent = `CV: ${(cvAnalysis.quality_score * 100).toFixed(0)}%`;
                    
                    // Color basado en calidad
                    if (cvAnalysis.quality_score >= 0.8) {
                        qualityIndicator.style.background = 'rgba(34, 197, 94, 0.9)'; // Verde
                    } else if (cvAnalysis.quality_score >= 0.6) {
                        qualityIndicator.style.background = 'rgba(249, 115, 22, 0.9)'; // Naranja
                    } else {
                        qualityIndicator.style.background = 'rgba(239, 68, 68, 0.9)'; // Rojo
                    }
                    
                    imageDiv.appendChild(qualityIndicator);
                    console.log(`‚ú® Indicador de calidad CV a√±adido: ${(cvAnalysis.quality_score * 100).toFixed(0)}%`);
                }
            }
        } else {
            console.log(`‚ÑπÔ∏è No hay an√°lisis CV disponible para art√≠culo ${article.id}`);
        }
    } catch (error) {
        console.error(`Error aplicando optimizaci√≥n CV para art√≠culo ${article.id}:`, error);
    }
}

// Generate mosaic tiles
async function generateMosaicTiles(mode) {
    const container = document.getElementById('news-mosaic');
    let tilesHTML = '';
    
    // Get the current news set
    const sampleArticles = getNewsSet(currentNewsSet);
    
    console.log(`üé® Generando mosaico con ${sampleArticles.length} art√≠culos usando computer vision...`);
    
    // Pre-cargar an√°lisis CV para todos los art√≠culos
    const cvAnalysisPromises = sampleArticles.map(article => 
        article.id ? getImageAnalysis(article.id) : Promise.resolve(null)
    );
    
    try {
        const cvAnalyses = await Promise.all(cvAnalysisPromises);
        console.log(`üîç An√°lisis CV obtenidos para ${cvAnalyses.filter(a => a).length} art√≠culos`);
        
        sampleArticles.forEach((article, index) => {
            let sizeClass;
            
            if (currentNewsSet === 0) {
                // Set 1: Dise√±o original (7 noticias)
                sizeClass = `size-${(index % 12) + 1}`;
            } else if (currentNewsSet === 1) {
                // Set 2: NUEVO DISE√ëO DEL USUARIO - Rejilla 3x4 (12 cuadrados) 
                const newUserPattern = [
                    'size-puzzle-single',  // Art 1: 1 cuadrado 
                    'size-puzzle-single',  // Art 2: 1 cuadrado  
                    'size-puzzle-single',  // Art 3: 1 cuadrado
                    'size-puzzle-single',  // Art 4: 1 cuadrado
                    'size-puzzle-big',     // Art 5: 4 cuadrados (grande)
                    'size-puzzle-wide',    // Art 6: 2 cuadrados (ancho)
                    'size-puzzle-wide'     // Art 7: 2 cuadrados (ancho)
                ];
                sizeClass = newUserPattern[index] || 'size-puzzle-single';
            } else if (currentNewsSet === 2) {
                // Set 3: Dise√±o puzzle anterior - Rejilla 3x4 (12 cuadrados) 
                const puzzlePattern = [
                    'size-puzzle-single',  // Art 1: 1 cuadrado (izquierda)
                    'size-puzzle-single',  // Art 2: 1 cuadrado (izquierda)
                    'size-puzzle-big',     // Art 3: 4 cuadrados (derecha)
                    'size-puzzle-single',  // Art 4: 1 cuadrado (izquierda)
                    'size-puzzle-single',  // Art 5: 1 cuadrado (izquierda)
                    'size-puzzle-wide',    // Art 6: 2 cuadrados (abajo)
                    'size-puzzle-wide'     // Art 7: 2 cuadrados (abajo)
                ];
                sizeClass = puzzlePattern[index] || 'size-puzzle-single';
            } else if (currentNewsSet === 3) {
                // Set 4: Dise√±o esquema Paint - Rejilla 3x4 (12 cuadrados) seg√∫n imagen
                const paintPattern = [
                    'size-puzzle-single',  // Art 1: Verde 1 (1 cuadrado)
                    'size-puzzle-single',  // Art 2: Verde 2 (1 cuadrado)  
                    'size-puzzle-big',     // Art 3: Azul grande (4 cuadrados)
                    'size-puzzle-single',  // Art 4: Amarillo 1 (1 cuadrado)
                    'size-puzzle-single',  // Art 5: Marr√≥n (1 cuadrado)
                    'size-puzzle-wide',    // Art 6: Amarillo ancho (2 cuadrados)
                    'size-puzzle-single',  // Art 7: Rojo (1 cuadrado)
                    'size-puzzle-single'   // Art 8: Verde 3 (1 cuadrado)
                ];
                sizeClass = paintPattern[index] || 'size-puzzle-single';
            } else {
                // Otros sets: usar sistema original
                sizeClass = `size-${(index % 12) + 1}`;
            }
            
            const riskClass = article.risk === 'high' ? 'hero' : article.risk;
            const cvAnalysis = cvAnalyses[index];
            
            // Determinar posicionamiento de fondo basado en an√°lisis CV
            let backgroundPosition = 'center center';
            if (cvAnalysis && cvAnalysis.positioning_recommendation) {
                const position = cvAnalysis.positioning_recommendation.position || 'center';
                const positions = {
                    'top-left': '0% 0%',
                    'top-center': '50% 0%',
                    'top-right': '100% 0%',
                    'center-left': '0% 50%',
                    'center': '50% 50%',
                    'center-right': '100% 50%',
                    'bottom-left': '0% 100%',
                    'bottom-center': '50% 100%',
                    'bottom-right': '100% 100%'
                };
                backgroundPosition = positions[position] || positions['center'];
            }
            
            // Generar indicador de calidad CV
            let cvIndicator = '';
            if (cvAnalysis && cvAnalysis.quality_score) {
                const qualityScore = (cvAnalysis.quality_score * 100).toFixed(0);
                let bgColor = 'rgba(34, 197, 94, 0.9)'; // Verde por defecto
                
                if (cvAnalysis.quality_score < 0.6) {
                    bgColor = 'rgba(239, 68, 68, 0.9)'; // Rojo
                } else if (cvAnalysis.quality_score < 0.8) {
                    bgColor = 'rgba(249, 115, 22, 0.9)'; // Naranja
                }
                
                cvIndicator = `
                    <div class="cv-quality-indicator" style="
                        position: absolute;
                        top: 8px;
                        right: 8px;
                        background: ${bgColor};
                        color: white;
                        padding: 3px 8px;
                        border-radius: 12px;
                        font-size: 11px;
                        font-weight: bold;
                        z-index: 20;
                        backdrop-filter: blur(4px);
                        border: 1px solid rgba(255, 255, 255, 0.2);
                        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
                    ">CV: ${qualityScore}%</div>
                `;
            }
            
            tilesHTML += `
                <div class="mosaic-article ${sizeClass}" 
                     style="background-image: url('${article.image}'); background-position: ${backgroundPosition};"
                     data-article-id="${article.id || ''}"
                     data-cv-optimized="${cvAnalysis ? 'true' : 'false'}">
                    ${cvIndicator}
                    <div class="mosaic-content">
                        <h3 class="mosaic-title">${article.title}</h3>
                        <div class="mosaic-meta">
                            <span class="mosaic-location">
                                <i class="fas fa-map-marker-alt"></i>
                                ${article.location}
                            </span>
                            <span class="mosaic-risk-badge ${riskClass}">${article.risk.toUpperCase()}</span>
                        </div>
                    </div>
                </div>
            `;
        });
        
        // If this is the first load, replace content. Otherwise, append
        if (currentNewsSet === 0) {
            container.innerHTML = tilesHTML;
        } else {
            // Para sets adicionales, a√±adir las noticias al contenido existente
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = tilesHTML;
            
            // A√±adir cada art√≠culo individualmente al contenedor
            while (tempDiv.firstChild) {
                container.appendChild(tempDiv.firstChild);
            }
        }
        
        // Log de estad√≠sticas CV
        const optimizedCount = cvAnalyses.filter(a => a && !a.error).length;
        console.log(`‚úÖ Mosaico generado con computer vision: ${optimizedCount}/${sampleArticles.length} im√°genes optimizadas`);
        
        // Show/hide load more button
        const loadMoreContainer = document.getElementById('load-more-container');
        loadMoreContainer.style.display = 'flex';
        
    } catch (error) {
        console.error('Error aplicando computer vision al mosaico:', error);
        
        // Fallback: generar mosaico sin CV
        sampleArticles.forEach((article, index) => {
            let sizeClass = `size-${(index % 12) + 1}`;
            const riskClass = article.risk === 'high' ? 'hero' : article.risk;
            
            tilesHTML += `
                <div class="mosaic-article ${sizeClass}" style="background-image: url('${article.image}')">
                    <div class="mosaic-content">
                        <h3 class="mosaic-title">${article.title}</h3>
                        <div class="mosaic-meta">
                            <span class="mosaic-location">
                                <i class="fas fa-map-marker-alt"></i>
                                ${article.location}
                            </span>
                            <span class="mosaic-risk-badge ${riskClass}">${article.risk.toUpperCase()}</span>
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = tilesHTML;
        const loadMoreContainer = document.getElementById('load-more-container');
        loadMoreContainer.style.display = 'flex';
    }
}

// Get different news sets with perfect alignment
function getNewsSet(setIndex) {
    // Verificar si tenemos datos reales cargados
    if (window.realNewsData && window.realNewsData.length > 0) {
        return getRealNewsForSet(setIndex);
    }
    
    // Fallback a datos mock si no hay datos reales
    return getMockNewsSet(setIndex);
}

// Obtener datos reales organizados por sets
function getRealNewsForSet(setIndex) {
    const articlesPerSet = 7; // Cada set tiene 7 art√≠culos
    const startIndex = setIndex * articlesPerSet;
    const endIndex = startIndex + articlesPerSet;
    
    // Obtener slice de art√≠culos reales para este set
    const realArticles = window.realNewsData.slice(startIndex, endIndex);
    
    // Si no hay suficientes art√≠culos reales, completar con mock
    if (realArticles.length < articlesPerSet) {
        const mockArticles = getMockNewsSet(setIndex);
        const needed = articlesPerSet - realArticles.length;
        realArticles.push(...mockArticles.slice(0, needed));
    }
    
    return realArticles;
}

// Funci√≥n para obtener datos mock (como respaldo)
function getMockNewsSet(setIndex) {
    const newsSets = [
        // Set 1: 7 articles - DISE√ëO ORIGINAL QUE FUNCIONABA BIEN
        [
            {
                title: "Tensiones geopol√≠ticas se intensifican en Europa Oriental",
                location: "Europa Oriental",
                risk: "high",
                image: "https://picsum.photos/400/300?random=1"
            },
            {
                title: "Crisis diplom√°tica en Asia-Pac√≠fico",
                location: "Asia-Pac√≠fico",
                risk: "medium",
                image: "https://picsum.photos/400/300?random=2"
            },
            {
                title: "Movimientos econ√≥micos estrat√©gicos en Medio Oriente",
                location: "Medio Oriente",
                risk: "medium",
                image: "https://picsum.photos/400/300?random=3"
            },
            {
                title: "Desarrollos significativos en Am√©rica Latina",
                location: "Am√©rica Latina",
                risk: "low",
                image: "https://picsum.photos/400/300?random=4"
            },
            {
                title: "Cambios en las alianzas africanas",
                location: "√Åfrica",
                risk: "medium",
                image: "https://picsum.photos/400/300?random=5"
            },
            {
                title: "Nuevas pol√≠ticas en Am√©rica del Norte",
                location: "Am√©rica del Norte",
                risk: "low",
                image: "https://picsum.photos/400/300?random=6"
            },
            {
                title: "Desarrollos en el √Årtico",
                location: "√Årtico",
                risk: "medium",
                image: "https://picsum.photos/400/300?random=7"
            }
        ],
        // Set 2: 7 articles - NUEVO DISE√ëO DEL USUARIO (3x4 = 12 cuadrados completos)
        [
            {
                title: "Reformas estrat√©gicas en el Sudeste Asi√°tico",
                location: "Sudeste Asi√°tico",
                risk: "medium",
                image: "https://picsum.photos/400/300?random=23"
            },
            {
                title: "Alianzas energ√©ticas en Europa Central",
                location: "Europa Central",
                risk: "high",
                image: "https://picsum.photos/400/300?random=24"
            },
            {
                title: "Desarrollos tecnol√≥gicos en Asia Oriental",
                location: "Asia Oriental",
                risk: "medium",
                image: "https://picsum.photos/400/300?random=25"
            },
            {
                title: "Negociaciones comerciales en el Mediterr√°neo",
                location: "Mediterr√°neo",
                risk: "low",
                image: "https://picsum.photos/400/300?random=26"
            },
            {
                title: "Crisis migratoria intensifica tensiones regionales",
                location: "Europa del Sur",
                risk: "high",
                image: "https://picsum.photos/400/300?random=27"
            },
            {
                title: "Acuerdos de cooperaci√≥n en el Atl√°ntico Norte",
                location: "Atl√°ntico Norte",
                risk: "low",
                image: "https://picsum.photos/400/300?random=28"
            },
            {
                title: "Reformas pol√≠ticas en Am√©rica Andina",
                location: "Am√©rica Andina",
                risk: "medium",
                image: "https://picsum.photos/400/300?random=29"
            }
        ],
        // Set 3: 7 articles - DISE√ëO PUZZLE ANTERIOR (3x4 = 12 cuadrados completos)
        [
            {
                title: "Escalada de conflictos en el Sudeste Asi√°tico",
                location: "Sudeste Asi√°tico",
                risk: "high",
                image: "https://picsum.photos/400/300?random=8"
            },
            {
                title: "Nuevas sanciones econ√≥micas globales",
                location: "Global",
                risk: "high",
                image: "https://picsum.photos/400/300?random=9"
            },
            {
                title: "Cambios en la pol√≠tica energ√©tica europea",
                location: "Europa",
                risk: "medium",
                image: "https://picsum.photos/400/300?random=10"
            },
            {
                title: "Desarrollos en el C√°ucaso",
                location: "C√°ucaso",
                risk: "medium",
                image: "https://picsum.photos/400/300?random=11"
            },
            {
                title: "Situaci√≥n en el Cuerno de √Åfrica",
                location: "√Åfrica Oriental",
                risk: "medium",
                image: "https://picsum.photos/400/300?random=12"
            },
            {
                title: "Acuerdos comerciales en el Pac√≠fico",
                location: "Pac√≠fico",
                risk: "low",
                image: "https://picsum.photos/400/300?random=13"
            },
            {
                title: "Reformas pol√≠ticas en Am√©rica Central",
                location: "Am√©rica Central",
                risk: "low",
                image: "https://picsum.photos/400/300?random=14"
            }
        ],
        // Set 4: 8 articles - DISE√ëO ESQUEMA PAINT (3x4 = 12 cuadrados completos)
        [
            {
                title: "Tensiones diplom√°ticas en Asia Central",
                location: "Asia Central",
                risk: "medium",
                image: "https://picsum.photos/400/300?random=15"
            },
            {
                title: "Crisis energ√©tica en Europa del Norte",
                location: "Europa del Norte",
                risk: "high",
                image: "https://picsum.photos/400/300?random=16"
            },
            {
                title: "Desarrollos militares en el Indo-Pac√≠fico",
                location: "Indo-Pac√≠fico",
                risk: "high",
                image: "https://picsum.photos/400/300?random=17"
            },
            {
                title: "Negociaciones comerciales en √Åfrica Occidental",
                location: "√Åfrica Occidental",
                risk: "low",
                image: "https://picsum.photos/400/300?random=18"
            },
            {
                title: "Reformas pol√≠ticas en el Mediterr√°neo Oriental",
                location: "Mediterr√°neo Oriental",
                risk: "medium",
                image: "https://picsum.photos/400/300?random=19"
            },
            {
                title: "Cooperaci√≥n internacional en la Ant√°rtida",
                location: "Ant√°rtida",
                risk: "low",
                image: "https://picsum.photos/400/300?random=20"
            },
            {
                title: "Disputas territoriales en el Mar del Sur de China",
                location: "Mar del Sur de China",
                risk: "high",
                image: "https://picsum.photos/400/300?random=21"
            },
            {
                title: "Alianzas estrat√©gicas en Am√©rica del Sur",
                location: "Am√©rica del Sur",
                risk: "medium",
                image: "https://picsum.photos/400/300?random=22"
            }
        ]
    ];
    
    return newsSets[setIndex] || [];
}

// Load more news function
function loadMoreNews() {
    if (currentNewsSet < totalNewsSets - 1) {
        currentNewsSet++;
        
        // Show loading for the additional content
        const container = document.getElementById('news-mosaic');
        const loadingHTML = `
            <div class="mosaic-loading" style="grid-column: 1 / -1; margin: 20px 0;">
                <i class="fas fa-spinner fa-spin"></i>
                <div>Cargando m√°s noticias...</div>
            </div>
        `;
        container.innerHTML += loadingHTML;
        
        // Simulate loading time
        setTimeout(() => {
            // Remove loading indicator
            const loadingElements = container.querySelectorAll('.mosaic-loading');
            loadingElements.forEach(el => el.remove());
            
            // Add new articles
            generateMosaicTiles('importance');
        }, 1000);
    }
}

// Update statistics
function updateStatistics() {
    // Fetch real statistics from API
    fetch('/api/statistics')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const stats = data.statistics;
                document.getElementById('total-articles').textContent = stats.total_articles || 0;
                document.getElementById('high-risk-count').textContent = stats.risk_alerts || 0;
                document.getElementById('countries-monitored').textContent = stats.countries_monitored || 0;
                document.getElementById('sources-count').textContent = stats.data_sources || 0;
                
                console.log('‚úÖ Estad√≠sticas actualizadas desde la base de datos');
            } else {
                console.warn('Error obteniendo estad√≠sticas, usando valores mock');
                updateStatisticsFallback();
            }
        })
        .catch(error => {
            console.error('Error cargando estad√≠sticas:', error);
            updateStatisticsFallback();
        });
}

function updateStatisticsFallback() {
    // Fallback statistics if API fails
    const stats = {
        totalArticles: Math.floor(Math.random() * 1000) + 500,
        highRiskCount: Math.floor(Math.random() * 20) + 5,
        countriesMonitored: Math.floor(Math.random() * 50) + 120,
        sourcesCount: Math.floor(Math.random() * 100) + 50
    };
    
    document.getElementById('total-articles').textContent = stats.totalArticles;
    document.getElementById('high-risk-count').textContent = stats.highRiskCount;
    document.getElementById('countries-monitored').textContent = stats.countriesMonitored;
    document.getElementById('sources-count').textContent = stats.sourcesCount;
}

// ===========================================
// ANALYTICS SECTION FUNCTIONS
// ===========================================

// Global analytics variables
let analyticsCharts = {};
let conflictHeatmapData = [];
let currentAnalyticsMode = 'overview';

// Initialize analytics when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    // Initialize analytics after a delay to ensure main content loads first
    setTimeout(() => {
        initializeAnalytics();
        loadAnalytics('overview', null);
    }, 2000);
});

// Initialize analytics components
function initializeAnalytics() {
    // Load Chart.js library if not already loaded
    if (typeof Chart === 'undefined') {
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
        script.onload = () => {
            console.log('‚úÖ Chart.js loaded for analytics');
            createAnalyticsCharts();
        };
        document.head.appendChild(script);
    } else {
        createAnalyticsCharts();
    }
    
    // Initialize conflict heatmap
    initializeConflictHeatmap();
    
    // Update analytics data
    fetchAnalyticsData();
    
    // Set up auto-refresh
    setInterval(fetchAnalyticsData, 300000); // Refresh every 5 minutes
}

// Load analytics based on selected mode
function loadAnalytics(mode, buttonElement) {
    currentAnalyticsMode = mode;
    
    // Update button states
    document.querySelectorAll('.btn-analytics').forEach(btn => {
        btn.classList.remove('active');
    });
    if (buttonElement) {
        buttonElement.classList.add('active');
    }
    
    // Show relevant charts based on mode
    showAnalyticsForMode(mode);
    
    console.log(`üìä Loading analytics for mode: ${mode}`);
}

// Show analytics components based on mode
function showAnalyticsForMode(mode) {
    const containers = {
        'risk-distribution-chart': ['overview', 'conflicts'],
        'temporal-trends-chart': ['overview', 'trends'],
        'geographic-analysis': ['overview', 'conflicts'],
        'conflict-categories': ['conflicts', 'trends'],
        'prediction-model': ['predictions', 'overview'],
        'news-analysis': ['overview', 'trends']
    };
    
    Object.keys(containers).forEach(containerId => {
        const container = document.getElementById(containerId);
        if (container) {
            if (containers[containerId].includes(mode)) {
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
            }
        }
    });
}

// Create analytics charts
function createAnalyticsCharts() {
    // Risk Distribution Chart (Doughnut)
    const riskCtx = document.getElementById('riskDistributionCanvas');
    if (riskCtx) {
        analyticsCharts.riskDistribution = new Chart(riskCtx, {
            type: 'doughnut',
            data: {
                labels: ['Alto Riesgo', 'Riesgo Medio', 'Bajo Riesgo'],
                datasets: [{
                    data: [25, 45, 30],
                    backgroundColor: ['#f44336', '#ff9800', '#4caf50'],
                    borderColor: '#fff',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: '#fff',
                            font: { size: 12 }
                        }
                    }
                }
            }
        });
    }
    
    // Temporal Trends Chart (Line)
    const temporalCtx = document.getElementById('temporalTrendsCanvas');
    if (temporalCtx) {
        const labels = generateDateLabels(7);
        analyticsCharts.temporalTrends = new Chart(temporalCtx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Conflictos Activos',
                        data: generateRandomData(7, 10, 50),
                        borderColor: '#ff4757',
                        backgroundColor: 'rgba(255, 71, 87, 0.1)',
                        tension: 0.4
                    },
                    {
                        label: 'Tensiones',
                        data: generateRandomData(7, 20, 80),
                        borderColor: '#ffa726',
                        backgroundColor: 'rgba(255, 167, 38, 0.1)',
                        tension: 0.4
                    },
                    {
                        label: 'Estabilidad',
                        data: generateRandomData(7, 60, 90),
                        borderColor: '#26c6da',
                        backgroundColor: 'rgba(38, 198, 218, 0.1)',
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false // We use custom legend
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { color: '#fff' },
                        grid: { color: 'rgba(255,255,255,0.1)' }
                    },
                    x: {
                        ticks: { color: '#fff' },
                        grid: { color: 'rgba(255,255,255,0.1)' }
                    }
                }
            }
        });
    }
    
    // Conflict Categories Chart (Bar)
    const categoriesCtx = document.getElementById('conflictCategoriesCanvas');
    if (categoriesCtx) {
        analyticsCharts.conflictCategories = new Chart(categoriesCtx, {
            type: 'bar',
            data: {
                labels: ['Territorial', 'Econ√≥mico', 'Pol√≠tico', 'Religioso', '√âtnico'],
                datasets: [{
                    data: [15, 23, 18, 12, 8],
                    backgroundColor: [
                        '#ff4757',
                        '#ff6b81',
                        '#ffa726',
                        '#ffcc02',
                        '#26c6da'
                    ],
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { color: '#fff' },
                        grid: { color: 'rgba(255,255,255,0.1)' }
                    },
                    x: {
                        ticks: { color: '#fff' },
                        grid: { display: false }
                    }
                }
            }
        });
    }
    
    // Sources Chart (Pie)
    const sourcesCtx = document.getElementById('sourcesCanvas');
    if (sourcesCtx) {
        analyticsCharts.sources = new Chart(sourcesCtx, {
            type: 'pie',
            data: {
                labels: ['Agencias Oficiales', 'Medios Locales', 'Redes Sociales', 'Think Tanks'],
                datasets: [{
                    data: [40, 30, 20, 10],
                    backgroundColor: ['#4caf50', '#2196f3', '#ff9800', '#9c27b0'],
                    borderColor: '#fff',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: '#fff',
                            font: { size: 10 }
                        }
                    }
                }
            }
        });
    }
    
    console.log('üìä Analytics charts created successfully');
}

// Initialize conflict heatmap
function initializeConflictHeatmap() {
    const heatmapContainer = document.getElementById('conflict-heatmap');
    if (heatmapContainer) {
        // Create a more detailed heatmap visualization
        heatmapContainer.innerHTML = `
            <svg width="100%" height="100%" viewBox="0 0 900 450" class="heatmap-svg">
                <!-- World regions representation -->
                <defs>
                    <radialGradient id="conflict-gradient-high" cx="50%" cy="50%" r="50%">
                        <stop offset="0%" style="stop-color:#ff4757;stop-opacity:0.9" />
                        <stop offset="50%" style="stop-color:#ff4757;stop-opacity:0.6" />
                        <stop offset="100%" style="stop-color:#ff4757;stop-opacity:0.2" />
                    </radialGradient>
                    <radialGradient id="conflict-gradient-medium" cx="50%" cy="50%" r="50%">
                        <stop offset="0%" style="stop-color:#ffa726;stop-opacity:0.8" />
                        <stop offset="50%" style="stop-color:#ffa726;stop-opacity:0.5" />
                        <stop offset="100%" style="stop-color:#ffa726;stop-opacity:0.1" />
                    </radialGradient>
                    <radialGradient id="conflict-gradient-low" cx="50%" cy="50%" r="50%">
                        <stop offset="0%" style="stop-color:#26c6da;stop-opacity:0.6" />
                        <stop offset="50%" style="stop-color:#26c6da;stop-opacity:0.3" />
                        <stop offset="100%" style="stop-color:#26c6da;stop-opacity:0.1" />
                    </radialGradient>
                </defs>
                
                <!-- Background world map representation -->
                <rect width="100%" height="100%" fill="rgba(26, 35, 126, 0.3)" rx="15"/>
                
                <!-- Continents outline (simplified) -->
                <path d="M150 120 L300 110 L350 140 L320 180 L250 190 L180 170 Z" 
                      fill="rgba(255,255,255,0.05)" stroke="rgba(255,255,255,0.1)" stroke-width="1"/>
                <path d="M400 130 L550 120 L580 160 L520 200 L450 190 L400 160 Z" 
                      fill="rgba(255,255,255,0.05)" stroke="rgba(255,255,255,0.1)" stroke-width="1"/>
                <path d="M600 140 L750 130 L780 180 L720 220 L650 210 L600 180 Z" 
                      fill="rgba(255,255,255,0.05)" stroke="rgba(255,255,255,0.1)" stroke-width="1"/>
                <path d="M100 250 L250 240 L280 280 L220 320 L150 310 L100 280 Z" 
                      fill="rgba(255,255,255,0.05)" stroke="rgba(255,255,255,0.1)" stroke-width="1"/>
                
                <!-- Conflict zones with better positioning -->
                <circle cx="250" cy="150" r="45" fill="url(#conflict-gradient-high)" 
                        class="conflict-zone" data-region="Europa Oriental" data-intensity="high" data-articles="25"/>
                <circle cx="450" cy="180" r="30" fill="url(#conflict-gradient-medium)" 
                        class="conflict-zone" data-region="Medio Oriente" data-intensity="medium" data-articles="18"/>
                <circle cx="650" cy="170" r="40" fill="url(#conflict-gradient-high)" 
                        class="conflict-zone" data-region="Asia Central" data-intensity="high" data-articles="32"/>
                <circle cx="180" cy="280" r="25" fill="url(#conflict-gradient-medium)" 
                        class="conflict-zone" data-region="√Åfrica Occidental" data-intensity="medium" data-articles="12"/>
                <circle cx="720" cy="250" r="50" fill="url(#conflict-gradient-high)" 
                        class="conflict-zone" data-region="Mar del Sur de China" data-intensity="high" data-articles="41"/>
                <circle cx="120" cy="350" r="20" fill="url(#conflict-gradient-medium)" 
                        class="conflict-zone" data-region="Am√©rica Central" data-intensity="medium" data-articles="8"/>
                <circle cx="350" cy="300" r="15" fill="url(#conflict-gradient-low)" 
                        class="conflict-zone" data-region="Norte de √Åfrica" data-intensity="low" data-articles="5"/>
                <circle cx="550" cy="280" r="22" fill="url(#conflict-gradient-medium)" 
                        class="conflict-zone" data-region="Asia Meridional" data-intensity="medium" data-articles="14"/>
                
                <!-- Labels for regions with better positioning -->
                <text x="250" y="210" text-anchor="middle" fill="#fff" font-size="11" font-weight="500" opacity="0.9">Europa Oriental</text>
                <text x="450" y="220" text-anchor="middle" fill="#fff" font-size="10" opacity="0.8">Medio Oriente</text>
                <text x="650" y="225" text-anchor="middle" fill="#fff" font-size="10" opacity="0.8">Asia Central</text>
                <text x="180" y="315" text-anchor="middle" fill="#fff" font-size="10" opacity="0.8">√Åfrica Occidental</text>
                <text x="720" y="310" text-anchor="middle" fill="#fff" font-size="10" opacity="0.8">Mar del Sur de China</text>
                <text x="120" y="380" text-anchor="middle" fill="#fff" font-size="9" opacity="0.8">Am√©rica Central</text>
                <text x="350" y="325" text-anchor="middle" fill="#fff" font-size="9" opacity="0.8">Norte de √Åfrica</text>
                <text x="550" y="310" text-anchor="middle" fill="#fff" font-size="9" opacity="0.8">Asia Meridional</text>
                
                <!-- Grid lines for reference (subtle) -->
                <defs>
                    <pattern id="grid" width="50" height="50" patternUnits="userSpaceOnUse">
                        <path d="M 50 0 L 0 0 0 50" fill="none" stroke="rgba(255,255,255,0.03)" stroke-width="1"/>
                    </pattern>
                </defs>
                <rect width="100%" height="100%" fill="url(#grid)"/>
            </svg>
        `;
        
        // Add enhanced interactivity to conflict zones
        const conflictZones = heatmapContainer.querySelectorAll('.conflict-zone');
        conflictZones.forEach(zone => {
            zone.style.cursor = 'pointer';
            zone.style.transition = 'all 0.3s ease';
            
            zone.addEventListener('mouseenter', function() {
                this.style.opacity = '1';
                this.style.transform = 'scale(1.15)';
                this.style.filter = 'drop-shadow(0 0 10px rgba(255,255,255,0.5))';
                
                // Show detailed tooltip
                const region = this.getAttribute('data-region');
                const intensity = this.getAttribute('data-intensity');
                const articles = this.getAttribute('data-articles');
                
                // Create or update tooltip
                let tooltip = document.getElementById('conflict-tooltip');
                if (!tooltip) {
                    tooltip = document.createElement('div');
                    tooltip.id = 'conflict-tooltip';
                    tooltip.style.cssText = `
                        position: absolute;
                        background: rgba(0,0,0,0.9);
                        color: white;
                        padding: 10px 15px;
                        border-radius: 8px;
                        font-size: 12px;
                        z-index: 1000;
                        pointer-events: none;
                        backdrop-filter: blur(10px);
                        border: 1px solid rgba(255,255,255,0.2);
                        box-shadow: 0 4px 15px rgba(0,0,0,0.5);
                    `;
                    document.body.appendChild(tooltip);
                }
                
                tooltip.innerHTML = `
                    <strong>${region}</strong><br>
                    Intensidad: <span style="color: ${intensity === 'high' ? '#ff4757' : intensity === 'medium' ? '#ffa726' : '#26c6da'}">${intensity.toUpperCase()}</span><br>
                    Art√≠culos: ${articles}
                `;
                tooltip.style.display = 'block';
                
                console.log(`üó∫Ô∏è Conflict zone: ${region} (${intensity} intensity, ${articles} articles)`);
            });
            
            zone.addEventListener('mouseleave', function() {
                this.style.opacity = '0.8';
                this.style.transform = 'scale(1)';
                this.style.filter = 'none';
                
                const tooltip = document.getElementById('conflict-tooltip');
                if (tooltip) {
                    tooltip.style.display = 'none';
                }
            });
            
            zone.addEventListener('mousemove', function(e) {
                const tooltip = document.getElementById('conflict-tooltip');
                if (tooltip && tooltip.style.display === 'block') {
                    tooltip.style.left = (e.pageX + 10) + 'px';
                    tooltip.style.top = (e.pageY - 10) + 'px';
                }
            });
            
            zone.addEventListener('click', function() {
                const region = this.getAttribute('data-region');
                console.log(`üéØ Clicked on conflict zone: ${region}`);
                // Aqu√≠ se podr√≠a abrir un modal con m√°s detalles
            });
        });
        
        // Auto-save GeoJSON data internally
        setTimeout(() => {
            saveGeoJSONInternally();
        }, 2000);
    }
}

// Fetch analytics data from API
function fetchAnalyticsData() {
    // Fetch conflict zones data
    fetch('/api/analytics/conflicts')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateConflictAnalytics(data.conflicts);
                updateAnalyticsStats(data.statistics);
                console.log('‚úÖ Analytics data updated from API');
            } else {
                console.warn('Analytics API failed, using mock data');
                updateAnalyticsWithMockData();
            }
        })
        .catch(error => {
            console.error('Error fetching analytics data:', error);
            updateAnalyticsWithMockData();
        });
    
    // Update last update timestamp
    document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
}

// Update analytics with conflict data
function updateConflictAnalytics(conflicts) {
    // Update stats
    const highRisk = conflicts.filter(c => c.risk_level === 'high').length;
    const mediumRisk = conflicts.filter(c => c.risk_level === 'medium').length;
    
    document.getElementById('high-risk-regions').textContent = highRisk;
    document.getElementById('medium-risk-regions').textContent = mediumRisk;
    
    // Update categories
    updateConflictCategories(conflicts);
    
    // Update prediction model
    updatePredictionModel(conflicts);
}

// Update analytics stats
function updateAnalyticsStats(stats) {
    if (stats) {
        document.getElementById('total-sources').textContent = stats.total_sources || 0;
        document.getElementById('active-sources').textContent = stats.active_sources || 0;
        document.getElementById('reliability-score').textContent = (stats.reliability_score || 0) + '%';
    }
}

// Update analytics with mock data (fallback)
function updateAnalyticsWithMockData() {
    // Mock statistics
    document.getElementById('high-risk-regions').textContent = Math.floor(Math.random() * 10) + 5;
    document.getElementById('medium-risk-regions').textContent = Math.floor(Math.random() * 15) + 10;
    document.getElementById('total-sources').textContent = Math.floor(Math.random() * 50) + 100;
    document.getElementById('active-sources').textContent = Math.floor(Math.random() * 30) + 50;
    document.getElementById('reliability-score').textContent = Math.floor(Math.random() * 20) + 75 + '%';
    
    // Mock categories
    const mockCategories = [
        { name: 'Territorial', count: Math.floor(Math.random() * 20) + 10 },
        { name: 'Econ√≥mico', count: Math.floor(Math.random() * 15) + 15 },
        { name: 'Pol√≠tico', count: Math.floor(Math.random() * 10) + 8 },
        { name: 'Religioso', count: Math.floor(Math.random() * 8) + 5 },
        { name: '√âtnico', count: Math.floor(Math.random() * 6) + 3 }
    ];
    
    updateConflictCategoriesDisplay(mockCategories);
    
    // Mock prediction
    const accuracy = Math.floor(Math.random() * 20) + 75;
    updatePredictionDisplay(accuracy);
}

// Update conflict categories display
function updateConflictCategories(conflicts) {
    const categories = {};
    conflicts.forEach(conflict => {
        const category = conflict.category || 'Otros';
        categories[category] = (categories[category] || 0) + 1;
    });
    
    const categoriesArray = Object.entries(categories).map(([name, count]) => ({ name, count }));
    updateConflictCategoriesDisplay(categoriesArray);
}

// Update conflict categories display
function updateConflictCategoriesDisplay(categories) {
    const container = document.getElementById('categories-list');
    if (container) {
        container.innerHTML = categories.map(cat => `
            <div class="category-item">
                <span class="category-name">${cat.name}</span>
                <span class="category-count">${cat.count}</span>
            </div>
        `).join('');
    }
}

// Update prediction model
function updatePredictionModel(conflicts) {
    const accuracy = Math.floor((conflicts.length / (conflicts.length + 5)) * 100);
    updatePredictionDisplay(accuracy);
}

// Update prediction display
function updatePredictionDisplay(accuracy) {
    const scoreElement = document.querySelector('.score-value');
    const circleElement = document.querySelector('.score-circle');
    
    if (scoreElement) {
        scoreElement.textContent = accuracy + '%';
    }
    
    if (circleElement) {
        circleElement.style.setProperty('--score-percentage', accuracy + '%');
    }
    
    // Update factors
    const factors = [
        { name: 'An√°lisis de Sentimientos', impact: 'Alto', color: '#f44336' },
        { name: 'Geolocalizaci√≥n', impact: 'Medio', color: '#ff9800' },
        { name: 'Tendencias Hist√≥ricas', impact: 'Alto', color: '#4caf50' },
        { name: 'Redes Sociales', impact: 'Medio', color: '#2196f3' }
    ];
    
    const factorsContainer = document.getElementById('factors-list');
    if (factorsContainer) {
        factorsContainer.innerHTML = factors.map(factor => `
            <div class="factor-item" style="--factor-color: ${factor.color};">
                <span class="factor-name">${factor.name}</span>
                <span class="factor-impact">${factor.impact}</span>
            </div>
        `).join('');
    }
}

// Update analytics based on timeframe
function updateAnalytics() {
    const timeframe = document.getElementById('timeframe-select').value;
    console.log(`üìä Updating analytics for timeframe: ${timeframe}`);
    
    // Re-fetch data with new timeframe
    fetchAnalyticsData();
}

// Toggle map layers
function toggleMapLayer(layer, buttonElement) {
    // Update button states
    document.querySelectorAll('.map-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    if (buttonElement) {
        buttonElement.classList.add('active');
    }
    
    // Update map display based on layer
    const conflictZones = document.querySelectorAll('.conflict-zone');
    conflictZones.forEach(zone => {
        const intensity = zone.getAttribute('data-intensity');
        if (layer === 'all' || layer === 'conflicts' || intensity === layer) {
            zone.style.display = 'block';
        } else {
            zone.style.display = 'none';
        }
    });
    
    console.log(`üó∫Ô∏è Map layer changed to: ${layer}`);
}

// Export GeoJSON data
function exportGeoJSON() {
    console.log('üì• Exporting GeoJSON data...');
    
    // Fetch GeoJSON data from API
    fetch('/api/analytics/geojson')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.geojson) {
                downloadGeoJSON(data.geojson, true); // true = user download
            } else {
                // Generate mock GeoJSON if API fails
                const mockGeoJSON = generateMockGeoJSON();
                downloadGeoJSON(mockGeoJSON, true);
            }
        })
        .catch(error => {
            console.error('Error exporting GeoJSON:', error);
            const mockGeoJSON = generateMockGeoJSON();
            downloadGeoJSON(mockGeoJSON, true);
        });
}

// Save GeoJSON internally for system use
function saveGeoJSONInternally() {
    console.log('üíæ Saving GeoJSON data internally...');
    
    fetch('/api/analytics/geojson')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.geojson) {
                // Store in localStorage for internal use
                localStorage.setItem('conflictZonesGeoJSON', JSON.stringify(data.geojson));
                localStorage.setItem('conflictZonesTimestamp', new Date().toISOString());
                
                // Also save to internal storage via API
                fetch('/api/analytics/save-geojson', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        geojson: data.geojson,
                        timestamp: new Date().toISOString()
                    })
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        document.getElementById('geojson-auto-status').textContent = 
                            `GeoJSON guardado autom√°ticamente (${new Date().toLocaleTimeString()})`;
                        console.log('‚úÖ GeoJSON saved internally successfully');
                    }
                })
                .catch(error => {
                    console.warn('Warning saving GeoJSON internally:', error);
                    document.getElementById('geojson-auto-status').textContent = 
                        'GeoJSON guardado localmente';
                });
            } else {
                // Save mock data internally
                const mockGeoJSON = generateMockGeoJSON();
                localStorage.setItem('conflictZonesGeoJSON', JSON.stringify(mockGeoJSON));
                localStorage.setItem('conflictZonesTimestamp', new Date().toISOString());
                document.getElementById('geojson-auto-status').textContent = 
                    'GeoJSON mock guardado localmente';
            }
        })
        .catch(error => {
            console.error('Error saving GeoJSON internally:', error);
            const mockGeoJSON = generateMockGeoJSON();
            localStorage.setItem('conflictZonesGeoJSON', JSON.stringify(mockGeoJSON));
            localStorage.setItem('conflictZonesTimestamp', new Date().toISOString());
            document.getElementById('geojson-auto-status').textContent = 
                'GeoJSON de respaldo guardado';
        });
}

// Generate mock GeoJSON for conflict zones
function generateMockGeoJSON() {
    return {
        "type": "FeatureCollection",
        "features": [
            {
                "type": "Feature",
                "properties": {
                    "name": "Europa Oriental",
                    "risk_level": "high",
                    "conflict_type": "territorial",
                    "intensity": 0.8,
                    "articles_count": 25
                },
                "geometry": {
                    "type": "Point",
                    "coordinates": [30.0, 50.0]
                }
            },
            {
                "type": "Feature",
                "properties": {
                    "name": "Medio Oriente",
                    "risk_level": "medium",
                    "conflict_type": "political",
                    "intensity": 0.6,
                    "articles_count": 18
                },
                "geometry": {
                    "type": "Point",
                    "coordinates": [45.0, 30.0]
                }
            },
            {
                "type": "Feature",
                "properties": {
                    "name": "Mar del Sur de China",
                    "risk_level": "high",
                    "conflict_type": "territorial",
                    "intensity": 0.9,
                    "articles_count": 32
                },
                "geometry": {
                    "type": "Point",
                    "coordinates": [115.0, 15.0]
                }
            }
        ]
    };
}

// Download GeoJSON file
function downloadGeoJSON(geoJsonData, isUserDownload = false) {
    const blob = new Blob([JSON.stringify(geoJsonData, null, 2)], {
        type: 'application/json'
    });
    
    if (isUserDownload) {
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `conflict_zones_${new Date().toISOString().split('T')[0]}.geojson`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        console.log('‚úÖ GeoJSON file downloaded successfully for user');
    } else {
        console.log('‚úÖ GeoJSON prepared for internal use');
    }
}

// Helper functions for chart data generation
function generateDateLabels(days) {
    const labels = [];
    for (let i = days - 1; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        labels.push(date.toLocaleDateString('es-ES', { month: 'short', day: 'numeric' }));
    }
    return labels;
}

function generateRandomData(length, min, max) {
    return Array.from({ length }, () => Math.floor(Math.random() * (max - min + 1)) + min);
}
</script>
{% endblock %}