<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Globo 3D - RISKMAP</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <!-- CSS personalizado -->
    <link href="{{ url_for('static', filename='css/earth3d.css') }}" rel="stylesheet">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/">
                <i class="fas fa-globe-americas me-2"></i>RISKMAP
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/"><i class="fas fa-home me-1"></i>Inicio</a>
                <a class="nav-link" href="/dashboard-unificado"><i class="fas fa-chart-line me-1"></i>Dashboard</a>
                <a class="nav-link active" href="/globo-3d"><i class="fas fa-globe me-1"></i>Globo 3D</a>
            </div>
        </div>
    </nav>

    <!-- Contenido principal -->
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="fas fa-globe me-2"></i>Globo 3D Interactivo</h2>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="resetView()">
                            <i class="fas fa-home me-1"></i>Inicio
                        </button>
                        <button type="button" class="btn btn-outline-success btn-sm" onclick="autoRotate()">
                            <i class="fas fa-play me-1"></i>Auto Rotar
                        </button>
                        <button type="button" class="btn btn-outline-info btn-sm" onclick="refreshEvents()">
                            <i class="fas fa-sync me-1"></i>Actualizar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <!-- Contenedor del globo 3D -->
                <div class="earth3d-container" id="earth3d-container">
                    <!-- Loading -->
                    <div class="earth3d-loading" id="earth3d-loading">
                        <div class="spinner-border" role="status"></div>
                        <p class="mt-2">Cargando globo 3D...</p>
                    </div>
                    
                    <!-- Controles -->
                    <div class="earth3d-controls">
                        <h6><i class="fas fa-cogs me-2"></i>Controles</h6>
                        <div class="btn-group-vertical btn-group-sm w-100">
                            <button class="btn btn-outline-light" onclick="zoomIn()">
                                <i class="fas fa-search-plus me-1"></i>Acercar
                            </button>
                            <button class="btn btn-outline-light" onclick="zoomOut()">
                                <i class="fas fa-search-minus me-1"></i>Alejar
                            </button>
                            <button class="btn btn-outline-light" onclick="toggleRotation()">
                                <i class="fas fa-sync-alt me-1"></i>Rotar
                            </button>
                        </div>
                    </div>
                    
                    <!-- Leyenda -->
                    <div class="event-marker-legend">
                        <h6><i class="fas fa-map-marker-alt me-2"></i>Leyenda</h6>
                        <div class="legend-item">
                            <div class="legend-color high"></div>
                            <span>Alto Riesgo (7-10)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color medium"></div>
                            <span>Medio Riesgo (4-6)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color low"></div>
                            <span>Bajo Riesgo (1-3)</span>
                        </div>
                    </div>
                    
                    <!-- Estadísticas -->
                    <div class="earth3d-stats">
                        <h6><i class="fas fa-chart-bar me-2"></i>Estadísticas</h6>
                        <div class="stat-item">
                            Eventos activos: <span class="stat-value" id="active-events">0</span>
                        </div>
                        <div class="stat-item">
                            Alto riesgo: <span class="stat-value" id="high-risk-events">0</span>
                        </div>
                        <div class="stat-item">
                            Última actualización: <span class="stat-value" id="last-update">--:--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Información adicional -->
        <div class="row mt-4">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-info-circle me-2"></i>Instrucciones</h5>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled">
                            <li><i class="fas fa-mouse me-2"></i>Click y arrastra para rotar</li>
                            <li><i class="fas fa-scroll me-2"></i>Scroll para zoom</li>
                            <li><i class="fas fa-hand-pointer me-2"></i>Click en eventos para detalles</li>
                            <li><i class="fas fa-keyboard me-2"></i>Teclas de flecha para navegar</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-filter me-2"></i>Filtros</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Tipo de Evento:</label>
                            <select class="form-select form-select-sm" id="event-type-filter">
                                <option value="all">Todos</option>
                                <option value="conflict">Conflictos</option>
                                <option value="climate">Clima</option>
                                <option value="political">Políticos</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Nivel de Riesgo:</label>
                            <select class="form-select form-select-sm" id="risk-level-filter">
                                <option value="all">Todos</option>
                                <option value="high">Alto (7-10)</option>
                                <option value="medium">Medio (4-6)</option>
                                <option value="low">Bajo (1-3)</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-clock me-2"></i>Tiempo Real</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <span>Estado del sistema:</span>
                            <span class="badge bg-success">Operativo</span>
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                            <span>Última sincronización:</span>
                            <span id="last-sync">Hace 2 min</span>
                        </div>
                        <button class="btn btn-primary btn-sm w-100 mt-3" onclick="forceRefresh()">
                            <i class="fas fa-sync me-1"></i>Forzar Actualización
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para detalles de eventos -->
    <div class="modal fade" id="eventModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="eventModalTitle">Detalles del Evento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="eventModalBody">
                    <!-- Contenido dinámico -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary">Ver en Dashboard</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/earth3d.js') }}"></script>
    
    <script>
        // Funciones de control global
        let autoRotateEnabled = false;
        
        function resetView() {
            if (window.earth3DViewer) {
                window.earth3DViewer.camera.position.set(0, 0, 2.5);
            }
        }
        
        function autoRotate() {
            autoRotateEnabled = !autoRotateEnabled;
            // Implementar auto rotación
        }
        
        function refreshEvents() {
            if (window.earth3DViewer) {
                window.earth3DViewer.loadGeopoliticalEvents();
            }
        }
        
        function zoomIn() {
            if (window.earth3DViewer && window.earth3DViewer.camera.position.length() > 1.5) {
                window.earth3DViewer.camera.position.multiplyScalar(0.9);
            }
        }
        
        function zoomOut() {
            if (window.earth3DViewer && window.earth3DViewer.camera.position.length() < 5) {
                window.earth3DViewer.camera.position.multiplyScalar(1.1);
            }
        }
        
        function toggleRotation() {
            autoRotate();
        }
        
        function forceRefresh() {
            location.reload();
        }
        
        // Ocultar loading cuando esté listo
        window.addEventListener('load', function() {
            setTimeout(() => {
                document.getElementById('earth3d-loading').style.display = 'none';
            }, 2000);
        });
        
        // Actualizar estadísticas
        function updateStats() {
            if (window.earth3DViewer && window.earth3DViewer.events) {
                const events = window.earth3DViewer.events;
                document.getElementById('active-events').textContent = events.length;
                document.getElementById('high-risk-events').textContent = 
                    events.filter(e => e.risk_level >= 7).length;
                document.getElementById('last-update').textContent = 
                    new Date().toLocaleTimeString();
            }
        }
        
        // Actualizar cada 30 segundos
        setInterval(updateStats, 30000);
    </script>
</body>
</html>