{% extends "base_navigation.html" %}

{% block title %}Alerta Temprana - Stratosight{% endblock %}

{% block extra_css %}
<style>
    .alerts-dashboard {
        padding: 30px;
        max-width: 1400px;
        margin: 0 auto;
    }
    
    .page-header {
        text-align: center;
        margin-bottom: 40px;
        color: #fff;
    }
    
    .page-title {
        font-family: 'Orbitron', monospace;
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 10px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .page-subtitle {
        font-size: 1.2rem;
        color: rgba(255, 255, 255, 0.7);
        margin-bottom: 30px;
    }
    
    .threat-level-banner {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 30px;
        text-align: center;
        box-shadow: 0 10px 30px rgba(239, 68, 68, 0.3);
        animation: pulse-glow 2s infinite;
    }
    
    @keyframes pulse-glow {
        0%, 100% { box-shadow: 0 10px 30px rgba(239, 68, 68, 0.3); }
        50% { box-shadow: 0 15px 40px rgba(239, 68, 68, 0.5); }
    }
    
    .threat-level-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #fff;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }
    
    .threat-level-value {
        font-size: 3rem;
        font-weight: 900;
        color: #fff;
        margin-bottom: 10px;
        font-family: 'Orbitron', monospace;
    }
    
    .threat-level-description {
        font-size: 1.1rem;
        color: rgba(255, 255, 255, 0.9);
    }
    
    .alerts-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding: 20px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        backdrop-filter: blur(10px);
    }
    
    .alerts-status {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #22c55e;
        animation: blink 1.5s infinite;
    }
    
    @keyframes blink {
        0%, 50% { opacity: 1; }
        51%, 100% { opacity: 0.3; }
    }
    
    .status-text {
        color: #fff;
        font-weight: 600;
    }
    
    .alerts-actions {
        display: flex;
        gap: 10px;
    }
    
    .btn-alert {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .btn-pause {
        background: rgba(245, 158, 11, 0.2);
        color: #f59e0b;
        border: 1px solid rgba(245, 158, 11, 0.3);
    }
    
    .btn-pause:hover {
        background: rgba(245, 158, 11, 0.3);
    }
    
    .btn-config {
        background: rgba(102, 126, 234, 0.2);
        color: #667eea;
        border: 1px solid rgba(102, 126, 234, 0.3);
    }
    
    .btn-config:hover {
        background: rgba(102, 126, 234, 0.3);
    }
    
    .alerts-grid {
        display: grid;
        grid-template-columns: 1fr 350px;
        gap: 30px;
        margin-bottom: 40px;
    }
    
    .alerts-feed {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 25px;
        backdrop-filter: blur(10px);
        max-height: 600px;
        overflow-y: auto;
    }
    
    .feed-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .feed-title {
        font-size: 1.3rem;
        font-weight: 600;
        color: #fff;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .feed-controls {
        display: flex;
        gap: 10px;
    }
    
    .btn-control {
        padding: 8px 16px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 6px;
        color: rgba(255, 255, 255, 0.8);
        text-decoration: none;
        font-size: 0.85rem;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .btn-control:hover {
        background: rgba(102, 126, 234, 0.2);
        border-color: rgba(102, 126, 234, 0.4);
        color: #fff;
    }
    
    .alert-item {
        padding: 20px;
        margin-bottom: 15px;
        border-radius: 8px;
        border-left: 4px solid;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .alert-item:hover {
        transform: translateX(5px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    
    .alert-critical {
        background: rgba(239, 68, 68, 0.1);
        border-left-color: #ef4444;
        border: 1px solid rgba(239, 68, 68, 0.2);
    }
    
    .alert-high {
        background: rgba(245, 158, 11, 0.1);
        border-left-color: #f59e0b;
        border: 1px solid rgba(245, 158, 11, 0.2);
    }
    
    .alert-medium {
        background: rgba(59, 130, 246, 0.1);
        border-left-color: #3b82f6;
        border: 1px solid rgba(59, 130, 246, 0.2);
    }
    
    .alert-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 10px;
    }
    
    .alert-title {
        font-weight: 600;
        color: #fff;
        font-size: 1rem;
    }
    
    .alert-time {
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.6);
    }
    
    .alert-description {
        color: rgba(255, 255, 255, 0.8);
        font-size: 0.9rem;
        line-height: 1.5;
        margin-bottom: 10px;
    }
    
    .alert-meta {
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 0.8rem;
    }
    
    .alert-location {
        color: rgba(255, 255, 255, 0.6);
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .alert-priority {
        padding: 4px 8px;
        border-radius: 4px;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.7rem;
    }
    
    .priority-critical {
        background: rgba(239, 68, 68, 0.2);
        color: #ef4444;
    }
    
    .priority-high {
        background: rgba(245, 158, 11, 0.2);
        color: #f59e0b;
    }
    
    .priority-medium {
        background: rgba(59, 130, 246, 0.2);
        color: #3b82f6;
    }
    
    .notifications-panel {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 25px;
        backdrop-filter: blur(10px);
    }
    
    .panel-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .panel-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #fff;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .notification-settings {
        margin-bottom: 30px;
    }
    
    .setting-group {
        margin-bottom: 20px;
    }
    
    .setting-label {
        color: #fff;
        font-weight: 600;
        margin-bottom: 10px;
        display: block;
    }
    
    .setting-options {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .setting-option {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .setting-option:hover {
        background: rgba(255, 255, 255, 0.08);
    }
    
    .setting-checkbox {
        width: 18px;
        height: 18px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 4px;
        position: relative;
        cursor: pointer;
    }
    
    .setting-checkbox.checked {
        background: #667eea;
        border-color: #667eea;
    }
    
    .setting-checkbox.checked::after {
        content: '✓';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #fff;
        font-size: 12px;
        font-weight: bold;
    }
    
    .setting-text {
        color: rgba(255, 255, 255, 0.8);
        font-size: 0.9rem;
    }
    
    .threat-indicators {
        grid-column: 1 / -1;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 25px;
        backdrop-filter: blur(10px);
    }
    
    .indicators-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
    }
    
    .indicator-card {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        transition: all 0.3s ease;
    }
    
    .indicator-card:hover {
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(102, 126, 234, 0.3);
    }
    
    .indicator-icon {
        width: 50px;
        height: 50px;
        margin: 0 auto 15px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.3rem;
        color: #fff;
    }
    
    .indicator-value {
        font-size: 2rem;
        font-weight: 700;
        color: #fff;
        margin-bottom: 5px;
        font-family: 'Orbitron', monospace;
    }
    
    .indicator-label {
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    @media (max-width: 768px) {
        .alerts-grid {
            grid-template-columns: 1fr;
        }
        
        .alerts-controls {
            flex-direction: column;
            gap: 15px;
        }
        
        .page-title {
            font-size: 2rem;
        }
        
        .alerts-dashboard {
            padding: 20px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="alerts-dashboard">
    <!-- Page Header -->
    <div class="page-header">
        <h1 class="page-title">🚨 Alertas Tempranas</h1>
        <p class="page-subtitle">
            Sistema de alertas en tiempo real con configuración de notificaciones y nivel de amenaza global
        </p>
    </div>
    
    <!-- Global Threat Level -->
    <div class="threat-level-banner">
        <div class="threat-level-title">
            <i class="fas fa-exclamation-triangle"></i>
            Nivel de Amenaza Global
        </div>
        <div class="threat-level-value">ALTO</div>
        <div class="threat-level-description">
            Múltiples conflictos activos con potencial de escalada. Monitoreo continuo requerido.
        </div>
    </div>
    
    <!-- Alerts Controls -->
    <div class="alerts-controls">
        <div class="alerts-status">
            <div class="status-indicator"></div>
            <span class="status-text">Sistema de Alertas Activo</span>
            <span style="color: rgba(255, 255, 255, 0.6);">| Última actualización: hace 2 minutos</span>
        </div>
        <div class="alerts-actions">
            <button class="btn-alert btn-pause">
                <i class="fas fa-pause"></i>
                Pausar Feed
            </button>
            <button class="btn-alert btn-config">
                <i class="fas fa-cog"></i>
                Configurar
            </button>
        </div>
    </div>
    
    <!-- Alerts Grid -->
    <div class="alerts-grid">
        <!-- Alerts Feed -->
        <div class="alerts-feed">
            <div class="feed-header">
                <h3 class="feed-title">
                    <i class="fas fa-stream"></i>
                    Feed de Alertas en Tiempo Real
                </h3>
                <div class="feed-controls">
                    <button class="btn-control" id="filterBtn">
                        <i class="fas fa-filter"></i> Filtrar
                    </button>
                    <button class="btn-control" id="exportBtn">
                        <i class="fas fa-download"></i> Exportar
                    </button>
                </div>
            </div>
            
            <div class="alerts-list" id="alertsList">
                <!-- Real alerts will be loaded here -->
                <div class="alert-item alert-medium">
                    <div class="alert-header">
                        <div class="alert-title">Cargando alertas en tiempo real...</div>
                        <div class="alert-time">--</div>
                    </div>
                    <div class="alert-description">
                        Conectando con el sistema de monitoreo para obtener las últimas alertas basadas en datos reales.
                    </div>
                    <div class="alert-meta">
                        <div class="alert-location">
                            <i class="fas fa-map-marker-alt"></i>
                            Sistema
                        </div>
                        <div class="alert-priority priority-medium">Cargando</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Notifications Panel -->
        <div class="notifications-panel">
            <div class="panel-header">
                <h3 class="panel-title">
                    <i class="fas fa-bell"></i>
                    Configuración de Notificaciones
                </h3>
            </div>
            
            <div class="notification-settings">
                <div class="setting-group">
                    <label class="setting-label">Canales de Notificación</label>
                    <div class="setting-options">
                        <div class="setting-option">
                            <div class="setting-checkbox checked"></div>
                            <div class="setting-text">Notificaciones Web</div>
                        </div>
                        <div class="setting-option">
                            <div class="setting-checkbox checked"></div>
                            <div class="setting-text">Email</div>
                        </div>
                        <div class="setting-option">
                            <div class="setting-checkbox"></div>
                            <div class="setting-text">SMS</div>
                        </div>
                        <div class="setting-option">
                            <div class="setting-checkbox"></div>
                            <div class="setting-text">Slack</div>
                        </div>
                    </div>
                </div>
                
                <div class="setting-group">
                    <label class="setting-label">Niveles de Prioridad</label>
                    <div class="setting-options">
                        <div class="setting-option">
                            <div class="setting-checkbox checked"></div>
                            <div class="setting-text">Crítico</div>
                        </div>
                        <div class="setting-option">
                            <div class="setting-checkbox checked"></div>
                            <div class="setting-text">Alto</div>
                        </div>
                        <div class="setting-option">
                            <div class="setting-checkbox"></div>
                            <div class="setting-text">Medio</div>
                        </div>
                        <div class="setting-option">
                            <div class="setting-checkbox"></div>
                            <div class="setting-text">Bajo</div>
                        </div>
                    </div>
                </div>
                
                <div class="setting-group">
                    <label class="setting-label">Regiones de Interés</label>
                    <div class="setting-options">
                        <div class="setting-option">
                            <div class="setting-checkbox checked"></div>
                            <div class="setting-text">Europa Oriental</div>
                        </div>
                        <div class="setting-option">
                            <div class="setting-checkbox checked"></div>
                            <div class="setting-text">Medio Oriente</div>
                        </div>
                        <div class="setting-option">
                            <div class="setting-checkbox"></div>
                            <div class="setting-text">Asia-Pacífico</div>
                        </div>
                        <div class="setting-option">
                            <div class="setting-checkbox"></div>
                            <div class="setting-text">África</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Threat Indicators -->
    <div class="threat-indicators">
        <div class="panel-header">
            <h3 class="panel-title">
                <i class="fas fa-chart-bar"></i>
                Indicadores de Amenaza
            </h3>
        </div>
        
        <div class="indicators-grid">
            <div class="indicator-card">
                <div class="indicator-icon">
                    <i class="fas fa-fire"></i>
                </div>
                <div class="indicator-value">24</div>
                <div class="indicator-label">Alertas Críticas (24h)</div>
            </div>
            
            <div class="indicator-card">
                <div class="indicator-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="indicator-value">2.3</div>
                <div class="indicator-label">Tiempo Respuesta (min)</div>
            </div>
            
            <div class="indicator-card">
                <div class="indicator-icon">
                    <i class="fas fa-eye"></i>
                </div>
                <div class="indicator-value">156</div>
                <div class="indicator-label">Eventos Monitoreados</div>
            </div>
            
            <div class="indicator-card">
                <div class="indicator-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <div class="indicator-value">94.2%</div>
                <div class="indicator-label">Precisión del Sistema</div>
            </div>
            
            <div class="indicator-card">
                <div class="indicator-icon">
                    <i class="fas fa-globe"></i>
                </div>
                <div class="indicator-value">45</div>
                <div class="indicator-label">Países Monitoreados</div>
            </div>
            
            <div class="indicator-card">
                <div class="indicator-icon">
                    <i class="fas fa-brain"></i>
                </div>
                <div class="indicator-value">8</div>
                <div class="indicator-label">Modelos IA Activos</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Alert system functionality
    let alertsActive = true;
    let alertsInterval;
    
    function initAlertSystem() {
        // Start real-time alerts simulation
        startAlertsSimulation();
        
        // Setup event listeners
        setupEventListeners();
        
        // Setup notification settings
        setupNotificationSettings();
    }
    
    function startAlertsSimulation() {
        // Load real alerts immediately
        loadRealAlerts();
        
        // Refresh alerts every 30 seconds
        alertsInterval = setInterval(() => {
            if (alertsActive) {
                loadRealAlerts();
            }
        }, 30000);
    }
    
    function loadRealAlerts() {
        fetch('/api/alerts/feed')
            .then(response => response.json())
            .then(alerts => {
                displayRealAlerts(alerts);
            })
            .catch(error => {
                console.error('Error loading real alerts:', error);
                // Fallback to show system message
                showSystemMessage('Error al cargar alertas en tiempo real. Reintentando...');
            });
    }
    
    function displayRealAlerts(alerts) {
        const alertsList = document.getElementById('alertsList');
        alertsList.innerHTML = ''; // Clear existing alerts
        
        if (alerts.length === 0) {
            showSystemMessage('No hay alertas de alto riesgo en las últimas 6 horas.');
            return;
        }
        
        alerts.forEach(alert => {
            const alertElement = createRealAlertElement(alert);
            alertsList.appendChild(alertElement);
        });
    }
    
    function createRealAlertElement(alert) {
        const div = document.createElement('div');
        const alertClass = `alert-${alert.priority}`;
        div.className = `alert-item ${alertClass}`;
        
        // Create entities display
        let entitiesDisplay = '';
        if (alert.entities && (alert.entities.persons.length > 0 || alert.entities.organizations.length > 0 || alert.entities.locations.length > 0)) {
            const allEntities = [
                ...alert.entities.persons,
                ...alert.entities.organizations,
                ...alert.entities.locations
            ].slice(0, 3); // Show max 3 entities
            
            if (allEntities.length > 0) {
                entitiesDisplay = `
                    <div class="fallback-indicator error">
                        <i class="fas fa-wifi"></i>
                        <span>API no disponible - Verificando conexión</span>
                    </div><div style="margin-top: 8px; font-size: 0.8rem; color: rgba(255,255,255,0.6);">
                    <i class="fas fa-tags"></i> ${allEntities.join(', ')}
                </div>`;
            }
        }
        
        div.innerHTML = `
            <div class="alert-header">
                <div class="alert-title">${alert.title}</div>
                <div class="alert-time">${alert.time}</div>
            </div>
            <div class="alert-description">
                ${alert.description}
                ${entitiesDisplay}
            </div>
            <div class="alert-meta">
                <div class="alert-location">
                    <i class="fas fa-map-marker-alt"></i>
                    ${alert.location}
                </div>
                <div class="alert-priority priority-${alert.priority}">
                    ${alert.priority === 'critical' ? 'Crítico' : alert.priority === 'high' ? 'Alto' : 'Medio'}
                </div>
            </div>
        `;
        
        // Add click handler for alert details
        div.addEventListener('click', () => {
            showAlertDetails(alert);
        });
        
        return div;
    }
    
    function showSystemMessage(message) {
        const alertsList = document.getElementById('alertsList');
        alertsList.innerHTML = `
            <div class="alert-item alert-medium">
                <div class="alert-header">
                    <div class="alert-title">Sistema de Alertas</div>
                    <div class="alert-time">ahora</div>
                </div>
                <div class="alert-description">
                    ${message}
                </div>
                <div class="alert-meta">
                    <div class="alert-location">
                        <i class="fas fa-info-circle"></i>
                        Sistema
                    </div>
                    <div class="alert-priority priority-medium">Info</div>
                </div>
            </div>
        `;
    }
    
    function showAlertDetails(alert) {
        // Create modal or detailed view for alert
        console.log('Alert details:', alert);
        
        // For now, show a simple alert with more details
        let entitiesText = '';
        if (alert.entities) {
            const allEntities = [
                ...alert.entities.persons.map(p => `👤 ${p}`),
                ...alert.entities.organizations.map(o => `🏢 ${o}`),
                ...alert.entities.locations.map(l => `📍 ${l}`)
            ];
            if (allEntities.length > 0) {
                entitiesText = `\n\nEntidades detectadas:\n${allEntities.join('\n')}`;
            }
        }
        
        alert(`ALERTA DETALLADA\n\n${alert.title}\n\nUbicación: ${alert.location}\nCategoría: ${alert.category}\nPrioridad: ${alert.priority}\nTiempo: ${alert.time}\n\nDescripción:\n${alert.description}${entitiesText}`);
    }
    
    function setupEventListeners() {
        // Pause/Resume button
        document.querySelector('.btn-pause').addEventListener('click', function() {
            alertsActive = !alertsActive;
            const icon = this.querySelector('i');
            const text = this.querySelector('span') || this.childNodes[1];
            
            if (alertsActive) {
                icon.className = 'fas fa-pause';
                this.innerHTML = '<i class="fas fa-pause"></i> Pausar Feed';
                document.querySelector('.status-indicator').style.animation = 'blink 1.5s infinite';
            } else {
                icon.className = 'fas fa-play';
                this.innerHTML = '<i class="fas fa-play"></i> Reanudar Feed';
                document.querySelector('.status-indicator').style.animation = 'none';
                document.querySelector('.status-indicator').style.opacity = '0.3';
            }
        });
        
        // Filter button
        document.getElementById('filterBtn').addEventListener('click', function() {
            const priority = prompt('Filtrar por prioridad (critical, high, medium) o dejar vacío para mostrar todas:');
            if (priority !== null) {
                filterAlerts(priority.toLowerCase());
            }
        });
        
        // Export button
        document.getElementById('exportBtn').addEventListener('click', function() {
            exportAlerts();
        });
        
        // Alert item clicks
        document.addEventListener('click', function(e) {
            const alertItem = e.target.closest('.alert-item');
            if (alertItem) {
                // Show alert details (could open modal)
                console.log('Alert clicked:', alertItem.querySelector('.alert-title').textContent);
            }
        });
    }
    
    function filterAlerts(priority) {
        const alertItems = document.querySelectorAll('.alert-item');
        alertItems.forEach(item => {
            if (!priority || priority === '' || item.classList.contains(`alert-${priority}`)) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    }
    
    function exportAlerts() {
        // Get current alerts data
        fetch('/api/alerts/feed')
            .then(response => response.json())
            .then(alerts => {
                if (alerts.length === 0) {
                    alert('No hay alertas para exportar.');
                    return;
                }
                
                // Create CSV content
                const csvContent = generateCSV(alerts);
                
                // Create and download file
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `alertas_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            })
            .catch(error => {
                console.error('Error exporting alerts:', error);
                alert('Error al exportar alertas.');
            });
    }
    
    function generateCSV(alerts) {
        const headers = ['ID', 'Título', 'Descripción', 'Ubicación', 'Prioridad', 'Categoría', 'Tiempo', 'Entidades'];
        const rows = alerts.map(alert => [
            alert.id,
            `"${alert.title.replace(/"/g, '""')}"`,
            `"${alert.description.replace(/"/g, '""')}"`,
            `"${alert.location}"`,
            alert.priority,
            `"${alert.category}"`,
            alert.time,
            `"${alert.entities ? Object.values(alert.entities).flat().join(', ') : ''}"`
        ]);
        
        return [headers.join(','), ...rows.map(row => row.join(','))].join('\n');
    }
    
    function setupNotificationSettings() {
        // Checkbox functionality
        document.querySelectorAll('.setting-checkbox').forEach(checkbox => {
            checkbox.addEventListener('click', function() {
                this.classList.toggle('checked');
                
                // Save settings (in real app, would save to backend)
                const settingText = this.nextElementSibling.textContent;
                const isChecked = this.classList.contains('checked');
                console.log(`Setting "${settingText}" ${isChecked ? 'enabled' : 'disabled'}`);
            });
        });
    }
    
    // Load alerts data
    function loadAlertsData() {
        // Load real-time alerts data from API
        fetch('/api/early-warning/real-alerts')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateAlertsStats(data.stats);
                } else {
                    console.error('Error loading alerts data:', data.error);
                    showLoadingAlertsStats();
                }
            })
            .catch(error => {
                console.error('Error fetching alerts data:', error);
                showLoadingAlertsStats();
            });
    }
    
    function updateAlertsStats(data) {
        // Update indicators with real data
        console.log('Updating alerts stats with:', data);
        
        // Update the indicator values
        const indicators = document.querySelectorAll('.indicator-value');
        if (indicators.length >= 6) {
            indicators[0].textContent = data.critical_alerts || 0;
            indicators[1].textContent = (data.avg_response_time || 0).toFixed(1) + ' min';
            indicators[2].textContent = data.monitored_events || 0;
            indicators[3].textContent = (data.system_accuracy || 0).toFixed(1) + '%';
            indicators[4].textContent = data.monitored_countries || 0;
            indicators[5].textContent = data.active_models || 0;
        }
    }
    
    function showLoadingAlertsStats() {
        const indicators = document.querySelectorAll('.indicator-value');
        indicators.forEach(indicator => {
            indicator.textContent = 'Cargando...
                    <div class="fallback-indicator warning">
                        <i class="fas fa-info-circle"></i>
                        <span>Si no hay datos, se mostrarán valores de demostración</span>
                    </div>';
        });
    }
            indicators[0].textContent = data.criticalAlerts || 0; // Critical alerts
            indicators[1].textContent = data.responseTime || '2.3'; // Response time
            indicators[2].textContent = data.monitoredEvents || 0; // Monitored events
            indicators[3].textContent = data.systemAccuracy ? `${data.systemAccuracy}%` : '94.2%'; // System accuracy
            indicators[4].textContent = data.monitoredCountries || 0; // Monitored countries
            indicators[5].textContent = data.activeModels || 8; // Active models
        }
        
        // Update threat level based on critical alerts
        const threatLevelValue = document.querySelector('.threat-level-value');
        const threatLevelDescription = document.querySelector('.threat-level-description');
        const threatLevelBanner = document.querySelector('.threat-level-banner');
        
        if (data.criticalAlerts > 20) {
            threatLevelValue.textContent = 'CRÍTICO';
            threatLevelDescription.textContent = 'Múltiples alertas críticas activas. Situación de máxima prioridad.';
            threatLevelBanner.style.background = 'linear-gradient(135deg, #dc2626 0%, #991b1b 100%)';
        } else if (data.criticalAlerts > 10) {
            threatLevelValue.textContent = 'ALTO';
            threatLevelDescription.textContent = 'Múltiples conflictos activos con potencial de escalada. Monitoreo continuo requerido.';
            threatLevelBanner.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
        } else if (data.criticalAlerts > 5) {
            threatLevelValue.textContent = 'MEDIO';
            threatLevelDescription.textContent = 'Situación estable con algunos eventos de riesgo. Monitoreo regular.';
            threatLevelBanner.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
        } else {
            threatLevelValue.textContent = 'BAJO';
            threatLevelDescription.textContent = 'Situación geopolítica estable. Monitoreo de rutina.';
            threatLevelBanner.style.background = 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)';
        }
    }
    
    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
    // Initialize fallback indicators for generic page
    if (window.FallbackManager) {
        window.FallbackManager.initializePageIndicators('generic');
    }
        initAlertSystem();
        loadAlertsData();
    });
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
        if (alertsInterval) {
            clearInterval(alertsInterval);
        }
    });
</script>
{% endblock %}