{% extends "base_navigation.html" %}

{% block title %}An√°lisis Satelital Avanzado - Stratosight{% endblock %}

{% block extra_css %}
<style>
    :root {
        --bg-primary: linear-gradient(180deg, #0a0f2c 0%, #1a2040 40%, #2a3558 80%, #3a4a70 100%);
        --bg-secondary: #141824;
        --bg-tertiary: #003566;
        --accent-cyan: #00d4ff;
        --accent-blue: #0077b6;
        --text-primary: #e8eaed;
        --text-secondary: #b0b8c4;
        --warning: #ffd60a;
        --danger: #dc2626;
        --success: #10b981;
        --border-color: rgba(255, 255, 255, 0.1);
        --accent-glow: 0 0 15px rgba(0, 212, 255, 0.4), 0 0 25px rgba(0, 212, 255, 0.2);
    }

    /* Header Section Styling */
    .header-section {
        width: 100vw;
        position: relative;
        left: 50%;
        right: 50%;
        margin-left: -50vw;
        margin-right: -50vw;
        top: -80px;
        margin-bottom: -80px;
        z-index: 0;
        background: linear-gradient(135deg, rgba(26, 32, 64, 0.75) 0%, rgba(16, 24, 48, 0.8) 50%, rgba(20, 28, 56, 0.75) 100%);
        backdrop-filter: blur(10px);
        box-shadow: 0 2px 20px rgba(0, 0, 0, 0.3);
        padding: 180px 0 80px 0;
        text-align: center;
    }

    .page-title {
        font-family: 'Orbitron', monospace;
        font-size: clamp(2rem, 6vw, 4rem);
        font-weight: 700;
        margin-bottom: 10px;
        background: linear-gradient(135deg, #00d4ff 0%, #00a3cc 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        line-height: 1.2;
    }

    .page-subtitle {
        font-size: 1.2rem;
        color: var(--text-secondary);
        margin-bottom: 30px;
    }

    .section-title {
        font-size: 1.3rem;
        font-weight: 600;
        color: #fff;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    /* Consistent heading sizes */
    h3.text-white {
        font-size: 1.3rem;
        font-weight: 600;
    }

    h4.text-white {
        font-size: 1.1rem;
        font-weight: 600;
    }

    /* Main container with proper margins for wide screens */
    .satellite-dashboard {
        background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 50%, var(--bg-tertiary) 100%);
        min-height: calc(100vh - 80px);
        padding: 40px 0;
        color: var(--text-primary);
        position: relative;
        z-index: 2;
    }

    .container-wide {
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 30px;
    }

    /* Page Header */
    .page-header {
        text-align: center;
        margin-bottom: 40px;
        padding: 40px 0;
        background: rgba(0, 13, 20, 0.6);
        border-radius: 20px;
        border: 1px solid var(--border-color);
        backdrop-filter: blur(10px);
    }

    .page-title {
        font-family: 'Orbitron', monospace;
        font-size: clamp(2rem, 6vw, 4rem);
        font-weight: 700;
        background: linear-gradient(135deg, var(--accent-cyan) 0%, var(--accent-blue) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 15px;
    }

    .page-subtitle {
        font-size: 1.2rem;
        color: var(--text-secondary);
        margin-bottom: 30px;
    }

    /* Grid Layout - Responsive */
    .analysis-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 30px;
        margin-bottom: 40px;
    }

    @media (min-width: 768px) {
        .analysis-grid {
            grid-template-columns: 1fr 1fr;
        }
    }

    @media (min-width: 1200px) {
        .analysis-grid {
            grid-template-columns: 2fr 1fr;
        }
    }

    /* Cards */
    .analysis-card {
        background: rgba(0, 13, 20, 0.4);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 25px;
        backdrop-filter: blur(10px);
        transition: all 0.3s ease;
    }

    .analysis-card:hover {
        border-color: var(--accent-cyan);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 212, 255, 0.1);
    }

    .card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--border-color);
    }

    .card-title {
        font-family: 'Orbitron', monospace;
        font-size: 1.3rem;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .card-icon {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, var(--accent-cyan) 0%, var(--accent-blue) 100%);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        color: white;
    }

    /* Control Panel */
    .control-panel {
        margin-bottom: 40px;
    }

    .btn-satellite {
        background: linear-gradient(135deg, var(--accent-cyan) 0%, var(--accent-blue) 100%);
        border: none;
        color: white;
        padding: 12px 24px;
        border-radius: 10px;
        font-weight: 600;
        font-size: 1rem;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .btn-satellite:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 212, 255, 0.3);
        color: white;
    }

    .btn-satellite:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    .btn-satellite-main {
        background: linear-gradient(135deg, var(--accent-cyan) 0%, var(--accent-blue) 100%);
        border: 3px solid var(--accent-cyan);
        color: white;
        padding: 25px 45px;
        border-radius: 15px;
        font-weight: 700;
        font-size: 1.2rem;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        min-width: 350px;
        text-align: center;
        position: relative;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0, 212, 255, 0.3);
    }

    .btn-satellite-main::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.6s;
    }

    .btn-satellite-main:hover::before {
        left: 100%;
    }

    .btn-satellite-main:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 40px rgba(0, 212, 255, 0.4);
        color: white;
        background: linear-gradient(135deg, #00b8e6 0%, #005f8a 100%);
        border-color: #00b8e6;
    }

    .btn-satellite-main .btn-text {
        font-size: 1.2rem;
        font-weight: 700;
        margin-bottom: 5px;
    }

    .btn-satellite-main .btn-subtitle {
        font-size: 0.9rem;
        opacity: 0.9;
        font-weight: 400;
        text-shadow: none;
    }

    .btn-satellite-main i {
        font-size: 1.8rem;
        margin-bottom: 8px;
    }

    .btn-satellite.btn-primary {
        background: linear-gradient(135deg, var(--accent-cyan) 0%, var(--accent-blue) 100%);
        border: 2px solid var(--accent-cyan);
        font-weight: 600;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }

    .btn-satellite.btn-primary:hover {
        background: linear-gradient(135deg, #00b8e6 0%, #005f8a 100%);
        border-color: #00b8e6;
        box-shadow: 0 8px 25px rgba(0, 212, 255, 0.4);
    }

    .btn-satellite.btn-mosaic {
        background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
        border: 2px solid #ff6b35;
        color: white;
        font-weight: 600;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }

    .btn-satellite.btn-mosaic:hover {
        background: linear-gradient(135deg, #ff8555 0%, #f9a541 100%);
        border-color: #ff8555;
        box-shadow: 0 8px 25px rgba(255, 107, 53, 0.4);
    }

    .btn-satellite.btn-ultra-hd {
        background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
        border: 2px solid #8b5cf6;
        color: white;
        font-weight: 600;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        position: relative;
        overflow: hidden;
    }

    .btn-satellite.btn-ultra-hd::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s;
    }

    .btn-satellite.btn-ultra-hd:hover::before {
        left: 100%;
    }

    .btn-satellite.btn-ultra-hd:hover {
        background: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%);
        border-color: #a78bfa;
        box-shadow: 0 8px 25px rgba(139, 92, 246, 0.4);
        transform: translateY(-2px);
    }

    /* Multi-API Ultra HD button */
    .btn-satellite.btn-multi-api {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        border: 2px solid #10b981;
        position: relative;
        overflow: hidden;
    }

    .btn-satellite.btn-multi-api::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s;
    }

    .btn-satellite.btn-multi-api:hover::before {
        left: 100%;
    }

    .btn-satellite.btn-multi-api:hover {
        background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
        border-color: #34d399;
        box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        transform: translateY(-2px);
    }

    /* Best Resolution button */
    .btn-satellite.btn-best-res {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        border: 2px solid #f59e0b;
        position: relative;
        overflow: hidden;
    }

    .btn-satellite.btn-best-res::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s;
    }

    .btn-satellite.btn-best-res:hover::before {
        left: 100%;
    }

    .btn-satellite.btn-best-res:hover {
        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        border-color: #fbbf24;
        box-shadow: 0 8px 25px rgba(245, 158, 11, 0.4);
        transform: translateY(-2px);
    }

    /* Commercial Satellites button */
    .btn-satellite.btn-commercial {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        border: 2px solid #ef4444;
        position: relative;
        overflow: hidden;
    }

    .btn-satellite.btn-commercial::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s;
    }

    .btn-satellite.btn-commercial:hover::before {
        left: 100%;
    }

    .btn-satellite.btn-commercial:hover {
        background: linear-gradient(135deg, #f87171 0%, #ef4444 100%);
        border-color: #f87171;
        box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
        transform: translateY(-2px);
    }

    /* Google Earth Engine buttons */
    .btn-satellite.btn-gee {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        border: 2px solid #10b981;
        color: white;
        font-weight: 600;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        position: relative;
        overflow: hidden;
    }

    .btn-satellite.btn-gee::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s;
    }

    .btn-satellite.btn-gee:hover::before {
        left: 100%;
    }

    .btn-satellite.btn-gee:hover {
        background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
        border-color: #34d399;
        box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        transform: translateY(-2px);
    }

    .btn-satellite.btn-gee-batch {
        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        border: 2px solid #8b5cf6;
        color: white;
        font-weight: 600;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        position: relative;
        overflow: hidden;
    }

    .btn-satellite.btn-gee-batch::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s;
    }

    .btn-satellite.btn-gee-batch:hover::before {
        left: 100%;
    }

    .btn-satellite.btn-gee-batch:hover {
        background: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%);
        border-color: #a78bfa;
        box-shadow: 0 8px 25px rgba(139, 92, 246, 0.4);
        transform: translateY(-2px);
    }

    .btn-satellite.btn-gee-mosaic {
        background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
        border: 2px solid #f97316;
        color: white;
        font-weight: 600;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        position: relative;
        overflow: hidden;
    }

    .btn-satellite.btn-gee-mosaic::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s;
    }

    .btn-satellite.btn-gee-mosaic:hover::before {
        left: 100%;
    }

    .btn-satellite.btn-gee-mosaic:hover {
        background: linear-gradient(135deg, #fb923c 0%, #f97316 100%);
        border-color: #fb923c;
        box-shadow: 0 8px 25px rgba(249, 115, 22, 0.4);
        transform: translateY(-2px);
    }

    /* Statistics Cards */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
    }

    .stat-card {
        background: rgba(0, 13, 20, 0.6);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        transition: all 0.3s ease;
    }

    .stat-card:hover {
        border-color: var(--accent-cyan);
    }

    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--accent-cyan);
        margin-bottom: 5px;
        font-family: 'Orbitron', monospace;
    }

    .stat-label {
        color: var(--text-secondary);
        font-size: 0.9rem;
        font-weight: 500;
    }

    /* Gallery */
    .gallery-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
    }

    .gallery-item {
        background: rgba(0, 13, 20, 0.6);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .gallery-item:hover {
        border-color: var(--accent-cyan);
        transform: translateY(-2px);
    }

    .gallery-image {
        width: 100%;
        height: 200px;
        object-fit: cover;
        border-bottom: 1px solid var(--border-color);
    }

    .gallery-info {
        padding: 15px;
    }

    .gallery-title {
        font-weight: 600;
        margin-bottom: 8px;
        color: var(--text-primary);
    }

    .gallery-meta {
        font-size: 0.85rem;
        color: var(--text-secondary);
    }

    /* Destacar mosaico Gaza */
    .mosaic-highlight {
        border: 3px solid #ff6b35;
        background: linear-gradient(135deg, rgba(255, 107, 53, 0.1), rgba(255, 107, 53, 0.05));
        transform: scale(1.02);
        box-shadow: 0 8px 25px rgba(255, 107, 53, 0.3);
    }

    .mosaic-highlight .gallery-title {
        color: #ff6b35;
        font-weight: 700;
        font-size: 1.1em;
    }

    .mosaic-highlight::before {
        content: "‚≠ê";
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 20px;
        z-index: 10;
    }

    /* Detection Gallery Styles */
    .detection-highlight {
        border: 2px solid #8b5cf6;
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(139, 92, 246, 0.05));
    }

    .detection-highlight:hover {
        border-color: #a78bfa;
        box-shadow: 0 8px 25px rgba(139, 92, 246, 0.3);
    }

    .threat-badge {
        position: absolute;
        top: 8px;
        left: 8px;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        z-index: 10;
    }

    .threat-critical { background: #dc2626; color: white; }
    .threat-high { background: #ea580c; color: white; }
    .threat-medium { background: #d97706; color: white; }
    .threat-low { background: #16a34a; color: white; }
    .threat-unknown { background: #6b7280; color: white; }

    .detection-count {
        position: absolute;
        top: 8px;
        right: 8px;
        background: rgba(139, 92, 246, 0.9);
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        z-index: 10;
    }

    .detection-summary {
        display: flex;
        gap: 8px;
        margin-bottom: 8px;
    }

    .military-count, .civilian-count, .infrastructure-count {
        background: rgba(255, 255, 255, 0.1);
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.75rem;
    }

    .military-count { color: #ff6b6b; }
    .civilian-count { color: #4ecdc4; }
    .infrastructure-count { color: #45b7d1; }

    .capture-time, .confidence-level {
        font-size: 0.75rem;
        color: var(--text-secondary);
        margin-bottom: 4px;
    }

    .no-images, .error-message {
        text-align: center;
        padding: 40px 20px;
        color: var(--text-secondary);
    }

    .no-images i, .error-message i {
        font-size: 3rem;
        margin-bottom: 15px;
        color: var(--accent-cyan);
    }

    /* Progress Bar */
    .progress-container {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 20px;
        margin: 20px 0;
        display: none;
    }

    .progress-bar-custom {
        width: 100%;
        height: 8px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 10px;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--accent-cyan) 0%, var(--accent-blue) 100%);
        border-radius: 4px;
        transition: width 0.3s ease;
        width: 0%;
    }

    .progress-text {
        color: var(--text-secondary);
        font-size: 0.9rem;
        text-align: center;
    }

    /* Badges */
    .badge {
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .badge.bg-danger {
        background-color: var(--danger) !important;
    }

    .badge.bg-warning {
        background-color: var(--warning) !important;
        color: #000 !important;
    }

    .badge.bg-success {
        background-color: var(--success) !important;
    }

    /* Timeline */
    .timeline {
        position: relative;
        padding-left: 30px;
    }

    .timeline::before {
        content: '';
        position: absolute;
        left: 15px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: var(--accent-cyan);
    }

    .timeline-item {
        position: relative;
        margin-bottom: 25px;
        padding-left: 25px;
    }

    .timeline-item::before {
        content: '';
        position: absolute;
        left: -6px;
        top: 5px;
        width: 12px;
        height: 12px;
        background: var(--accent-cyan);
        border-radius: 50%;
    }

    .timeline-date {
        font-size: 0.8rem;
        color: var(--text-secondary);
        margin-bottom: 5px;
    }

    .timeline-content {
        color: var(--text-primary);
        font-size: 0.9rem;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .container-wide {
            padding: 0 20px;
        }
        
        .page-title {
            font-size: 2rem;
        }
        
        .analysis-grid {
            grid-template-columns: 1fr;
        }
        
        .stats-grid {
            grid-template-columns: 1fr;
        }
        
        .gallery-grid {
            grid-template-columns: 1fr;
        }
    }

    /* Loading states */
    .loading {
        text-align: center;
        padding: 40px;
        color: var(--text-secondary);
    }

    .spinner {
        display: inline-block;
        width: 40px;
        height: 40px;
        border: 3px solid rgba(0, 212, 255, 0.3);
        border-radius: 50%;
        border-top-color: var(--accent-cyan);
        animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<!-- Header Section -->
<div class="header-section">
    <h1 class="page-title">üõ∞Ô∏è An√°lisis Satelital Avanzado</h1>
    <p class="page-subtitle">Monitoreo en Tiempo Real ‚Ä¢ Im√°genes de Alta Resoluci√≥n ‚Ä¢ Detecci√≥n de Eventos Cr√≠ticos</p>
</div>

<div class="satellite-dashboard">
    <div class="container-wide">
        <!-- Control Panel -->
        <div class="analysis-card control-panel">
            <div class="card-header">
                <h3 class="card-title">
                    <div class="card-icon">
                        <i class="fas fa-play"></i>
                    </div>
                    Panel de Control
                </h3>
            </div>
            <div class="d-flex justify-content-center" style="padding: 40px 0;">
                <button id="startComprehensiveAnalysis" class="btn-satellite-main">
                    <i class="fas fa-satellite-dish"></i>
                    <span class="btn-text">Iniciar An√°lisis Satelital Completo</span>
                    <small class="btn-subtitle">Sentinel Hub + Google Earth Engine + IA</small>
                </button>
            </div>
            
            <!-- Progress Bar -->
            <div id="progressContainer" class="progress-container">
                <div class="progress-bar-custom">
                    <div id="progressFill" class="progress-fill"></div>
                </div>
                <div id="progressText" class="progress-text">Iniciando an√°lisis...</div>
            </div>
        </div>

        <!-- Main Analysis Grid -->
        <div class="analysis-grid">
            <!-- Statistics Section -->
            <div class="analysis-card">
                <div class="card-header">
                    <h3 class="card-title">
                        <div class="card-icon">
                            <i class="fas fa-chart-bar"></i>
                        </div>
                        Estad√≠sticas de An√°lisis
                    </h3>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div id="totalImages" class="stat-value">-</div>
                        <div class="stat-label">Im√°genes Analizadas</div>
                    </div>
                    <div class="stat-card">
                        <div id="detectionsCount" class="stat-value">-</div>
                        <div class="stat-label">Detecciones Cr√≠ticas</div>
                    </div>
                    <div class="stat-card">
                        <div id="regionsCount" class="stat-value">-</div>
                        <div class="stat-label">Regiones Monitoreadas</div>
                    </div>
                    <div class="stat-card">
                        <div id="lastUpdate" class="stat-value">-</div>
                        <div class="stat-label">√öltima Actualizaci√≥n</div>
                    </div>
                </div>
            </div>

            <!-- Critical Alerts -->
            <div class="analysis-card">
                <div class="card-header">
                    <h3 class="card-title">
                        <div class="card-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        Alertas Cr√≠ticas
                    </h3>
                </div>
                <div id="criticalAlerts" class="loading">
                    <div class="spinner"></div>
                    <p>Cargando alertas cr√≠ticas...</p>
                </div>
            </div>
        </div>

        <!-- Gallery Section -->
        <div class="analysis-card">
            <div class="card-header">
                <h3 class="card-title">
                    <div class="card-icon">
                        <i class="fas fa-images"></i>
                    </div>
                    Galer√≠a de Im√°genes Satelitales (<span id="imageCount">0</span>)
                </h3>
            </div>
            <div id="galleryImages" class="gallery-grid loading">
                <div class="spinner"></div>
                <p>Cargando galer√≠a de im√°genes...</p>
            </div>
        </div>

        <!-- Ultra HD Detection Gallery Section -->
        <div class="analysis-card">
            <div class="card-header">
                <h3 class="card-title">
                    <div class="card-icon">
                        <i class="fas fa-eye"></i>
                    </div>
                    Galer√≠a Ultra HD - Solo Detecciones
                </h3>
                <p class="text-secondary small mt-1">Im√°genes con objetos detectados por an√°lisis YOLO</p>
            </div>
            <div id="galleryDetections" class="gallery-grid loading">
                <div class="spinner"></div>
                <p>Cargando galer√≠a de detecciones...</p>
            </div>
        </div>

        <!-- Timeline and Predictions Grid -->
        <div class="analysis-grid">
            <!-- Analysis Timeline -->
            <div class="analysis-card">
                <div class="card-header">
                    <h3 class="card-title">
                        <div class="card-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        Cronolog√≠a de Eventos
                    </h3>
                </div>
                <div id="analysisTimeline" class="timeline loading">
                    <div class="spinner"></div>
                    <p>Cargando cronolog√≠a...</p>
                </div>
            </div>

            <!-- Evolution Predictions -->
            <div class="analysis-card">
                <div class="card-header">
                    <h3 class="card-title">
                        <div class="card-icon">
                            <i class="fas fa-brain"></i>
                        </div>
                        Predicciones de Evoluci√≥n
                    </h3>
                </div>
                <div id="evolutionPredictions" class="loading">
                    <div class="spinner"></div>
                    <p>Cargando predicciones...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Image Details -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color);">
            <div class="modal-header" style="border-bottom: 1px solid var(--border-color);">
                <h5 class="modal-title" id="imageModalLabel">Detalles de la Imagen Satelital</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <img id="modalImage" src="" alt="Imagen satelital" style="width: 100%; border-radius: 8px; margin-bottom: 15px;">
                <div id="modalDetails">
                    <p><strong>Regi√≥n:</strong> <span id="modalRegion">-</span></p>
                    <p><strong>Fecha:</strong> <span id="modalDate">-</span></p>
                    <p><strong>Coordenadas:</strong> <span id="modalCoords">-</span></p>
                    <p><strong>Detecciones:</strong> <span id="modalDetections">-</span></p>
                </div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid var(--border-color);">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary">Generar Reporte</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block dashboard_js %}
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
class SatelliteAnalysisManager {
    constructor() {
        this.analysisId = null;
        this.pollInterval = null;
        this.progressInterval = null;
        this.initialize();
    }

    initialize() {
        console.log('Initializing Satellite Analysis Manager...');
        this.bindEvents();
        this.loadInitialData();
    }

    bindEvents() {
        // Comprehensive Analysis Button
        document.getElementById('startComprehensiveAnalysis').addEventListener('click', () => {
            this.startComprehensiveAnalysis();
        });
    }

    async loadInitialData() {
        console.log('Loading initial data...');
        await Promise.all([
            this.loadStatistics(),
            this.loadCriticalAlerts(),
            this.loadGallery(),
            this.loadDetectionGallery(),
            this.loadTimeline(),
            this.loadPredictions()
        ]);
    }

    async startAnalysis() {
        const triggerBtn = document.getElementById('triggerAnalysis');
        const progressContainer = document.getElementById('progressContainer');
        
        try {
            triggerBtn.disabled = true;
            triggerBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Iniciando...';
            
            const response = await fetch('/api/satellite/trigger-analysis', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            
            if (data.success) {
                this.analysisId = data.analysis_id;
                progressContainer.style.display = 'block';
                this.startProgressPolling();
            } else {
                throw new Error(data.message || 'Error al iniciar an√°lisis');
            }
            
        } catch (error) {
            console.error('Error starting analysis:', error);
            this.showError('Error al iniciar an√°lisis satelital: ' + error.message);
        } finally {
            triggerBtn.disabled = false;
            triggerBtn.innerHTML = '<i class="fas fa-rocket"></i> Iniciar An√°lisis Satelital';
        }
    }

    async startComprehensiveAnalysis() {
        const analysisBtn = document.getElementById('startComprehensiveAnalysis');
        const progressContainer = document.getElementById('progressContainer');
        
        try {
            analysisBtn.disabled = true;
            analysisBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span class="btn-text">Ejecutando An√°lisis...</span><small class="btn-subtitle">Procesando datos en tiempo real</small>';
            
            // Show progress container
            progressContainer.style.display = 'block';
            this.updateProgress(0, 'Iniciando an√°lisis satelital completo...');

            // Step 1: Get conflict zones from integrated pipeline
            this.updateProgress(10, 'Obteniendo zonas de conflicto del pipeline integrado...');
            const conflictsResponse = await fetch('/api/analytics/conflicts?timeframe=7d&predictions=true');
            
            if (!conflictsResponse.ok) {
                throw new Error(`Error obteniendo zonas de conflicto: ${conflictsResponse.status}`);
            }
            
            const conflictsData = await conflictsResponse.json();
            
            if (!conflictsData.success) {
                throw new Error(conflictsData.error || 'Error en datos de conflictos');
            }

            this.updateProgress(20, `${conflictsData.satellite_zones.length} zonas detectadas, iniciando an√°lisis satelital...`);

            // Step 2: Execute comprehensive satellite analysis
            const analysisResponse = await fetch('/api/satellite/comprehensive-analysis', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    satellite_zones: conflictsData.satellite_zones,
                    max_zoom: true, // Maximum resolution
                    use_sentinel_hub: true,
                    use_google_earth: true,
                    ai_analysis: true,
                    gaza_focus: true, // Special focus on Gaza strip
                    cloud_coverage_max: 10, // Very low cloud coverage for better quality
                    resolution_priority: 'ultra_high' // 0.5m resolution when possible
                })
            });

            if (!analysisResponse.ok) {
                throw new Error(`Error en an√°lisis satelital: ${analysisResponse.status}`);
            }

            const analysisData = await analysisResponse.json();
            
            if (analysisData.success) {
                this.updateProgress(50, 'Procesando im√°genes con m√°xima resoluci√≥n...');
                
                // Monitor progress if the backend provides it
                if (analysisData.job_id) {
                    await this.monitorAnalysisProgress(analysisData.job_id);
                } else {
                    // Simulate progress for immediate results
                    setTimeout(() => {
                        this.updateProgress(75, 'Aplicando an√°lisis de IA...');
                        setTimeout(() => {
                            this.updateProgress(100, `An√°lisis completado: ${analysisData.images_processed || 0} im√°genes procesadas`);
                            
                            const message = analysisData.fallback_mode ? 
                                `‚úÖ An√°lisis satelital completado con datos de demostraci√≥n. ${analysisData.images_processed || 0} im√°genes de alta resoluci√≥n procesadas.` :
                                `‚úÖ An√°lisis satelital completo exitoso. ${analysisData.images_processed || 0} im√°genes en tiempo real procesadas con IA.`;
                            
                            this.showSuccess(message);
                            
                            // Hide progress and refresh
                            setTimeout(() => {
                                progressContainer.style.display = 'none';
                                this.loadGallery();
                                this.loadStatistics();
                                this.loadDetectionGallery();
                            }, 3000);
                            
                        }, 1500);
                    }, 1500);
                }
                
            } else {
                throw new Error(analysisData.error || 'Error en an√°lisis satelital completo');
            }
            
        } catch (error) {
            console.error('Error in comprehensive analysis:', error);
            this.showError('Error en an√°lisis satelital: ' + error.message);
            progressContainer.style.display = 'none';
        } finally {
            analysisBtn.disabled = false;
            analysisBtn.innerHTML = '<i class="fas fa-satellite-dish"></i><span class="btn-text">Iniciar An√°lisis Satelital Completo</span><small class="btn-subtitle">Sentinel Hub + Google Earth Engine + IA</small>';
        }
    }

    async monitorAnalysisProgress(jobId) {
        const maxAttempts = 30; // Maximum 5 minutes
        let attempts = 0;
        
        const checkProgress = async () => {
            try {
                const response = await fetch(`/api/satellite/progress/${jobId}`);
                const data = await response.json();
                
                if (data.status === 'completed') {
                    this.updateProgress(100, `An√°lisis completado: ${data.images_processed} im√°genes procesadas`);
                    return true;
                } else if (data.status === 'error') {
                    throw new Error(data.error);
                } else if (data.status === 'processing') {
                    const progress = Math.min(50 + (data.progress || 0) * 0.5, 95);
                    this.updateProgress(progress, data.message || 'Procesando im√°genes...');
                }
                
                return false;
            } catch (error) {
                console.error('Error checking progress:', error);
                return false;
            }
        };
        
        while (attempts < maxAttempts) {
            const completed = await checkProgress();
            if (completed) break;
            
            await new Promise(resolve => setTimeout(resolve, 10000)); // Wait 10 seconds
            attempts++;
        }
    }

    async generateGazaMosaic() {
        const mosaicBtn = document.getElementById('generateGazaMosaic');
        const progressContainer = document.getElementById('progressContainer');
        
        try {
            mosaicBtn.disabled = true;
            mosaicBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generando Mosaico HR...';
            
            // Show progress container
            progressContainer.style.display = 'block';
            this.updateProgress(0, 'Iniciando generaci√≥n de mosaico de alta resoluci√≥n...');

            const response = await fetch('/api/satellite/generate-gaza-mosaic', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            
            if (data.success) {
                this.updateProgress(25, 'Dividiendo Gaza en sectores...');
                
                // Simulate progress for user feedback
                setTimeout(() => {
                    this.updateProgress(50, 'Obteniendo im√°genes Sentinel-2...');
                }, 1000);
                
                setTimeout(() => {
                    this.updateProgress(75, 'Ensamblando mosaico...');
                }, 2000);
                
                setTimeout(() => {
                    this.updateProgress(100, `Mosaico generado: ${data.dimensions} (${data.file_size_mb?.toFixed(1)} MB)`);
                    
                    // Show success message with details
                    const message = `‚úÖ Mosaico de Gaza generado exitosamente!\n` +
                                  `üìè Dimensiones: ${data.dimensions}\n` +
                                  `üó∫Ô∏è Cobertura: ${data.coverage_area}\n` +
                                  `üîç Resoluci√≥n: ${data.resolution}\n` +
                                  `üìÅ Tama√±o: ${data.file_size_mb?.toFixed(1)} MB`;
                    
                    this.showSuccess(message);
                    
                    // Hide progress after delay and refresh data
                    setTimeout(() => {
                        progressContainer.style.display = 'none';
                        this.loadGallery(); // Refresh gallery to show new mosaic
                        this.loadStatistics(); // Update statistics
                    }, 4000);
                    
                }, 3000);
                
            } else {
                throw new Error(data.error || 'Error generando mosaico de Gaza');
            }
            
        } catch (error) {
            console.error('Error generating Gaza mosaic:', error);
            this.showError('Error generando mosaico de Gaza: ' + error.message);
            progressContainer.style.display = 'none';
        } finally {
            mosaicBtn.disabled = false;
            mosaicBtn.innerHTML = '<i class="fas fa-map"></i> Generar Mosaico Gaza HR';
        }
    }

    async runUltraHdAnalysis() {
        const ultraBtn = document.getElementById('ultraHdAnalysis');
        const progressContainer = document.getElementById('progressContainer');
        
        try {
            ultraBtn.disabled = true;
            ultraBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> An√°lisis Ultra HD en curso...';
            
            // Show progress container
            progressContainer.style.display = 'block';
            this.updateProgress(0, 'Iniciando an√°lisis Ultra HD con YOLO...');

            const response = await fetch('/api/satellite/ultra-hd/auto-execute', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            
            if (data.success) {
                this.updateProgress(20, 'Autenticando con SentinelHub...');
                
                setTimeout(() => {
                    this.updateProgress(40, 'Descargando im√°genes de m√°xima resoluci√≥n...');
                }, 1000);
                
                setTimeout(() => {
                    this.updateProgress(65, 'Ejecutando an√°lisis YOLO...');
                }, 2500);
                
                setTimeout(() => {
                    this.updateProgress(85, 'Procesando detecciones...');
                }, 4000);
                
                setTimeout(() => {
                    this.updateProgress(100, `An√°lisis completado: ${data.zones_processed} zonas procesadas`);
                    
                    // Show detailed success message
                    const stats = data.statistics || {};
                    const predictions = data.predictions || {};
                    
                    const message = `üéØ An√°lisis Ultra HD completado!\n\n` +
                                  `üì° Zonas procesadas: ${data.zones_processed}\n` +
                                  `üîç Total detecciones: ${stats.total_objects_detected || 0}\n` +
                                  `ü™ñ Objetos militares: ${stats.military_objects_total || 0}\n` +
                                  `üèòÔ∏è Objetos civiles: ${stats.civilian_objects_total || 0}\n` +
                                  `üèóÔ∏è Infraestructura: ${stats.infrastructure_total || 0}\n` +
                                  `‚ö†Ô∏è Nivel de amenaza: ${stats.overall_threat_level || 'BAJO'}\n` +
                                  `üìà Tendencia militar: ${predictions.military_activity_trend || 'ESTABLE'}`;
                    
                    this.showSuccess(message);
                    
                    // Hide progress after delay and refresh data
                    setTimeout(() => {
                        progressContainer.style.display = 'none';
                        this.loadAllGalleries(); // Load both galleries
                        this.loadUltraHdStatistics(); // Load Ultra HD statistics
                        this.loadUltraHdPredictions(); // Load Ultra HD predictions
                    }, 5000);
                    
                }, 5500);
                
            } else {
                throw new Error(data.error || 'Error en an√°lisis Ultra HD');
            }
            
        } catch (error) {
            console.error('Error running Ultra HD analysis:', error);
            this.showError('Error en an√°lisis Ultra HD: ' + error.message);
            progressContainer.style.display = 'none';
        } finally {
            ultraBtn.disabled = false;
            ultraBtn.innerHTML = '<i class="fas fa-eye"></i> An√°lisis Ultra HD + YOLO';
        }
    }

    async startMultiApiUltraHd() {
        const btn = document.getElementById('multiApiUltraHd');
        const progressContainer = document.getElementById('progressContainer');
        
        try {
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ejecutando Multi-API Ultra HD...';
            
            // Show progress container
            progressContainer.style.display = 'block';
            this.updateProgress(0, 'Iniciando an√°lisis Multi-API Ultra HD (0.5m)...');

            const response = await fetch('/api/satellite/ultra-hd/auto-execute', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    target_resolution_m: 0.5,  // Objetivo: 50cm por pixel
                    max_zones: 15
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            
            if (data.success) {
                this.updateProgress(25, 'Conectando a m√∫ltiples APIs satelitales...');
                
                setTimeout(() => {
                    this.updateProgress(50, 'Procesando im√°genes SentinelHub y Google Earth Engine...');
                    
                    setTimeout(() => {
                        this.updateProgress(75, 'Obteniendo im√°genes de WorldView/SPOT...');
                        
                        setTimeout(() => {
                            this.updateProgress(100, 'An√°lisis Multi-API completado!');
                            
                            // Show success message with detailed statistics
                            const summary = data.analysis_summary;
                            const message = `üõ∞Ô∏è An√°lisis Multi-API Ultra HD completado!\n\n` +
                                          `üìä Zonas procesadas: ${summary.total_zones_processed}/${summary.total_zones_requested}\n` +
                                          `üîç Ultra HD (‚â§1m): ${summary.ultra_hd_zones} zonas\n` +
                                          `üì∑ Alta resoluci√≥n (‚â§2m): ${summary.high_resolution_zones} zonas\n` +
                                          `üéØ Resoluci√≥n objetivo: ${summary.target_resolution_m}m/pixel`;
                            
                            this.showSuccess(message);
                            
                            // Hide progress after delay and refresh data
                            setTimeout(() => {
                                progressContainer.style.display = 'none';
                                this.loadGallery();
                                this.loadStatistics();
                            }, 4000);
                            
                        }, 2500);
                    }, 2000);
                }, 2000);
                
            } else {
                throw new Error(data.error || 'Error en an√°lisis Multi-API Ultra HD');
            }
            
        } catch (error) {
            console.error('Error running Multi-API Ultra HD analysis:', error);
            this.showError('Error en an√°lisis Multi-API Ultra HD: ' + error.message);
            progressContainer.style.display = 'none';
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-satellite-dish"></i> Multi-API Ultra HD (0.5m)';
        }
    }

    async startBestResolutionSearch() {
        const btn = document.getElementById('bestResolutionSearch');
        
        try {
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Buscando mejor resoluci√≥n...';
            
            // Show input dialog for coordinates
            const coordsDialog = prompt('Ingrese coordenadas (formato: lat,lon) o deje en blanco para usar Gaza:', '31.5017,34.4668');
            if (coordsDialog === null) {
                return; // User cancelled
            }
            
            let latitude = 31.5017;  // Gaza default
            let longitude = 34.4668;
            let locationName = 'Gaza Strip';
            
            if (coordsDialog.trim()) {
                const coords = coordsDialog.split(',');
                if (coords.length === 2) {
                    latitude = parseFloat(coords[0].trim());
                    longitude = parseFloat(coords[1].trim());
                    locationName = `${latitude.toFixed(4)}, ${longitude.toFixed(4)}`;
                }
            }

            const response = await fetch('/api/satellite/ultra-hd/best-resolution', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    latitude: latitude,
                    longitude: longitude,
                    location_name: locationName,
                    target_resolution_m: 0.5
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            
            if (data.success) {
                const result = data.result;
                const message = `‚úÖ Mejor imagen encontrada!\n\n` +
                              `üõ∞Ô∏è Fuente: ${result.source}\n` +
                              `üîç Resoluci√≥n: ${result.resolution_m}m/pixel\n` +
                              `üìè Tama√±o: ${(result.size_bytes / 1024 / 1024).toFixed(1)} MB\n` +
                              `üìç Ubicaci√≥n: ${locationName}`;
                
                this.showSuccess(message);
                
                // Refresh gallery to show new image
                setTimeout(() => {
                    this.loadGallery();
                }, 2000);
                
            } else {
                throw new Error(data.error || 'Error buscando mejor resoluci√≥n');
            }
            
        } catch (error) {
            console.error('Error searching best resolution:', error);
            this.showError('Error buscando mejor resoluci√≥n: ' + error.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-search-plus"></i> Buscar Mejor Resoluci√≥n';
        }
    }

    async startCommercialSatelliteAnalysis() {
        const btn = document.getElementById('commercialSatellites');
        const progressContainer = document.getElementById('progressContainer');
        
        try {
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Accediendo sat√©lites comerciales...';
            
            // Show progress container
            progressContainer.style.display = 'block';
            this.updateProgress(0, 'Conectando a sat√©lites comerciales...');

            const response = await fetch('/api/satellite/ultra-hd/auto-execute', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    target_resolution_m: 0.3,  // Objetivo: 30cm por pixel (WorldView)
                    max_zones: 8,              // Menos zonas para comerciales
                    commercial_only: true
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            
            if (data.success) {
                this.updateProgress(30, 'Autenticando con proveedores comerciales...');
                
                setTimeout(() => {
                    this.updateProgress(60, 'Descargando im√°genes WorldView/DigitalGlobe...');
                    
                    setTimeout(() => {
                        this.updateProgress(85, 'Procesando im√°genes de alta resoluci√≥n...');
                        
                        setTimeout(() => {
                            this.updateProgress(100, 'An√°lisis comercial completado!');
                            
                            const summary = data.analysis_summary;
                            const message = `üè¢ An√°lisis Sat√©lites Comerciales completado!\n\n` +
                                          `üìä Zonas procesadas: ${summary.total_zones_processed}\n` +
                                          `üîç Resoluci√≥n sub-m√©trica: ${summary.ultra_hd_zones} zonas\n` +
                                          `üí∞ Calidad comercial alcanzada\n` +
                                          `üéØ Resoluci√≥n objetivo: ${summary.target_resolution_m}m/pixel`;
                            
                            this.showSuccess(message);
                            
                            // Hide progress after delay and refresh data
                            setTimeout(() => {
                                progressContainer.style.display = 'none';
                                this.loadGallery();
                                this.loadStatistics();
                            }, 4000);
                            
                        }, 2000);
                    }, 2500);
                }, 2000);
                
            } else {
                throw new Error(data.error || 'Error en an√°lisis de sat√©lites comerciales');
            }
            
        } catch (error) {
            console.error('Error running commercial satellite analysis:', error);
            this.showError('Error en an√°lisis comercial: ' + error.message);
            progressContainer.style.display = 'none';
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-industry"></i> Sat√©lites Comerciales';
        }
    }

    async startGeeBatchExport() {
        const btn = document.getElementById('geeBatchExport');
        const progressContainer = document.getElementById('progressContainer');
        
        try {
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Exportando con GEE...';
            
            // Show progress container
            progressContainer.style.display = 'block';
            this.updateProgress(0, 'Conectando a Google Earth Engine...');

            // Use Gaza coordinates from fallback GeoJSON
            const geometry = {
                type: "Polygon",
                coordinates: [[
                    [34.1, 31.2],
                    [34.6, 31.2],
                    [34.6, 31.6],
                    [34.1, 31.6],
                    [34.1, 31.2]
                ]]
            };

            const response = await fetch('/api/satellite/gee/batch-export', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    geometry: geometry,
                    date_range: {
                        start: '2024-01-01',
                        end: '2024-12-31'
                    },
                    max_cloud_cover: 20,
                    collection: 'LANDSAT/LC08/C02/T1_L2'
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            
            if (data.success) {
                this.updateProgress(50, 'Iniciando tareas de exportaci√≥n...');
                
                setTimeout(() => {
                    this.updateProgress(100, 'Exportaci√≥n por lotes iniciada!');
                    
                    const message = `üåç Exportaci√≥n GEE iniciada exitosamente!\n\n` +
                                  `üì§ Tareas creadas: ${data.result.task_count || 'N/A'}\n` +
                                  `‚òÅÔ∏è Nubosidad m√°xima: 20%\n` +
                                  `üìÖ Per√≠odo: 2024 completo\n` +
                                  `üóÇÔ∏è Colecci√≥n: Landsat 8`;
                    
                    this.showSuccess(message);
                    
                    // Hide progress after delay
                    setTimeout(() => {
                        progressContainer.style.display = 'none';
                    }, 3000);
                    
                }, 2000);
                
            } else {
                throw new Error(data.error || 'Error en exportaci√≥n por lotes de GEE');
            }
            
        } catch (error) {
            console.error('Error running GEE batch export:', error);
            this.showError('Error en exportaci√≥n GEE: ' + error.message);
            progressContainer.style.display = 'none';
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-cloud-download-alt"></i> GEE Exportaci√≥n Lote';
        }
    }

    async startGeeBestImage() {
        const btn = document.getElementById('geeBestImage');
        const progressContainer = document.getElementById('progressContainer');
        
        try {
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Buscando con GEE...';
            
            // Show progress container
            progressContainer.style.display = 'block';
            this.updateProgress(0, 'Autenticando con Google Earth Engine...');

            // Gaza coordinates (center)
            const latitude = 31.4;
            const longitude = 34.35;

            const response = await fetch('/api/satellite/gee/best-image', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    latitude: latitude,
                    longitude: longitude,
                    date_range: {
                        start: '2024-01-01',
                        end: '2024-12-31'
                    },
                    max_cloud_cover: 10,
                    target_resolution: 10
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            
            if (data.success) {
                this.updateProgress(70, 'Analizando cat√°logo de im√°genes...');
                
                setTimeout(() => {
                    this.updateProgress(100, 'Mejor imagen GEE encontrada!');
                    
                    const imageInfo = data.result.image_info;
                    const message = `üéØ Mejor imagen GEE encontrada!\n\n` +
                                  `üÜî ID: ${imageInfo.id || 'N/A'}\n` +
                                  `‚òÅÔ∏è Nubosidad: ${imageInfo.cloud_cover || 'N/A'}%\n` +
                                  `üìÖ Fecha: ${imageInfo.date || 'N/A'}\n` +
                                  `üìê Resoluci√≥n: ${data.result.resolution || 'N/A'}m`;
                    
                    this.showSuccess(message);
                    
                    // Hide progress after delay and refresh gallery
                    setTimeout(() => {
                        progressContainer.style.display = 'none';
                        this.loadGallery();
                    }, 3000);
                    
                }, 2000);
                
            } else {
                throw new Error(data.error || 'No se encontr√≥ imagen adecuada en GEE');
            }
            
        } catch (error) {
            console.error('Error running GEE best image search:', error);
            this.showError('Error buscando imagen GEE: ' + error.message);
            progressContainer.style.display = 'none';
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fab fa-google"></i> GEE Mejor Imagen';
        }
    }

    async startGeeUltraHdMosaic() {
        const btn = document.getElementById('geeUltraHdMosaic');
        const progressContainer = document.getElementById('progressContainer');
        
        try {
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generando mosaico GEE...';
            
            // Show progress container
            progressContainer.style.display = 'block';
            this.updateProgress(0, 'Iniciando mosaico ultra HD con GEE...');

            // Gaza geometry for mosaic
            const geometry = {
                type: "Polygon",
                coordinates: [[
                    [34.1, 31.2],
                    [34.6, 31.2],
                    [34.6, 31.6],
                    [34.1, 31.6],
                    [34.1, 31.2]
                ]]
            };

            const response = await fetch('/api/satellite/gee/ultra-hd-mosaic', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    geometry: geometry,
                    date_range: {
                        start: '2024-01-01',
                        end: '2024-12-31'
                    },
                    max_cloud_cover: 5,
                    target_resolution: 1  // 1m objetivo
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            
            if (data.success) {
                this.updateProgress(30, 'Seleccionando mejores im√°genes...');
                
                setTimeout(() => {
                    this.updateProgress(60, 'Creando mosaico sin nubes...');
                    
                    setTimeout(() => {
                        this.updateProgress(85, 'Aplicando realce ultra HD...');
                        
                        setTimeout(() => {
                            this.updateProgress(100, 'Mosaico ultra HD GEE completado!');
                            
                            const mosaicInfo = data.result.mosaic_info;
                            const message = `üó∫Ô∏è Mosaico Ultra HD GEE generado!\n\n` +
                                          `üìê Resoluci√≥n final: ${mosaicInfo.resolution || 'N/A'}m\n` +
                                          `üå§Ô∏è Sin nubes: < 5%\n` +
                                          `üìä Calidad: Ultra Alta Definici√≥n\n` +
                                          `üéØ √Årea: Franja de Gaza completa`;
                            
                            this.showSuccess(message);
                            
                            // Hide progress after delay and refresh data
                            setTimeout(() => {
                                progressContainer.style.display = 'none';
                                this.loadGallery();
                                this.loadStatistics();
                            }, 4000);
                            
                        }, 2000);
                    }, 2500);
                }, 2000);
                
            } else {
                throw new Error(data.error || 'Error generando mosaico ultra HD con GEE');
            }
            
        } catch (error) {
            console.error('Error running GEE ultra HD mosaic:', error);
            this.showError('Error en mosaico GEE: ' + error.message);
            progressContainer.style.display = 'none';
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-layer-group"></i> GEE Mosaico Ultra HD';
        }
    }

    async loadAllGalleries() {
        await Promise.all([
            this.loadGallery(),
            this.loadDetectionGallery()
        ]);
    }

    async loadDetectionGallery() {
        try {
            const response = await fetch('/api/satellite/ultra-hd/gallery-detections');
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            
            const data = await response.json();
            const galleryContainer = document.getElementById('galleryDetections');
            
            if (data.success && data.images && data.images.length > 0) {
                galleryContainer.innerHTML = '';
                galleryContainer.classList.remove('loading');
                
                data.images.forEach((image, index) => {
                    const imageElement = document.createElement('div');
                    imageElement.className = 'gallery-item detection-highlight';
                    
                    const threatClass = this.getThreatClass(image.threat_level);
                    const created = new Date(image.created_at).toLocaleString('es-ES');
                    const coords = `${image.coordinates?.lat?.toFixed(3) || 'N/A'}, ${image.coordinates?.lon?.toFixed(3) || 'N/A'}`;
                    
                    // Funci√≥n para generar nombres m√°s profesionales
                    const getRegionName = (zoneId, imageIndex) => {
                        if (zoneId.toLowerCase().includes('gaza')) {
                            return `üéØ GAZA - Detecci√≥n ${String(imageIndex + 1).padStart(2, '0')}`;
                        } else if (zoneId.toLowerCase().includes('ucrania') || zoneId.toLowerCase().includes('ukraine')) {
                            return `üõ∞Ô∏è UCRANIA - Detecci√≥n ${String(imageIndex + 1).padStart(2, '0')}`;
                        } else if (zoneId.toLowerCase().includes('siria') || zoneId.toLowerCase().includes('syria')) {
                            return `üîç SIRIA - Detecci√≥n ${String(imageIndex + 1).padStart(2, '0')}`;
                        }
                        
                        // Para otros casos
                        return `üõ∞Ô∏è ${zoneId.toUpperCase()} - Detecci√≥n ${String(imageIndex + 1).padStart(2, '0')}`;
                    };
                    
                    const region = getRegionName(image.zone_id, index);
                    
                    imageElement.innerHTML = `
                        <div class="gallery-image" style="background-image: url('${image.image_path || '/static/images/satellite/placeholder.jpg'}');">
                            <div class="threat-badge ${threatClass}">${image.threat_level}</div>
                            <div class="detection-count">${image.detection_count} detecciones</div>
                        </div>
                        <div class="gallery-info">
                            <h4 class="gallery-title">${region}</h4>
                            <div class="gallery-meta">
                                <div class="detection-summary">
                                    <span class="military-count">ü™ñ ${image.military_objects?.length || 0}</span>
                                    <span class="destruction-count">üí• ${image.destruction_indicators?.length || 0}</span>
                                    <span class="confidence-count">üìä ${(image.confidence_score * 100).toFixed(0)}%</span>
                                </div>
                                <div class="capture-time">
                                    <i class="fas fa-clock"></i> ${created}
                                </div>
                                <div class="coordinates">
                                    <i class="fas fa-map-marker-alt"></i> ${coords}
                                </div>
                                <div class="detection-explanation" style="margin-top: 8px; font-size: 11px; color: var(--text-secondary); font-style: italic;">
                                    ${image.detection_summary || 'Sin resumen disponible'}
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Click event for modal - show detailed detection info
                    imageElement.addEventListener('click', () => {
                        this.showDetectionModal(image, region, created, coords);
                    });
                    
                    galleryContainer.appendChild(imageElement);
                });
                
                // Actualizar contador de detecciones
                document.getElementById('detectionsCount').textContent = data.total_images;
            } else {
                galleryContainer.innerHTML = '<div class="no-images"><i class="fas fa-search"></i><p>No hay im√°genes con detecciones militares/conflicto disponibles. Ejecuta el an√°lisis completo primero.</p></div>';
                galleryContainer.classList.remove('loading');
                document.getElementById('detectionsCount').textContent = '0';
            }
            
        } catch (error) {
            console.error('Error loading detection gallery:', error);
            const galleryContainer = document.getElementById('galleryDetections');
            galleryContainer.innerHTML = '<div class="error-message"><i class="fas fa-exclamation-triangle"></i><p>Error cargando galer√≠a de detecciones</p></div>';
            galleryContainer.classList.remove('loading');
        }
    }

    getThreatClass(threatLevel) {
        switch(threatLevel) {
            case 'CR√çTICO': return 'threat-critical';
            case 'ALTO': return 'threat-high';
            case 'MEDIO': return 'threat-medium';
            case 'BAJO': return 'threat-low';
            default: return 'threat-unknown';
        }
    }

    async loadUltraHdStatistics() {
        try {
            const response = await fetch('/api/satellite/ultra-hd/statistics');
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            
            const data = await response.json();
            
            if (data.success && data.statistics) {
                const stats = data.statistics;
                
                // Update statistics display with Ultra HD data
                document.getElementById('totalImages').textContent = stats.total_analyses || '0';
                document.getElementById('detectionsCount').textContent = stats.total_objects_detected || '0';
                document.getElementById('regionsCount').textContent = stats.analyses_with_detections || '0';
                document.getElementById('lastUpdate').textContent = new Date(stats.last_updated).toLocaleString();
            }
            
        } catch (error) {
            console.error('Error loading Ultra HD statistics:', error);
        }
    }

    async loadUltraHdPredictions() {
        try {
            const response = await fetch('/api/satellite/ultra-hd/predictions');
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            
            const data = await response.json();
            
            if (data.success && data.predictions) {
                const predictions = data.predictions;
                
                // Update predictions display with Ultra HD data
                const predictionsContainer = document.getElementById('evolutionPredictions');
                if (predictionsContainer) {
                    predictionsContainer.innerHTML = `
                        <div class="prediction-summary">
                            <div class="prediction-item">
                                <h5>üìà Actividad Militar</h5>
                                <span class="trend ${predictions.military_activity_trend?.toLowerCase()}">${predictions.military_activity_trend}</span>
                            </div>
                            <div class="prediction-item">
                                <h5>‚ö†Ô∏è Probabilidad de Escalaci√≥n</h5>
                                <span class="probability ${predictions.escalation_probability?.toLowerCase()}">${predictions.escalation_probability}</span>
                            </div>
                            <div class="prediction-item">
                                <h5>üîç Frecuencia Recomendada</h5>
                                <span class="frequency">${predictions.recommended_monitoring_frequency}</span>
                            </div>
                            <div class="prediction-item">
                                <h5>üéØ Confianza del Modelo</h5>
                                <span class="confidence">${(predictions.prediction_confidence * 100).toFixed(0)}%</span>
                            </div>
                        </div>
                    `;
                    predictionsContainer.classList.remove('loading');
                }
            }
            
        } catch (error) {
            console.error('Error loading Ultra HD predictions:', error);
        }
    }

    startProgressPolling() {
        if (this.progressInterval) {
            clearInterval(this.progressInterval);
        }

        this.progressInterval = setInterval(async () => {
            try {
                const response = await fetch(`/api/satellite/analysis-progress/${this.analysisId}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                this.updateProgress(data.progress, data.status);

                if (data.status === 'completed' || data.status === 'failed') {
                    clearInterval(this.progressInterval);
                    document.getElementById('progressContainer').style.display = 'none';
                    
                    if (data.status === 'completed') {
                        this.loadInitialData(); // Refresh all data
                    }
                }
                
            } catch (error) {
                console.error('Error polling progress:', error);
                clearInterval(this.progressInterval);
            }
        }, 2000);
    }

    updateProgress(progress, status) {
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        
        progressFill.style.width = `${progress}%`;
        progressText.textContent = `${status} - ${progress}%`;
    }

    async loadStatistics() {
        try {
            const response = await fetch('/api/satellite/statistics');
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            
            const data = await response.json();
            
            document.getElementById('totalImages').textContent = data.total_images || '0';
            document.getElementById('detectionsCount').textContent = data.detections_count || '0';
            document.getElementById('regionsCount').textContent = data.regions_count || '0';
            document.getElementById('lastUpdate').textContent = data.last_update || 'Nunca';
            
        } catch (error) {
            console.error('Error loading statistics:', error);
            this.showLoadingError('statistics');
        }
    }

    async loadCriticalAlerts() {
        try {
            const response = await fetch('/api/satellite/critical-alerts');
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            
            const data = await response.json();
            const container = document.getElementById('criticalAlerts');
            
            if (data.alerts && data.alerts.length > 0) {
                container.innerHTML = data.alerts.map(alert => `
                    <div class="alert-item" style="background: rgba(220, 38, 38, 0.1); border: 1px solid rgba(220, 38, 38, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <h6 style="color: #fff; margin-bottom: 5px;">${alert.title || 'Alerta Sin T√≠tulo'}</h6>
                                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 8px;">${alert.description || 'Sin descripci√≥n'}</p>
                                <small style="color: var(--text-secondary);">${alert.timestamp || 'Fecha desconocida'}</small>
                            </div>
                            <span class="badge ${this.getSeverityClass(alert.severity)}">${alert.severity || 'unknown'}</span>
                        </div>
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No hay alertas cr√≠ticas en este momento</p>';
            }
            
        } catch (error) {
            console.error('Error loading critical alerts:', error);
            this.showLoadingError('criticalAlerts');
        }
    }

    async loadGallery() {
        try {
            // Cargar galer√≠a principal (todas las im√°genes)
            const response = await fetch('/api/satellite/gallery');
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            
            const data = await response.json();
            const container = document.getElementById('galleryImages');
            
            // SVG placeholder como data URL para evitar bucles infinitos
            const placeholderSvg = 'data:image/svg+xml;base64,' + btoa(`
                <svg width="300" height="200" xmlns="http://www.w3.org/2000/svg">
                    <rect width="100%" height="100%" fill="#1a237e"/>
                    <rect x="10" y="10" width="280" height="180" fill="none" stroke="#00d4ff" stroke-width="2" stroke-dasharray="5,5"/>
                    <text x="150" y="90" text-anchor="middle" fill="#00d4ff" font-family="Arial" font-size="14">Imagen Satelital</text>
                    <text x="150" y="110" text-anchor="middle" fill="#00d4ff" font-family="Arial" font-size="12">No Disponible</text>
                </svg>
            `);
            
            if (data.success && data.images && data.images.length > 0) {
                container.className = 'gallery-grid';
                container.innerHTML = data.images.map((image, index) => {
                    const imageUrl = image.image_path ? `${image.image_path}` : placeholderSvg;
                    
                    // Funci√≥n para generar nombres m√°s profesionales
                    const getRegionName = (zoneId, imageIndex) => {
                        if (zoneId.toLowerCase().includes('gaza')) {
                            return `üéØ GAZA - Zona ${String(imageIndex + 1).padStart(2, '0')}`;
                        } else if (zoneId.toLowerCase().includes('ucrania') || zoneId.toLowerCase().includes('ukraine')) {
                            return `üõ∞Ô∏è UCRANIA - Zona ${String(imageIndex + 1).padStart(2, '0')}`;
                        } else if (zoneId.toLowerCase().includes('siria') || zoneId.toLowerCase().includes('syria')) {
                            return `ÔøΩ SIRIA - Zona ${String(imageIndex + 1).padStart(2, '0')}`;
                        }
                        
                        // Para otros casos
                        return `üõ∞Ô∏è ${zoneId.toUpperCase()} - ${String(imageIndex + 1).padStart(2, '0')}`;
                    };
                    
                    const region = getRegionName(image.zone_id, index);
                    const coords = `${image.coordinates?.lat?.toFixed(3) || 'N/A'}, ${image.coordinates?.lon?.toFixed(3) || 'N/A'}`;
                    const source = image.source === 'sentinel' ? 'Sentinel Hub' : 'Google Maps';
                    const created = new Date(image.created_at).toLocaleString('es-ES');
                    
                    return `
                    <div class="gallery-item" onclick="window.satelliteManager.showImageModal('${imageUrl}', '${region}', '${created}', '${coords}', '${source}')">
                        <img src="${imageUrl}" alt="${region}" class="gallery-image" onerror="if(this.src !== '${placeholderSvg}') this.src='${placeholderSvg}';">
                        <div class="gallery-info">
                            <div class="gallery-title">${region}</div>
                            <div class="gallery-meta">
                                <small><i class="fas fa-map-marker-alt"></i> ${coords}</small><br>
                                <small><i class="fas fa-calendar"></i> ${created}</small><br>
                                <small><i class="fas fa-satellite"></i> ${source}</small><br>
                                <small><i class="fas fa-expand-arrows-alt"></i> ${image.resolution}</small>
                            </div>
                        </div>
                    </div>
                `;
                }).join('');
                
                // Actualizar contador
                document.getElementById('imageCount').textContent = data.total_images;
            } else {
                container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); grid-column: 1 / -1;">No hay im√°genes disponibles</p>';
                document.getElementById('imageCount').textContent = '0';
            }
            
        } catch (error) {
            console.error('Error loading gallery:', error);
            this.showLoadingError('galleryImages');
        }
    }

    async loadTimeline() {
        try {
            const response = await fetch('/api/satellite/analysis-timeline');
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            
            const data = await response.json();
            const container = document.getElementById('analysisTimeline');
            
            if (data.timeline && data.timeline.length > 0) {
                container.className = 'timeline';
                container.innerHTML = data.timeline.map(event => `
                    <div class="timeline-item">
                        <div class="timeline-date">${event.timestamp || 'Fecha desconocida'}</div>
                        <div class="timeline-content">${event.description || 'Sin descripci√≥n'}</div>
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No hay eventos registrados</p>';
            }
            
        } catch (error) {
            console.error('Error loading timeline:', error);
            this.showLoadingError('analysisTimeline');
        }
    }

    async loadPredictions() {
        try {
            const response = await fetch('/api/satellite/evolution-predictions');
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            
            const data = await response.json();
            const container = document.getElementById('evolutionPredictions');
            
            if (data.predictions && data.predictions.length > 0) {
                container.innerHTML = data.predictions.map(pred => `
                    <div style="background: rgba(0, 13, 20, 0.6); border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <h6 style="color: #fff; margin: 0;">${pred.region || 'Regi√≥n desconocida'}</h6>
                            <span class="badge ${this.getRiskLevelClass(pred.risk_level)}">${pred.risk_level || 'unknown'}</span>
                        </div>
                        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 8px;">${pred.prediction || 'Sin predicci√≥n disponible'}</p>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <small style="color: var(--text-secondary);">Confianza: ${pred.confidence || '0'}%</small>
                            <small style="color: var(--text-secondary);">Plazo: ${pred.timeframe || 'No especificado'}</small>
                        </div>
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No hay predicciones disponibles</p>';
            }
            
        } catch (error) {
            console.error('Error loading predictions:', error);
            this.showLoadingError('evolutionPredictions');
        }
    }

    showImageModal(url, region, date, coordinates, detections) {
        // SVG placeholder como data URL
        const placeholderSvg = 'data:image/svg+xml;base64,' + btoa(`
            <svg width="600" height="400" xmlns="http://www.w3.org/2000/svg">
                <rect width="100%" height="100%" fill="#1a237e"/>
                <rect x="20" y="20" width="560" height="360" fill="none" stroke="#00d4ff" stroke-width="3" stroke-dasharray="10,5"/>
                <text x="300" y="180" text-anchor="middle" fill="#00d4ff" font-family="Arial" font-size="24">Imagen Satelital</text>
                <text x="300" y="210" text-anchor="middle" fill="#00d4ff" font-family="Arial" font-size="18">No Disponible</text>
            </svg>
        `);
        
        const modalImage = document.getElementById('modalImage');
        modalImage.src = url || placeholderSvg;
        modalImage.onerror = function() {
            if(this.src !== placeholderSvg) {
                this.src = placeholderSvg;
            }
        };
        
        document.getElementById('modalRegion').textContent = region;
        document.getElementById('modalDate').textContent = date;
        document.getElementById('modalCoords').textContent = coordinates;
        document.getElementById('modalDetections').textContent = detections;
        
        const modal = new bootstrap.Modal(document.getElementById('imageModal'));
        modal.show();
    }

    showDetectionModal(image, region, date, coordinates) {
        // Crear modal espec√≠fico para detecciones con explicaciones detalladas
        const placeholderSvg = 'data:image/svg+xml;base64,' + btoa(`
            <svg width="600" height="400" xmlns="http://www.w3.org/2000/svg">
                <rect width="100%" height="100%" fill="#1a237e"/>
                <rect x="20" y="20" width="560" height="360" fill="none" stroke="#ff6b35" stroke-width="3" stroke-dasharray="10,5"/>
                <text x="300" y="170" text-anchor="middle" fill="#ff6b35" font-family="Arial" font-size="24">Detecci√≥n Militar</text>
                <text x="300" y="200" text-anchor="middle" fill="#ff6b35" font-family="Arial" font-size="18">An√°lisis IA</text>
                <text x="300" y="230" text-anchor="middle" fill="#ff6b35" font-family="Arial" font-size="16">Imagen No Disponible</text>
            </svg>
        `);
        
        const modalImage = document.getElementById('modalImage');
        modalImage.src = image.image_path || placeholderSvg;
        modalImage.onerror = function() {
            if(this.src !== placeholderSvg) {
                this.src = placeholderSvg;
            }
        };
        
        // Actualizar informaci√≥n b√°sica
        document.getElementById('modalRegion').textContent = region;
        document.getElementById('modalDate').textContent = date;
        document.getElementById('modalCoords').textContent = coordinates;
        
        // Crear descripci√≥n detallada de detecciones
        let detectionText = '';
        if (image.detections && image.detections.length > 0) {
            detectionText = `DETECCIONES ENCONTRADAS:\n\n`;
            image.detections.forEach((detection, index) => {
                detectionText += `${index + 1}. ${detection.class_name || 'Objeto desconocido'}\n`;
                detectionText += `   Confianza: ${(detection.confidence * 100).toFixed(1)}%\n`;
                if (detection.explanation) {
                    detectionText += `   Explicaci√≥n: ${detection.explanation}\n`;
                }
                detectionText += `\n`;
            });
        }
        
        if (image.detection_summary) {
            detectionText += `\nRESUMEN DEL AN√ÅLISIS:\n${image.detection_summary}`;
        }
        
        if (image.military_objects && image.military_objects.length > 0) {
            detectionText += `\n\nOBJETOS MILITARES: ${image.military_objects.length}`;
        }
        
        if (image.destruction_indicators && image.destruction_indicators.length > 0) {
            detectionText += `\nINDICADORES DE DESTRUCCI√ìN: ${image.destruction_indicators.length}`;
        }
        
        detectionText += `\n\nNIVEL DE AMENAZA: ${image.threat_level}`;
        detectionText += `\nPUNTUACI√ìN DE CONFIANZA: ${(image.confidence_score * 100).toFixed(1)}%`;
        
        document.getElementById('modalDetections').textContent = detectionText || 'Sin detecciones disponibles';
        
        const modal = new bootstrap.Modal(document.getElementById('imageModal'));
        modal.show();
    }

    getSeverityClass(severity) {
        switch(severity?.toLowerCase()) {
            case 'high': return 'bg-danger';
            case 'critical': return 'bg-danger';
            case 'medium': return 'bg-warning';
            case 'low': return 'bg-success';
            default: return 'bg-secondary';
        }
    }

    getRiskLevelClass(riskLevel) {
        switch(riskLevel?.toLowerCase()) {
            case 'high': return 'bg-danger';
            case 'medium': return 'bg-warning';
            case 'low': return 'bg-success';
            default: return 'bg-secondary';
        }
    }

    showLoadingError(containerId) {
        const container = document.getElementById(containerId);
        container.innerHTML = '<p style="text-align: center; color: var(--danger);">Error al cargar datos</p>';
    }

    showError(message) {
        // Create temporary error notification
        const errorDiv = document.createElement('div');
        errorDiv.style.cssText = `
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(220, 38, 38, 0.95);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            z-index: 9999;
            font-weight: 500;
        `;
        errorDiv.textContent = message;
        document.body.appendChild(errorDiv);
        
        setTimeout(() => {
            if (errorDiv.parentNode) {
                errorDiv.parentNode.removeChild(errorDiv);
            }
        }, 5000);
    }

    showSuccess(message) {
        // Create temporary success notification
        const successDiv = document.createElement('div');
        successDiv.style.cssText = `
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(16, 185, 129, 0.95);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            z-index: 9999;
            font-weight: 500;
        `;
        successDiv.textContent = message;
        document.body.appendChild(successDiv);
        
        setTimeout(() => {
            if (successDiv.parentNode) {
                successDiv.parentNode.removeChild(successDiv);
            }
        }, 5000);
    }
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    window.satelliteManager = new SatelliteAnalysisManager();
});
</script>
{% endblock %}
